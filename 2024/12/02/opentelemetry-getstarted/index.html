<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>OpenTelemetry上手指南</title>
<meta charset=utf-8><meta name=google-adsense-account content="ca-pub-2871082647721658"><meta content="Web开发 ,Java ,Go ,Node.js ,PHP ,Koa ,MySQL ,Redis ,前端 ,后端 ,数据库" name=keywords><meta name=description content="可观测性的三要素 在现代分布式系统中，可观测性是确保系统健康和性能的关键。可观测性通常由以下三要素组成：
Metrics（指标） Metrics 是关于系统性能和健康的数值数据。它们通常是定期收集的，提供了系统在特定时间点的状态快照。 常见的指标包括 CPU 使用率、内存使用量、请求速率、错误率等。 Metrics 通常用于监控和告警。"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/2024/12/02/opentelemetry-getstarted/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com/index.xml title=每天进步一点点><script async src="https://www.googletagmanager.com/gtag/js?id=G-EC3XLVSGKV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EC3XLVSGKV")</script><meta property="og:title" content="OpenTelemetry上手指南"><meta property="og:description" content="可观测性的三要素 在现代分布式系统中，可观测性是确保系统健康和性能的关键。可观测性通常由以下三要素组成：
Metrics（指标） Metrics 是关于系统性能和健康的数值数据。它们通常是定期收集的，提供了系统在特定时间点的状态快照。 常见的指标包括 CPU 使用率、内存使用量、请求速率、错误率等。 Metrics 通常用于监控和告警。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ddhigh.com/2024/12/02/opentelemetry-getstarted/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-02T11:53:08+08:00"><meta property="article:modified_time" content="2024-12-02T11:53:08+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenTelemetry上手指南"><meta name=twitter:description content="可观测性的三要素 在现代分布式系统中，可观测性是确保系统健康和性能的关键。可观测性通常由以下三要素组成：
Metrics（指标） Metrics 是关于系统性能和健康的数值数据。它们通常是定期收集的，提供了系统在特定时间点的状态快照。 常见的指标包括 CPU 使用率、内存使用量、请求速率、错误率等。 Metrics 通常用于监控和告警。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.ddhigh.com/posts/"},{"@type":"ListItem","position":3,"name":"OpenTelemetry上手指南","item":"https://www.ddhigh.com/2024/12/02/opentelemetry-getstarted/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OpenTelemetry上手指南","name":"OpenTelemetry上手指南","description":"可观测性的三要素 在现代分布式系统中，可观测性是确保系统健康和性能的关键。可观测性通常由以下三要素组成：\nMetrics（指标） Metrics 是关于系统性能和健康的数值数据。它们通常是定期收集的，提供了系统在特定时间点的状态快照。 常见的指标包括 CPU 使用率、内存使用量、请求速率、错误率等。 Metrics 通常用于监控和告警。","keywords":["Observability"],"articleBody":"可观测性的三要素 在现代分布式系统中，可观测性是确保系统健康和性能的关键。可观测性通常由以下三要素组成：\nMetrics（指标） Metrics 是关于系统性能和健康的数值数据。它们通常是定期收集的，提供了系统在特定时间点的状态快照。 常见的指标包括 CPU 使用率、内存使用量、请求速率、错误率等。 Metrics 通常用于监控和告警。\nTraces（追踪） Traces 记录了请求在系统中流动的路径，帮助开发者理解请求的生命周期。 每个 trace 由多个 span 组成，每个 span 代表请求在系统中一个特定操作的执行。 Traces 对于调试分布式系统中的性能问题和瓶颈非常有用。\nLogs（日志） Logs 是系统在运行时生成的事件记录，通常包含时间戳和事件描述。 日志可以是结构化的（如 JSON 格式）或非结构化的（如纯文本）。 Logs 是调试和故障排查的基础工具。\nOpenTelemetry OpenTelemetry 是一个开源项目，旨在为分布式系统提供统一的可观测性数据收集和传输标准。它是由 OpenTracing 和 OpenCensus 合并而来的，提供了以下功能：\n统一的 API 和 SDK：支持多种编程语言，帮助开发者轻松集成可观测性。 自动化的上下文传播：在分布式系统中自动传播上下文信息，确保 trace 的完整性。 多种后端支持：支持将数据发送到多种后端，如 Prometheus、Jaeger、Zipkin 等。 可扩展性：通过插件和扩展机制，支持自定义数据收集和处理。 需要注意的是，OpenTelemetry 本身并不直接提供数据存储和分析功能，它只是一个标准和工具集，需要与具体的可观测性平台（如 Grafana、Jaeger、Prometheus 等）结合使用。 本文使用OpenObserve作为后端，OpenTelemetry作为数据收集工具进行演示。\nGo服务接入OpenTelemetry实践 启动本地OpenObserve服务 本地安装Docker后执行以下命令启动本地OpenObserve服务：\ndocker run -v $PWD/data:/data -e ZO_DATA_DIR=\"/data\" -p 5080:5080 \\ -e ZO_ROOT_USER_EMAIL=\"root@example.com\" -e ZO_ROOT_USER_PASSWORD=\"Complexpass#123\" \\ public.ecr.aws/zinclabs/openobserve:latest 打开浏览器访问http://localhost:5080，使用root@example.com和Complexpass#123登录。\n启动OpenTelemetry Collector服务 新建 otel-collector-config.yaml 文件，内容如下：\nreceivers: otlp: protocols: grpc: endpoint: 0.0.0.0:4317 http: endpoint: 0.0.0.0:4318 processors: batch: timeout: 1s send_batch_size: 1024 exporters: otlphttp/openobserve: endpoint: http://localhost:5080/api/default headers: Authorization: Basic bGVpQGNvbm5lY3RseS5haTphMldmRzFTWXlGWXhjUWtp stream-name: default service: pipelines: traces: receivers: [otlp] processors: [batch] exporters: [otlphttp/openobserve] metrics: receivers: [otlp] processors: [batch] exporters: [otlphttp/openobserve] logs: receivers: [otlp] processors: [batch] exporters: [otlphttp/openobserve] OpenTelemetry Collector由receiver、processor和exporter组成，receiver用于接收数据，processor用于处理数据，exporter用于将数据发送到后端。上述例子中，receiver使用otlp协议接收数据，processor使用batch进行批量处理，exporter将数据发送到OpenObserve。\n使用下列配置通过Docker Compose启动OpenTelemetry Collector服务：\nservices: otel-collector: image: otel/opentelemetry-collector-contrib:0.114.0 volumes: - ./otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml - /var/lib/docker/containers:/var/lib/docker/containers:ro - /var/log/containers:/var/log/containers:ro ports: # - 1888:1888 # pprof extension # - 18888:8888 # Prometheus metrics exposed by the Collector # - 18889:8889 # Prometheus exporter metrics # - 13133:13133 # health_check extension - 4317:4317 # OTLP gRPC receiver - 4318:4318 # OTLP http receiver # - 55679:55679 # zpages extension volumes: data: 此时，OpenTelemetry Collector和OpenObserve服务已经启动，可以进行下一步。\nGo代码埋点 下面演示了一个Gin开发的Web服务器，访问主服务器的 /hello 路径时，会请求go协程启动的HTTP服务。\npackage main import ( \"context\" \"encoding/json\" \"fmt\" \"io\" \"math/rand\" \"net/http\" \"time\" \"github.com/gin-gonic/gin\" \"go.opentelemetry.io/contrib/bridges/otelzap\" \"go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp\" \"go.opentelemetry.io/otel\" \"go.opentelemetry.io/otel/attribute\" \"go.opentelemetry.io/otel/exporters/otlp/otlplog/otlploggrpc\" \"go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetricgrpc\" \"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc\" \"go.opentelemetry.io/otel/log/global\" \"go.opentelemetry.io/otel/metric\" \"go.opentelemetry.io/otel/sdk/log\" sdkmetric \"go.opentelemetry.io/otel/sdk/metric\" \"go.opentelemetry.io/otel/sdk/resource\" sdktrace \"go.opentelemetry.io/otel/sdk/trace\" semconv \"go.opentelemetry.io/otel/semconv/v1.21.0\" \"go.opentelemetry.io/otel/trace\" \"go.uber.org/zap\" \"google.golang.org/grpc\" \"google.golang.org/grpc/credentials/insecure\" ) func initProvider() (func(), error) { ctx := context.Background() res, err := resource.New(ctx, resource.WithAttributes( semconv.ServiceName(\"my-service\"), semconv.ServiceVersion(\"1.0.0\"), ), ) if err != nil { return nil, err } conn, err := grpc.Dial(\"127.0.0.1:4317\", grpc.WithTransportCredentials(insecure.NewCredentials()), grpc.WithBlock(), ) if err != nil { return nil, err } // 设置 trace exporter traceExporter, err := otlptracegrpc.New(ctx, otlptracegrpc.WithGRPCConn(conn)) if err != nil { return nil, err } // 设置 trace provider tracerProvider := sdktrace.NewTracerProvider( sdktrace.WithBatcher(traceExporter), sdktrace.WithResource(res), ) otel.SetTracerProvider(tracerProvider) // 设置 metric exporter metricExporter, err := otlpmetricgrpc.New(ctx, otlpmetricgrpc.WithGRPCConn(conn)) if err != nil { return nil, err } // 设置 metric provider metricProvider := sdkmetric.NewMeterProvider( sdkmetric.WithResource(res), sdkmetric.WithReader(sdkmetric.NewPeriodicReader(metricExporter, sdkmetric.WithInterval(2*time.Second))), ) otel.SetMeterProvider(metricProvider) // 设置log exporter logExporter, err := otlploggrpc.New(ctx, otlploggrpc.WithGRPCConn(conn)) if err != nil { return nil, err } processor := log.NewBatchProcessor(logExporter, log.WithExportMaxBatchSize(10)) logProvider := log.NewLoggerProvider( log.WithResource(res), log.WithProcessor(processor), ) global.SetLoggerProvider(logProvider) return func() { ctx := context.Background() if err := tracerProvider.Shutdown(ctx); err != nil { panic(err) } if err := metricProvider.Shutdown(ctx); err != nil { panic(err) } if err := logProvider.Shutdown(ctx); err != nil { panic(err) } conn.Close() }, nil } func metricsMiddleware() gin.HandlerFunc { meter := otel.GetMeterProvider().Meter(\"http_server\") // 创建延迟直方图 latencyHist, _ := meter.Float64Histogram( \"http_server_request_duration_seconds\", metric.WithDescription(\"HTTP request duration in seconds\"), ) // 创建请求计数器 requestCount, _ := meter.Int64Counter( \"http_server_requests_total\", metric.WithDescription(\"Total number of HTTP requests\"), ) return func(c *gin.Context) { start := time.Now() c.Next() duration := time.Since(start).Seconds() // 通用标签 attrs := []attribute.KeyValue{ attribute.String(\"method\", c.Request.Method), attribute.String(\"path\", c.FullPath()), attribute.Int(\"status\", c.Writer.Status()), } // 记录指标，使用正确的 API latencyHist.Record(c.Request.Context(), duration, metric.WithAttributes(attrs...)) requestCount.Add(c.Request.Context(), 1, metric.WithAttributes(attrs...)) } } func newTracedServer(httpClient *http.Client, sugar *zap.SugaredLogger) *gin.Engine { // 为内部服务创建新的 resource res, err := resource.New(context.Background(), resource.WithAttributes( semconv.ServiceName(\"helloservice\"), semconv.ServiceVersion(\"1.0.0\"), ), ) if err != nil { sugar.Errorw(\"failed to create resource\", \"error\", err) panic(err) } // 为内部服务创建新的 TracerProvider tracerProvider := sdktrace.NewTracerProvider( sdktrace.WithResource(res), ) r := gin.New() r.Use(gin.Recovery()) // 使用新的 TracerProvider 创建 handler r.Use(func(c *gin.Context) { handler := otelhttp.NewHandler( http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { c.Request = r c.Next() }), \"helloservice.http\", otelhttp.WithTracerProvider(tracerProvider), ) handler.ServeHTTP(c.Writer, c.Request) }) r.GET(\"/hello\", func(c *gin.Context) { // 从请求中获取 trace context ctx := c.Request.Context() // 创建 GitHub API 请求 req, err := http.NewRequestWithContext(ctx, \"GET\", \"https://api.github.com\", nil) if err != nil { sugar.Errorw(\"failed to create request\", \"error\", err) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } // 发送请求 resp, err := httpClient.Do(req) if err != nil { sugar.Errorw(\"failed to send request\", \"error\", err) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } defer resp.Body.Close() // 读取响应 body, err := io.ReadAll(resp.Body) if err != nil { sugar.Errorw(\"failed to read response\", \"error\", err) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } var respBody map[string]any if err := json.Unmarshal(body, \u0026respBody); err != nil { sugar.Errorw(\"failed to unmarshal response\", \"error\", err) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } c.JSON(http.StatusOK, respBody) }) return r } func main() { cleanup, err := initProvider() if err != nil { panic(err) } defer cleanup() // 创建 OTLP core logProvider := global.GetLoggerProvider() logger := zap.New(otelzap.NewCore(\"my/pkg/name\", otelzap.WithLoggerProvider(logProvider))) defer logger.Sync() sugar := logger.Sugar() // 创建带有 trace 的 HTTP 客户端 httpClient := \u0026http.Client{ Transport: otelhttp.NewTransport(http.DefaultTransport), } // 启动内部服务器（18080端口） internalServer := newTracedServer(httpClient, sugar) go func() { if err := internalServer.Run(\":18080\"); err != nil { sugar.Errorw(\"internal server failed\", \"error\", err) } }() // 主服务器配置 gin.SetMode(gin.ReleaseMode) r := gin.New() r.Use(gin.Recovery(), metricsMiddleware()) r.GET(\"/ping\", func(c *gin.Context) { resp := gin.H{ \"message\": \"pong\", } sugar.Infow(\"ping\", \"url\", c.Request.URL.String(), \"method\", c.Request.Method, \"ip\", c.ClientIP(), \"user-agent\", c.Request.UserAgent(), \"resp\", resp, ) c.JSON(http.StatusOK, resp) }) r.GET(\"/github\", func(c *gin.Context) { // 从 gin.Context 获取 trace context ctx := c.Request.Context() // 创建新的请求 req, err := http.NewRequestWithContext(ctx, \"GET\", \"https://api.github.com\", nil) if err != nil { sugar.Errorw(\"failed to create request\", \"error\", err, ) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } // 发送请求 resp, err := httpClient.Do(req) if err != nil { sugar.Errorw(\"failed to send request\", \"error\", err, ) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } defer resp.Body.Close() // 读取响应 body, err := io.ReadAll(resp.Body) if err != nil { sugar.Errorw(\"failed to read response\", \"error\", err, ) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } var respBody map[string]any if err := json.Unmarshal(body, \u0026respBody); err != nil { sugar.Errorw(\"failed to unmarshal response\", \"error\", err, ) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } // 记录日志 sugar.Infow(\"github api request\", zap.Any(\"resp\", map[string]any{\"status\": rand.Intn(500)}), ) // 返回响应 c.JSON(resp.StatusCode, respBody) }) // 添加 /trace 路由 r.GET(\"/trace\", func(c *gin.Context) { ctx := c.Request.Context() // 获取 trace ID 用于日志 var traceID string if spanCtx := trace.SpanContextFromContext(ctx); spanCtx.IsValid() { traceID = spanCtx.TraceID().String() } tr := otel.Tracer(\"time-consuming-operation\") ctx, span := tr.Start(ctx, \"sleep-operation\") time.Sleep(1 * time.Second) span.End() req, err := http.NewRequestWithContext(ctx, \"GET\", \"http://localhost:18080/hello\", nil) if err != nil { sugar.Errorw(\"failed to create request\", \"error\", err, \"trace_id\", traceID, ) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } resp, err := httpClient.Do(req) if err != nil { sugar.Errorw(\"failed to send request\", \"error\", err, \"trace_id\", traceID, ) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } defer resp.Body.Close() body, err := io.ReadAll(resp.Body) if err != nil { sugar.Errorw(\"failed to read response\", \"error\", err, \"trace_id\", traceID, ) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } var respBody map[string]any if err := json.Unmarshal(body, \u0026respBody); err != nil { sugar.Errorw(\"failed to unmarshal response\", \"error\", err, \"trace_id\", traceID, ) c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } // 记录成功日志 sugar.Infow(\"trace request completed\", \"trace_id\", traceID, \"status\", resp.StatusCode, ) // 设置响应头 if traceID != \"\" { c.Header(\"X-Trace-ID\", traceID) } c.JSON(resp.StatusCode, respBody) }) fmt.Println(\"start server\") panic(r.Run(\":8080\")) } 总结 本文详细介绍了OpenTelemetry在Go服务中的实践应用。通过可观测性的三大支柱（Metrics、Traces和Logs），我们可以全方位监控和了解分布式系统的运行状态。OpenTelemetry作为一个统一的可观测性框架，不仅提供了标准化的数据收集方式，还支持多种后端存储方案。\n在实践部分，我们通过一个完整的示例展示了：\n如何搭建本地OpenObserve和OpenTelemetry Collector环境 如何在Go服务中初始化OpenTelemetry的各个组件 如何使用中间件收集HTTP请求的指标 如何在分布式系统中进行链路追踪 如何集成结构化日志 通过这些实践，我们可以构建一个具有完整可观测性的现代分布式系统，为系统的监控、调试和优化提供有力支持。\n参考链接 OpenTelemetry官方文档 OpenTelemetry Go SDK OpenObserve文档 Gin Web Framework OpenTelemetry Collector Zap Logger ","wordCount":"1069","inLanguage":"zh","datePublished":"2024-12-02T11:53:08+08:00","dateModified":"2024-12-02T11:53:08+08:00","author":{"@type":"Person","name":"Lei Xia"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com/2024/12/02/opentelemetry-getstarted/"},"publisher":{"@type":"Organization","name":"每天进步一点点","logo":{"@type":"ImageObject","url":"https://www.ddhigh.com/favicon.ico"}}}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link href=/titilliumweb/titilliumweb.css rel=stylesheet><link rel=stylesheet href=/css/main.min.0eb4160ba4a2d63122fe8ae83f1560951a87ab510d5dab0615973b5206555759.css integrity="sha256-DrQWC6Si1jEi/oroPxVglRqHq1ENXasGFZc7UgZVV1k=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css integrity="sha512-ygEyjMC6rqnzJqWGjRTJUPYMEs9JUOm3i7OWUS9CgQ4XkBUvMsgCS1I8JqavidQ2ClHcREB7IbA2mN08+r9Elg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>$darkModeInit.Content|safeJS</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2871082647721658" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>每天进步一点点
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/>首页</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>归档</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>出版物</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>留言板</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li><li class="navigation-item navigation-language"><a href=https://www.ddhigh.com/en/2024/12/02/opentelemetry-getstarted/>EN</a></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>OpenTelemetry上手指南</h1></header><p><small>2024年12月2日&nbsp;· 1069 字&nbsp;· 6 分钟</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#可观测性的三要素>可观测性的三要素</a></li><li><a href=#opentelemetry>OpenTelemetry</a></li><li><a href=#go服务接入opentelemetry实践>Go服务接入OpenTelemetry实践</a><ul><li><a href=#启动本地openobserve服务>启动本地OpenObserve服务</a></li><li><a href=#启动opentelemetry-collector服务>启动OpenTelemetry Collector服务</a></li><li><a href=#go代码埋点>Go代码埋点</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考链接>参考链接</a></li></ul></nav></div><section class=blog-content><h2 id=可观测性的三要素>可观测性的三要素</h2><p>在现代分布式系统中，可观测性是确保系统健康和性能的关键。可观测性通常由以下三要素组成：</p><p><strong>Metrics（指标）</strong>
Metrics 是关于系统性能和健康的数值数据。它们通常是定期收集的，提供了系统在特定时间点的状态快照。
常见的指标包括 CPU 使用率、内存使用量、请求速率、错误率等。
Metrics 通常用于监控和告警。</p><p><strong>Traces（追踪）</strong>
Traces 记录了请求在系统中流动的路径，帮助开发者理解请求的生命周期。
每个 trace 由多个 span 组成，每个 span 代表请求在系统中一个特定操作的执行。
Traces 对于调试分布式系统中的性能问题和瓶颈非常有用。</p><p><strong>Logs（日志）</strong>
Logs 是系统在运行时生成的事件记录，通常包含时间戳和事件描述。
日志可以是结构化的（如 JSON 格式）或非结构化的（如纯文本）。
Logs 是调试和故障排查的基础工具。</p><h2 id=opentelemetry>OpenTelemetry</h2><p>OpenTelemetry 是一个开源项目，旨在为分布式系统提供统一的可观测性数据收集和传输标准。它是由 OpenTracing 和 OpenCensus 合并而来的，提供了以下功能：</p><ul><li>统一的 API 和 SDK：支持多种编程语言，帮助开发者轻松集成可观测性。</li><li>自动化的上下文传播：在分布式系统中自动传播上下文信息，确保 trace 的完整性。</li><li>多种后端支持：支持将数据发送到多种后端，如 Prometheus、Jaeger、Zipkin 等。</li><li>可扩展性：通过插件和扩展机制，支持自定义数据收集和处理。</li></ul><p>需要注意的是，OpenTelemetry 本身并不直接提供数据存储和分析功能，它只是一个标准和工具集，需要与具体的可观测性平台（如 Grafana、Jaeger、Prometheus 等）结合使用。
本文使用OpenObserve作为后端，OpenTelemetry作为数据收集工具进行演示。</p><h2 id=go服务接入opentelemetry实践>Go服务接入OpenTelemetry实践</h2><h3 id=启动本地openobserve服务>启动本地OpenObserve服务</h3><p>本地安装Docker后执行以下命令启动本地OpenObserve服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -v $PWD/data:/data -e ZO_DATA_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/data&#34;</span> -p 5080:5080 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -e ZO_ROOT_USER_EMAIL<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;root@example.com&#34;</span> -e ZO_ROOT_USER_PASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Complexpass#123&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    public.ecr.aws/zinclabs/openobserve:latest
</span></span></code></pre></div><p>打开浏览器访问http://localhost:5080，使用root@example.com和Complexpass#123登录。</p><h3 id=启动opentelemetry-collector服务>启动OpenTelemetry Collector服务</h3><p>新建 <code>otel-collector-config.yaml</code> 文件，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>receivers</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>otlp</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocols</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>grpc</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>0.0.0.0</span>:<span style=color:#ae81ff>4317</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>0.0.0.0</span>:<span style=color:#ae81ff>4318</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>processors</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>batch</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>1s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>send_batch_size</span>: <span style=color:#ae81ff>1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>exporters</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>otlphttp/openobserve</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>endpoint</span>: <span style=color:#ae81ff>http://localhost:5080/api/default</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Authorization</span>: <span style=color:#ae81ff>Basic bGVpQGNvbm5lY3RseS5haTphMldmRzFTWXlGWXhjUWtp</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>stream-name</span>: <span style=color:#ae81ff>default</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>service</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>pipelines</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>traces</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>receivers</span>: [<span style=color:#ae81ff>otlp]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>processors</span>: [<span style=color:#ae81ff>batch]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>exporters</span>: [<span style=color:#ae81ff>otlphttp/openobserve]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>metrics</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>receivers</span>: [<span style=color:#ae81ff>otlp]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>processors</span>: [<span style=color:#ae81ff>batch]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>exporters</span>: [<span style=color:#ae81ff>otlphttp/openobserve]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>logs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>receivers</span>: [<span style=color:#ae81ff>otlp]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>processors</span>: [<span style=color:#ae81ff>batch]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>exporters</span>: [<span style=color:#ae81ff>otlphttp/openobserve]</span>
</span></span></code></pre></div><p>OpenTelemetry Collector由receiver、processor和exporter组成，receiver用于接收数据，processor用于处理数据，exporter用于将数据发送到后端。上述例子中，receiver使用otlp协议接收数据，processor使用batch进行批量处理，exporter将数据发送到OpenObserve。</p><p>使用下列配置通过Docker Compose启动OpenTelemetry Collector服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>otel-collector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>otel/opentelemetry-collector-contrib:0.114.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/lib/docker/containers:/var/lib/docker/containers:ro</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/log/containers:/var/log/containers:ro</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      <span style=color:#75715e># - 1888:1888 # pprof extension</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># - 18888:8888 # Prometheus metrics exposed by the Collector</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># - 18889:8889 # Prometheus exporter metrics</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># - 13133:13133 # health_check extension</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>4317</span>:<span style=color:#ae81ff>4317</span> <span style=color:#75715e># OTLP gRPC receiver</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>4318</span>:<span style=color:#ae81ff>4318</span> <span style=color:#75715e># OTLP http receiver</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># - 55679:55679 # zpages extension</span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>data</span>:
</span></span></code></pre></div><p>此时，OpenTelemetry Collector和OpenObserve服务已经启动，可以进行下一步。</p><h3 id=go代码埋点>Go代码埋点</h3><p>下面演示了一个Gin开发的Web服务器，访问主服务器的 <code>/hello</code> 路径时，会请求go协程启动的HTTP服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;io&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/contrib/bridges/otelzap&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel/attribute&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel/exporters/otlp/otlplog/otlploggrpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel/exporters/otlp/otlpmetric/otlpmetricgrpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel/log/global&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel/metric&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel/sdk/log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sdkmetric</span> <span style=color:#e6db74>&#34;go.opentelemetry.io/otel/sdk/metric&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel/sdk/resource&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sdktrace</span> <span style=color:#e6db74>&#34;go.opentelemetry.io/otel/sdk/trace&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>semconv</span> <span style=color:#e6db74>&#34;go.opentelemetry.io/otel/semconv/v1.21.0&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.opentelemetry.io/otel/trace&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;go.uber.org/zap&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;google.golang.org/grpc/credentials/insecure&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>initProvider</span>() (<span style=color:#66d9ef>func</span>(), <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>WithAttributes</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>semconv</span>.<span style=color:#a6e22e>ServiceName</span>(<span style=color:#e6db74>&#34;my-service&#34;</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>semconv</span>.<span style=color:#a6e22e>ServiceVersion</span>(<span style=color:#e6db74>&#34;1.0.0&#34;</span>),
</span></span><span style=display:flex><span>		),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#e6db74>&#34;127.0.0.1:4317&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithTransportCredentials</span>(<span style=color:#a6e22e>insecure</span>.<span style=color:#a6e22e>NewCredentials</span>()),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithBlock</span>(),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置 trace exporter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>traceExporter</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>otlptracegrpc</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>otlptracegrpc</span>.<span style=color:#a6e22e>WithGRPCConn</span>(<span style=color:#a6e22e>conn</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置 trace provider
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tracerProvider</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sdktrace</span>.<span style=color:#a6e22e>NewTracerProvider</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sdktrace</span>.<span style=color:#a6e22e>WithBatcher</span>(<span style=color:#a6e22e>traceExporter</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sdktrace</span>.<span style=color:#a6e22e>WithResource</span>(<span style=color:#a6e22e>res</span>),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>otel</span>.<span style=color:#a6e22e>SetTracerProvider</span>(<span style=color:#a6e22e>tracerProvider</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置 metric exporter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>metricExporter</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>otlpmetricgrpc</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>otlpmetricgrpc</span>.<span style=color:#a6e22e>WithGRPCConn</span>(<span style=color:#a6e22e>conn</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置 metric provider
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>metricProvider</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sdkmetric</span>.<span style=color:#a6e22e>NewMeterProvider</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sdkmetric</span>.<span style=color:#a6e22e>WithResource</span>(<span style=color:#a6e22e>res</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sdkmetric</span>.<span style=color:#a6e22e>WithReader</span>(<span style=color:#a6e22e>sdkmetric</span>.<span style=color:#a6e22e>NewPeriodicReader</span>(<span style=color:#a6e22e>metricExporter</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sdkmetric</span>.<span style=color:#a6e22e>WithInterval</span>(<span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>))),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>otel</span>.<span style=color:#a6e22e>SetMeterProvider</span>(<span style=color:#a6e22e>metricProvider</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置log exporter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>logExporter</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>otlploggrpc</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>otlploggrpc</span>.<span style=color:#a6e22e>WithGRPCConn</span>(<span style=color:#a6e22e>conn</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>processor</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>NewBatchProcessor</span>(<span style=color:#a6e22e>logExporter</span>, <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithExportMaxBatchSize</span>(<span style=color:#ae81ff>10</span>))
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>logProvider</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>NewLoggerProvider</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithResource</span>(<span style=color:#a6e22e>res</span>),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>WithProcessor</span>(<span style=color:#a6e22e>processor</span>),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>global</span>.<span style=color:#a6e22e>SetLoggerProvider</span>(<span style=color:#a6e22e>logProvider</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tracerProvider</span>.<span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>metricProvider</span>.<span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>logProvider</span>.<span style=color:#a6e22e>Shutdown</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>metricsMiddleware</span>() <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>meter</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>otel</span>.<span style=color:#a6e22e>GetMeterProvider</span>().<span style=color:#a6e22e>Meter</span>(<span style=color:#e6db74>&#34;http_server&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建延迟直方图
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>latencyHist</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>meter</span>.<span style=color:#a6e22e>Float64Histogram</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;http_server_request_duration_seconds&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>WithDescription</span>(<span style=color:#e6db74>&#34;HTTP request duration in seconds&#34;</span>),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建请求计数器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>requestCount</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>meter</span>.<span style=color:#a6e22e>Int64Counter</span>(
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;http_server_requests_total&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>WithDescription</span>(<span style=color:#e6db74>&#34;Total number of HTTP requests&#34;</span>),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Next</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>duration</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>start</span>).<span style=color:#a6e22e>Seconds</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 通用标签
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>attrs</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>attribute</span>.<span style=color:#a6e22e>KeyValue</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>attribute</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;method&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Method</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>attribute</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>FullPath</span>()),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>attribute</span>.<span style=color:#a6e22e>Int</span>(<span style=color:#e6db74>&#34;status&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Writer</span>.<span style=color:#a6e22e>Status</span>()),
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 记录指标，使用正确的 API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>latencyHist</span>.<span style=color:#a6e22e>Record</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#a6e22e>duration</span>, <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>WithAttributes</span>(<span style=color:#a6e22e>attrs</span><span style=color:#f92672>...</span>))
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>requestCount</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>metric</span>.<span style=color:#a6e22e>WithAttributes</span>(<span style=color:#a6e22e>attrs</span><span style=color:#f92672>...</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newTracedServer</span>(<span style=color:#a6e22e>httpClient</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>sugar</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>SugaredLogger</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Engine</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 为内部服务创建新的 resource
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>res</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>WithAttributes</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>semconv</span>.<span style=color:#a6e22e>ServiceName</span>(<span style=color:#e6db74>&#34;helloservice&#34;</span>),
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>semconv</span>.<span style=color:#a6e22e>ServiceVersion</span>(<span style=color:#e6db74>&#34;1.0.0&#34;</span>),
</span></span><span style=display:flex><span>		),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to create resource&#34;</span>, <span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 为内部服务创建新的 TracerProvider
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>tracerProvider</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sdktrace</span>.<span style=color:#a6e22e>NewTracerProvider</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sdktrace</span>.<span style=color:#a6e22e>WithResource</span>(<span style=color:#a6e22e>res</span>),
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Recovery</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 使用新的 TracerProvider 创建 handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>handler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>otelhttp</span>.<span style=color:#a6e22e>NewHandler</span>(
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span> = <span style=color:#a6e22e>r</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Next</span>()
</span></span><span style=display:flex><span>			}),
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;helloservice.http&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>otelhttp</span>.<span style=color:#a6e22e>WithTracerProvider</span>(<span style=color:#a6e22e>tracerProvider</span>),
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Writer</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/hello&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 从请求中获取 trace context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 创建 GitHub API 请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequestWithContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;https://api.github.com&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to create request&#34;</span>, <span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httpClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to send request&#34;</span>, <span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 读取响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to read response&#34;</span>, <span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>respBody</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>body</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>respBody</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to unmarshal response&#34;</span>, <span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>respBody</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>r</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cleanup</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>initProvider</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cleanup</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建 OTLP core
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>logProvider</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>global</span>.<span style=color:#a6e22e>GetLoggerProvider</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>logger</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>otelzap</span>.<span style=color:#a6e22e>NewCore</span>(<span style=color:#e6db74>&#34;my/pkg/name&#34;</span>, <span style=color:#a6e22e>otelzap</span>.<span style=color:#a6e22e>WithLoggerProvider</span>(<span style=color:#a6e22e>logProvider</span>)))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Sync</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sugar</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>Sugar</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 创建带有 trace 的 HTTP 客户端
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>httpClient</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Client</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Transport</span>: <span style=color:#a6e22e>otelhttp</span>.<span style=color:#a6e22e>NewTransport</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>DefaultTransport</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 启动内部服务器（18080端口）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>internalServer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>newTracedServer</span>(<span style=color:#a6e22e>httpClient</span>, <span style=color:#a6e22e>sugar</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>internalServer</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;:18080&#34;</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;internal server failed&#34;</span>, <span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 主服务器配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>SetMode</span>(<span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>ReleaseMode</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Use</span>(<span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Recovery</span>(), <span style=color:#a6e22e>metricsMiddleware</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/ping&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;pong&#34;</span>,
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Infow</span>(<span style=color:#e6db74>&#34;ping&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;url&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>URL</span>.<span style=color:#a6e22e>String</span>(),
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;method&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Method</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;ip&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>ClientIP</span>(),
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;user-agent&#34;</span>, <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>UserAgent</span>(),
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;resp&#34;</span>, <span style=color:#a6e22e>resp</span>,
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>, <span style=color:#a6e22e>resp</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/github&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 从 gin.Context 获取 trace context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 创建新的请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequestWithContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;https://api.github.com&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to create request&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 发送请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httpClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to send request&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 读取响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to read response&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>respBody</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>body</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>respBody</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to unmarshal response&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 记录日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Infow</span>(<span style=color:#e6db74>&#34;github api request&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>zap</span>.<span style=color:#a6e22e>Any</span>(<span style=color:#e6db74>&#34;resp&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{<span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#ae81ff>500</span>)}),
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 返回响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span>, <span style=color:#a6e22e>respBody</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 添加 /trace 路由
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GET</span>(<span style=color:#e6db74>&#34;/trace&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>c</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>Context</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Request</span>.<span style=color:#a6e22e>Context</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 获取 trace ID 用于日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>traceID</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>spanCtx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>SpanContextFromContext</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>spanCtx</span>.<span style=color:#a6e22e>IsValid</span>() {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>traceID</span> = <span style=color:#a6e22e>spanCtx</span>.<span style=color:#a6e22e>TraceID</span>().<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>otel</span>.<span style=color:#a6e22e>Tracer</span>(<span style=color:#e6db74>&#34;time-consuming-operation&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>span</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tr</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;sleep-operation&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>End</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>NewRequestWithContext</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;GET&#34;</span>, <span style=color:#e6db74>&#34;http://localhost:18080/hello&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to create request&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;trace_id&#34;</span>, <span style=color:#a6e22e>traceID</span>,
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>httpClient</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to send request&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;trace_id&#34;</span>, <span style=color:#a6e22e>traceID</span>,
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to read response&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;trace_id&#34;</span>, <span style=color:#a6e22e>traceID</span>,
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>respBody</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>body</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>respBody</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Errorw</span>(<span style=color:#e6db74>&#34;failed to unmarshal response&#34;</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;error&#34;</span>, <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;trace_id&#34;</span>, <span style=color:#a6e22e>traceID</span>,
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>, <span style=color:#a6e22e>gin</span>.<span style=color:#a6e22e>H</span>{<span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>()})
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 记录成功日志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>sugar</span>.<span style=color:#a6e22e>Infow</span>(<span style=color:#e6db74>&#34;trace request completed&#34;</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;trace_id&#34;</span>, <span style=color:#a6e22e>traceID</span>,
</span></span><span style=display:flex><span>			<span style=color:#e6db74>&#34;status&#34;</span>, <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span>,
</span></span><span style=display:flex><span>		)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 设置响应头
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>traceID</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Header</span>(<span style=color:#e6db74>&#34;X-Trace-ID&#34;</span>, <span style=color:#a6e22e>traceID</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>JSON</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>StatusCode</span>, <span style=color:#a6e22e>respBody</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;start server&#34;</span>)
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=总结>总结</h2><p>本文详细介绍了OpenTelemetry在Go服务中的实践应用。通过可观测性的三大支柱（Metrics、Traces和Logs），我们可以全方位监控和了解分布式系统的运行状态。OpenTelemetry作为一个统一的可观测性框架，不仅提供了标准化的数据收集方式，还支持多种后端存储方案。</p><p>在实践部分，我们通过一个完整的示例展示了：</p><ol><li>如何搭建本地OpenObserve和OpenTelemetry Collector环境</li><li>如何在Go服务中初始化OpenTelemetry的各个组件</li><li>如何使用中间件收集HTTP请求的指标</li><li>如何在分布式系统中进行链路追踪</li><li>如何集成结构化日志</li></ol><p>通过这些实践，我们可以构建一个具有完整可观测性的现代分布式系统，为系统的监控、调试和优化提供有力支持。</p><h2 id=参考链接>参考链接</h2><ul><li><a href=https://opentelemetry.io/docs/ target=_blank rel=noopener>OpenTelemetry官方文档</a></li><li><a href=https://github.com/open-telemetry/opentelemetry-go target=_blank rel=noopener>OpenTelemetry Go SDK</a></li><li><a href=https://openobserve.ai/docs/ target=_blank rel=noopener>OpenObserve文档</a></li><li><a href=https://gin-gonic.com/ target=_blank rel=noopener>Gin Web Framework</a></li><li><a href=https://opentelemetry.io/docs/collector/ target=_blank rel=noopener>OpenTelemetry Collector</a></li><li><a href=https://github.com/uber-go/zap target=_blank rel=noopener>Zap Logger</a></li></ul><div class=blog-footer><div class=social-share></div><div class=copyright><ul><li style=margin-bottom:.5em>本文作者: <a href=https://ddhigh.com/ target=_blank style=color:#000;text-decoration:none>xialeistudio</a></li><li style=margin-bottom:.5em>本文链接: <a href=https://www.ddhigh.com/2024/12/02/opentelemetry-getstarted/ target=_blank style=color:#000;text-decoration:none>OpenTelemetry上手指南</a></li><li>版权声明: <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank style=color:#000;text-decoration:none>「署名-非商业性使用-相同方式共享 4.0 国际」</a></li></ul></div><div style=margin-top:2rem><img src=/img/mp.png alt=qrcode></div></div></section><div class=paginator><a class=prev href=https://www.ddhigh.com/2025/02/12/the-evolution-of-service-architecture/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>服务架构的演进历史</span></a>
<a class=next href=https://www.ddhigh.com/2024/08/22/build-a-weather-query-agent/><span>构建一个天气查询Agent</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","xialeistudio/discussion"),s.setAttribute("data-repo-id","R_kgDOKurTRA"),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOKurTRM4CbCJt"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2014 - 2025 <a href=https://www.ddhigh.com>每天进步一点点</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js integrity="sha512-9DNXrSjk17bU9MUbRp3IjwcWe46V8FaGA062PFbryPUAEQVRbz4jiZP6FW0AdbqEGtMYBDWnul3eiGBMJOQajA==" crossorigin=anonymous referrerpolicy=no-referrer></script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>