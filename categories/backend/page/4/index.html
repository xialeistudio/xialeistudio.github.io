<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><meta><title>Kategorie: backend - Learning &amp; Sharing</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Learning &amp; Sharing"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Learning &amp; Sharing"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Learning &amp;amp; Sharing"><meta property="og:type" content="website"><meta property="og:title" content="Learning &amp; Sharing"><meta property="og:url" content="https://www.ddhigh.com/"><meta property="og:site_name" content="Learning &amp; Sharing"><meta property="og:description" content="Learning &amp;amp; Sharing"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.ddhigh.com/img/og_image.png"><meta property="article:author" content="Xia Lei"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://www.ddhigh.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com"},"headline":"Learning & Sharing","image":["https://www.ddhigh.com/img/og_image.png"],"author":{"@type":"Person","name":"Xia Lei"},"publisher":{"@type":"Organization","name":"Learning & Sharing","logo":{"@type":"ImageObject","url":{"text":"Learning & Sharing"}}},"description":"Learning &amp; Sharing"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.4.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?78141f99bbb49f1564a7af89344f5add";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Learning &amp; Sharing</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Suche" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">Kategorien</a></li><li class="is-active"><a href="#" aria-current="page">backend</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2021-02-25T03:13:02.000Z" title="2/25/2021, 3:13:02 AM">2021-02-25</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/go/">go</a></span><span class="level-item">21 minutes lesen (Über 3133 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/25/2021-02-25-golang-get-started.html">Go语言程序设计</a></p><div class="content"><h2 id="Go语言概述"><a href="#Go语言概述" class="headerlink" title="Go语言概述"></a>Go语言概述</h2><h3 id="语言历史"><a href="#语言历史" class="headerlink" title="语言历史"></a>语言历史</h3><p>Go语言也称为Golang，是由Google公司开发的一种静态强类型、编译型、语言原生支持并发、具有垃圾回收功能的编程语言。起源于2007年，并在2009年正式对外发布。Go语言是非常年轻的一门语言，它的主要目标是“兼具 Python 等动态语言的开发速度和 C&#x2F;C++等编译型语言的性能与安全性”。</p>
<p>Go语言是编程语言设计的又一次尝试，是对类C语言的重大改进，它不但能让你访问底层操作系统，还提供了强大的网络编程和并发编程支持。Go语言的用途众多，可以进行网络编程、系统编程、并发编程等等。</p>
<p>Go语言的推出，旨在不损失应用程序性能的情况下降低代码的复杂性，具有“部署简单、并发性好、语言设计良好、执行性能好”等优势。</p>
<p>Go语言有时候被描述为“21世纪的C语言”。Go 从C语言继承了相似的表达式语法、控制流结构、基础数据类型、调用参数传值、指针等很多思想，还有C语言编译后的运行效率。</p>
<p>Go语言没有类和继承的概念，通过组合来实现代码复用，同时它通过接口（interface）的概念来实现多态性。所以Go语言的面向对象编程和传统面向对象语言（如C++和Java）并不相同。</p>
<p>Go语言有一个吉祥物，在会议、文档页面和博文中，大多会包含下图所示的 Go Gopher，这是才华横溢的插画家 Renee French 设计的，她也是 Go 设计者之一 Rob Pike 的妻子。</p>
<p><img src="https://static.ddhigh.com/blog/2021-02-25-111457-2.jpg" alt="img"></p>
<h3 id="语言特性"><a href="#语言特性" class="headerlink" title="语言特性"></a>语言特性</h3><p><strong>语法简单</strong></p>
<p>Go语言的设计思想类似Unix的“少即是多”。Go语言的语法规则严谨，没有歧义，这使得Go语言简单易学。Go语言保留了指针，但通常情况下禁止指针运算（保留unsafe包操作指针的能力）。此外，Go语言还内置切片和字典，在保留运行性能的同时也提高了开发效率。</p>
<p><strong>语言级别支持并发</strong></p>
<p>主流的并发模型有多进程模型、多线程模型。和主流多并发模型不同，Go语言采用了基于CSP的协程实现，并且在运行时做了更深度的优化处理。这使得语言级别上并发编程变得极为容易，无须处理回调、也无需关注线程切换，只需要添加一个go关键字即可。</p>
<p>“通过通信去共享内存，而不是通过共享内存去通信”，go语言内置的channel数据结构配合go关键字实现并发通信及控制，这对于需要考虑内存可见性等问题的多线程模型来说，是一个良好的解决方案。</p>
<p><strong>高效的垃圾回收</strong></p>
<p>Go语言的每次升级，垃圾回收器必然是核心组件里修改最多的部分。从并发清理，到降低STW时间，直到Go的1.5版本实现并发标记，逐步引入三色标记和写屏障等等，都是为了能让垃圾回收在不影响用户逻辑的情况下更好地工作。从最开始的秒级别STW到目前的微秒级STW，Go语言开发团队一直在垃圾回收方面进行努力。</p>
<p><strong>静态链接</strong></p>
<p>静态编译的好处显而易见。将运行时、依赖库直接打包到可执行文件内部，简化了部署和发布操作，无须事先安装运行环境和下载诸多第三方库。虽然相比动态编译增加了可执行文件的大小，但是省去了依赖库的管理。随着微服务和容器化的发展，这也成为了Go语言的杀手锏之一，一个二进制文件即可运行服务。</p>
<p><strong>标准库</strong></p>
<p>功能完善、质量可靠的标准库为编程语言提供了有力的支持。在不借助第三方扩展的情况下，就可完成大部分基础功能开发，这大大降低了学习和使用成本。</p>
<p>Go语言标准库可以说极为丰富。其中值得称道的是net&#x2F;http，仅须简单几条语句就能实现一个高性能 Web Server。</p>
<p><strong>工具链</strong></p>
<p>完整的工具链对于项目开发极为重要。Go语言在此做得相当不错，无论是编译、格式化、错误检查、帮助文档，还是第三方包下载、更新都有对应的工具。</p>
<p>值得一提的gofmt工具，为了解决开发者经常遇到的“代码风格不统一”的难题，官方直接通过gofmt指定一套标准，可以看出go语言在工程方面确实解决了许多实际问题。</p>
<p>此外Go语言内置完整测试框架，其中包括单元测试、性能测试、代码覆盖率、数据竞争，以及用来调优的pprof，这些都是保障代码能正确而稳定运行的必备利器。</p>
<h3 id="Go语言应用场景"><a href="#Go语言应用场景" class="headerlink" title="Go语言应用场景"></a>Go语言应用场景</h3><p>Go 语言从发布1.0版本以来备受众多开发者关注并得到广泛使用，Go 语言的简单、高效、并发特性吸引了众多传统语言开发者的加入，而且人数越来越多。</p>
<p>鉴于Go语言的特点和设计的初衷，Go语言作为服务器编程语言，很适合处理日志、数据打包、虚拟机处理、文件系统、分布式系统、数据库代理等；网络编程方面，Go语言广泛应用于Web应用、API应用、下载应用等；除此之外，Go语言还适用于内存数据库和云平台领域，目前国外很多云平台都是采用Go开发。</p>
<ul>
<li><p>服务器编程。例如处理日志、数据打包、虚拟机处理、文件系统等。</p>
</li>
<li><p>分布式系统、数据库代理器、中间件等。例如Etcd。</p>
</li>
<li><p>网络编程。这一块目前应用最广，包括Web应用、API应用、下载应用等等。</p>
</li>
<li><p>开发云平台。目前国内外很多云平台在采用Go开发。</p>
</li>
</ul>
<h3 id="Go语言知名项目"><a href="#Go语言知名项目" class="headerlink" title="Go语言知名项目"></a>Go语言知名项目</h3><p>Go发布之后，很多公司特别是云计算公司开始用Go重构他们的基础架构，很多基础设施都是直接采用Go进行了开发，诞生了许多热门项目。</p>
<p><strong>基础设施</strong></p>
<p>代表项目：docker、kubernetes、etcd、consul等。</p>
<p><strong>数据库</strong></p>
<p>代表项目：influxdb、cockroachdb等。</p>
<p><strong>微服务</strong></p>
<p>代表项目：go-kit、micro、kratos等。</p>
<h2 id="安装Go语言"><a href="#安装Go语言" class="headerlink" title="安装Go语言"></a>安装Go语言</h2><p>Go语言可用于FreeBSD、Linux、Windows和macOS等操作系统。有关对这些平台的要求，请参与Go语言网站列出的系统需求。</p>
<p>Go语言的官方网站为<a target="_blank" rel="noopener" href="https://golang.org/%EF%BC%8C%E5%9B%BD%E5%86%85%E7%9A%84%E7%94%A8%E6%88%B7%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AEhttps://golang.google.cn/dl/%E3%80%82%E9%80%9A%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E6%8C%89%E7%85%A7%E6%9C%AC%E6%96%87%E7%9A%84%E6%AD%A5%E9%AA%A4%E8%BF%9B%E8%A1%8C%E5%AE%89%E8%A3%85%E4%B8%8D%E4%BC%9A%E5%87%BA%E7%8E%B0%E9%97%AE%E9%A2%98%EF%BC%8C%E9%81%87%E5%88%B0%E5%AE%89%E8%A3%85%E9%97%AE%E9%A2%98%E7%9A%84%E8%AF%BB%E8%80%85%EF%BC%8C%E8%AF%B7%E9%80%9A%E8%BF%87%E5%85%AC%E4%BC%97%E5%8F%B7%E4%B8%8E%E6%88%91%E8%81%94%E7%B3%BB%E3%80%82">https://golang.org/，国内的用户可以访问https://golang.google.cn/dl/。通常情况下，按照本文的步骤进行安装不会出现问题，遇到安装问题的读者，请通过公众号与我联系。</a></p>
<h3 id="Windows系统"><a href="#Windows系统" class="headerlink" title="Windows系统"></a>Windows系统</h3><p><strong>下载链接</strong></p>
<ul>
<li><p>32位下载地址：<a target="_blank" rel="noopener" href="https://golang.google.cn/dl/go1.15.8.windows-386.msi">https://golang.google.cn/dl/go1.15.8.windows-386.msi</a></p>
</li>
<li><p>64位下载地址：<a target="_blank" rel="noopener" href="https://golang.google.cn/dl/go1.15.8.windows-amd64.msi">https://golang.google.cn/dl/go1.15.8.windows-amd64.msi</a></p>
</li>
</ul>
<p>默认安装到C:\go目录下，建议不要更改安装目录。</p>
<p><strong>GOPATH配置</strong></p>
<p>安装完毕后需要配置GOPATH，GOPATH是Go语言用来存放第三方源码、二进制文件、类库等文件的路径。</p>
<ol>
<li>例如系统用户名为demo，则需要新建以下三个目录：</li>
</ol>
<ul>
<li><p>C:\Users\demo\go\src 存放源码</p>
</li>
<li><p>C:\Users\demo\go\pkg 存放类库</p>
</li>
<li><p>C:\Users\demo\go\bin 存在二进制文件</p>
</li>
</ul>
<ol start="2">
<li>环境变量设置：</li>
</ol>
<ul>
<li><p>新增GOPATH，值为C:\Users\demo\go</p>
</li>
<li><p>新增PATH（已存在则编辑），值为C:\Users\demo\go\bin</p>
</li>
</ul>
<h3 id="Linux系统"><a href="#Linux系统" class="headerlink" title="Linux系统"></a>Linux系统</h3><p>Linux具有众多发行版，如Ubuntu、CentOS、RedHat、Debian等等，所有发行版的安装步骤是一致的，区别是根据CPU架构选择不同的发布包。</p>
<p>常见的个人计算机CPU架构为amd64，下载amd64架构的发布包即可。</p>
<p><strong>Linux配置命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载压缩包</span></span><br><span class="line">wget https://golang.google.cn/dl/go1.15.8.linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># 移动到opt目录</span></span><br><span class="line"><span class="built_in">mv</span> go1.15.8.linux-amd64.tar.gz /opt</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">tar xf go1.15.8.linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># 新建GOPATH目录</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line"><span class="built_in">mkdir</span> go</span><br><span class="line"><span class="built_in">cd</span> go</span><br><span class="line"><span class="built_in">mkdir</span> pkg src bin</span><br><span class="line"><span class="comment"># 编辑 ~/.bashrc文件, 添加bin路径到PATH环境变量中</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;GOPATH=用户主目录/go&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;PATH=/opt/go/bin:$GOPATH/bin:$PATH&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="comment"># 更新环境变量</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="comment"># 测试安装结果</span></span><br><span class="line">go version</span><br></pre></td></tr></table></figure>

<h3 id="macOS系统"><a href="#macOS系统" class="headerlink" title="macOS系统"></a>macOS系统</h3><p>Apple公司于2020年发布了采用M1芯片(arm64架构)的硬件产品，支持M1芯片的Go语言版本为1.16，根据CPU架构选择对应的pkg包安装即可。</p>
<ul>
<li><p>amd64: <a target="_blank" rel="noopener" href="https://golang.google.cn/dl/go1.15.8.darwin-amd64.pkg">https://golang.google.cn/dl/go1.15.8.darwin-amd64.pkg</a></p>
</li>
<li><p>arm64: <a target="_blank" rel="noopener" href="https://golang.google.cn/dl/go1.16.darwin-arm64.pkg">https://golang.google.cn/dl/go1.16.darwin-arm64.pkg</a></p>
</li>
</ul>
<p><strong>macOS配置命令</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新建GOPATH目录</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line"><span class="built_in">mkdir</span> go</span><br><span class="line"><span class="built_in">cd</span> go</span><br><span class="line"><span class="built_in">mkdir</span> pkg src bin</span><br><span class="line"><span class="comment"># 编辑 ~/.bashrc文件, 添加bin路径到PATH环境变量中</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;GOPATH=用户主目录/go&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;PATH=$GOPATH/bin:$PATH&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="comment"># 更新环境变量</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="comment"># 测试安装结果</span></span><br><span class="line">go version</span><br></pre></td></tr></table></figure>

<h2 id="配置集成开发环境"><a href="#配置集成开发环境" class="headerlink" title="配置集成开发环境"></a>配置集成开发环境</h2><p>本节将介绍如何在本地计算机上配置集成开发环境，以下步骤使用macOS版本作为示例，其他操作系统类似。</p>
<p>Visual Studio Code(简称VSCode)是由微软开发的、同时支持Windows、Linux和macOS操作系统的开源编辑器，它支持测试，并且内置了git功能，提供了丰富的语言支持与常用编程工具。</p>
<ol>
<li><p>打开官方网站 <a target="_blank" rel="noopener" href="https://code.visualstudio.com/%EF%BC%8C%E7%82%B9%E5%87%BB%E8%93%9D%E8%89%B2%E6%8C%89%E9%92%AE%E4%B8%8B%E8%BD%BD%E5%8D%B3%E5%8F%AF%E3%80%82">https://code.visualstudio.com/，点击蓝色按钮下载即可。</a></p>
</li>
<li><p>新版本的VSCode不再内置中文语言包，需要安装语言包扩展。安装VSCode后打开VSCode编辑器，在扩展窗口中搜索“Chinese”，安装第一个即可。</p>
</li>
</ol>
<p><img src="https://static.ddhigh.com/blog/2021-02-25-111457-2.png" alt="image-20191022102923920"></p>
<ol start="3">
<li>用VSCode新建一个空项目，打开项目之后新建main.go，此时VSCode右下角会弹出Go工具链安装的提示，选择”Install All“即可。</li>
</ol>
<h2 id="编写HTTP服务器"><a href="#编写HTTP服务器" class="headerlink" title="编写HTTP服务器"></a>编写HTTP服务器</h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		io.WriteString(w, <span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">	http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="程序结构说明"><a href="#程序结构说明" class="headerlink" title="程序结构说明"></a>程序结构说明</h3><ul>
<li>package 关键字声明文件所在的包，每个go文件都必须声明。每个可执行程序都必须包含main包，程序的入口点为main包的func main函数</li>
<li>import 关键字声明需要导入的包，代码中需要使用http服务器相关方法，因此导入了http包</li>
<li>func main程序的入口点</li>
</ul>
<h3 id="编译并运行程序"><a href="#编译并运行程序" class="headerlink" title="编译并运行程序"></a>编译并运行程序</h3><p>编译并运行文件是开发过程中的一个常见步骤，Go提供了完成这个步骤的快捷途径。</p>
<p>Go语言提供了build和run两个命令来编译运行Go程序：</p>
<ul>
<li>go build 会编译可执行文件，并不执行</li>
<li>go run 不会创建可执行文件，直接执行</li>
</ul>
<p>使用go run运行HTTP服务器，之后通过浏览器打开即可。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文介绍了Go语言的安装以及集成开发环境的配置。通过HTTP服务器演示了Go程序的开发过程。</p>
<p>下一章将学习Go语言的基本语法：</p>
<ul>
<li>变量和常量</li>
<li>数据类型</li>
<li>运算符</li>
<li>条件语句</li>
<li>循环语句</li>
</ul>
<p><img src="https://static.ddhigh.com/blog/2021-02-26-161953-2.png" alt="img"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2021-02-06T12:27:14.000Z" title="2/6/2021, 12:27:14 PM">2021-02-06</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/go/">go</a></span><span class="level-item">17 minutes lesen (Über 2577 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/06/2021-02-06-go-wire-tutorial.html">golang依赖注入工具wire指南</a></p><div class="content"><h2 id="wire与依赖注入"><a href="#wire与依赖注入" class="headerlink" title="wire与依赖注入"></a>wire与依赖注入</h2><p><a target="_blank" rel="noopener" href="https://github.com/google/wire">Wire</a> 是一个的Golang依赖注入工具，通过自动生成代码的方式在<strong>编译期</strong>完成依赖注入，Java体系中最出名的<strong>Spring</strong>框架采用<strong>运行时</strong>注入，个人认为这是wire和其他依赖注入最大的不同之处。</p>
<p>依赖注入(Dependency Injection)也称作控制反转(Inversion of Control)，个人给控制反转下的定义如下：</p>
<blockquote>
<p>当前对象需要的依赖对象由外部提供（通常是IoC容器），外部负责依赖对象的构造等操作，当前对象只负责调用，而不关心依赖对象的构造。即依赖对象的控制权交给了IoC容器。</p>
</blockquote>
<p>下面给出一个控制反转的示例，比如我们通过配置去创建一个数据库连接：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 连接配置</span></span><br><span class="line"><span class="keyword">type</span> DatabaseConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    Dsn <span class="type">string</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDB</span><span class="params">(config *DatabaseConfig)</span></span>(*sql.DB, <span class="type">error</span>) &#123;</span><br><span class="line">    db,err := sql.Open(<span class="string">&quot;mysql&quot;</span>, config.Dsn)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun NewConfig()(*DatabaseConfig,<span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 读取配置文件</span></span><br><span class="line">    fp, err := os.Open(<span class="string">&quot;config.json&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> fp.Close()</span><br><span class="line">    <span class="comment">// 解析为Json</span></span><br><span class="line">    <span class="keyword">var</span> config DatabaseConfig</span><br><span class="line">    <span class="keyword">if</span> err:=json.NewDecoder(fp).Decode(&amp;config);err!=<span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;config, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitDatabase</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cfg, err:=NewConfig()</span><br><span class="line">    <span class="keyword">if</span> err!=<span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    db,err:=NewDB(cfg)</span><br><span class="line">    <span class="keyword">if</span> err!=<span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatail(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// db对象构造完毕</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据库配置怎么来的，<code>NewDB</code>方法并不关心(示例代码采用的是<code>NewConfig</code>提供的JSON配置对象)，<code>NewDB</code>只负责创建DB对象并返回，和配置方式并没有耦合，所以即使换成配置中心或者其他方式来提供配置，<code>NewDB</code>代码也无需更改，这就是控制反转的魔力！</p>
<p>来看一个反面例子，也就是控制正转：</p>
<blockquote>
<p>当前对象需要的依赖由自己创建，即依赖对象的控制权在当前对象自己手里。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DatabaseConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    Dsn <span class="type">string</span> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDB</span><span class="params">()</span></span>(*sql.DB, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 读取配置文件</span></span><br><span class="line">    fp, err := os.Open(<span class="string">&quot;config.json&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> fp.Close()</span><br><span class="line">    <span class="comment">// 解析为Json</span></span><br><span class="line">    <span class="keyword">var</span> config DatabaseConfig</span><br><span class="line">    <span class="keyword">if</span> err:=json.NewDecoder(fp).Decode(&amp;config);err!=<span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>,err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化数据库连接</span></span><br><span class="line">    db,err = sql.Open(<span class="string">&quot;mysql&quot;</span>, config.Dsn)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在控制正转模式下，<code>NewDB</code>方法需要自己实现配置对象的创建工作，在示例中需要读取Json配置文件，这是<strong>强耦合</strong>的代码，一旦配置文件的格式不是Json，<code>NewDB</code>方法将返回错误。</p>
<p>依赖注入固然好用，但是像刚才的例子中去手动管理依赖关系是相当复杂也是相当痛苦的一件事，因此在接下来的内容中会重点介绍golang的依赖注入工具——wire。</p>
<h2 id="上手使用"><a href="#上手使用" class="headerlink" title="上手使用"></a>上手使用</h2><p>通过<code>go get github.com/google/wire/cmd/wire</code>安装好<code>wire</code>命令行工具即可。</p>
<p>在正式开始之前需要介绍一下wire中的两个概念：<code>Provider</code>和<code>Injector</code>：</p>
<ul>
<li><code>Provider</code>：负责创建对象的方法，比如上文中<code>控制反转示例</code>的<code>NewDB</code>(提供DB对象)和<code>NewConfig</code>(提供DatabaseConfig对象)方法。</li>
<li><code>Injector</code>：负责根据对象的依赖，依次构造依赖对象，最终构造目的对象的方法，比如上文中<code>控制反转示例</code>的<code>InitDatabase</code>方法。</li>
</ul>
<p>现在我们通过<code>wire</code>来实现一个简单的项目。项目结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">|--cmd</span><br><span class="line">	|--main.go</span><br><span class="line">	|--wire.go</span><br><span class="line">|--config</span><br><span class="line">	|--app.json</span><br><span class="line">|--internal</span><br><span class="line">	|--config</span><br><span class="line">		|--config.go</span><br><span class="line">	|--db</span><br><span class="line">		|--db.go</span><br></pre></td></tr></table></figure>

<p>config&#x2F;app.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;database&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dsn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root:root@tcp(localhost:3306)/test&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>internal&#x2F;config&#x2F;config.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> config</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/google/wire&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Provider = wire.NewSet(New) <span class="comment">// 将New方法声明为Provider，表示New方法可以创建一个被别人依赖的对象,也就是Config对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">	Database database <span class="string">`json:&quot;database&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> database <span class="keyword">struct</span> &#123;</span><br><span class="line">	Dsn <span class="type">string</span> <span class="string">`json:&quot;dsn&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span></span> (*Config, <span class="type">error</span>) &#123;</span><br><span class="line">	fp, err := os.Open(<span class="string">&quot;config/app.json&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> fp.Close()</span><br><span class="line">	<span class="keyword">var</span> cfg Config</span><br><span class="line">	<span class="keyword">if</span> err := json.NewDecoder(fp).Decode(&amp;cfg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;cfg, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>internal&#x2F;db&#x2F;db.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line">	_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/google/wire&quot;</span></span><br><span class="line">	<span class="string">&quot;wire-example2/internal/config&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Provider = wire.NewSet(New) <span class="comment">// 同理</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(cfg *config.Config)</span></span> (db *sql.DB, err <span class="type">error</span>) &#123;</span><br><span class="line">	db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, cfg.Database.Dsn)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err = db.Ping(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> db, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cmd&#x2F;main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;database/sql&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> App <span class="keyword">struct</span> &#123; <span class="comment">// 最终需要的对象</span></span><br><span class="line">	db *sql.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewApp</span><span class="params">(db *sql.DB)</span></span> *App &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;App&#123;db: db&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	app, err := InitApp() <span class="comment">// 使用wire生成的injector方法获取app对象</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> version <span class="type">string</span></span><br><span class="line">	row := app.db.QueryRow(<span class="string">&quot;SELECT VERSION()&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err := row.Scan(&amp;version); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(version)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cmd&#x2F;wire.go</p>
<p>重点文件，也就是实现Injector的核心所在：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +build wireinject</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;github.com/google/wire&quot;</span></span><br><span class="line">	<span class="string">&quot;wire-example2/internal/config&quot;</span></span><br><span class="line">	<span class="string">&quot;wire-example2/internal/db&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitApp</span><span class="params">()</span></span> (*App, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="built_in">panic</span>(wire.Build(config.Provider, db.Provider, NewApp)) <span class="comment">// 调用wire.Build方法传入所有的依赖对象以及构建最终对象的函数得到目标对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件编写完毕，进入<code>cmd</code>目录执行<code>wire</code>命令会得到以下输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\GolandProjects\wire-example2\cmd&gt;wire</span><br><span class="line">wire: wire-example2/cmd: wrote C:\Users\Administrator\GolandProjects\wire-example2\cmd\wire_gen.go</span><br></pre></td></tr></table></figure>

<p>表明成功生成<code>wire_gen.go</code>文件，文件内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Code generated by Wire. DO NOT EDIT.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:generate go run github.com/google/wire/cmd/wire</span></span><br><span class="line"><span class="comment">//+build !wireinject</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;wire-example2/internal/config&quot;</span></span><br><span class="line">	<span class="string">&quot;wire-example2/internal/db&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Injectors from wire.go:</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitApp</span><span class="params">()</span></span> (*App, <span class="type">error</span>) &#123;</span><br><span class="line">	configConfig, err := config.New()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	sqlDB, err := db.New(configConfig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	app := NewApp(sqlDB)</span><br><span class="line">	<span class="keyword">return</span> app, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到生成App对象的代码已经自动生成了。</p>
<h3 id="Provider说明"><a href="#Provider说明" class="headerlink" title="Provider说明"></a>Provider说明</h3><p>通过<code>NewSet</code>方法将本包内创建对象的方法声明为<code>Provider</code>以供其他对象使用。<code>NewSet</code>可以接收多个参数，比如我们<code>db</code>包内可以创建Mysql和Redis连接对象，则可以如下声明：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Provider = wire.NewSet(NewDB, NewRedis)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDB</span><span class="params">(config *Config)</span></span>(*sql.DB,<span class="type">error</span>) &#123; <span class="comment">// 创建数据库对象</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRedis</span><span class="params">(config *Config)</span></span>(*redis.Client,<span class="type">error</span>) &#123; <span class="comment">// 创建Redis对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="wire-go文件说明"><a href="#wire-go文件说明" class="headerlink" title="wire.go文件说明"></a>wire.go文件说明</h3><p><code>wire.go</code>文件需要放在创建目标对象的地方，比如我们<code>Config</code>和<code>DB</code>对象最终是为<code>App</code>服务的，因此<code>wire.go</code>文件需要放在<code>App</code>所在的包内。</p>
<blockquote>
<p>wire.go文件名不是固定的，不过大家习惯叫这个文件名。</p>
</blockquote>
<p><code>wire.go</code>的第一行<code>// +build wireinject</code>是必须的，含义如下：</p>
<blockquote>
<p>只有添加了名称为”wireinject”的build tag，本文件才会编译，而我们go build main.go的时候通常不会加。因此，该文件不会参与最终编译。</p>
</blockquote>
<p><code>wire.Build(config.Provider, db.Provider, NewApp)</code>通过传入<code>config</code>以及<code>db</code>对象来创建最终需要的<code>App</code>对象</p>
<h3 id="wire-gen-go文件说明"><a href="#wire-gen-go文件说明" class="headerlink" title="wire_gen.go文件说明"></a>wire_gen.go文件说明</h3><p>该文件由<code>wire</code>自动生成，无需手工编辑！！！</p>
<p><code>//+build !wireinject</code>标签和<code>wire.go</code>文件的标签相对应，含义如下：</p>
<blockquote>
<p>编译时只有<strong>未添加</strong>“wireinject”的build tag，本文件才参与编译。</p>
</blockquote>
<p>因此，任意时刻下，<code>wire.go</code>和<code>wire_gen.go</code>只会有一个参与编译。</p>
<h2 id="高级玩法"><a href="#高级玩法" class="headerlink" title="高级玩法"></a>高级玩法</h2><h3 id="cleanup函数"><a href="#cleanup函数" class="headerlink" title="cleanup函数"></a>cleanup函数</h3><p>在创建依赖资源时，如果由某个资源创建失败，那么其他资源需要关闭的情况下，可以使用cleanup函数来关闭资源。比如咱们给<code>db.New</code>方法返回一个<code>cleanup</code>函数来关闭数据库连接，相关代码修改如下(未列出的代码不修改)：</p>
<p>internal&#x2F;db&#x2F;db.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(cfg *config.Config)</span></span> (db *sql.DB, cleanup <span class="function"><span class="keyword">func</span><span class="params">()</span></span>, err <span class="type">error</span>) &#123; <span class="comment">// 声明第二个返回值</span></span><br><span class="line">	db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, cfg.Database.Dsn)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err = db.Ping(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	cleanup = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// cleanup函数中关闭数据库连接</span></span><br><span class="line">		db.Close()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> db, cleanup, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cmd&#x2F;wire.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitApp</span><span class="params">()</span></span> (*App, <span class="function"><span class="keyword">func</span><span class="params">()</span></span>, <span class="type">error</span>) &#123; <span class="comment">// 声明第二个返回值</span></span><br><span class="line">	<span class="built_in">panic</span>(wire.Build(config.Provider, db.Provider, NewApp))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cmd&#x2F;main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	app, cleanup, err := InitApp() <span class="comment">// 添加第二个参数</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> cleanup() <span class="comment">// 延迟调用cleanup关闭资源</span></span><br><span class="line">	<span class="keyword">var</span> version <span class="type">string</span></span><br><span class="line">	row := app.db.QueryRow(<span class="string">&quot;SELECT VERSION()&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err := row.Scan(&amp;version); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(version)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新在cmd目录执行<code>wire</code>命令，生成的<code>wire_gen.go</code>如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitApp</span><span class="params">()</span></span> (*App, <span class="function"><span class="keyword">func</span><span class="params">()</span></span>, <span class="type">error</span>) &#123;</span><br><span class="line">	configConfig, err := config.New()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	sqlDB, cleanup, err := db.New(configConfig)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	app := NewApp(sqlDB)</span><br><span class="line">	<span class="keyword">return</span> app, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// 返回了清理函数</span></span><br><span class="line">		cleanup()</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="接口绑定"><a href="#接口绑定" class="headerlink" title="接口绑定"></a>接口绑定</h3><p>在面向接口编程中，代码依赖的往往是接口，而不是具体的struct，此时依赖注入相关代码需要做一点小小的修改，继续刚才的例子，示例修改如下：</p>
<p>新增<code>internal/db/dao.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> db</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;database/sql&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Dao <span class="keyword">interface</span> &#123; <span class="comment">// 接口声明</span></span><br><span class="line">	Version() (<span class="type">string</span>, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> dao <span class="keyword">struct</span> &#123; <span class="comment">// 默认实现</span></span><br><span class="line">	db *sql.DB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d dao)</span></span> Version() (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> version <span class="type">string</span></span><br><span class="line">	row := d.db.QueryRow(<span class="string">&quot;SELECT VERSION()&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err := row.Scan(&amp;version); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> version, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDao</span><span class="params">(db *sql.DB)</span></span> *dao &#123; <span class="comment">// 生成dao对象的方法</span></span><br><span class="line">	<span class="keyword">return</span> &amp;dao&#123;db: db&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>internal&#x2F;db&#x2F;db.go也需要修改Provider，增加<code>NewDao</code>声明:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Provider = wire.NewSet(New, NewDao)</span><br></pre></td></tr></table></figure>

<p>cmd&#x2F;main.go文件修改：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;wire-example2/internal/db&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> App <span class="keyword">struct</span> &#123;</span><br><span class="line">	dao db.Dao <span class="comment">// 依赖Dao接口</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewApp</span><span class="params">(dao db.Dao)</span></span> *App &#123; <span class="comment">// 依赖Dao接口</span></span><br><span class="line">	<span class="keyword">return</span> &amp;App&#123;dao: dao&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	app, cleanup, err := InitApp()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> cleanup()</span><br><span class="line">	version, err := app.dao.Version() <span class="comment">// 调用Dao接口方法</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(version)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入cmd目录执行<code>wire</code>命令，此时会出现报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\GolandProjects\wire-example2\cmd&gt;wire</span><br><span class="line">wire: C:\Users\Administrator\GolandProjects\wire-example2\cmd\wire.go:11:1: inject InitApp: no provider found for wire-example2/internal/db.Dao</span><br><span class="line">        needed by *wire-example2/cmd.App in provider &quot;NewApp&quot; (C:\Users\Administrator\GolandProjects\wire-example2\cmd\main.go:12:6)</span><br><span class="line">wire: wire-example2/cmd: generate failed</span><br><span class="line">wire: at least one generate failure</span><br></pre></td></tr></table></figure>

<p><code>wire</code>提示<code>inject InitApp: no provider found for wire-example2/internal/db.Dao</code>，也就是没找到能提供<code>db.Dao</code>对象的<code>Provider</code>，咱们不是提供了默认的<code>db.dao</code>实现也注册了<code>Provider</code>吗？这也是go的OOP设计奇特之处。</p>
<p>咱们修改一下<code>internal/db/db.go</code>的<code>Provider</code>声明，增加<code>db.*dao</code>和<code>db.Dao</code>的接口绑定关系:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Provider = wire.NewSet(New, NewDao, wire.Bind(<span class="built_in">new</span>(Dao), <span class="built_in">new</span>(*dao)))</span><br></pre></td></tr></table></figure>

<p><code>wire.Bind()</code>方法第一个参数为<code>interface&#123;&#125;</code>，第二个参数为<code>实现</code>。</p>
<p>此时再执行<code>wire</code>命令就可以成功了！</p>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p><code>wire</code>工具还有很多玩法，但是就笔者个人工作经验而言，掌握本文介绍到的知识已经能够胜任绝大部分场景了！</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2021-01-12T04:00:00.000Z" title="1/12/2021, 4:00:00 AM">2021-01-12</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/go/">go</a></span><span class="level-item">10 minutes lesen (Über 1499 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/12/2021-01-12-golang-halia-get-started.html">Golang组件化网络服务器框架Halia指南</a></p><div class="content"><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>在<strong>netty</strong>框架面世之前，几乎没有一个成熟的OOP&#x2F;组件化规范指导网络服务器开发，一些常用的<code>FrameDecoder</code>,<code>BusinessHandler</code>等等组件紧密耦合在了项目当中，整个项目可以说扩展性比较差。</p>
<p>netty的出现可以说是划时代的，基于OOP&#x2F;组件化屏蔽了底层 <strong>BlockingIO</strong>&#x2F;<strong>NonBlockingIO</strong>&#x2F;<strong>AsynchrousIO</strong>之间的差异，各种组件可以无缝切换，网络服务器开发效率有了非常大的提高。</p>
<p>通过阅读netty源码，以及核心组件的架构，基于Golang进行了实现，至此，Golang的Halia框架面世了！</p>
<h2 id="Halia特性"><a href="#Halia特性" class="headerlink" title="Halia特性"></a>Halia特性</h2><h3 id="组件化-x2F-可扩展"><a href="#组件化-x2F-可扩展" class="headerlink" title="组件化&#x2F;可扩展"></a>组件化&#x2F;可扩展</h3><p>Halia框架面向接口编程，并提供默认实现，同时内置常用的解码器，真正做到开箱即用。</p>
<h3 id="高性能"><a href="#高性能" class="headerlink" title="高性能"></a>高性能</h3><p>基于Golang原生网络库进行开发，无第三方依赖，性能有保障。</p>
<h3 id="易用性"><a href="#易用性" class="headerlink" title="易用性"></a>易用性</h3><p>Halia框架采用极简设计，没有冗余代码，并附带3个常用解码器示例，助您基于Halia快速开始开发。</p>
<h3 id="开源免费"><a href="#开源免费" class="headerlink" title="开源免费"></a>开源免费</h3><p>Halia框架基于MIT开源协议发布，无论是商用以及非商用都可以免费使用。</p>
<h3 id="社区驱动"><a href="#社区驱动" class="headerlink" title="社区驱动"></a>社区驱动</h3><p>Halia框架托管于Github，任何人都可以贡献一臂之力。</p>
<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><p>接下来将演示如何开发一个时间回显服务器。</p>
<p>客户端每隔1秒发送时间字符串给服务器，服务器回显该数据。</p>
<h3 id="公用代码"><a href="#公用代码" class="headerlink" title="公用代码"></a>公用代码</h3><h4 id="encoder-go"><a href="#encoder-go" class="headerlink" title="encoder.go"></a>encoder.go</h4><p>字符串编码器，将字符串转换为<code>[]byte</code>传输到下一个出站处理器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;halia/channel&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> StringToByteEncoder <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="comment">// 编码器不处理处理，交由下一个处理器(也就是业务处理器)处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *StringToByteEncoder)</span></span> OnError(c channel.HandlerContext, err <span class="type">error</span>) &#123;</span><br><span class="line">	c.FireOnError(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *StringToByteEncoder)</span></span> Write(c channel.HandlerContext, msg <span class="keyword">interface</span>&#123;&#125;) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> str, ok := msg.(<span class="type">string</span>); ok &#123; <span class="comment">// string才转换</span></span><br><span class="line">		<span class="keyword">return</span> c.Write([]<span class="type">byte</span>(str))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> c.Write(msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *StringToByteEncoder)</span></span> Flush(c channel.HandlerContext) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> c.Flush()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="客户端代码"><a href="#客户端代码" class="headerlink" title="客户端代码"></a>客户端代码</h3><h4 id="handler-go"><a href="#handler-go" class="headerlink" title="handler.go"></a>handler.go</h4><p>客户端业务处理代码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	log <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">	<span class="string">&quot;halia/channel&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> EchoClientHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">	log *log.Entry</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEchoClientHandler</span><span class="params">()</span></span> *EchoClientHandler &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;EchoClientHandler&#123;</span><br><span class="line">		log: log.WithField(<span class="string">&quot;component&quot;</span>, <span class="string">&quot;EchoClientHandler&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 发送错误回调</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *EchoClientHandler)</span></span> OnError(c channel.HandlerContext, err <span class="type">error</span>) &#123;</span><br><span class="line">	p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Warnln(<span class="string">&quot;error caught&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 连接已建立</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *EchoClientHandler)</span></span> ChannelActive(c channel.HandlerContext) &#123;</span><br><span class="line">	p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Infoln(<span class="string">&quot;connected&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := c.WriteAndFlush(<span class="string">&quot;Hello World\r\n&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		p.log.WithError(err).Warnln(<span class="string">&quot;write error&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	p.log.Infof(<span class="string">&quot;pipeline in: %v&quot;</span>, strings.Join(c.Pipeline().InboundNames(), <span class="string">&quot;-&gt;&quot;</span>))</span><br><span class="line">	p.log.Infof(<span class="string">&quot;pipeline out: %v&quot;</span>, strings.Join(c.Pipeline().OutboundNames(), <span class="string">&quot;-&gt;&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接已断开</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *EchoClientHandler)</span></span> ChannelInActive(c channel.HandlerContext) &#123;</span><br><span class="line">	p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Infoln(<span class="string">&quot;disconnected&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取到完整的消息回调</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *EchoClientHandler)</span></span> ChannelRead(c channel.HandlerContext, msg <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	data, ok := msg.([]<span class="type">byte</span>)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Warnf(<span class="string">&quot;unknown msg type: %+v&quot;</span>, msg)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	str := <span class="type">string</span>(data)</span><br><span class="line">	p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Infoln(<span class="string">&quot;receive &quot;</span>, str)</span><br><span class="line">    <span class="comment">// 1秒后发送数据给服务器</span></span><br><span class="line">	time.AfterFunc(time.Second, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := c.WriteAndFlush(fmt.Sprintf(<span class="string">&quot;client say:%s\r\n&quot;</span>, time.Now().String())); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			p.log.WithError(err).Warnln(<span class="string">&quot;write error&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	log <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">	<span class="string">&quot;halia/bootstrap&quot;</span></span><br><span class="line">	<span class="string">&quot;halia/channel&quot;</span></span><br><span class="line">	<span class="string">&quot;halia/handler/codec&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.SetOutput(os.Stdout)</span><br><span class="line">	log.SetLevel(log.DebugLevel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	client := bootstrap.NewClient(&amp;bootstrap.ClientOptions&#123;</span><br><span class="line">        <span class="comment">// 将原始net.Conn包装为Channel实现，一般情况下用DefaultChannel即可</span></span><br><span class="line">		ChannelFactory: <span class="function"><span class="keyword">func</span><span class="params">(conn net.Conn)</span></span> channel.Channel &#123;</span><br><span class="line">			c := channel.NewDefaultChannel(conn)</span><br><span class="line">            <span class="comment">// 添加解码器，换行符分割报文解码器</span></span><br><span class="line">			c.Pipeline().AddInbound(<span class="string">&quot;decoder&quot;</span>, codec.NewLineBasedFrameDecoder())</span><br><span class="line">            <span class="comment">// 添加业务处理器</span></span><br><span class="line">			c.Pipeline().AddInbound(<span class="string">&quot;handler&quot;</span>, NewEchoClientHandler())</span><br><span class="line">            <span class="comment">// 添加编码器</span></span><br><span class="line">			c.Pipeline().AddOutbound(<span class="string">&quot;encoder&quot;</span>, &amp;StringToByteEncoder&#123;&#125;)</span><br><span class="line">			<span class="keyword">return</span> c</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">// 连接服务器</span></span><br><span class="line">	log.WithField(<span class="string">&quot;component&quot;</span>, <span class="string">&quot;client&quot;</span>).Fatal(client.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:8080&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="服务端代码"><a href="#服务端代码" class="headerlink" title="服务端代码"></a>服务端代码</h3><h4 id="handler-go-1"><a href="#handler-go-1" class="headerlink" title="handler.go"></a>handler.go</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	log <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">	<span class="string">&quot;halia/channel&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> EchoServerHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">	log *log.Entry</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEchoServerHandler</span><span class="params">()</span></span> *EchoServerHandler &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;EchoServerHandler&#123;</span><br><span class="line">		log: log.WithField(<span class="string">&quot;component&quot;</span>, <span class="string">&quot;EchoServerHandler&quot;</span>),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *EchoServerHandler)</span></span> OnError(c channel.HandlerContext, err <span class="type">error</span>) &#123;</span><br><span class="line">	p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Warnln(<span class="string">&quot;error caught&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *EchoServerHandler)</span></span> ChannelActive(c channel.HandlerContext) &#123;</span><br><span class="line">	p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Infoln(<span class="string">&quot;connected&quot;</span>)</span><br><span class="line"></span><br><span class="line">	p.log.Infof(<span class="string">&quot;pipeline in: %v&quot;</span>, strings.Join(c.Pipeline().InboundNames(), <span class="string">&quot;-&gt;&quot;</span>))</span><br><span class="line">	p.log.Infof(<span class="string">&quot;pipeline out: %v&quot;</span>, strings.Join(c.Pipeline().OutboundNames(), <span class="string">&quot;-&gt;&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *EchoServerHandler)</span></span> ChannelInActive(c channel.HandlerContext) &#123;</span><br><span class="line">	p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Infoln(<span class="string">&quot;disconnected&quot;</span>)</span><br><span class="line"></span><br><span class="line">	p.log.Infof(<span class="string">&quot;pipeline in: %v&quot;</span>, strings.Join(c.Pipeline().InboundNames(), <span class="string">&quot;-&gt;&quot;</span>))</span><br><span class="line">	p.log.Infof(<span class="string">&quot;pipeline out: %v&quot;</span>, strings.Join(c.Pipeline().OutboundNames(), <span class="string">&quot;-&gt;&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *EchoServerHandler)</span></span> ChannelRead(c channel.HandlerContext, msg <span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">	data, ok := msg.([]<span class="type">byte</span>)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Warnf(<span class="string">&quot;unknown msg type: %+v&quot;</span>, msg)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	str := <span class="type">string</span>(data)</span><br><span class="line">	p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).Infoln(<span class="string">&quot;receive &quot;</span>, str)</span><br><span class="line">	<span class="keyword">if</span> err := c.Write(<span class="string">&quot;server:&quot;</span> + str + <span class="string">&quot;\r\n&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		p.log.WithField(<span class="string">&quot;peer&quot;</span>, c.Channel().RemoteAddr()).WithError(err).Warnln(<span class="string">&quot;write error&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="main-go-1"><a href="#main-go-1" class="headerlink" title="main.go"></a>main.go</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	log <span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line">	<span class="string">&quot;halia/bootstrap&quot;</span></span><br><span class="line">	<span class="string">&quot;halia/channel&quot;</span></span><br><span class="line">	<span class="string">&quot;halia/handler/codec&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	log.SetOutput(os.Stdout)</span><br><span class="line">	log.SetLevel(log.DebugLevel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	s := bootstrap.NewServer(&amp;bootstrap.ServerOptions&#123;</span><br><span class="line">		ChannelFactory: <span class="function"><span class="keyword">func</span><span class="params">(conn net.Conn)</span></span> channel.Channel &#123;</span><br><span class="line">			c := channel.NewDefaultChannel(conn)</span><br><span class="line">			c.Pipeline().AddInbound(<span class="string">&quot;decoder&quot;</span>, codec.NewLineBasedFrameDecoder())</span><br><span class="line">			c.Pipeline().AddInbound(<span class="string">&quot;handler&quot;</span>, NewEchoServerHandler())</span><br><span class="line">			c.Pipeline().AddOutbound(<span class="string">&quot;encoder&quot;</span>, &amp;StringToByteEncoder&#123;&#125;)</span><br><span class="line">			<span class="keyword">return</span> c</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	log.WithField(<span class="string">&quot;component&quot;</span>, <span class="string">&quot;server&quot;</span>).Fatal(s.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;0.0.0.0:8080&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>先运行服务端，再运行客户端。</p>
<p>服务端输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">time=&quot;2021-01-12T11:30:13+08:00&quot; level=info msg=started addr=&quot;0.0.0.0:8080&quot; component=server network=tcp pid=7584</span><br><span class="line">time=&quot;2021-01-12T11:30:13+08:00&quot; level=info msg=initialized component=channelId machineId=a0c5895a25a3 pid=7584</span><br><span class="line">time=&quot;2021-01-12T11:30:18+08:00&quot; level=info msg=connected component=EchoServerHandler peer=&quot;127.0.0.1:57641&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:18+08:00&quot; level=info msg=&quot;pipeline in: InHeadContext-&gt;decoder-&gt;handler&quot; component=EchoServerHandler</span><br><span class="line">time=&quot;2021-01-12T11:30:18+08:00&quot; level=info msg=&quot;pipeline out: OutHeadContext-&gt;encoder-&gt;OutTailContext&quot; component=EchoServerHandler</span><br><span class="line">time=&quot;2021-01-12T11:30:18+08:00&quot; level=info msg=&quot;receive  Hello World&quot; component=EchoServerHandler peer=&quot;127.0.0.1:57641&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:19+08:00&quot; level=info msg=&quot;receive  client say:2021-01-12 11:30:19.5192868 +0800 CST m=+1.046443501&quot; component=EchoServerHandler peer=&quot;127.0.0.1:57641&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:20+08:00&quot; level=info msg=&quot;receive  client say:2021-01-12 11:30:20.5193884 +0800 CST m=+2.046545101&quot; component=EchoServerHandler peer=&quot;127.0.0.1:57641&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:21+08:00&quot; level=info msg=&quot;receive  client say:2021-01-12 11:30:21.5345887 +0800 CST m=+3.061745401&quot; component=EchoServerHandler peer=&quot;127.0.0.1:57641&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:22+08:00&quot; level=info msg=&quot;receive  client say:2021-01-12 11:30:22.5459978 +0800 CST m=+4.073154501&quot; component=EchoServerHandler peer=&quot;127.0.0.1:57641&quot;</span><br></pre></td></tr></table></figure>

<p>客户端输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">time=&quot;2021-01-12T11:30:18+08:00&quot; level=info msg=connected component=EchoClientHandler peer=&quot;127.0.0.1:8080&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:18+08:00&quot; level=info msg=&quot;pipeline in: InHeadContext-&gt;decoder-&gt;handler&quot; component=EchoClientHandler</span><br><span class="line">time=&quot;2021-01-12T11:30:18+08:00&quot; level=info msg=&quot;pipeline out: OutHeadContext-&gt;encoder-&gt;OutTailContext&quot; component=EchoClientHandler</span><br><span class="line">time=&quot;2021-01-12T11:30:18+08:00&quot; level=info msg=&quot;receive  server:Hello World&quot; component=EchoClientHandler peer=&quot;127.0.0.1:8080&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:18+08:00&quot; level=info msg=initialized component=channelId machineId=a0c5895a25a3 pid=960</span><br><span class="line">time=&quot;2021-01-12T11:30:19+08:00&quot; level=info msg=&quot;receive  server:client say:2021-01-12 11:30:19.5192868 +0800 CST m=+1.046443501&quot; component=EchoClientHandler peer=&quot;127.0.0.1:8080&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:20+08:00&quot; level=info msg=&quot;receive  server:client say:2021-01-12 11:30:20.5193884 +0800 CST m=+2.046545101&quot; component=EchoClientHandler peer=&quot;127.0.0.1:8080&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:21+08:00&quot; level=info msg=&quot;receive  server:client say:2021-01-12 11:30:21.5345887 +0800 CST m=+3.061745401&quot; component=EchoClientHandler peer=&quot;127.0.0.1:8080&quot;</span><br><span class="line">time=&quot;2021-01-12T11:30:22+08:00&quot; level=info msg=&quot;receive  server:client say:2021-01-12 11:30:22.5459978 +0800 CST m=+4.073154501&quot; component=EchoClientHandler peer=&quot;127.0.0.1:8080&quot;</span><br></pre></td></tr></table></figure>

<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><p>Halia期待您的贡献！</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://halia-group.github.io/halia/">文档地址</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/halia-group/halia">仓库地址</a></li>
</ul>
<p><img src="https://imgkr2.cn-bj.ufileos.com/ccd85d43-46ce-405b-8efb-6f22c0f9ec3f.png?UCloudPublicKey=TOKEN_8d8b72be-579a-4e83-bfd0-5f6ce1546f13&Signature=APhNQ04SOdsYvwRWMyj6hc%252BUu5s%253D&Expires=1610510873"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-10-20T03:17:09.000Z" title="10/20/2020, 3:17:09 AM">2020-10-20</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/php/">php</a></span><span class="level-item">3 minutes lesen (Über 388 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/10/20/2020-10-20-laravel-crontab-log-permission.html">Laravel定时任务写入日志用户变为root导致Web进程无法写入日志问题</a></p><div class="content"><p>今天访问接口时返回 <strong>接口写入日志失败</strong>，通过排查后发现 <code>storage/logs</code>下面出现了<code>root</code>用户新建的日志，导致<code>www</code>用户无法写入日志。</p>
<p>通过排查发现，<code>crontab</code>写入了<code>laravel</code>的<code>定时任务命令</code>。默认情况下，crontab的任务是使用<code>root</code>用户去执行的，因此<code>laravel定时任务</code>新建的文件属主自然成为了<code>root</code>。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>解决方法就是<code>使用指定用户来运行 crontab 任务</code>。比如使用<code>www</code>用户来运行<code>laravel</code>的计划任务命令。</p>
<p>使用下面的命令编辑<code>www</code>用户的定时任务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -u www -e</span><br></pre></td></tr></table></figure>

<p>例如写入下面的示例任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /usr/local/php/bin/php /data/wwwroot/laravel/artisan schedule:run &gt;&gt; /var/log/laravel-crontab.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>保存即可，等待系统运行任务。</p>
<h2 id="运行时错误"><a href="#运行时错误" class="headerlink" title="运行时错误"></a>运行时错误</h2><p>通过观察发现定时任务并没有成功运行，通过查询<code>/var/log/cron</code>日志发现如下的日志：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(www) CMD (/usr/local/php/bin/php /data/wwwroot/laravel/artisan schedule:run &gt;&gt; /var/log/laravel-crontab.log 2&gt;&amp;1)</span><br><span class="line">(CRON) ERROR chdir failed (/home/www): No such file or directory</span><br></pre></td></tr></table></figure>

<p>可以看到，定时任务确实有执行，但是执行出错。出现这个问题的原因是<code>www 用户没有主目录</code>。</p>
<p>解决方案如下：</p>
<ol>
<li>新建<code>/home/www</code>目录</li>
<li>将<code>/home/www</code>的用户属主改为<code>www</code>用户</li>
</ol>
<p>相关命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/www</span><br><span class="line">chown -R www:www /home/www</span><br></pre></td></tr></table></figure>

<p>后续执行没有再出现错误。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-08-20T09:18:38.000Z" title="8/20/2020, 9:18:38 AM">2020-08-20</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/go/">go</a></span><span class="level-item">6 minutes lesen (Über 940 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/08/20/2020-08-20-golang-http-captcha-example.html">Golang Http 验证码示例</a></p><div class="content"><blockquote>
<p>验证码（CAPTCHA）是“Completely Automated Public Turing test to tell Computers and Humans Apart”（全自动区分<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%AE%A1%E7%AE%97%E6%9C%BA">计算机</a>和人类的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%9B%BE%E7%81%B5%E6%B5%8B%E8%AF%95">图灵测试</a>）的缩写，是一种区分用户是计算机还是人的公共全自动<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%A8%8B%E5%BA%8F/71525">程序</a>。可以防止：恶意破解密码、<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%88%B7%E7%A5%A8/6540942">刷票</a>、论坛灌水，有效防止某个黑客对某一个特定注册用户用特定程序暴力破解方式进行不断的登陆尝试，实际上用验证码是现在很多网站通行的方式，我们利用比较简易的方式实现了这个功能。这个问题可以由计算机生成并评判，但是必须只有人类才能解答。由于计算机无法解答CAPTCHA的问题，所以回答出问题的用户就可以被认为是人类。</p>
</blockquote>
<h2 id="传统网站验证码工作机制"><a href="#传统网站验证码工作机制" class="headerlink" title="传统网站验证码工作机制"></a>传统网站验证码工作机制</h2><ol>
<li>客户端请求服务器获取验证码图片</li>
<li>服务器生成随机串(验证码值)写入Session，并将验证码值写入到图片中返回给客户端</li>
<li>客户端输入图片上的字符串提交给服务器验证</li>
<li>服务器比对客户端提交的字符串值和 Session 中是否匹配，如果匹配则通过验证</li>
</ol>
<p>由于服务器生成的验证码值从始至终均未返回给客户端，因此，客户端只能从图片中识别验证码字符串，从而保证人机校验逻辑。</p>
<h2 id="Go的HTTP验证码"><a href="#Go的HTTP验证码" class="headerlink" title="Go的HTTP验证码"></a>Go的HTTP验证码</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>Go 语言的 HTTP 服务器默认不支持 Session，因此验证码值需要换个思路存储，以下是不使用 Session 的逻辑</p>
<ol>
<li>客户端请求服务器获取验证码ID</li>
<li>服务器生成验证码 ID，并生成验证码值，将 ID 和值的映射关系记录到内存或缓存，并将 ID 返回给客户端</li>
<li>客户端根据返回的 ID 请求服务器获取验证码图片</li>
<li>服务器获取到验证码 ID，从内存或缓存中取出验证码值，将该值写入图片并将图片返回给客户端</li>
<li>客户端提交验证码 ID（第1步获得）和验证码值给服务器验证</li>
<li>服务器获取验证码 ID，从内存或缓存中取出验证码值与客户端提交的验证码值比对</li>
</ol>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ol>
<li><p>安装验证码依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">github.com/dchest/captcha</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/dchest/captcha&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 获取验证码 ID</span></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/captcha/generate&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		id := captcha.NewLen(<span class="number">6</span>)</span><br><span class="line">		<span class="keyword">if</span> _, err := fmt.Fprint(w, id); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;generate captcha error&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">// 获取验证码图片</span></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/captcha/image&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		id := r.URL.Query().Get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> id == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			http.Error(w, <span class="string">&quot;Bad Request&quot;</span>, http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;image/png&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err := captcha.WriteImage(w, id, <span class="number">120</span>, <span class="number">80</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;show captcha error&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">// 业务处理</span></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/login&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := r.ParseForm(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;parseForm error&quot;</span>, err)</span><br><span class="line">			http.Error(w, <span class="string">&quot;Internal Error&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 获取验证码 ID 和验证码值</span></span><br><span class="line">		id := r.FormValue(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">		value := r.FormValue(<span class="string">&quot;value&quot;</span>)</span><br><span class="line">		<span class="comment">// 比对提交的验证码值和内存中的验证码值</span></span><br><span class="line">		<span class="keyword">if</span> captcha.VerifyString(id, value) &#123;</span><br><span class="line">			fmt.Fprint(w, <span class="string">&quot;ok&quot;</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fmt.Fprint(w, <span class="string">&quot;mismatch&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行</p>
<ol>
<li>访问&#x2F;captcha&#x2F;generate获得验证码 ID</li>
<li>访问&#x2F;captcha&#x2F;image?id&#x3D;验证码 ID</li>
<li>访问&#x2F;login，并输入第一步的验证码 ID 和第二步的验证码值即可查看验证结果</li>
</ol>
</li>
</ol>
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/xialeistudio/go-http-captcha-example">https://github.com/xialeistudio/go-http-captcha-example</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-02-01T04:00:00.000Z" title="2/1/2020, 4:00:00 AM">2020-02-01</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/java/">java</a></span><span class="level-item">3 minutes lesen (Über 443 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/02/01/2020-02-01-java-resource-load.html">Java中加载文件的几种方式</a></p><div class="content"><p>在Java程序中加载外部文件有多中方式，每种方式也存在区别，本文将理清这些加载方式之间的区别。</p>
<h2 id="文件IO方式"><a href="#文件IO方式" class="headerlink" title="文件IO方式"></a>文件IO方式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xialei.example.resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;app.properties&quot;</span>);</span><br><span class="line">        System.out.println(file.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>常见的读取方式，使用该方式读取文件时规则如下：</p>
<blockquote>
<p>如果传入的是绝对路径，则以系统根目录作为绝对路径的起点。</p>
<p>如果传入的是相对路径，则以当前工作目录作为起点。</p>
</blockquote>
<p>本例中，运行<code>java</code>命令的目录即为工作目录，app.properties从工作目录开始查找。</p>
<h2 id="Class-getResourceAsStream"><a href="#Class-getResourceAsStream" class="headerlink" title="Class.getResourceAsStream"></a>Class.getResourceAsStream</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xialei.example.resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Main.class.getResourceAsStream(<span class="string">&quot;app.properties&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(is);</span><br><span class="line">            System.out.println(properties.getProperty(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用该方式读取文件时规则如下：</p>
<blockquote>
<p>如果传入的是相对路径，则以当前class所在的包作为起点。</p>
<p>如果传入的是绝对路径，则以classpath的根目录为起点。</p>
</blockquote>
<ul>
<li><code>Main.class.getResourceAsStream(&quot;app.properties&quot;)</code> 会读取<code>/org/xialei/example/resource/app.properties</code>文件。</li>
<li><code>Main.class.getResourceAsStream(&quot;/app.properties&quot;)</code>会读取”classpath:&#x2F;app.properties”文件</li>
</ul>
<h2 id="ClassLoader-getResourceAsStream"><a href="#ClassLoader-getResourceAsStream" class="headerlink" title="ClassLoader.getResourceAsStream"></a>ClassLoader.getResourceAsStream</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xialei.example.resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Main.class.getClassLoader().getResourceAsStream(<span class="string">&quot;org/xialei/example/resource/app.properties&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(is);</span><br><span class="line">            System.out.println(properties.getProperty(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用该方式时规则如下:</p>
<blockquote>
<p>使用classpath根目录作为起点。</p>
</blockquote>
<p>本例中，<code>org/xialei/example/resource/app.properties</code>就是从classpath根目录进行查找的。</p>
<p><img src="https://static.ddhigh.com/blog/2019-10-22-102654.jpg" alt="0.jpeg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-01-17T04:00:00.000Z" title="1/17/2020, 4:00:00 AM">2020-01-17</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a></span><span class="level-item">14 minutes lesen (Über 2080 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/01/17/2020-01-17-php-binary-io.html">kafka二进制协议简要分析</a></p><div class="content"><p>最近分享了《应用层私有协议的设计和实战》，对应用层私有协议设计做了一些介绍，同时也对协议设计中常用的数据类型做了比较形象的讲解，今天我们来研究一下kafka的二进制协议。</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>kafka二进制协议定义了许多的数据类型，包含常用的数字、字符串，也包含了数组等类型。</p>
<p>本文主要讨论不可变长数据类型，可变长度（如Google Protocol Buffers）不在讨论范围内。</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>字节长度</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>BOOLEAN</td>
<td>1</td>
<td>布尔值</td>
</tr>
<tr>
<td>INT8</td>
<td>1</td>
<td>单字节整型，-2^7 ~ 2^7-1</td>
</tr>
<tr>
<td>INT16</td>
<td>2</td>
<td>双字节整型，大端序，范围 -2^15 ~ 2^15 - 1</td>
</tr>
<tr>
<td>INT32</td>
<td>4</td>
<td>四字节整型、大端序，范围 -2^31 ~ 2^31 - 1</td>
</tr>
<tr>
<td>INT64</td>
<td>8</td>
<td>八字节整型、大端序，范围 -2^63 ~ 2^63 -1</td>
</tr>
<tr>
<td>UINT32</td>
<td>4</td>
<td>十字街</td>
</tr>
<tr>
<td>UUID</td>
<td>16</td>
<td>16字节，Java UUID类型</td>
</tr>
<tr>
<td>STRING</td>
<td>2+N</td>
<td>头部由2字节标识字符串长度N，后续N字节为字符串内容</td>
</tr>
<tr>
<td>NULLABLE_STRING</td>
<td>2+N</td>
<td>头部由2字节标识字符串长度N，后续N字节为字符串内容，N为-1时无后续内容</td>
</tr>
<tr>
<td>BYTES</td>
<td>4+N</td>
<td>头部4字节标识字节数组长度，后续N字节为字节数组内容</td>
</tr>
<tr>
<td>NULLABLE_BYTES</td>
<td>4+N</td>
<td>头部4字节标识字节数组长度，后续N字节为字节数组内容，N为-1时无后续内容</td>
</tr>
<tr>
<td>ARRAY</td>
<td>4+N*M</td>
<td>头部4字节标识数组长度N，M为单个数组元素的长度，N为-1时为空数组</td>
</tr>
</tbody></table>
<h2 id="错误码"><a href="#错误码" class="headerlink" title="错误码"></a>错误码</h2><ul>
<li>-1 未知错误</li>
<li>0 未出错</li>
<li>大于0， 具体错误</li>
</ul>
<p>kafka内置的操作类型有点多，有兴趣的可以参阅<a target="_blank" rel="noopener" href="https://kafka.apache.org/protocol#protocol_error_codes">kafka错误码</a></p>
<h2 id="Api-Keys"><a href="#Api-Keys" class="headerlink" title="Api Keys"></a>Api Keys</h2><p>可以理解为操作码，服务端根据该字段区分当前请求操作。</p>
<p>这里不做展开，有兴趣的可以参阅<a target="_blank" rel="noopener" href="https://kafka.apache.org/protocol#protocol_api_keys">kafka Api Keys</a></p>
<h2 id="报文结构"><a href="#报文结构" class="headerlink" title="报文结构"></a>报文结构</h2><p>接下来我们重点分析一下kafka的报文结构。</p>
<blockquote>
<p>本文基于kafka V1版本协议写作，其他版本的研究原理时一致的。</p>
</blockquote>
<h3 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h3><p>kafka的协议结构比较简单，请求和响应使用同样的整体结构。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RequestOrResponse =&gt; Size (RequestMessage | ResponseMessage)</span><br><span class="line">  Size =&gt; int32</span><br></pre></td></tr></table></figure>

<p>我们转化为表格来看看</p>
<p><img src="https://static.ddhigh.com/blog/2020-01-17-093002.png" alt="image-20200117172959642"></p>
<ul>
<li>Size为INT32类型，正文长度</li>
<li>Message 为请求或响应正文的内容，变长字段，长度由Size给出</li>
</ul>
<h3 id="请求格式"><a href="#请求格式" class="headerlink" title="请求格式"></a>请求格式</h3><p>请求数据包有固定的请求包头，我们来看看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Request Header v1 =&gt; request_api_key request_api_version correlation_id client_id </span><br><span class="line">  request_api_key =&gt; INT16</span><br><span class="line">  request_api_version =&gt; INT16</span><br><span class="line">  correlation_id =&gt; INT32</span><br><span class="line">  client_id =&gt; NULLABLE_STRING</span><br></pre></td></tr></table></figure>

<p>上面给出的是请求头的内容，结合整体结构得出的协议表格如下：</p>
<p><img src="https://static.ddhigh.com/blog/2020-01-17-093119.png" alt="image-20200117173117965"></p>
<ul>
<li>Size 4字节正文长度（包含请求头）</li>
<li>request_api_key 2字节 api key，用来区分操作</li>
<li>request_api_version 2字节api 版本号</li>
<li>correlation_id 4字节请求ID，服务端会原样响应该请求ID</li>
<li>client_id 可空字符串，根据kafka数据类型定义，需要2字节client_id length字段标识client_id长度，如果client_id length为-1，则不需要传具体的client_id，否则需要传递client_id</li>
<li>request message* 请求正文，不同的api key请求正文不同</li>
</ul>
<h3 id="响应格式"><a href="#响应格式" class="headerlink" title="响应格式"></a>响应格式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Response Header v1 =&gt; correlation_id TAG_BUFFER </span><br><span class="line">  correlation_id =&gt; INT32</span><br></pre></td></tr></table></figure>

<p>响应头的结构比较简单，返回了请求ID</p>
<p><img src="https://static.ddhigh.com/blog/2020-01-17-093701.png" alt="image-20200117173658934"></p>
<ul>
<li>Size 4字节响应正文长度（包含请求ID）</li>
<li>correlation_id 4字节请求ID</li>
<li>response message* 响应正文</li>
</ul>
<h3 id="Metadata-示例"><a href="#Metadata-示例" class="headerlink" title="Metadata 示例"></a>Metadata 示例</h3><h4 id="请求数据"><a href="#请求数据" class="headerlink" title="请求数据"></a>请求数据</h4><p>Kafka Metadata对应的协议格式如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Metadata Request (Version: 1) =&gt; [topics] </span><br><span class="line">  topics =&gt; name </span><br><span class="line">    name =&gt; STRING</span><br></pre></td></tr></table></figure>

<p>我们转化为表格看看</p>
<p><img src="https://static.ddhigh.com/blog/2020-01-17-093858.png" alt="image-20200117173855988"></p>
<ul>
<li>Size 4字节请求正文长度</li>
<li>Request_api_key，根据协议文档， 此处为3</li>
<li>Request_api_version，本文基于v1版本写作，因此版本号为1</li>
<li>correlation_id 请求ID</li>
<li>client_id length 2字节客户端长度，我们使用test作为客户端标识，此处传入4</li>
<li>client_id 客户端名称，传入test字符串</li>
<li>topic name length 需要查询的topic数组，我们查询test1这个topic，此处传入1</li>
<li>topic name 字符串类型，因此先写入字符串长度5(test1字符串长度为5)，再写入test1字符串（总共写入2+5 &#x3D; 7个字节）</li>
</ul>
<h4 id="响应数据"><a href="#响应数据" class="headerlink" title="响应数据"></a>响应数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Metadata Response (Version: 1) =&gt; [brokers] controller_id [topics] </span><br><span class="line">  brokers =&gt; node_id host port rack </span><br><span class="line">    node_id =&gt; INT32</span><br><span class="line">    host =&gt; STRING</span><br><span class="line">    port =&gt; INT32</span><br><span class="line">    rack =&gt; NULLABLE_STRING</span><br><span class="line">  controller_id =&gt; INT32</span><br><span class="line">  topics =&gt; error_code name is_internal [partitions] </span><br><span class="line">    error_code =&gt; INT16</span><br><span class="line">    name =&gt; STRING</span><br><span class="line">    is_internal =&gt; BOOLEAN</span><br><span class="line">    partitions =&gt; error_code partition_index leader_id [replica_nodes] [isr_nodes] </span><br><span class="line">      error_code =&gt; INT16</span><br><span class="line">      partition_index =&gt; INT32</span><br><span class="line">      leader_id =&gt; INT32</span><br><span class="line">      replica_nodes =&gt; INT32</span><br><span class="line">      isr_nodes =&gt; INT32</span><br></pre></td></tr></table></figure>

<p><img src="https://static.ddhigh.com/blog/2020-01-17-094212.png" alt="image-20200117174211271"></p>
<ul>
<li>Size 4字节响应长度</li>
<li>Correlation_id 4字节请求ID</li>
<li>Broker Count，数组类型，4字节整型标识数组长度<ul>
<li>node_id 4字节整型，broker的节点ID</li>
<li>host 字符串类型，主机名称</li>
<li>port 4字节整型，端口号</li>
<li>rack 可空字符串，如果broker是rack，则需要2+N字节，否则只需要2字节</li>
</ul>
</li>
<li>Controller_id 4字节整型</li>
<li>Topics 数组类型，topic数组<ul>
<li>error_code 2字节整型，错误码</li>
<li>name 字符串类型，topic名称</li>
<li>is_internal 布尔类型，是否内部topic</li>
<li>partions 数组类型，topic所在partition<ul>
<li>error_code 2字节整型，错误码</li>
<li>partition_index 4字节整型，partition index</li>
<li>leader_id 4字节整型，leader id</li>
<li>Replica_nodes 数组类型<ul>
<li>Replica_node 4字节整型</li>
</ul>
</li>
<li>isr_nodes 数组类型<ul>
<li>Isr_node 4字节整型</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>其他类型的请求也可以使用同样的方式去分析</p>
</blockquote>
<h2 id="PHP客户端实现"><a href="#PHP客户端实现" class="headerlink" title="PHP客户端实现"></a>PHP客户端实现</h2><p>PHP自带了pack&#x2F;unpack函数帮助我们操作二进制数据，不过pack&#x2F;unpack易用性比较低。</p>
<blockquote>
<p>对于二进制数据，java有byte[]，golang有[]byte，PHP没有专门的类型，而是使用字符串存储的，不过PHP字符串是二进制安全的。</p>
</blockquote>
<p>针对pack&#x2F;unpack函数易用性问题，这两天参考Java的IO系统开发了一个简单版本的io库来简化二进制数据流的操作（文末有仓库地址）。</p>
<p>接下来使用该库来编写一个kafka的客户端。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取kafka broker列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">BinaryStringInputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">BinaryStringOutputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">DataInputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">DataOutputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">FileInputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">FileOutputStream</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$client</span> = <span class="title function_ invoke__">stream_socket_client</span>(<span class="string">&#x27;tcp://127.0.0.1:9092&#x27;</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$errno</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$errstr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$binaryOutputStream</span> = <span class="keyword">new</span> <span class="title class_">BinaryStringOutputStream</span>();</span><br><span class="line"><span class="variable">$binaryPacketOutput</span> = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(<span class="variable">$binaryOutputStream</span>);</span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedShortBE</span>(<span class="number">0x03</span>); <span class="comment">// METADATA_REQUEST</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedShortBE</span>(<span class="number">1</span>); <span class="comment">// API_VERSION</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedIntBE</span>(<span class="number">0x01</span>); <span class="comment">// 请求ID</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedShortBE</span>(<span class="title function_ invoke__">strlen</span>(<span class="string">&#x27;test&#x27;</span>)); <span class="comment">// 客户端标识长度</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeString</span>(<span class="string">&#x27;test&#x27;</span>); <span class="comment">// 客户端标识</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedIntBE</span>(<span class="number">1</span>); <span class="comment">// topic列表数组长度</span></span><br><span class="line"><span class="comment">// topic数组元素</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedShortBE</span>(<span class="title function_ invoke__">strlen</span>(<span class="string">&#x27;test1&#x27;</span>)); <span class="comment">// 写入2字节topic名称长度</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeString</span>(<span class="string">&#x27;test1&#x27;</span>); <span class="comment">// topic名称</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">flush</span>(); <span class="comment">// 输出缓冲</span></span><br><span class="line"><span class="variable">$packet</span> = <span class="variable">$binaryOutputStream</span>-&gt;<span class="title function_ invoke__">toBinaryString</span>(); <span class="comment">// 获得构造好的正文数据包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 包装socket链接，获得多数据类型操作能力</span></span><br><span class="line"><span class="variable">$out</span> = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="variable">$client</span>));</span><br><span class="line"><span class="variable">$out</span>-&gt;<span class="title function_ invoke__">writeUnSignedIntBE</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$packet</span>)); <span class="comment">// 4字节包长度</span></span><br><span class="line"><span class="variable">$out</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$packet</span>); <span class="comment">// 包体</span></span><br><span class="line"><span class="variable">$out</span>-&gt;<span class="title function_ invoke__">flush</span>(); <span class="comment">// 输出到Socket</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化输入流，从socket读取数据</span></span><br><span class="line"><span class="variable">$in</span> = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="variable">$client</span>));</span><br><span class="line"><span class="variable">$size</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// 4字节包长度</span></span><br><span class="line"><span class="comment">// 一次性读取完socket数据后关闭，然后将读取到的响应数据填充到二进制字符串输入流中，释放socket</span></span><br><span class="line"><span class="variable">$in</span> = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="keyword">new</span> <span class="title class_">BinaryStringInputStream</span>(<span class="title function_ invoke__">fread</span>(<span class="variable">$client</span>, <span class="variable">$size</span>)));</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$requestId</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// 4字节请求ID</span></span><br><span class="line"><span class="title function_ invoke__">printf</span>(<span class="string">&quot;packet length: %d requestId: %d\n&quot;</span>, <span class="variable">$size</span>, <span class="variable">$requestId</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$brokerCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// broker数量</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$brokerCount</span>; <span class="variable">$i</span>++) &#123; <span class="comment">// 循环读取broker</span></span><br><span class="line">    <span class="variable">$nodeId</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// nodeId</span></span><br><span class="line">    <span class="variable">$hostLength</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedShortBE</span>(); <span class="comment">// host长度</span></span><br><span class="line">    <span class="variable">$host</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readString</span>(<span class="variable">$hostLength</span>); <span class="comment">// 主机名</span></span><br><span class="line">    <span class="variable">$port</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// port</span></span><br><span class="line">    <span class="variable">$rackLength</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readShortBE</span>(); <span class="comment">// rack</span></span><br><span class="line">    <span class="variable">$rack</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$rackLength</span> != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable">$rack</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readString</span>(<span class="variable">$rackLength</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">printf</span>(<span class="string">&quot;nodeId:%d host:%s port:%d rack: %s\n&quot;</span>, <span class="variable">$nodeId</span>, <span class="variable">$host</span>, <span class="variable">$port</span>, <span class="variable">$rack</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$controllerId</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line"><span class="title function_ invoke__">printf</span>(<span class="string">&quot;controllerId: %d\n&quot;</span>, <span class="variable">$controllerId</span>);</span><br><span class="line"><span class="variable">$topicCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line"><span class="title function_ invoke__">printf</span>(<span class="string">&quot;topic count %d\n&quot;</span>, <span class="variable">$topicCount</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$topicCount</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="title function_ invoke__">printf</span>(<span class="string">&quot;----topic list----\n&quot;</span>);</span><br><span class="line">    <span class="variable">$errCode</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedShortBE</span>();</span><br><span class="line">    <span class="variable">$nameLength</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedShortBE</span>();</span><br><span class="line">    <span class="variable">$name</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readString</span>(<span class="variable">$nameLength</span>);</span><br><span class="line">    <span class="variable">$isInternal</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedChar</span>();</span><br><span class="line">    <span class="title function_ invoke__">printf</span>(<span class="string">&quot;errcode: %d name: %s interval: %d\n&quot;</span>, <span class="variable">$errCode</span>, <span class="variable">$name</span>, <span class="variable">$isInternal</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$partitionCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">    <span class="title function_ invoke__">printf</span>(<span class="string">&quot;----topic [%s] partition list count %d---\n&quot;</span>, <span class="variable">$name</span>, <span class="variable">$partitionCount</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$j</span> = <span class="number">0</span>; <span class="variable">$j</span> &lt; <span class="variable">$partitionCount</span>; <span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$errCode</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedShortBE</span>();</span><br><span class="line">        <span class="variable">$partitionIndex</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        <span class="variable">$leaderId</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        <span class="variable">$replicaNodesCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        <span class="variable">$replicaNodes</span> = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$k</span> = <span class="number">0</span>; <span class="variable">$k</span> &lt; <span class="variable">$replicaNodesCount</span>; <span class="variable">$k</span>++) &#123;</span><br><span class="line">            <span class="variable">$replicaNodes</span>[] = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$isrNodeCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        <span class="variable">$isrNodes</span> = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$k</span> = <span class="number">0</span>; <span class="variable">$k</span> &lt; <span class="variable">$isrNodeCount</span>; <span class="variable">$k</span>++) &#123;</span><br><span class="line">            <span class="variable">$isrNodes</span>[] = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">printf</span>(</span><br><span class="line">            <span class="string">&quot;errcode: %d partitionIndex: %d leaderId: %d replicaNodes: [%s] isrNodes: [%s]\n&quot;</span>,</span><br><span class="line">            <span class="variable">$errCode</span>,</span><br><span class="line">            <span class="variable">$partitionIndex</span>,</span><br><span class="line">            <span class="variable">$leaderId</span>,</span><br><span class="line">            <span class="title function_ invoke__">join</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$replicaNodes</span>),</span><br><span class="line">            <span class="title function_ invoke__">join</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$isrNodes</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">packet length: 73 requestId: 1</span><br><span class="line">nodeId:0 host:bogon port:9092 rack: </span><br><span class="line">controllerId: 0</span><br><span class="line">topic count 1</span><br><span class="line">----topic list----</span><br><span class="line">errcode: 0 name: test1 interval: 0</span><br><span class="line">----topic [test1] partition list count 1---</span><br><span class="line">errcode: 0 partitionIndex: 0 leaderId: 0 replicaNodes: [0] isrNodes: [0]</span><br></pre></td></tr></table></figure>

<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p> <a target="_blank" rel="noopener" href="https://github.com/xialeistudio/php-io">php-io</a></p>
<p>(完)</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2019-11-14T09:00:00.000Z" title="11/14/2019, 9:00:00 AM">2019-11-14</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/mysql/">mysql</a></span><span class="level-item">4 minutes lesen (Über 570 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/11/14/2019-11-14-mysql-char-varchar-max-length.html">MySQL中的CHAR和VARCHAR到底支持多长?</a></p><div class="content"><p>最近在研究MySQL的数据类型，我们知道，选择合适的数据类型和数据长度对MySQL的性能影响是不可忽视的，小字段意味着可以MySQL可以读取更多的记录，从而加快查询速度。</p>
<p>网上该问题的答案有很多版本，还是通过实践得出的结论比较靠谱。</p>
<p>先说结论(MySQL版本5.7.27)</p>
<ul>
<li>CHAR最大255<strong>字符</strong>，字符集对CHAR没有影响，CHAR()括号内填写最大字符数255</li>
<li>VARCHAR最大65535<strong>字节</strong>，字符集对VARCHAR有影响<ul>
<li>UTF8字符集，每个字符大小3字节，所以65535&#x2F;3 &#x3D; 21845，最大支持21845字符，因此VARCHAR()括号中最大填写21845字符</li>
<li>GBK字符集，每个字符大小2字节，所以65535&#x2F;2 &#x3D; 32767.5，最大支持32767<strong>字符</strong>，因此VARCHAR()括号中最大填写32767字符</li>
</ul>
</li>
</ul>
<h2 id="验证过程"><a href="#验证过程" class="headerlink" title="验证过程"></a>验证过程</h2><h3 id="CHAR"><a href="#CHAR" class="headerlink" title="CHAR"></a>CHAR</h3><p>UTF8字符集(1个字符占用3个字节)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test`.`demo`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">0</span>) UNSIGNED <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `title` <span class="type">char</span>(<span class="number">256</span>) <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci;</span><br></pre></td></tr></table></figure>

<p>MySQL提示错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1074 - Column length too big for column &#x27;title&#x27; (max = 255); use BLOB or TEXT instead</span><br></pre></td></tr></table></figure>

<p>GBK字符集(1个字符占用2个字节)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test`.`demo`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">0</span>) UNSIGNED <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `title` <span class="type">char</span>(<span class="number">256</span>) <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> gbk <span class="keyword">COLLATE</span> <span class="operator">=</span> gbk_chinese_ci;</span><br></pre></td></tr></table></figure>

<p>MySQL提示错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1074 - Column length too big for column &#x27;title&#x27; (max = 255); use BLOB or TEXT instead</span><br></pre></td></tr></table></figure>

<blockquote>
<p>结论：CHAR最大长度和字符集没有关系，因此CHAR()括号内填写字符大小，最终数据的字节大小随着字符集不同而不同</p>
</blockquote>
<h3 id="VARCHAR"><a href="#VARCHAR" class="headerlink" title="VARCHAR"></a>VARCHAR</h3><p>UTF8字符集(1个字符占用3个字节)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test`.`demo`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">0</span>) UNSIGNED <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">65535</span>) <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci;</span><br></pre></td></tr></table></figure>

<p>MySQL提示错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1074 - Column length too big for column &#x27;title&#x27; (max = 21845); use BLOB or TEXT instead</span><br></pre></td></tr></table></figure>

<p>MySQL提示的最大长度为21845，通过UTF8字符集的大小可知VARCHAR()括号中指的是字符大小。</p>
<p>UTF8MB4字符集(1个字符占用4个字节)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `test`.`demo`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">0</span>) UNSIGNED <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">65535</span>) <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb4 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb4_general_ci;</span><br></pre></td></tr></table></figure>

<p>MySQL提示错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1074 - Column length too big for column &#x27;title&#x27; (max = 16383); use BLOB or TEXT instead</span><br></pre></td></tr></table></figure>

<p>MySQL提示的最大长度为16383，通过UTF8MB4字符集大小可知VARCHAR()括号中指的是字符大小。</p>
<p><img src="https://static.ddhigh.com/blog/2019-10-22-102654.jpg" alt="0.jpeg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2019-10-29T04:00:00.000Z" title="10/29/2019, 4:00:00 AM">2019-10-29</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a></span><span class="level-item">12 minutes lesen (Über 1788 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/10/29/2019-10-29-redis-high-concurrent.html">Redis优化高并发下的秒杀性能</a></p><div class="content"><p>本文内容</p>
<ul>
<li>使用Redis优化高并发场景下的接口性能</li>
<li>数据库乐观锁</li>
</ul>
<p>随着双11的临近，各种促销活动开始变得热门起来，比较主流的有秒杀、抢优惠券、拼团等等。</p>
<p>涉及到高并发争抢同一个资源的主要场景有秒杀和抢优惠券。</p>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>活动规则</p>
<ul>
<li>奖品数量有限，比如100个</li>
<li>不限制参与用户数</li>
<li>每个用户只能参与1次秒杀</li>
</ul>
<p>活动要求</p>
<ul>
<li>不能多发，也不能少发，100个奖品要全部发出去</li>
<li>1个用户最多抢1个奖品</li>
<li>遵循先到先得原则，先来的用户有奖品</li>
</ul>
<h2 id="数据库实现"><a href="#数据库实现" class="headerlink" title="数据库实现"></a>数据库实现</h2><p>悲观锁性能太差，本文不予讨论，讨论一下使用乐观锁解决高并发问题的优缺点。</p>
<h3 id="数据库结构"><a href="#数据库结构" class="headerlink" title="数据库结构"></a>数据库结构</h3><table>
<thead>
<tr>
<th>ID</th>
<th>Code</th>
<th>UserId</th>
<th>CreatedAt</th>
<th>RewardAt</th>
</tr>
</thead>
<tbody><tr>
<td>奖品ID</td>
<td>奖品码</td>
<td>用户ID</td>
<td>创建时间</td>
<td>中奖时间</td>
</tr>
</tbody></table>
<ul>
<li>未中奖时UserId为0，RewardAt为NULL</li>
<li>中奖时UserId为中奖用户ID，RewardAt为中奖时间</li>
</ul>
<h3 id="乐观锁实现"><a href="#乐观锁实现" class="headerlink" title="乐观锁实现"></a>乐观锁实现</h3><p>乐观锁实际上并不存在真正的锁，乐观锁是利用数据的某个字段来做的，比如本文的例子就是以UserId来实现的。</p>
<p>实现流程如下：</p>
<ol>
<li><p>查询UserId为0的奖品，如果未找到则提示无奖品</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> envelope <span class="keyword">WHERE</span> user_id<span class="operator">=</span><span class="number">0</span> LIMIT <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>更新奖品的用户ID和中奖时间(假设奖品ID为1，中奖用户ID为100，当前时间为2019-10-29 12:00:00)，这里的user_id&#x3D;0就是我们的乐观锁了。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> envelope <span class="keyword">SET</span> user_id<span class="operator">=</span><span class="number">100</span>, reward_at<span class="operator">=</span><span class="string">&#x27;2019-10-29 12:00:00&#x27;</span> <span class="keyword">WHERE</span> user_id<span class="operator">=</span><span class="number">0</span> <span class="keyword">AND</span> id<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>检测UPDATE语句的执行返回值，如果返回1证明中奖成功，否则证明该奖品被其他人抢了</p>
</li>
</ol>
<h4 id="为什么要添加乐观锁"><a href="#为什么要添加乐观锁" class="headerlink" title="为什么要添加乐观锁"></a>为什么要添加乐观锁</h4><p>正常情况下获取奖品、然后把奖品更新给指定用户是没问题的。如果不添加user_id&#x3D;0时，高并发场景下会出现下面的问题：</p>
<ol>
<li>两个用户同时查询到了1个未中奖的奖品(发生并发问题)</li>
<li>将奖品的中奖用户更新为用户1，更新条件只有ID&#x3D;奖品ID</li>
<li>上述SQL执行是成功的，影响行数也是1，此时接口会返回用户1中奖</li>
<li>接下来将中奖用户更新为用户2，更新条件也只有ID&#x3D;奖品ID</li>
<li>由于是同一个奖品，已经发给用户1的奖品会重新发放给用户2，此时影响行数为1，接口返回用户2也中奖</li>
<li>所以该奖品的最终结果是发放给用户2</li>
<li><code>用户1就会过来投诉活动方了，因为抽奖接口返回用户1中奖，但他的奖品被抢了，此时活动方只能赔钱了</code></li>
</ol>
<h4 id="添加乐观锁之后的抽奖流程"><a href="#添加乐观锁之后的抽奖流程" class="headerlink" title="添加乐观锁之后的抽奖流程"></a>添加乐观锁之后的抽奖流程</h4><ol>
<li>更新用户1时的条件为<code>id=红包ID AND user_id=0</code> ,由于此时红包未分配给任何人，用户1更新成功，接口返回用户1中奖</li>
<li>当更新用户2时更新条件为<code>id=红包ID AND user_id=0</code>，由于此时该红包已经分配给用户1了，所以该条件不会更新任何记录，接口返回用户2中奖</li>
</ol>
<h4 id="乐观锁优缺点"><a href="#乐观锁优缺点" class="headerlink" title="乐观锁优缺点"></a>乐观锁优缺点</h4><p>优点</p>
<ul>
<li>性能尚可，因为无锁</li>
<li>不会超发</li>
</ul>
<p>缺点</p>
<ul>
<li>通常不满足“先到先得”的活动规则，一旦发生并发，就会发生未中奖的情况，此时奖品库还有奖品</li>
</ul>
<h3 id="压测"><a href="#压测" class="headerlink" title="压测"></a>压测</h3><p>在MacBook Pro 2018上的压测表现如下(Golang实现的HTTP服务器,MySQL连接池大小100，Jmeter压测)：</p>
<ul>
<li>500并发 500总请求数 平均响应时间331ms 发放成功数为31 吞吐量458.7&#x2F;s</li>
</ul>
<h2 id="Redis实现"><a href="#Redis实现" class="headerlink" title="Redis实现"></a>Redis实现</h2><p>可以看到乐观锁的实现下争抢比太高，不是推荐的实现方法，下面通过Redis来优化这个秒杀业务。</p>
<h3 id="Redis高性能的原因"><a href="#Redis高性能的原因" class="headerlink" title="Redis高性能的原因"></a>Redis高性能的原因</h3><ul>
<li>单线程 省去了线程切换开销</li>
<li>基于内存的操作 虽然持久化操作涉及到硬盘访问，但是那是异步的，不会影响Redis的业务</li>
<li>使用了IO多路复用</li>
</ul>
<h3 id="实现流程"><a href="#实现流程" class="headerlink" title="实现流程"></a>实现流程</h3><ol>
<li><p>活动开始前将数据库中奖品的code写入Redis队列中</p>
</li>
<li><p>活动进行时使用lpop弹出队列中的元素</p>
</li>
<li><p>如果获取成功，则使用UPDATE语法发放奖品</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> reward <span class="keyword">SET</span> user_id<span class="operator">=</span>用户ID,reward_at<span class="operator">=</span>当前时间 <span class="keyword">WHERE</span> code<span class="operator">=</span><span class="string">&#x27;奖品码&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果获取失败，则当前无可用奖品，提示未中奖即可</p>
</li>
</ol>
<p>使用Redis的情况下并发访问是通过Redis的<code>lpop()</code>来保证的，该方法是原子方法，可以保证并发情况下也是一个个弹出的。</p>
<h3 id="压测-1"><a href="#压测-1" class="headerlink" title="压测"></a>压测</h3><p>在MacBook Pro 2018上的压测表现如下(Golang实现的HTTP服务器,MySQL连接池大小100，Redis连接池代销100，Jmeter压测)：</p>
<ul>
<li>500并发 500总请求数 平均响应时间48ms 发放成功数100 吞吐量497.0&#x2F;s</li>
</ul>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>可以看到Redis的表现是稳定的，不会出现超发，且访问延迟少了8倍左右，吞吐量还没达到瓶颈，可以看出Redis对于高并发系统的性能提升是非常大的！接入成本也不算高，值得学习！</p>
<p><img src="https://static.ddhigh.com/blog/2019-10-22-102654.jpg" alt="0.jpeg"></p>
<h2 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/go-redis/redis&quot;</span></span><br><span class="line">	_ <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jinzhu/gorm&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;strconv&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Envelope <span class="keyword">struct</span> &#123;</span><br><span class="line">	Id        <span class="type">int</span> <span class="string">`gorm:&quot;primary_key&quot;`</span></span><br><span class="line">	Code      <span class="type">string</span></span><br><span class="line">	UserId    <span class="type">int</span></span><br><span class="line">	CreatedAt time.Time</span><br><span class="line">	RewardAt  *time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(Envelope)</span></span> TableName() <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;envelope&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Envelope)</span></span> BeforeCreate() <span class="type">error</span> &#123;</span><br><span class="line">	p.CreatedAt = time.Now()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	QueueEnvelope = <span class="string">&quot;envelope&quot;</span></span><br><span class="line">	QueueUser     = <span class="string">&quot;user&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	db          *gorm.DB</span><br><span class="line">	redisClient *redis.Client</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">	db, err = gorm.Open(<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;root:root@tcp(localhost:3306)/test?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err = db.DB().Ping(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	db.DB().SetMaxOpenConns(<span class="number">100</span>)</span><br><span class="line">	fmt.Println(<span class="string">&quot;database connected. pool size 10&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	redisClient = redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">		Addr:     <span class="string">&quot;localhost:6379&quot;</span>,</span><br><span class="line">		DB:       <span class="number">0</span>,</span><br><span class="line">		PoolSize: <span class="number">100</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> _, err := redisClient.Ping().Result(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;redis connected. pool size 100&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取Code写入Queue</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	envelopes := <span class="built_in">make</span>([]Envelope, <span class="number">0</span>, <span class="number">100</span>)</span><br><span class="line">	<span class="keyword">if</span> err := db.Debug().Where(<span class="string">&quot;user_id=0&quot;</span>).Limit(<span class="number">100</span>).Find(&amp;envelopes).Error; err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(envelopes) != <span class="number">100</span> &#123;</span><br><span class="line">		log.Fatal(<span class="string">&quot;不足100个奖品&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> envelopes &#123;</span><br><span class="line">		<span class="keyword">if</span> err := redisClient.LPush(QueueEnvelope, envelopes[i].Code).Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;load 100 envelopes&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/envelope&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		uid := r.Header.Get(<span class="string">&quot;x-user-id&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> uid == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">401</span>)</span><br><span class="line">			_, _ = fmt.Fprint(w, <span class="string">&quot;UnAuthorized&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		uidValue, err := strconv.Atoi(uid)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">400</span>)</span><br><span class="line">			_, _ = fmt.Fprint(w, <span class="string">&quot;Bad Request&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 检测用户是否抢过了</span></span><br><span class="line">		<span class="keyword">if</span> result, err := redisClient.HIncrBy(QueueUser, uid, <span class="number">1</span>).Result(); err != <span class="literal">nil</span> || result != <span class="number">1</span> &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">429</span>)</span><br><span class="line">			_, _ = fmt.Fprint(w, <span class="string">&quot;Too Many Request&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 检测是否在队列中</span></span><br><span class="line">		code, err := redisClient.LPop(QueueEnvelope).Result()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">200</span>)</span><br><span class="line">			_, _ = fmt.Fprint(w, <span class="string">&quot;No Envelope&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 发放红包</span></span><br><span class="line">		envelope := &amp;Envelope&#123;&#125;</span><br><span class="line">		err = db.Where(<span class="string">&quot;code=?&quot;</span>, code).Take(&amp;envelope).Error</span><br><span class="line">		<span class="keyword">if</span> err == gorm.ErrRecordNotFound &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">200</span>)</span><br><span class="line">			_, _ = fmt.Fprint(w, <span class="string">&quot;No Envelope&quot;</span>)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">			_, _ = fmt.Fprint(w, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		now := time.Now()</span><br><span class="line">		envelope.UserId = uidValue</span><br><span class="line">		envelope.RewardAt = &amp;now</span><br><span class="line">		rowsAffected := db.Where(<span class="string">&quot;user_id=0&quot;</span>).Save(&amp;envelope).RowsAffected <span class="comment">// 添加user_id=0来验证Redis是否真的解决争抢问题</span></span><br><span class="line">		<span class="keyword">if</span> rowsAffected == <span class="number">0</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;发生争抢. id=%d\n&quot;</span>, envelope.Id)</span><br><span class="line">			w.WriteHeader(<span class="number">500</span>)</span><br><span class="line">			_, _ = fmt.Fprintf(w, <span class="string">&quot;发生争抢. id=%d\n&quot;</span>, envelope.Id)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		_, _ = fmt.Fprint(w, envelope.Code)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;listen on 8080&quot;</span>)</span><br><span class="line">	fmt.Println(http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2019-09-10T07:17:32.000Z" title="9/10/2019, 7:17:32 AM">2019-09-10</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/nodejs/">nodejs</a></span><span class="level-item">10 minutes lesen (Über 1504 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2019/09/10/2019-09-10-nestjs-interceptor.html">NestJs学习之旅(9)——拦截器</a></p><div class="content"><p>本文是NestJs的第九篇，讲解拦截器。</p>
<p>拦截器是一个实现了<strong>NestInterceptor</strong>接口且被**@Injectable**装饰器修饰的类。</p>
<p><img src="https://static.ddhigh.com/blog/2019-09-10-061428.png" alt="img"></p>
<p>拦截器是基于AOP编程思想的一种应用，以下是常用的功能：</p>
<ul>
<li>在方法执行之前或之后执行<strong>额外的逻辑</strong>，这些逻辑一般不属于业务的一部分</li>
<li><strong>转换</strong>函数执行结果</li>
<li><strong>转换</strong>函数执行时抛出的异常</li>
<li>扩展函数基本行为</li>
<li>特定场景下完全重写函数的行为（比如缓存拦截器，一旦有可用的缓存则直接返回，不执行真正的业务逻辑，即业务逻辑处理函数行为已经被重写）</li>
</ul>
<h2 id="拦截器接口"><a href="#拦截器接口" class="headerlink" title="拦截器接口"></a>拦截器接口</h2><p>每个拦截器都需要实现<strong>NestInterceptor</strong>接口的**intercept()**方法，该方法接收两个参数。方法原型如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">intercept</span>(<span class="params">context: ExecutionContext, next: CallHandler</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">any</span>&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>ExecutionContext 执行上下文，与<a href="https://www.ddhigh.com/2019/08/27/nestjs-guard.html">NestJs学习之旅(7)——路由守卫</a>中的<strong>执行上下文</strong>相同</li>
<li>CallHandler 路由处理函数</li>
</ul>
<h2 id="CallHandler"><a href="#CallHandler" class="headerlink" title="CallHandler"></a>CallHandler</h2><p>该接口是对路由处理函数的抽象，接口定义如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">CallHandler</span>&lt;T = <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="title function_">handle</span>(): <span class="title class_">Observable</span>&lt;T&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handle()函数的返回值也就是对应路由函数的返回值。</p>
<p>以获取用户列表为例：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user.controller.ts</span></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当访问 &#x2F;user&#x2F;list 时，路由处理函数返回**[]**，如果在应用拦截器的情况下，调用CallHandler接口的handle()方法得到的也是Observable&lt;[]&gt;(RxJs包装对象)。</p>
<p><strong>所以，如果在拦截器中调用了next.handle()方法就会执行对应的路由处理函数，如果不调用的话就不会执行。</strong></p>
<h2 id="一个请求链路日志记录拦截器"><a href="#一个请求链路日志记录拦截器" class="headerlink" title="一个请求链路日志记录拦截器"></a>一个请求链路日志记录拦截器</h2><p>随着微服务的兴起，原来的单一项目被拆分成多个比较小的子模块，这些子模块可以独立开发、独立部署、独立运行，大大提高了开发、执行效率，但是带来的问题也比较多，一个经常遇到的问题是接口调用出错不好查找日志。</p>
<p>如果在业务逻辑中硬编码这种链路调用日志是非常不可取的，严重违反了单一职责的原则，这在微服务开发中是相当不好的一种行为，会让微服务变得臃肿，这些逻辑完全可以通过拦截器来实现。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.interceptor.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CallHandler</span>, <span class="title class_">ExecutionContext</span>, <span class="title class_">Injectable</span>, <span class="title class_">Logger</span>, <span class="title class_">NestInterceptor</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; tap &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Request</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; format &#125; <span class="keyword">from</span> <span class="string">&#x27;util&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppInterceptor</span> <span class="keyword">implements</span> <span class="title class_">NestInterceptor</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> logger = <span class="keyword">new</span> <span class="title class_">Logger</span>(); <span class="comment">// 实例化日志记录器</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>, <span class="attr">next</span>: <span class="title class_">CallHandler</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>(); <span class="comment">// 请求开始时间</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>().<span class="title function_">pipe</span>(<span class="title function_">tap</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 调用完handle()后得到RxJs响应对象，使用tap可以得到路由函数的返回值</span></span><br><span class="line">      <span class="keyword">const</span> host = context.<span class="title function_">switchToHttp</span>();</span><br><span class="line">      <span class="keyword">const</span> request = host.<span class="property">getRequest</span>&lt;<span class="title class_">Request</span>&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 打印请求方法，请求链接，处理时间和响应数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">logger</span>.<span class="title function_">log</span>(<span class="title function_">format</span>(</span><br><span class="line">        <span class="string">&#x27;%s %s %dms %s&#x27;</span>,</span><br><span class="line">        request.<span class="property">method</span>,</span><br><span class="line">        request.<span class="property">url</span>,</span><br><span class="line">        <span class="title class_">Date</span>.<span class="title function_">now</span>() - start,</span><br><span class="line">        <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(response),</span><br><span class="line">      ));</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user.controller.ts</span></span><br><span class="line"><span class="meta">@UseInterceptors</span>(<span class="title class_">AppInterceptor</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当访问 &#x2F;user时控制台想输出</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Nest] 96310   - 09/10/2019, 2:44 PM   GET /user 1ms []</span><br></pre></td></tr></table></figure>

<h2 id="拦截器作用域"><a href="#拦截器作用域" class="headerlink" title="拦截器作用域"></a>拦截器作用域</h2><p>拦截器可以在以下作用域进行绑定：</p>
<ul>
<li>全局拦截器</li>
<li>控制器拦截器</li>
<li>路由方法拦截器</li>
</ul>
<h3 id="全局拦截器"><a href="#全局拦截器" class="headerlink" title="全局拦截器"></a>全局拦截器</h3><p>在main.ts中使用以下代码即可：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="keyword">await</span> <span class="title class_">NestFactory</span>.<span class="title function_">create</span>(<span class="title class_">AppModule</span>);</span><br><span class="line">app.<span class="title function_">useGlobalInterceptors</span>(<span class="keyword">new</span> <span class="title class_">AppInterceptor</span>());</span><br></pre></td></tr></table></figure>

<h3 id="控制器拦截器"><a href="#控制器拦截器" class="headerlink" title="控制器拦截器"></a>控制器拦截器</h3><p>将对该控制器所有<strong>路由</strong>方法生效：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"><span class="meta">@UseInterceptors</span>(<span class="title class_">AppInterceptor</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="路由方法拦截器"><a href="#路由方法拦截器" class="headerlink" title="路由方法拦截器"></a>路由方法拦截器</h3><p>只对当前被装饰的路由方法进行拦截：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span>(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">  <span class="meta">@UseInterceptors</span>(<span class="title class_">AppInterceptor</span>)</span><br><span class="line">  <span class="meta">@Get</span>()</span><br><span class="line">  <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="响应处理"><a href="#响应处理" class="headerlink" title="响应处理"></a>响应处理</h2><p>CallHandler接口的handle()返回值实际上是RxJs的Observable对象，利用RxJs操作符可以对该对象进行操作，比如有一个API接口，之前返回的数据结构如下，如果正常响应，响应体就是数据，没有包装结构：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;xialei&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新的需求是要把之前的纯数据响应包装为一个data属性，结构如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;xialei&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接到这个需求时有的小伙伴可能已经在梳理响应接口的数量然后评估工时准备进行开发了，而使用NestJs的拦截器，不到一炷香的时间即可实现该需求。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CallHandler</span>, <span class="title class_">ExecutionContext</span>, <span class="title class_">Injectable</span>, <span class="title class_">Logger</span>, <span class="title class_">NestInterceptor</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppInterceptor</span> <span class="keyword">implements</span> <span class="title class_">NestInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>, <span class="attr">next</span>: <span class="title class_">CallHandler</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>().</span><br><span class="line">      <span class="title function_">pipe</span>(<span class="title function_">map</span>(<span class="function"><span class="params">data</span> =&gt;</span> (&#123; data &#125;))); <span class="comment">// map操作符与Array.prototype.map类似</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>应用上述拦截器后响应数据就会被包上一层data属性。</p>
<h2 id="异常映射"><a href="#异常映射" class="headerlink" title="异常映射"></a>异常映射</h2><p>另外一个有趣的例子是利用RxJs的catchError来覆盖路由处理函数抛出的异常。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">Injectable</span>,</span><br><span class="line">  <span class="title class_">NestInterceptor</span>,</span><br><span class="line">  <span class="title class_">ExecutionContext</span>,</span><br><span class="line">  <span class="title class_">BadGatewayException</span>,</span><br><span class="line">  <span class="title class_">CallHandler</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, throwError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; catchError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ErrorsInterceptor</span> <span class="keyword">implements</span> <span class="title class_">NestInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">intercept</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>, <span class="attr">next</span>: <span class="title class_">CallHandler</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> next</span><br><span class="line">      .<span class="title function_">handle</span>()</span><br><span class="line">      .<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title function_">catchError</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="title function_">throwError</span>(<span class="keyword">new</span> <span class="title class_">BadGatewayException</span>())) <span class="comment">// catchError用来捕获异常</span></span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="重写路由函数逻辑"><a href="#重写路由函数逻辑" class="headerlink" title="重写路由函数逻辑"></a>重写路由函数逻辑</h2><p>在文章开始部分提到了拦截器可以重写路由处理函数逻辑。如下是一个缓存拦截器的例子</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">NestInterceptor</span>, <span class="title class_">ExecutionContext</span>, <span class="title class_">CallHandler</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@nestjs/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span>, <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">CacheInterceptor</span> <span class="keyword">implements</span> <span class="title class_">NestInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> cacheService: CacheService</span>) &#123;&#125;</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">async</span> <span class="title function_">intercept</span>(<span class="attr">context</span>: <span class="title class_">ExecutionContext</span>, <span class="attr">next</span>: <span class="title class_">CallHandler</span>): <span class="title class_">Observable</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  	<span class="keyword">const</span> host = context.<span class="title function_">switchToHttp</span>();</span><br><span class="line">    <span class="keyword">const</span> request = host.<span class="title function_">getRequest</span>();</span><br><span class="line">    <span class="keyword">if</span>(request.<span class="property">method</span> !== <span class="string">&#x27;GET&#x27;</span>) &#123;  </span><br><span class="line">      <span class="comment">// 非GET请求放行</span></span><br><span class="line">      <span class="keyword">return</span> next.<span class="title function_">handle</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> cachedData = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">cacheService</span>.<span class="title function_">get</span>(request.<span class="property">url</span>);</span><br><span class="line">    <span class="keyword">if</span>(cachedData) &#123; </span><br><span class="line">      <span class="comment">// 命中缓存，直接放行</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">of</span>(cachedData);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>().<span class="title function_">pipe</span>(<span class="title function_">tap</span>(response) =&gt; &#123; </span><br><span class="line">      <span class="comment">// 响应数据写入缓存，此处可以等待缓存写入完成，也可以不等待</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cacheService</span>.<span class="title function_">set</span>(request.<span class="property">method</span>, response);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>本文是NestJs基础知识的最后一篇，接下将针对特定模块进行更新，比如数据库、上传、鉴权等等。</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/categories/backend/page/3/">Zurück</a></div><div class="pagination-next"><a href="/categories/backend/page/5/">Weiter</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/categories/backend/">1</a></li><li><a class="pagination-link" href="/categories/backend/page/2/">2</a></li><li><a class="pagination-link" href="/categories/backend/page/3/">3</a></li><li><a class="pagination-link is-current" href="/categories/backend/page/4/">4</a></li><li><a class="pagination-link" href="/categories/backend/page/5/">5</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/categories/backend/page/17/">17</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://static.ddhigh.com/blog/2019-09-18-094336.jpg" alt="XiaLei"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">XiaLei</p><p class="is-size-6 is-block">Senior Software Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Tencent</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Seiten</p><a href="/archives"><p class="title">306</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Kategorien</p><a href="/categories"><p class="title">25</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">38</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/xialeistudio"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/xialeidoc/"><i class="fa-brands fa-linkedin"></i></a></div></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Learning &amp; Sharing</a><p class="is-size-7"><span>&copy; 2023 Xia Lei</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en-us");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><a id="back-to-top" title="Zurück nach oben" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "Diese Website verwendet Cookies, um Ihre Erfahrung zu verbessern.",
          dismiss: "Verstanden!",
          allow: "Cookies zulassen",
          deny: "Ablehnen",
          link: "Mehr erfahren",
          policy: "Cookie-Richtlinie",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Tippen Sie etwas..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Tippen Sie etwas...","untitled":"(Ohne Titel)","posts":"Seiten","pages":"Pages","categories":"Kategorien","tags":"Tags"});
        });</script></body></html>