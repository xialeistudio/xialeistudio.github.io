<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Engineering</title>
<meta charset=utf-8><meta name=description content="Ladder@Learning & Writing & Sharing"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/categories/engineering/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com//index.xml title="Lei Xia"><meta property="og:title" content="Engineering"><meta property="og:description" content="Learning & Writing & Sharing"><meta property="og:type" content="website"><meta property="og:url" content="https://www.ddhigh.com/categories/engineering/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Engineering"><meta name=twitter:description content="Learning & Writing & Sharing"><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.5dd042a107aa191c819948e5648b04844bec5bdd365fdcf2b880177ce3d89b79.css integrity="sha256-XdBCoQeqGRyBmUjlZIsEhEvsW902X9zyuIAXfOPYm3k=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>Books</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>Guestbook</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><div class=blog-wrapper><div><div class=blog-list><article><div class=blog-card><h3><a href=/2017/09/14/nginx-alias-root/>Nginx alias和root指令</a></h3><p><small>September 14, 2017&nbsp;· 20 words&nbsp;· One minute</small><p>Nginx的root指令相信大家用的都挺多，用来指定document_root，但是如果是针对特定path的请求才启用的话，root指令显得不好用
location /web { root /home/wwwroot/site1; } 访问 http://demo.com/web/a.js的时候,nginx会去查找*/home/wwwroot/site1/web/a.js*，一般就会404了。因为文件是放在site1目录下的。 这时候就需要alias指令了。
location /web/{ alias /home/wwwroot/site1/; } 访问 http://demo.com/web/a.js的时候,nginx会去查找*/home/wwwroot/site1/a.js*。
注意 alias location末尾斜杠以及alias的末尾斜杠</div></article><article><div class=blog-card><h3><a href=/2017/07/31/spring-boot-exclude-null/>Spring Boot JPA 返回json时排除Null字段</a></h3><p><small>July 31, 2017&nbsp;· 9 words&nbsp;· One minute</small><p>Spring Boot在返回JSON的时候默认会返回null字段，这个对客户端一般没什么作用，还会增加服务器带宽压力。使用如下配置可以屏蔽。
在pojo对象上添加注解
@JsonInclude(JsonInclude.Include.NON_NULL) class User { } 再使用@ResponseBody的时候就不会返回Null字段了。</div></article><article><div class=blog-card><h3><a href=/2017/07/31/spring-boot-pm2/>使用pm2来保证Spring Boot应用稳定运行</a></h3><p><small>July 31, 2017&nbsp;· 75 words&nbsp;· One minute</small><p>Spring Boot开发web应用就像开发普通的java程序一般简洁，因为其内嵌了web容易，启动的时候只需要一条命令java -jar server.jar即可，非常方便。 但是由此而来的问题是万一应用挂了怎么办？
别担心，有pm2进程管理工具可以帮到你。
PM2简介 pm2原先是nodejs应用的进程管理工具，不过其良好的设计以及扩展性可以手动执行执行进程。
PM2安装 安装NodeJs npm install pm2 -g PM2基本命令 pm2 list 查看所有被PM2管理的进程列表 pm2 start xxx 启动一个应用 pm2 stop xxx 停止一个应用 pm2 restart xxx 重启一个应用 pm2 describe xxx 查看应用详情 pm2 startup, pm2 save 两条命令，用来保证服务器启动时,pm2管理的程序自动运行 Java程序处理 在jar的同级目录新建应用启动配置文件，如pm2.json，内容如下：
{ "name": "my-server", "script": "/usr/bin/java", "args": [ "-jar", "server.jar" ], "exec_interpreter": "", "exec_mode": "fork" } 说明如下：
name 进程名称（显示在pm2 list命令中） script 执行进程名称，如果需要执行PHP脚本则填写php解释器的路径，本文为java args 传给执行进程的参数，多个参数以数组单元分割 exec_interpreter NodeJs解析器，本文不适用 exec_mode 执行模式[cluster|fork]这个针对NodeJs应用的配置，非NodeJs应用统一fork 配置文件完成后，使用
pm2 start pm2.</div></article><article><div class=blog-card><h3><a href=/2017/07/28/mobile-rem/>移动端rem和PSD单位换算问题</a></h3><p><small>July 28, 2017&nbsp;· 69 words&nbsp;· One minute</small><p>设计图尺寸一般750宽度，而需要兼容640宽度手机的话，需要调整缩放比率，之前使用写死viewport的做法来实现，不过这个方法有点取巧，而且有些场景并不适用。 本文用标准的@media来实现
rem定义 @media screen and (max-width: 750px) { html { font-size: 30px; } } @media screen and (min-width: 640px) and (max-width: 749px) { html { font-size: 25px; } } @media screen and (min-width: 480px) and (max-width: 639px) { html { font-size: 20px; } } @media screen and (min-width: 320px) and (max-width: 479px) { html { font-size: 15px; } } 如何使用 假设PSD中有个button的大小为100px*40px，那使用rem时CSS如下
button { width: 3.333rem; height: 1.333rem; }</div></article><article><div class=blog-card><h3><a href=/2017/07/18/spring-boot-druid-sql/>druid spring boot 统计SQL问题</a></h3><p><small>July 18, 2017&nbsp;· 46 words&nbsp;· One minute</small><p>spring-boot配置 spring.jpa.hibernate.ddl-auto=validate spring.datasource.type=com.alibaba.druid.pool.DruidDataSource spring.datasource.driver-class-name=com.mysql.jdbc.Driver spring.datasource.initialize=true spring.datasource.initialSize=5 spring.datasource.minIdle=5 spring.datasource.maxActive=10 spring.datasource.maxWait=60000 spring.datasource.timeBetweenEvictionRunsMillis=60000 spring.datasource.minEvictableIdleTimeMillis=300000 spring.datasource.validationQuery=SELECT 'x' spring.datasource.testWhileIdle=true spring.datasource.testOnBorrow=false spring.datasource.testOnReturn=false spring.datasource.poolPreparedStatements=false spring.datasource.maxPoolPreparedStatementPerConnectionSize=20 spring.datasource.filters=stat,wall,slf4j spring.datasource.connectionProperties=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000 spring.datasource.useGlobalDataSourceStat=true 这个配置没有什么好说的，网上很多，可能关键在
spring.datasource.filters=stat,wall,slf4j spring.datasource.connectionProperties=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=5000 spring.datasource.useGlobalDataSourceStat=true 但是就算配置好这些后，返回/druid也不显示SQL统计。 其实问题在于
系统默认使用的数据库连接池没有使用你的配置，所以需要我们手动实例化Bean
kotlin代码 @SpringBootApplication open class Application { @Bean @ConfigurationProperties(prefix = "spring.datasource") open fun druidDataSource(): DataSource { return DruidDataSource() }</div></article><article><div class=blog-card><h3><a href=/2017/06/24/rsa-in-node-php/>使用RSA在PHP和NodeJs中进行加密数据通信</a></h3><p><small>June 24, 2017&nbsp;· 367 words&nbsp;· 2 min</small><p>RSA算法是目前用的最多的非对称加密算法，文本将基于openssl在nodejs和php中进行加密数据通信。
生成密钥对 openssl genrsa -out private.key 2048 rsa -in private.key -pubout -out public.key 执行完命令后，可以在当前目录看到:
public.key 公钥 private.key 私钥 NodeJs服务器 本文使用koa2来构建一个基于openssl加密方案的http服务器。 源码使用typescript进行开发。
安装依赖 npm init -y npm install typescript koa koa-router @types/node @types/koa @types/koa-router --save 最终的package.json内容如下：
{ "name": "openssl-demo", "version": "1.0.0", "description": "", "main": "index.js", "scripts": { "build": "tsc -w", "start": "node index.js" }, "keywords": [], "author": "", "license": "ISC", "dependencies": { "@types/koa": "^2.0.39", "@types/koa-router": "^7.0.22", "@types/node": "^8.0.2", "koa": "^2.3.0", "koa-router": "^7.</div></article><article><div class=blog-card><h3><a href=/2017/06/13/node-unhandledrejection/>nodejs unhandledRejection问题解决</a></h3><p><small>June 13, 2017&nbsp;· 11 words&nbsp;· One minute</small><p>今天在使用promise的时候没有catch掉错误，导致报错，类似于
unhandledRejection promise .... 而且不会显示trace信息，导致无从查错，经过google发现，需要监听进程的unhandledRejection事件，才能显示trace信息
process.on('unhandledRejection', (...params) => { console.log(params); });</div></article><article><div class=blog-card><h3><a href=/2017/05/24/nginx-proxy-websocket-cors/>nginx反向代理websocket支持跨域</a></h3><p><small>May 24, 2017&nbsp;· 56 words&nbsp;· One minute</small><p>今天在调试远程websocket的时候发现控制台提示跨域错误，看到浏览器Network中方向响应头没有跨域方面的数据。
nginx做websocket反向代理挺简单的
proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade"; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $host; proxy_http_version 1.1; proxy_pass http://socket服务器地址; 但是如此配置除非后端服务器支持跨域，否则socket无法跨域。 其实nginx支持的add_header指令已经可以添加跨域相关头了
完整配置如下
add_header "Access-Control-Allow-Origin" "$http_origin"; add_header "Access-Control-Allow-Credentials" "true"; add_header "Access-Control-Allow-Methods" "GET, POST, OPTIONS, DELETE, PATCH, PUT, HEAD"; add_header "Access-Control-Allow-Headers" "DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type"; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade"; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header Host $host; proxy_http_version 1.1; proxy_pass http://socket服务器地址; 再看到浏览器响应头时发现已经成功返回跨域头了。</div></article><article><div class=blog-card><h3><a href=/2017/05/12/yii2-memcached-qcloud-not-expires/>Yii2框架MemCache在腾讯云部署时不过期问题</a></h3><p><small>May 12, 2017&nbsp;· 1278 words&nbsp;· 6 min</small><p>之前部署在阿里云时一直memcache没有问题，部署到腾讯云发现缓存永不过期。查看yii2的MemCache类源码后，发现在设置缓存时，Yii2添加了$expire = $duration > 0 ? $duration + time() :0;这样的代码，会导致强制使用时间戳来标记过期时间，而阿里云是过期时间和时间戳都支持的，腾讯云只支持前者。
解决方案 重写组件即可 在app\components中加添加MemCache集成Yii2的MemCache，由于Yii2的MemCache中$_cache成员变量为private，子类无法访问，所以需要直接copy源码：
&lt;?php /** * Created by PhpStorm. * User: xialei * Date: 2017/5/12 * Time: 下午5:55 */ namespace app\components; use yii\base\InvalidConfigException; use yii\caching\MemCacheServer; class MemCache extends \yii\caching\MemCache { /** * @var bool whether to use memcached or memcache as the underlying caching extension. * If true, [memcached](http://pecl.php.net/package/memcached) will be used. * If false, [memcache](http://pecl.php.net/package/memcache) will be used. * Defaults to false.</div></article><article><div class=blog-card><h3><a href=/2017/04/27/log4php-syslog/>log4php使用syslog记录日志</a></h3><p><small>April 27, 2017&nbsp;· 58 words&nbsp;· One minute</small><p>log4php是apache基金会下的一个开源项目，灵活、强大，已经有几个项目使用了log4php处理日志，目前遇到的问题是服务器太多的时候日志如何统一管理，本来想使用数据库存储。但是日志格式成了一个问题，而且不利于扩展，如果临时需要保存到文件，又要更改log4php的配置。 好在log4php提供了syslog的一个appender，可以将日志写入syslog;
log4php配置 log4php.rootLogger=INFO, stdout, stderr log4php.appender.stdout=LoggerAppenderConsole log4php.appender.stdout.layout=LoggerLayoutPattern log4php.appender.stdout.layout.ConversionPattern=%date{Y-m-d H:i:s} [%-5p] %m%n log4php.appender.stdout.threshold=INFO log4php.appender.stderr=LoggerAppenderSyslog log4php.appender.stderr.ident=qun.hk-task log4php.appender.stderr.priority=ERR log4php.appender.stderr.facility=LOCAL0 log4php.appender.stderr.layout=LoggerLayoutPattern log4php.appender.stderr.layout.ConversionPattern=%date{Y-m-d H:i:s} %m%n log4php.appender.stderr.threshold=WARN 这里使用两个输出目的地,stdout输出到终端，stderr输出到syslod，log4php配置对应rsyslog的配置关系为：
ident -> syslog中的tag priority -> syslog中的priority facility -> syslog中的facility，请注意全部为大写 rsyslog配置 rsyslog配置文件一般在 /etc/rsyslog.conf 以及 /etc/rsyslog.d目录下 我们不更改主配置文件，在*/etc/rsyslog.d/*目录下新建文件
vim local0.conf
内容为
local0.* /var/log/local0.log
rsyslog输出可以写成服务器，本文为了测试直接写入文件，有需要的可以根据实际情况进行转发。重启rsyslog
service rsyslog restart
PHP加载配置 &lt;?php \Logger::configure(__DIR__ . '/log4php.properties'); $logger = \Logger::getLogger('default'); $logger->info('info'); $logger->error('error'); 可以看到*/var/log/local0.log中多出一行error*的日志</div></article></div><div class=paginator><a class=prev href=/categories/engineering/page/13/>&larr;&nbsp;&nbsp;Pre Page</a>
<a class=next href=/categories/engineering/page/15/>Next Page&nbsp;&nbsp;&rarr;</a></div></div></div></div><footer class=footer><p>&copy; 2014 - 2024 <a href=https://www.ddhigh.com/>Lei Xia</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-EC3XLVSGKV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EC3XLVSGKV")</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>