<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>golang依赖注入工具wire指南</title>
<meta charset=utf-8><meta name=description content='Ladder@wire与依赖注入 Wire 是一个的Golang依赖注入工具，通过自动生成代码的方式在编译期完成依赖注入，Java体系中最出名的Spring框架采用运行时注入，个人认为这是wire和其他依赖注入最大的不同之处。
依赖注入(Dependency Injection)也称作控制反转(Inversion of Control)，个人给控制反转下的定义如下：
当前对象需要的依赖对象由外部提供（通常是IoC容器），外部负责依赖对象的构造等操作，当前对象只负责调用，而不关心依赖对象的构造。即依赖对象的控制权交给了IoC容器。
下面给出一个控制反转的示例，比如我们通过配置去创建一个数据库连接：
// 连接配置 type DatabaseConfig struct { Dsn string } func NewDB(config *DatabaseConfig)(*sql.DB, error) { db,err := sql.Open("mysql", config.Dsn) if err != nil { return nil, err } // ... } fun NewConfig()(*DatabaseConfig,error) { // 读取配置文件 fp, err := os.Open("config.json") if err != nil { return nil,err } defer fp.Close() // 解析为Json var config DatabaseConfig if err:=json.NewDecoder(fp).Decode(&amp;config);err!=nil { return nil,err } return &amp;config, nil } func InitDatabase() { cfg, err:=NewConfig() if err!'><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/2021/02/06/go-wire-tutorial/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com//index.xml title="Lei Xia"><script async defer data-website-id=865c8529-0729-4cf5-88a9-448616abbcbb src=https://umami-beta-peach.vercel.app/xialeistudio></script><meta property="og:title" content="golang依赖注入工具wire指南"><meta property="og:description" content='wire与依赖注入 Wire 是一个的Golang依赖注入工具，通过自动生成代码的方式在编译期完成依赖注入，Java体系中最出名的Spring框架采用运行时注入，个人认为这是wire和其他依赖注入最大的不同之处。
依赖注入(Dependency Injection)也称作控制反转(Inversion of Control)，个人给控制反转下的定义如下：
当前对象需要的依赖对象由外部提供（通常是IoC容器），外部负责依赖对象的构造等操作，当前对象只负责调用，而不关心依赖对象的构造。即依赖对象的控制权交给了IoC容器。
下面给出一个控制反转的示例，比如我们通过配置去创建一个数据库连接：
// 连接配置 type DatabaseConfig struct { Dsn string } func NewDB(config *DatabaseConfig)(*sql.DB, error) { db,err := sql.Open("mysql", config.Dsn) if err != nil { return nil, err } // ... } fun NewConfig()(*DatabaseConfig,error) { // 读取配置文件 fp, err := os.Open("config.json") if err != nil { return nil,err } defer fp.Close() // 解析为Json var config DatabaseConfig if err:=json.NewDecoder(fp).Decode(&amp;config);err!=nil { return nil,err } return &amp;config, nil } func InitDatabase() { cfg, err:=NewConfig() if err!'><meta property="og:type" content="article"><meta property="og:url" content="https://www.ddhigh.com/2021/02/06/go-wire-tutorial/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-06T20:27:14+00:00"><meta property="article:modified_time" content="2021-02-06T20:27:14+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="golang依赖注入工具wire指南"><meta name=twitter:description content='wire与依赖注入 Wire 是一个的Golang依赖注入工具，通过自动生成代码的方式在编译期完成依赖注入，Java体系中最出名的Spring框架采用运行时注入，个人认为这是wire和其他依赖注入最大的不同之处。
依赖注入(Dependency Injection)也称作控制反转(Inversion of Control)，个人给控制反转下的定义如下：
当前对象需要的依赖对象由外部提供（通常是IoC容器），外部负责依赖对象的构造等操作，当前对象只负责调用，而不关心依赖对象的构造。即依赖对象的控制权交给了IoC容器。
下面给出一个控制反转的示例，比如我们通过配置去创建一个数据库连接：
// 连接配置 type DatabaseConfig struct { Dsn string } func NewDB(config *DatabaseConfig)(*sql.DB, error) { db,err := sql.Open("mysql", config.Dsn) if err != nil { return nil, err } // ... } fun NewConfig()(*DatabaseConfig,error) { // 读取配置文件 fp, err := os.Open("config.json") if err != nil { return nil,err } defer fp.Close() // 解析为Json var config DatabaseConfig if err:=json.NewDecoder(fp).Decode(&amp;config);err!=nil { return nil,err } return &amp;config, nil } func InitDatabase() { cfg, err:=NewConfig() if err!'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.ddhigh.com/posts/"},{"@type":"ListItem","position":2,"name":"golang依赖注入工具wire指南","item":"https://www.ddhigh.com/2021/02/06/go-wire-tutorial/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"golang依赖注入工具wire指南","name":"golang依赖注入工具wire指南","description":"wire与依赖注入 Wire 是一个的Golang依赖注入工具，通过自动生成代码的方式在编译期完成依赖注入，Java体系中最出名的Spring框架采用运行时注入，个人认为这是wire和其他依赖注入最大的不同之处。\n依赖注入(Dependency Injection)也称作控制反转(Inversion of Control)，个人给控制反转下的定义如下：\n当前对象需要的依赖对象由外部提供（通常是IoC容器），外部负责依赖对象的构造等操作，当前对象只负责调用，而不关心依赖对象的构造。即依赖对象的控制权交给了IoC容器。\n下面给出一个控制反转的示例，比如我们通过配置去创建一个数据库连接：\n// 连接配置 type DatabaseConfig struct { Dsn string } func NewDB(config *DatabaseConfig)(*sql.DB, error) { db,err := sql.Open(\u0026#34;mysql\u0026#34;, config.Dsn) if err != nil { return nil, err } // ... } fun NewConfig()(*DatabaseConfig,error) { // 读取配置文件 fp, err := os.Open(\u0026#34;config.json\u0026#34;) if err != nil { return nil,err } defer fp.Close() // 解析为Json var config DatabaseConfig if err:=json.NewDecoder(fp).Decode(\u0026amp;config);err!=nil { return nil,err } return \u0026amp;config, nil } func InitDatabase() { cfg, err:=NewConfig() if err!","keywords":[],"articleBody":"wire与依赖注入 Wire 是一个的Golang依赖注入工具，通过自动生成代码的方式在编译期完成依赖注入，Java体系中最出名的Spring框架采用运行时注入，个人认为这是wire和其他依赖注入最大的不同之处。\n依赖注入(Dependency Injection)也称作控制反转(Inversion of Control)，个人给控制反转下的定义如下：\n当前对象需要的依赖对象由外部提供（通常是IoC容器），外部负责依赖对象的构造等操作，当前对象只负责调用，而不关心依赖对象的构造。即依赖对象的控制权交给了IoC容器。\n下面给出一个控制反转的示例，比如我们通过配置去创建一个数据库连接：\n// 连接配置 type DatabaseConfig struct { Dsn string } func NewDB(config *DatabaseConfig)(*sql.DB, error) { db,err := sql.Open(\"mysql\", config.Dsn) if err != nil { return nil, err } // ... } fun NewConfig()(*DatabaseConfig,error) { // 读取配置文件 fp, err := os.Open(\"config.json\") if err != nil { return nil,err } defer fp.Close() // 解析为Json var config DatabaseConfig if err:=json.NewDecoder(fp).Decode(\u0026config);err!=nil { return nil,err } return \u0026config, nil } func InitDatabase() { cfg, err:=NewConfig() if err!=nil { log.Fatal(err) } db,err:=NewDB(cfg) if err!=nil { log.Fatail(err) } // db对象构造完毕 } 数据库配置怎么来的，NewDB方法并不关心(示例代码采用的是NewConfig提供的JSON配置对象)，NewDB只负责创建DB对象并返回，和配置方式并没有耦合，所以即使换成配置中心或者其他方式来提供配置，NewDB代码也无需更改，这就是控制反转的魔力！\n来看一个反面例子，也就是控制正转：\n当前对象需要的依赖由自己创建，即依赖对象的控制权在当前对象自己手里。\ntype DatabaseConfig struct { Dsn string } func NewDB()(*sql.DB, error) { // 读取配置文件 fp, err := os.Open(\"config.json\") if err != nil { return nil,err } defer fp.Close() // 解析为Json var config DatabaseConfig if err:=json.NewDecoder(fp).Decode(\u0026config);err!=nil { return nil,err } // 初始化数据库连接 db,err = sql.Open(\"mysql\", config.Dsn) if err != nil { return } // ... } 在控制正转模式下，NewDB方法需要自己实现配置对象的创建工作，在示例中需要读取Json配置文件，这是强耦合的代码，一旦配置文件的格式不是Json，NewDB方法将返回错误。\n依赖注入固然好用，但是像刚才的例子中去手动管理依赖关系是相当复杂也是相当痛苦的一件事，因此在接下来的内容中会重点介绍golang的依赖注入工具——wire。\n上手使用 通过go get github.com/google/wire/cmd/wire安装好wire命令行工具即可。\n在正式开始之前需要介绍一下wire中的两个概念：Provider和Injector：\nProvider：负责创建对象的方法，比如上文中控制反转示例的NewDB(提供DB对象)和NewConfig(提供DatabaseConfig对象)方法。 Injector：负责根据对象的依赖，依次构造依赖对象，最终构造目的对象的方法，比如上文中控制反转示例的InitDatabase方法。 现在我们通过wire来实现一个简单的项目。项目结构如下：\n|--cmd |--main.go |--wire.go |--config |--app.json |--internal |--config |--config.go |--db |--db.go config/app.json\n{ \"database\": { \"dsn\": \"root:root@tcp(localhost:3306)/test\" } } internal/config/config.go\npackage config import ( \"encoding/json\" \"github.com/google/wire\" \"os\" ) var Provider = wire.NewSet(New) // 将New方法声明为Provider，表示New方法可以创建一个被别人依赖的对象,也就是Config对象 type Config struct { Database database `json:\"database\"` } type database struct { Dsn string `json:\"dsn\"` } func New() (*Config, error) { fp, err := os.Open(\"config/app.json\") if err != nil { return nil, err } defer fp.Close() var cfg Config if err := json.NewDecoder(fp).Decode(\u0026cfg); err != nil { return nil, err } return \u0026cfg, nil } internal/db/db.go\npackage db import ( \"database/sql\" _ \"github.com/go-sql-driver/mysql\" \"github.com/google/wire\" \"wire-example2/internal/config\" ) var Provider = wire.NewSet(New) // 同理 func New(cfg *config.Config) (db *sql.DB, err error) { db, err = sql.Open(\"mysql\", cfg.Database.Dsn) if err != nil { return } if err = db.Ping(); err != nil { return } return db, nil } cmd/main.go\npackage main import ( \"database/sql\" \"log\" ) type App struct { // 最终需要的对象 db *sql.DB } func NewApp(db *sql.DB) *App { return \u0026App{db: db} } func main() { app, err := InitApp() // 使用wire生成的injector方法获取app对象 if err != nil { log.Fatal(err) } var version string row := app.db.QueryRow(\"SELECT VERSION()\") if err := row.Scan(\u0026version); err != nil { log.Fatal(err) } log.Println(version) } cmd/wire.go\n重点文件，也就是实现Injector的核心所在：\n// +build wireinject package main import ( \"github.com/google/wire\" \"wire-example2/internal/config\" \"wire-example2/internal/db\" ) func InitApp() (*App, error) { panic(wire.Build(config.Provider, db.Provider, NewApp)) // 调用wire.Build方法传入所有的依赖对象以及构建最终对象的函数得到目标对象 } 文件编写完毕，进入cmd目录执行wire命令会得到以下输出：\nC:\\Users\\Administrator\\GolandProjects\\wire-example2\\cmd\u003ewire wire: wire-example2/cmd: wrote C:\\Users\\Administrator\\GolandProjects\\wire-example2\\cmd\\wire_gen.go 表明成功生成wire_gen.go文件，文件内容如下：\n// Code generated by Wire. DO NOT EDIT. //go:generate go run github.com/google/wire/cmd/wire //+build !wireinject package main import ( \"wire-example2/internal/config\" \"wire-example2/internal/db\" ) // Injectors from wire.go: func InitApp() (*App, error) { configConfig, err := config.New() if err != nil { return nil, err } sqlDB, err := db.New(configConfig) if err != nil { return nil, err } app := NewApp(sqlDB) return app, nil } 可以看到生成App对象的代码已经自动生成了。\nProvider说明 通过NewSet方法将本包内创建对象的方法声明为Provider以供其他对象使用。NewSet可以接收多个参数，比如我们db包内可以创建Mysql和Redis连接对象，则可以如下声明：\nvar Provider = wire.NewSet(NewDB, NewRedis) func NewDB(config *Config)(*sql.DB,error) { // 创建数据库对象 } func NewRedis(config *Config)(*redis.Client,error) { // 创建Redis对象 } wire.go文件说明 wire.go文件需要放在创建目标对象的地方，比如我们Config和DB对象最终是为App服务的，因此wire.go文件需要放在App所在的包内。\nwire.go文件名不是固定的，不过大家习惯叫这个文件名。\nwire.go的第一行// +build wireinject是必须的，含义如下：\n只有添加了名称为\"wireinject\"的build tag，本文件才会编译，而我们go build main.go的时候通常不会加。因此，该文件不会参与最终编译。\nwire.Build(config.Provider, db.Provider, NewApp)通过传入config以及db对象来创建最终需要的App对象\nwire_gen.go文件说明 该文件由wire自动生成，无需手工编辑！！！\n//+build !wireinject标签和wire.go文件的标签相对应，含义如下：\n编译时只有未添加“wireinject\"的build tag，本文件才参与编译。\n因此，任意时刻下，wire.go和wire_gen.go只会有一个参与编译。\n高级玩法 cleanup函数 在创建依赖资源时，如果由某个资源创建失败，那么其他资源需要关闭的情况下，可以使用cleanup函数来关闭资源。比如咱们给db.New方法返回一个cleanup函数来关闭数据库连接，相关代码修改如下(未列出的代码不修改)：\ninternal/db/db.go\nfunc New(cfg *config.Config) (db *sql.DB, cleanup func(), err error) { // 声明第二个返回值 db, err = sql.Open(\"mysql\", cfg.Database.Dsn) if err != nil { return } if err = db.Ping(); err != nil { return } cleanup = func() { // cleanup函数中关闭数据库连接 db.Close() } return db, cleanup, nil } cmd/wire.go\nfunc InitApp() (*App, func(), error) { // 声明第二个返回值 panic(wire.Build(config.Provider, db.Provider, NewApp)) } cmd/main.go\nfunc main() { app, cleanup, err := InitApp() // 添加第二个参数 if err != nil { log.Fatal(err) } defer cleanup() // 延迟调用cleanup关闭资源 var version string row := app.db.QueryRow(\"SELECT VERSION()\") if err := row.Scan(\u0026version); err != nil { log.Fatal(err) } log.Println(version) } 重新在cmd目录执行wire命令，生成的wire_gen.go如下：\nfunc InitApp() (*App, func(), error) { configConfig, err := config.New() if err != nil { return nil, nil, err } sqlDB, cleanup, err := db.New(configConfig) if err != nil { return nil, nil, err } app := NewApp(sqlDB) return app, func() { // 返回了清理函数 cleanup() }, nil } 接口绑定 在面向接口编程中，代码依赖的往往是接口，而不是具体的struct，此时依赖注入相关代码需要做一点小小的修改，继续刚才的例子，示例修改如下：\n新增internal/db/dao.go\npackage db import \"database/sql\" type Dao interface { // 接口声明 Version() (string, error) } type dao struct { // 默认实现 db *sql.DB } func (d dao) Version() (string, error) { var version string row := d.db.QueryRow(\"SELECT VERSION()\") if err := row.Scan(\u0026version); err != nil { return \"\", err } return version, nil } func NewDao(db *sql.DB) *dao { // 生成dao对象的方法 return \u0026dao{db: db} } internal/db/db.go也需要修改Provider，增加NewDao声明:\nvar Provider = wire.NewSet(New, NewDao) cmd/main.go文件修改：\npackage main import ( \"log\" \"wire-example2/internal/db\" ) type App struct { dao db.Dao // 依赖Dao接口 } func NewApp(dao db.Dao) *App { // 依赖Dao接口 return \u0026App{dao: dao} } func main() { app, cleanup, err := InitApp() if err != nil { log.Fatal(err) } defer cleanup() version, err := app.dao.Version() // 调用Dao接口方法 if err != nil { log.Fatal(err) } log.Println(version) } 进入cmd目录执行wire命令，此时会出现报错：\nC:\\Users\\Administrator\\GolandProjects\\wire-example2\\cmd\u003ewire wire: C:\\Users\\Administrator\\GolandProjects\\wire-example2\\cmd\\wire.go:11:1: inject InitApp: no provider found for wire-example2/internal/db.Dao needed by *wire-example2/cmd.App in provider \"NewApp\" (C:\\Users\\Administrator\\GolandProjects\\wire-example2\\cmd\\main.go:12:6) wire: wire-example2/cmd: generate failed wire: at least one generate failure wire提示inject InitApp: no provider found for wire-example2/internal/db.Dao，也就是没找到能提供db.Dao对象的Provider，咱们不是提供了默认的db.dao实现也注册了Provider吗？这也是go的OOP设计奇特之处。\n咱们修改一下internal/db/db.go的Provider声明，增加db.*dao和db.Dao的接口绑定关系:\nvar Provider = wire.NewSet(New, NewDao, wire.Bind(new(Dao), new(*dao))) wire.Bind()方法第一个参数为interface{}，第二个参数为实现。\n此时再执行wire命令就可以成功了！\n结尾 wire工具还有很多玩法，但是就笔者个人工作经验而言，掌握本文介绍到的知识已经能够胜任绝大部分场景了！\n","wordCount":"829","inLanguage":"en","datePublished":"2021-02-06T20:27:14Z","dateModified":"2021-02-06T20:27:14Z","author":{"@type":"Person","name":"Lei Xia"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com/2021/02/06/go-wire-tutorial/"},"publisher":{"@type":"Organization","name":"Lei Xia","logo":{"@type":"ImageObject","url":"https://www.ddhigh.com/favicon.ico"}}}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.4e70a7c9d7285fdcae5fdaeeddd5999441d33a8b2c4f360cdbff862671a3c49c.css integrity="sha256-TnCnydcoX9yuX9ru3dWZlEHTOossTzYM2/+GJnGjxJw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>Books</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>Guestbook</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>golang依赖注入工具wire指南</h1></header><p><small>February 6, 2021&nbsp;· 829 words&nbsp;· 4 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#wire与依赖注入>wire与依赖注入</a></li><li><a href=#上手使用>上手使用</a><ul><li><a href=#provider说明>Provider说明</a></li><li><a href=#wirego文件说明>wire.go文件说明</a></li><li><a href=#wire_gengo文件说明>wire_gen.go文件说明</a></li></ul></li><li><a href=#高级玩法>高级玩法</a><ul><li><a href=#cleanup函数>cleanup函数</a></li><li><a href=#接口绑定>接口绑定</a></li></ul></li><li><a href=#结尾>结尾</a></li></ul></nav></div><section class=blog-content><h2 id=wire与依赖注入>wire与依赖注入</h2><p><a href=https://github.com/google/wire target=_blank rel=noopener>Wire</a> 是一个的Golang依赖注入工具，通过自动生成代码的方式在<strong>编译期</strong>完成依赖注入，Java体系中最出名的<strong>Spring</strong>框架采用<strong>运行时</strong>注入，个人认为这是wire和其他依赖注入最大的不同之处。</p><p>依赖注入(Dependency Injection)也称作控制反转(Inversion of Control)，个人给控制反转下的定义如下：</p><blockquote><p>当前对象需要的依赖对象由外部提供（通常是IoC容器），外部负责依赖对象的构造等操作，当前对象只负责调用，而不关心依赖对象的构造。即依赖对象的控制权交给了IoC容器。</p></blockquote><p>下面给出一个控制反转的示例，比如我们通过配置去创建一个数据库连接：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 连接配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DatabaseConfig</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Dsn</span> <span style=color:#66d9ef>string</span> 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDB</span>(<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DatabaseConfig</span>)(<span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>,<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;mysql&#34;</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Dsn</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fun</span> <span style=color:#a6e22e>NewConfig</span>()(<span style=color:#f92672>*</span><span style=color:#a6e22e>DatabaseConfig</span>,<span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取配置文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;config.json&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>,<span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fp</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 解析为Json
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>config</span> <span style=color:#a6e22e>DatabaseConfig</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span><span style=color:#f92672>:=</span><span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>fp</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>config</span>);<span style=color:#a6e22e>err</span><span style=color:#f92672>!=</span><span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>,<span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>config</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitDatabase</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span><span style=color:#f92672>:=</span><span style=color:#a6e22e>NewConfig</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span><span style=color:#f92672>!=</span><span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>,<span style=color:#a6e22e>err</span><span style=color:#f92672>:=</span><span style=color:#a6e22e>NewDB</span>(<span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span><span style=color:#f92672>!=</span><span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatail</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// db对象构造完毕
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>数据库配置怎么来的，<code>NewDB</code>方法并不关心(示例代码采用的是<code>NewConfig</code>提供的JSON配置对象)，<code>NewDB</code>只负责创建DB对象并返回，和配置方式并没有耦合，所以即使换成配置中心或者其他方式来提供配置，<code>NewDB</code>代码也无需更改，这就是控制反转的魔力！</p><p>来看一个反面例子，也就是控制正转：</p><blockquote><p>当前对象需要的依赖由自己创建，即依赖对象的控制权在当前对象自己手里。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DatabaseConfig</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Dsn</span> <span style=color:#66d9ef>string</span> 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDB</span>()(<span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 读取配置文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;config.json&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>,<span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fp</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 解析为Json
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>config</span> <span style=color:#a6e22e>DatabaseConfig</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span><span style=color:#f92672>:=</span><span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>fp</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>config</span>);<span style=color:#a6e22e>err</span><span style=color:#f92672>!=</span><span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>,<span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化数据库连接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>db</span>,<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;mysql&#34;</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Dsn</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>在控制正转模式下，<code>NewDB</code>方法需要自己实现配置对象的创建工作，在示例中需要读取Json配置文件，这是<strong>强耦合</strong>的代码，一旦配置文件的格式不是Json，<code>NewDB</code>方法将返回错误。</p><p>依赖注入固然好用，但是像刚才的例子中去手动管理依赖关系是相当复杂也是相当痛苦的一件事，因此在接下来的内容中会重点介绍golang的依赖注入工具——wire。</p><h2 id=上手使用>上手使用</h2><p>通过<code>go get github.com/google/wire/cmd/wire</code>安装好<code>wire</code>命令行工具即可。</p><p>在正式开始之前需要介绍一下wire中的两个概念：<code>Provider</code>和<code>Injector</code>：</p><ul><li><code>Provider</code>：负责创建对象的方法，比如上文中<code>控制反转示例</code>的<code>NewDB</code>(提供DB对象)和<code>NewConfig</code>(提供DatabaseConfig对象)方法。</li><li><code>Injector</code>：负责根据对象的依赖，依次构造依赖对象，最终构造目的对象的方法，比如上文中<code>控制反转示例</code>的<code>InitDatabase</code>方法。</li></ul><p>现在我们通过<code>wire</code>来实现一个简单的项目。项目结构如下：</p><pre tabindex=0><code>|--cmd
	|--main.go
	|--wire.go
|--config
	|--app.json
|--internal
	|--config
		|--config.go
	|--db
		|--db.go
</code></pre><p>config/app.json</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;database&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;dsn&#34;</span>: <span style=color:#e6db74>&#34;root:root@tcp(localhost:3306)/test&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>internal/config/config.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>config</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/google/wire&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Provider</span> = <span style=color:#a6e22e>wire</span>.<span style=color:#a6e22e>NewSet</span>(<span style=color:#a6e22e>New</span>) <span style=color:#75715e>// 将New方法声明为Provider，表示New方法可以创建一个被别人依赖的对象,也就是Config对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Config</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Database</span> <span style=color:#a6e22e>database</span> <span style=color:#e6db74>`json:&#34;database&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>database</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Dsn</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;dsn&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>Config</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;config/app.json&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fp</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>Config</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>fp</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cfg</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>cfg</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>internal/db/db.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>db</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;database/sql&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/google/wire&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;wire-example2/internal/config&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Provider</span> = <span style=color:#a6e22e>wire</span>.<span style=color:#a6e22e>NewSet</span>(<span style=color:#a6e22e>New</span>) <span style=color:#75715e>// 同理
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Config</span>) (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;mysql&#34;</span>, <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Database</span>.<span style=color:#a6e22e>Dsn</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Ping</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>cmd/main.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;database/sql&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>App</span> <span style=color:#66d9ef>struct</span> { <span style=color:#75715e>// 最终需要的对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewApp</span>(<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>App</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>App</span>{<span style=color:#a6e22e>db</span>: <span style=color:#a6e22e>db</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>app</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>InitApp</span>() <span style=color:#75715e>// 使用wire生成的injector方法获取app对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>row</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>QueryRow</span>(<span style=color:#e6db74>&#34;SELECT VERSION()&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>Scan</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>version</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>version</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>cmd/wire.go</p><p>重点文件，也就是实现Injector的核心所在：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// +build wireinject
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/google/wire&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;wire-example2/internal/config&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;wire-example2/internal/db&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitApp</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>App</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	panic(<span style=color:#a6e22e>wire</span>.<span style=color:#a6e22e>Build</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Provider</span>, <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Provider</span>, <span style=color:#a6e22e>NewApp</span>)) <span style=color:#75715e>// 调用wire.Build方法传入所有的依赖对象以及构建最终对象的函数得到目标对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>文件编写完毕，进入<code>cmd</code>目录执行<code>wire</code>命令会得到以下输出：</p><pre tabindex=0><code>C:\Users\Administrator\GolandProjects\wire-example2\cmd&gt;wire
wire: wire-example2/cmd: wrote C:\Users\Administrator\GolandProjects\wire-example2\cmd\wire_gen.go
</code></pre><p>表明成功生成<code>wire_gen.go</code>文件，文件内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Code generated by Wire. DO NOT EDIT.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//go:generate go run github.com/google/wire/cmd/wire
</span></span></span><span style=display:flex><span><span style=color:#75715e>//+build !wireinject
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;wire-example2/internal/config&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;wire-example2/internal/db&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Injectors from wire.go:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitApp</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>App</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>configConfig</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sqlDB</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>configConfig</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>app</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewApp</span>(<span style=color:#a6e22e>sqlDB</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>app</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到生成App对象的代码已经自动生成了。</p><h3 id=provider说明>Provider说明</h3><p>通过<code>NewSet</code>方法将本包内创建对象的方法声明为<code>Provider</code>以供其他对象使用。<code>NewSet</code>可以接收多个参数，比如我们<code>db</code>包内可以创建Mysql和Redis连接对象，则可以如下声明：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Provider</span> = <span style=color:#a6e22e>wire</span>.<span style=color:#a6e22e>NewSet</span>(<span style=color:#a6e22e>NewDB</span>, <span style=color:#a6e22e>NewRedis</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDB</span>(<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Config</span>)(<span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>,<span style=color:#66d9ef>error</span>) { <span style=color:#75715e>// 创建数据库对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRedis</span>(<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Config</span>)(<span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>,<span style=color:#66d9ef>error</span>) { <span style=color:#75715e>// 创建Redis对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h3 id=wirego文件说明>wire.go文件说明</h3><p><code>wire.go</code>文件需要放在创建目标对象的地方，比如我们<code>Config</code>和<code>DB</code>对象最终是为<code>App</code>服务的，因此<code>wire.go</code>文件需要放在<code>App</code>所在的包内。</p><blockquote><p>wire.go文件名不是固定的，不过大家习惯叫这个文件名。</p></blockquote><p><code>wire.go</code>的第一行<code>// +build wireinject</code>是必须的，含义如下：</p><blockquote><p>只有添加了名称为"wireinject"的build tag，本文件才会编译，而我们go build main.go的时候通常不会加。因此，该文件不会参与最终编译。</p></blockquote><p><code>wire.Build(config.Provider, db.Provider, NewApp)</code>通过传入<code>config</code>以及<code>db</code>对象来创建最终需要的<code>App</code>对象</p><h3 id=wire_gengo文件说明>wire_gen.go文件说明</h3><p>该文件由<code>wire</code>自动生成，无需手工编辑！！！</p><p><code>//+build !wireinject</code>标签和<code>wire.go</code>文件的标签相对应，含义如下：</p><blockquote><p>编译时只有<strong>未添加</strong>&ldquo;wireinject"的build tag，本文件才参与编译。</p></blockquote><p>因此，任意时刻下，<code>wire.go</code>和<code>wire_gen.go</code>只会有一个参与编译。</p><h2 id=高级玩法>高级玩法</h2><h3 id=cleanup函数>cleanup函数</h3><p>在创建依赖资源时，如果由某个资源创建失败，那么其他资源需要关闭的情况下，可以使用cleanup函数来关闭资源。比如咱们给<code>db.New</code>方法返回一个<code>cleanup</code>函数来关闭数据库连接，相关代码修改如下(未列出的代码不修改)：</p><p>internal/db/db.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>cfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Config</span>) (<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>, <span style=color:#a6e22e>cleanup</span> <span style=color:#66d9ef>func</span>(), <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) { <span style=color:#75715e>// 声明第二个返回值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;mysql&#34;</span>, <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Database</span>.<span style=color:#a6e22e>Dsn</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Ping</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>cleanup</span> = <span style=color:#66d9ef>func</span>() { <span style=color:#75715e>// cleanup函数中关闭数据库连接
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>cleanup</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>cmd/wire.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitApp</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>App</span>, <span style=color:#66d9ef>func</span>(), <span style=color:#66d9ef>error</span>) { <span style=color:#75715e>// 声明第二个返回值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	panic(<span style=color:#a6e22e>wire</span>.<span style=color:#a6e22e>Build</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Provider</span>, <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Provider</span>, <span style=color:#a6e22e>NewApp</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>cmd/main.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>app</span>, <span style=color:#a6e22e>cleanup</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>InitApp</span>() <span style=color:#75715e>// 添加第二个参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cleanup</span>() <span style=color:#75715e>// 延迟调用cleanup关闭资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>row</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>QueryRow</span>(<span style=color:#e6db74>&#34;SELECT VERSION()&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>Scan</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>version</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>version</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>重新在cmd目录执行<code>wire</code>命令，生成的<code>wire_gen.go</code>如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>InitApp</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>App</span>, <span style=color:#66d9ef>func</span>(), <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>configConfig</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>New</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sqlDB</span>, <span style=color:#a6e22e>cleanup</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>configConfig</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>app</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewApp</span>(<span style=color:#a6e22e>sqlDB</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>app</span>, <span style=color:#66d9ef>func</span>() { <span style=color:#75715e>// 返回了清理函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>cleanup</span>()
</span></span><span style=display:flex><span>	}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=接口绑定>接口绑定</h3><p>在面向接口编程中，代码依赖的往往是接口，而不是具体的struct，此时依赖注入相关代码需要做一点小小的修改，继续刚才的例子，示例修改如下：</p><p>新增<code>internal/db/dao.go</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>db</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;database/sql&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Dao</span> <span style=color:#66d9ef>interface</span> { <span style=color:#75715e>// 接口声明
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>Version</span>() (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>dao</span> <span style=color:#66d9ef>struct</span> { <span style=color:#75715e>// 默认实现
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#a6e22e>dao</span>) <span style=color:#a6e22e>Version</span>() (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>version</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>row</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>QueryRow</span>(<span style=color:#e6db74>&#34;SELECT VERSION()&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>row</span>.<span style=color:#a6e22e>Scan</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>version</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>version</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDao</span>(<span style=color:#a6e22e>db</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sql</span>.<span style=color:#a6e22e>DB</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>dao</span> { <span style=color:#75715e>// 生成dao对象的方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>dao</span>{<span style=color:#a6e22e>db</span>: <span style=color:#a6e22e>db</span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>internal/db/db.go也需要修改Provider，增加<code>NewDao</code>声明:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Provider</span> = <span style=color:#a6e22e>wire</span>.<span style=color:#a6e22e>NewSet</span>(<span style=color:#a6e22e>New</span>, <span style=color:#a6e22e>NewDao</span>)
</span></span></code></pre></div><p>cmd/main.go文件修改：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;wire-example2/internal/db&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>App</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>dao</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Dao</span> <span style=color:#75715e>// 依赖Dao接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewApp</span>(<span style=color:#a6e22e>dao</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Dao</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>App</span> { <span style=color:#75715e>// 依赖Dao接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>App</span>{<span style=color:#a6e22e>dao</span>: <span style=color:#a6e22e>dao</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>app</span>, <span style=color:#a6e22e>cleanup</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>InitApp</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cleanup</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>version</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>dao</span>.<span style=color:#a6e22e>Version</span>() <span style=color:#75715e>// 调用Dao接口方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>version</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>进入cmd目录执行<code>wire</code>命令，此时会出现报错：</p><pre tabindex=0><code>C:\Users\Administrator\GolandProjects\wire-example2\cmd&gt;wire
wire: C:\Users\Administrator\GolandProjects\wire-example2\cmd\wire.go:11:1: inject InitApp: no provider found for wire-example2/internal/db.Dao
        needed by *wire-example2/cmd.App in provider &#34;NewApp&#34; (C:\Users\Administrator\GolandProjects\wire-example2\cmd\main.go:12:6)
wire: wire-example2/cmd: generate failed
wire: at least one generate failure
</code></pre><p><code>wire</code>提示<code>inject InitApp: no provider found for wire-example2/internal/db.Dao</code>，也就是没找到能提供<code>db.Dao</code>对象的<code>Provider</code>，咱们不是提供了默认的<code>db.dao</code>实现也注册了<code>Provider</code>吗？这也是go的OOP设计奇特之处。</p><p>咱们修改一下<code>internal/db/db.go</code>的<code>Provider</code>声明，增加<code>db.*dao</code>和<code>db.Dao</code>的接口绑定关系:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>Provider</span> = <span style=color:#a6e22e>wire</span>.<span style=color:#a6e22e>NewSet</span>(<span style=color:#a6e22e>New</span>, <span style=color:#a6e22e>NewDao</span>, <span style=color:#a6e22e>wire</span>.<span style=color:#a6e22e>Bind</span>(new(<span style=color:#a6e22e>Dao</span>), new(<span style=color:#f92672>*</span><span style=color:#a6e22e>dao</span>)))
</span></span></code></pre></div><p><code>wire.Bind()</code>方法第一个参数为<code>interface{}</code>，第二个参数为<code>实现</code>。</p><p>此时再执行<code>wire</code>命令就可以成功了！</p><h2 id=结尾>结尾</h2><p><code>wire</code>工具还有很多玩法，但是就笔者个人工作经验而言，掌握本文介绍到的知识已经能够胜任绝大部分场景了！</p></section><div class=paginator><a class=prev href=https://www.ddhigh.com/2021/02/25/golang-get-started/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>Go语言程序设计</span></a>
<a class=next href=https://www.ddhigh.com/2021/01/12/golang-halia-get-started/><span>Golang组件化网络服务器框架Halia指南</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","xialeistudio/discussion"),s.setAttribute("data-repo-id","R_kgDOKurTRA"),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOKurTRM4CbCJt"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2014 - 2024 <a href=https://www.ddhigh.com/>Lei Xia</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
<a href=https://umami-beta-peach.vercel.app/ target=_blank>Statistics</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>