<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Webpack4不求人(5)——编写自定义插件</title>
<meta charset=utf-8><meta name=google-adsense-account content="ca-pub-2871082647721658"><meta content="Web开发 ,Java ,Go ,Node.js ,PHP ,Koa ,MySQL ,Redis ,前端 ,后端 ,数据库" name=keywords><meta name=description content="Webpack通过Loader完成模块的转换工作，让“一切皆模块”成为可能。Plugin机制则让其更加灵活，可以在Webpack生命周期中调用钩子完成各种任务，包括修改输出资源、输出目录等等。
今天我们一起来学习如何编写Webpack插件。
构建流程 在编写插件之前，还需要了解一下Webpack的构建流程，以便在合适的时机插入合适的插件逻辑。Webpack的基本构建流程如下："><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/2020/03/18/webpack-plugin-development/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com/index.xml title=每天进步一点点><script async src="https://www.googletagmanager.com/gtag/js?id=G-EC3XLVSGKV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EC3XLVSGKV")</script><meta property="og:title" content="Webpack4不求人(5)——编写自定义插件"><meta property="og:description" content="Webpack通过Loader完成模块的转换工作，让“一切皆模块”成为可能。Plugin机制则让其更加灵活，可以在Webpack生命周期中调用钩子完成各种任务，包括修改输出资源、输出目录等等。
今天我们一起来学习如何编写Webpack插件。
构建流程 在编写插件之前，还需要了解一下Webpack的构建流程，以便在合适的时机插入合适的插件逻辑。Webpack的基本构建流程如下："><meta property="og:type" content="article"><meta property="og:url" content="https://www.ddhigh.com/2020/03/18/webpack-plugin-development/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-18T12:00:00+00:00"><meta property="article:modified_time" content="2020-03-18T12:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Webpack4不求人(5)——编写自定义插件"><meta name=twitter:description content="Webpack通过Loader完成模块的转换工作，让“一切皆模块”成为可能。Plugin机制则让其更加灵活，可以在Webpack生命周期中调用钩子完成各种任务，包括修改输出资源、输出目录等等。
今天我们一起来学习如何编写Webpack插件。
构建流程 在编写插件之前，还需要了解一下Webpack的构建流程，以便在合适的时机插入合适的插件逻辑。Webpack的基本构建流程如下："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.ddhigh.com/posts/"},{"@type":"ListItem","position":3,"name":"Webpack4不求人(5)——编写自定义插件","item":"https://www.ddhigh.com/2020/03/18/webpack-plugin-development/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Webpack4不求人(5)——编写自定义插件","name":"Webpack4不求人(5)——编写自定义插件","description":"Webpack通过Loader完成模块的转换工作，让“一切皆模块”成为可能。Plugin机制则让其更加灵活，可以在Webpack生命周期中调用钩子完成各种任务，包括修改输出资源、输出目录等等。\n今天我们一起来学习如何编写Webpack插件。\n构建流程 在编写插件之前，还需要了解一下Webpack的构建流程，以便在合适的时机插入合适的插件逻辑。Webpack的基本构建流程如下：","keywords":["webpack"],"articleBody":"\nWebpack通过Loader完成模块的转换工作，让“一切皆模块”成为可能。Plugin机制则让其更加灵活，可以在Webpack生命周期中调用钩子完成各种任务，包括修改输出资源、输出目录等等。\n今天我们一起来学习如何编写Webpack插件。\n构建流程 在编写插件之前，还需要了解一下Webpack的构建流程，以便在合适的时机插入合适的插件逻辑。Webpack的基本构建流程如下：\n校验配置文件 生成Compiler对象 初始化默认插件 run/watch：如果运行在watch模式则执行watch方法，否则执行run方法 compilation：创建Compilation对象回调compilation相关钩子 emit：文件内容准备完成，准备生成文件，这是最后一次修改最终文件的机会 afterEmit：文件已经写入磁盘完成 done：完成编译 插件示例 一个典型的Webpack插件代码如下：\n// 插件代码 class MyWebpackPlugin { constructor(options) { } apply(compiler) { // 在emit阶段插入钩子函数 compiler.hooks.emit.tap('MyWebpackPlugin', (compilation) =\u003e {}); } } module.exports = MyWebpackPlugin; 接下来需要在webpack.config.js中引入这个插件。\nmodule.exports = { plugins:[ // 传入插件实例 new MyWebpackPlugin({ param:'paramValue' }), ] }; Webpack在启动时会实例化插件对象，在初始化compiler对象之后会调用插件实例的apply方法，传入compiler对象，插件实例在apply方法中会注册感兴趣的钩子，Webpack在执行过程中会根据构建阶段回调相应的钩子。\nCompiler \u0026\u0026 Compilation对象 在编写Webpack插件过程中，最常用也是最主要的两个对象就是Webpack提供的Compiler和Compilation，Plugin通过访问Compiler和Compilation对象来完成工作。\nCompiler 对象包含了当前运行Webpack的配置，包括entry、output、loaders等配置，这个对象在启动Webpack时被实例化，而且是全局唯一的。Plugin可以通过该对象获取到Webpack的配置信息进行处理。 Compilation对象可以理解编译对象，包含了模块、依赖、文件等信息。在开发模式下运行Webpack时，每修改一次文件都会产生一个新的Compilation对象，Plugin可以访问到本次编译过程中的模块、依赖、文件内容等信息。 常见钩子 Webpack会根据执行流程来回调对应的钩子，下面我们来看看都有哪些常见钩子，这些钩子支持的tap操作是什么。\n钩子 说明 参数 类型 afterPlugins 启动一次新的编译 compiler 同步 compile 创建compilation对象之前 compilationParams 同步 compilation compilation对象创建完成 compilation 同步 emit 资源生成完成，输出之前 compilation 异步 afterEmit 资源输出到目录完成 compilation 异步 done 完成编译 stats 同步 Tapable Tapable是Webpack的一个核心工具，Webpack中许多对象扩展自Tapable类。Tapable类暴露了tap、tapAsync和tapPromise方法，可以根据钩子的同步/异步方式来选择一个函数注入逻辑。\ntap 同步钩子 tapAsync 异步钩子，通过callback回调告诉Webpack异步执行完毕 tapPromise 异步钩子，返回一个Promise告诉Webpack异步执行完毕 tap tap是一个同步钩子，同步钩子在使用时不可以包含异步调用，因为函数返回时异步逻辑有可能未执行完毕导致问题。\n下面一个在compile阶段插入同步钩子的示例。\ncompiler.hooks.compile.tap('MyWebpackPlugin', params =\u003e { console.log('我是同步钩子') }); tapAsync tapAsync是一个异步钩子，我们可以通过callback告知Webpack异步逻辑执行完毕。\n下面是一个在emit阶段的示例，在1秒后打印文件列表。\ncompiler.hooks.emit.tapAsync('MyWebpackPlugin', (compilation, callback) =\u003e { setTimeout(()=\u003e{ console.log('文件列表', Object.keys(compilation.assets).join(',')); callback(); }, 1000); }); tapPromise tapPromise也是也是异步钩子，和tapAsync的区别在于tapPromise是通过返回Promise来告知Webpack异步逻辑执行完毕。\n下面是一个将生成结果上传到CDN的示例。\ncompiler.hooks.afterEmit.tapPromise('MyWebpackPlugin', (compilation) =\u003e { return new Promise((resolve, reject) =\u003e { const filelist = Object.keys(compilation.assets); uploadToCDN(filelist, (err) =\u003e { if(err) { reject(err); return; } resolve(); }); }); }); apply方法中插入钩子的一般形式如下：\ncompileer.hooks.阶段.tap函数('插件名称', (阶段回调参数) =\u003e { }); 常用API 读取输出资源、模块及依赖 在emit阶段，我们可以读取最终需要输出的资源、chunk、模块和对应的依赖，如果有需要还可以更改输出资源。\napply(compiler) { compiler.hooks.emit.tapAsync('MyWebpackPlugin', (compilation, callback) =\u003e { // compilation.chunks存放了代码块列表 compilation.chunks.forEach(chunk =\u003e { // chunk包含多个模块，通过chunk.modulesIterable可以遍历模块列表 for(const module of chunk.modulesIterable) { // module包含多个依赖，通过module.dependencies进行遍历 module.dependencies.forEach(dependency =\u003e { console.log(dependency); }); } }); callback(); }); } 修改输出资源 通过操作compilation.assets对象，我们可以添加、删除、更改最终输出的资源。\napply(compiler) { compiler.hooks.emit.tapAsync('MyWebpackPlugin', (compilation) =\u003e { // 修改或添加资源 compilation.assets['main.js'] = { source() { return 'modified content'; }, size() { return this.source().length; } }; // 删除资源 delete compilation.assets['main.js']; }); } assets对象需要定义source和size方法，source方法返回资源的内容，支持字符串和Node.js的Buffer，size返回文件的大小字节数。\n插件编写实例 接下来我们开始编写自定义插件，所有插件使用的示例项目如下(需要安装webpack和webpack-cli)：\n|----src |----main.js |----plugins |----my-webpack-plugin.js |----package.json |----webpack.config.js 相关文件的内容如下:\n// src/main.js console.log('Hello World'); // package.json { \"scripts\":{ \"build\":\"webpack\" } } const path = require('path'); const MyWebpackPlugin = require('my-webpack-plugin'); // webpack.config.js module.exports = { entry:'./src/main', output:{ path: path.resolve(__dirname, 'build'), filename:'[name].js', }, plugins:[ new MyWebpackPlugin() ] }; 生成清单文件 通过在emit阶段操作compilation.assets实现。\nclass MyWebpackPlugin { apply(compiler) { compiler.hooks.emit.tapAsync('MyWebpackPlugin', (compilation, callback) =\u003e { const manifest = {}; for (const name of Object.keys(compilation.assets)) { manifest[name] = compilation.assets[name].size(); // 将生成文件的文件名和大小写入manifest对象 } compilation.assets['manifest.json'] = { source() { return JSON.stringify(manifest); }, size() { return this.source().length; } }; callback(); }); } } module.exports = MyWebpackPlugin; 构建完成后会在build目录添加manifest.json，内容如下：\n{\"main.js\":956} 构建结果上传到七牛 在实际开发中，资源文件构建完成后一般会同步到CDN，最终前端界面使用的是CDN服务器上的静态资源。\n下面我们编写一个Webpack插件，文件构建完成后上传的七牛CDN。\n我们的插件依赖qiniu，因此需要额外安装qiniu模块\nnpm install qiniu --save-dev 七牛的Node.js SDK文档地址如下：\nhttps://developer.qiniu.com/kodo/sdk/1289/nodejs 开始编写插件代码：\nconst qiniu = require('qiniu'); const path = require('path'); class MyWebpackPlugin { // 七牛SDK mac对象 mac = null; constructor(options) { // 读取传入选项 this.options = options || {}; // 检查选项中的参数 this.checkQiniuConfig(); // 初始化七牛mac对象 this.mac = new qiniu.auth.digest.Mac( this.options.qiniu.accessKey, this.options.qiniu.secretKey ); } checkQiniuConfig() { // 配置未传qiniu，读取环境变量中的配置 if (!this.options.qiniu) { this.options.qiniu = { accessKey: process.env.QINIU_ACCESS_KEY, secretKey: process.env.QINIU_SECRET_KEY, bucket: process.env.QINIU_BUCKET, keyPrefix: process.env.QINIU_KEY_PREFIX || '' }; } const qiniu = this.options.qiniu; if (!qiniu.accessKey || !qiniu.secretKey || !qiniu.bucket) { throw new Error('invalid qiniu config'); } } apply(compiler) { compiler.hooks.afterEmit.tapPromise('MyWebpackPlugin', (compilation) =\u003e { return new Promise((resolve, reject) =\u003e { // 总上传数量 const uploadCount = Object.keys(compilation.assets).length; // 已上传数量 let currentUploadedCount = 0; // 七牛SDK相关参数 const putPolicy = new qiniu.rs.PutPolicy({ scope: this.options.qiniu.bucket }); const uploadToken = putPolicy.uploadToken(this.mac); const config = new qiniu.conf.Config(); config.zone = qiniu.zone.Zone_z1; const formUploader = new qiniu.form_up.FormUploader() const putExtra = new qiniu.form_up.PutExtra(); // 因为是批量上传，需要在最后将错误对象回调 let globalError = null; // 遍历编译资源文件 for (const filename of Object.keys(compilation.assets)) { // 开始上传 formUploader.putFile( uploadToken, this.options.qiniu.keyPrefix + filename, path.resolve(compilation.outputOptions.path, filename), putExtra, (err) =\u003e { console.log(`uploade ${filename} result: ${err ? `Error:${err.message}` : 'Success'}`) currentUploadedCount++; if (err) { globalError = err; } if (currentUploadedCount === uploadCount) { globalError ? reject(globalError) : resolve(); } }); } }) }); } } module.exports = MyWebpackPlugin; Webpack中需要传递给该插件传递相关配置：\nmodule.exports = { entry: './src/index', target: 'node', output: { path: path.resolve(__dirname, 'build'), filename: '[name].js', publicPath: 'CDN域名' }, plugins: [ new CleanWebpackPlugin(), new QiniuWebpackPlugin({ qiniu: { accessKey: '七牛AccessKey', secretKey: '七牛SecretKey', bucket: 'static', keyPrefix: 'webpack-inaction/demo1/' } }) ] }; 编译完成后资源会自动上传到七牛CDN，这样前端只用交付index.html即可。\n小结 至此，Webpack相关常用知识和进阶知识都介绍完毕，需要各位读者在工作中去多加探索，Webpack配合Node.js生态，一定会涌现出更多优秀的新语言和新工具！\n","wordCount":"567","inLanguage":"zh","datePublished":"2020-03-18T12:00:00Z","dateModified":"2020-03-18T12:00:00Z","author":{"@type":"Person","name":"Lei Xia"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com/2020/03/18/webpack-plugin-development/"},"publisher":{"@type":"Organization","name":"每天进步一点点","logo":{"@type":"ImageObject","url":"https://www.ddhigh.com/favicon.ico"}}}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link href=/titilliumweb/titilliumweb.css rel=stylesheet><link rel=stylesheet href=/css/main.min.0eb4160ba4a2d63122fe8ae83f1560951a87ab510d5dab0615973b5206555759.css integrity="sha256-DrQWC6Si1jEi/oroPxVglRqHq1ENXasGFZc7UgZVV1k=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css integrity="sha512-ygEyjMC6rqnzJqWGjRTJUPYMEs9JUOm3i7OWUS9CgQ4XkBUvMsgCS1I8JqavidQ2ClHcREB7IbA2mN08+r9Elg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>$darkModeInit.Content|safeJS</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2871082647721658" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>每天进步一点点
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/>首页</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>归档</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>出版物</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>留言板</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li><li class="navigation-item navigation-language"><a href=https://www.ddhigh.com/en/>EN</a></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Webpack4不求人(5)——编写自定义插件</h1></header><p><small>2020年3月18日&nbsp;· 567 字&nbsp;· 3 分钟</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#构建流程>构建流程</a></li><li><a href=#插件示例>插件示例</a></li><li><a href=#compiler--compilation对象>Compiler && Compilation对象</a><ul><li><a href=#常见钩子>常见钩子</a></li></ul></li><li><a href=#tapable>Tapable</a><ul><li><a href=#tap>tap</a></li><li><a href=#tapasync>tapAsync</a></li><li><a href=#tappromise>tapPromise</a></li></ul></li><li><a href=#常用api>常用API</a><ul><li><a href=#读取输出资源模块及依赖>读取输出资源、模块及依赖</a></li><li><a href=#修改输出资源>修改输出资源</a></li></ul></li><li><a href=#插件编写实例>插件编写实例</a><ul><li><a href=#生成清单文件>生成清单文件</a></li><li><a href=#构建结果上传到七牛>构建结果上传到七牛</a></li></ul></li><li><a href=#小结>小结</a></li></ul></nav></div><section class=blog-content><p><img src=https://static.ddhigh.com/blog/2020-03-18-032856.png alt></p><p>Webpack通过Loader完成模块的转换工作，让“一切皆模块”成为可能。Plugin机制则让其更加灵活，可以在Webpack生命周期中调用钩子完成各种任务，包括修改输出资源、输出目录等等。</p><p>今天我们一起来学习如何编写Webpack插件。</p><h2 id=构建流程>构建流程</h2><p>在编写插件之前，还需要了解一下Webpack的构建流程，以便在合适的时机插入合适的插件逻辑。Webpack的基本构建流程如下：</p><ol><li>校验配置文件</li><li>生成Compiler对象</li><li>初始化默认插件</li><li>run/watch：如果运行在watch模式则执行watch方法，否则执行run方法</li><li>compilation：创建Compilation对象回调compilation相关钩子</li><li>emit：文件内容准备完成，准备生成文件，这是最后一次修改最终文件的机会</li><li>afterEmit：文件已经写入磁盘完成</li><li>done：完成编译</li></ol><h2 id=插件示例>插件示例</h2><p>一个典型的Webpack插件代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// 插件代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyWebpackPlugin</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>options</span>) {
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>compiler</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在emit阶段插入钩子函数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>compiler</span>.<span style=color:#a6e22e>hooks</span>.<span style=color:#a6e22e>emit</span>.<span style=color:#a6e22e>tap</span>(<span style=color:#e6db74>&#39;MyWebpackPlugin&#39;</span>, (<span style=color:#a6e22e>compilation</span>) =&gt; {});
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>MyWebpackPlugin</span>;
</span></span></code></pre></div><p>接下来需要在webpack.config.js中引入这个插件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span>[
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 传入插件实例
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyWebpackPlugin</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>param</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;paramValue&#39;</span>
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Webpack在启动时会实例化插件对象，在初始化compiler对象之后会调用插件实例的apply方法，传入compiler对象，插件实例在apply方法中会注册感兴趣的钩子，Webpack在执行过程中会根据构建阶段回调相应的钩子。</p><h2 id=compiler--compilation对象>Compiler && Compilation对象</h2><p>在编写Webpack插件过程中，最常用也是最主要的两个对象就是Webpack提供的Compiler和Compilation，Plugin通过访问Compiler和Compilation对象来完成工作。</p><ul><li>Compiler 对象包含了当前运行Webpack的配置，包括entry、output、loaders等配置，这个对象在启动Webpack时被实例化，而且是全局唯一的。Plugin可以通过该对象获取到Webpack的配置信息进行处理。</li><li>Compilation对象可以理解编译对象，包含了模块、依赖、文件等信息。在开发模式下运行Webpack时，每修改一次文件都会产生一个新的Compilation对象，Plugin可以访问到本次编译过程中的模块、依赖、文件内容等信息。</li></ul><h3 id=常见钩子>常见钩子</h3><p>Webpack会根据执行流程来回调对应的钩子，下面我们来看看都有哪些常见钩子，这些钩子支持的tap操作是什么。</p><table><thead><tr><th>钩子</th><th>说明</th><th>参数</th><th>类型</th></tr></thead><tbody><tr><td>afterPlugins</td><td>启动一次新的编译</td><td>compiler</td><td>同步</td></tr><tr><td>compile</td><td>创建compilation对象之前</td><td>compilationParams</td><td>同步</td></tr><tr><td>compilation</td><td>compilation对象创建完成</td><td>compilation</td><td>同步</td></tr><tr><td>emit</td><td>资源生成完成，输出之前</td><td>compilation</td><td>异步</td></tr><tr><td>afterEmit</td><td>资源输出到目录完成</td><td>compilation</td><td>异步</td></tr><tr><td>done</td><td>完成编译</td><td>stats</td><td>同步</td></tr></tbody></table><h2 id=tapable>Tapable</h2><p>Tapable是Webpack的一个核心工具，Webpack中许多对象扩展自Tapable类。Tapable类暴露了tap、tapAsync和tapPromise方法，可以根据钩子的同步/异步方式来选择一个函数注入逻辑。</p><ul><li>tap 同步钩子</li><li>tapAsync 异步钩子，通过callback回调告诉Webpack异步执行完毕</li><li>tapPromise 异步钩子，返回一个Promise告诉Webpack异步执行完毕</li></ul><h3 id=tap>tap</h3><p>tap是一个同步钩子，同步钩子在使用时不可以包含异步调用，因为函数返回时异步逻辑有可能未执行完毕导致问题。</p><p>下面一个在compile阶段插入同步钩子的示例。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>compiler</span>.<span style=color:#a6e22e>hooks</span>.<span style=color:#a6e22e>compile</span>.<span style=color:#a6e22e>tap</span>(<span style=color:#e6db74>&#39;MyWebpackPlugin&#39;</span>, <span style=color:#a6e22e>params</span> =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;我是同步钩子&#39;</span>)
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=tapasync>tapAsync</h3><p>tapAsync是一个异步钩子，我们可以通过callback告知Webpack异步逻辑执行完毕。</p><p>下面是一个在emit阶段的示例，在1秒后打印文件列表。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>compiler</span>.<span style=color:#a6e22e>hooks</span>.<span style=color:#a6e22e>emit</span>.<span style=color:#a6e22e>tapAsync</span>(<span style=color:#e6db74>&#39;MyWebpackPlugin&#39;</span>, (<span style=color:#a6e22e>compilation</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setTimeout</span>(()=&gt;{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;文件列表&#39;</span>, Object.<span style=color:#a6e22e>keys</span>(<span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>assets</span>).<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;,&#39;</span>));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>callback</span>();
</span></span><span style=display:flex><span>  }, <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h3 id=tappromise>tapPromise</h3><p>tapPromise也是也是异步钩子，和tapAsync的区别在于tapPromise是通过返回Promise来告知Webpack异步逻辑执行完毕。</p><p>下面是一个将生成结果上传到CDN的示例。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>compiler</span>.<span style=color:#a6e22e>hooks</span>.<span style=color:#a6e22e>afterEmit</span>.<span style=color:#a6e22e>tapPromise</span>(<span style=color:#e6db74>&#39;MyWebpackPlugin&#39;</span>, (<span style=color:#a6e22e>compilation</span>) =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filelist</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>keys</span>(<span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>assets</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>uploadToCDN</span>(<span style=color:#a6e22e>filelist</span>, (<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>apply方法中插入钩子的一般形式如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>compileer</span>.<span style=color:#a6e22e>hooks</span>.<span style=color:#a6e22e>阶段</span>.<span style=color:#a6e22e>tap函数</span>(<span style=color:#e6db74>&#39;插件名称&#39;</span>, (<span style=color:#a6e22e>阶段回调参数</span>) =&gt; {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=常用api>常用API</h2><h3 id=读取输出资源模块及依赖>读取输出资源、模块及依赖</h3><p>在emit阶段，我们可以读取最终需要输出的资源、chunk、模块和对应的依赖，如果有需要还可以更改输出资源。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>compiler</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>compiler</span>.<span style=color:#a6e22e>hooks</span>.<span style=color:#a6e22e>emit</span>.<span style=color:#a6e22e>tapAsync</span>(<span style=color:#e6db74>&#39;MyWebpackPlugin&#39;</span>, (<span style=color:#a6e22e>compilation</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// compilation.chunks存放了代码块列表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>chunks</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>chunk</span> =&gt; {
</span></span><span style=display:flex><span>     <span style=color:#75715e>// chunk包含多个模块，通过chunk.modulesIterable可以遍历模块列表 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			<span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>module</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>chunk</span>.<span style=color:#a6e22e>modulesIterable</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// module包含多个依赖，通过module.dependencies进行遍历
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      	<span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>dependencies</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>dependency</span> =&gt; {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>dependency</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>callback</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=修改输出资源>修改输出资源</h3><p>通过操作compilation.assets对象，我们可以添加、删除、更改最终输出的资源。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>compiler</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>compiler</span>.<span style=color:#a6e22e>hooks</span>.<span style=color:#a6e22e>emit</span>.<span style=color:#a6e22e>tapAsync</span>(<span style=color:#e6db74>&#39;MyWebpackPlugin&#39;</span>, (<span style=color:#a6e22e>compilation</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 修改或添加资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>assets</span>[<span style=color:#e6db74>&#39;main.js&#39;</span>]  <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>source</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;modified content&#39;</span>;
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>size</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>source</span>().<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 删除资源
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>delete</span> <span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>assets</span>[<span style=color:#e6db74>&#39;main.js&#39;</span>];
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>assets对象需要定义source和size方法，source方法返回资源的内容，支持字符串和Node.js的Buffer，size返回文件的大小字节数。</p><h2 id=插件编写实例>插件编写实例</h2><p>接下来我们开始编写自定义插件，所有插件使用的示例项目如下(需要安装webpack和webpack-cli)：</p><pre tabindex=0><code>|----src
		|----main.js
|----plugins
		|----my-webpack-plugin.js
|----package.json
|----webpack.config.js
</code></pre><p>相关文件的内容如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// src/main.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;Hello World&#39;</span>);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#75715e>// package.json
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scripts&#34;</span>:{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;build&#34;</span>:<span style=color:#e6db74>&#34;webpack&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;path&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>MyWebpackPlugin</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;my-webpack-plugin&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// webpack.config.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>entry</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;./src/main&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>output</span><span style=color:#f92672>:</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#39;build&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39;[name].js&#39;</span>,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span>[
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MyWebpackPlugin</span>()
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=生成清单文件>生成清单文件</h3><p>通过在emit阶段操作compilation.assets实现。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyWebpackPlugin</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>compiler</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>compiler</span>.<span style=color:#a6e22e>hooks</span>.<span style=color:#a6e22e>emit</span>.<span style=color:#a6e22e>tapAsync</span>(<span style=color:#e6db74>&#39;MyWebpackPlugin&#39;</span>, (<span style=color:#a6e22e>compilation</span>, <span style=color:#a6e22e>callback</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>manifest</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>of</span> Object.<span style=color:#a6e22e>keys</span>(<span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>assets</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>manifest</span>[<span style=color:#a6e22e>name</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>assets</span>[<span style=color:#a6e22e>name</span>].<span style=color:#a6e22e>size</span>();
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 将生成文件的文件名和大小写入manifest对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>assets</span>[<span style=color:#e6db74>&#39;manifest.json&#39;</span>] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>source</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>manifest</span>);
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>size</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>source</span>().<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>callback</span>();
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>MyWebpackPlugin</span>;
</span></span></code></pre></div><p>构建完成后会在build目录添加manifest.json，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;main.js&#34;</span>:<span style=color:#ae81ff>956</span>}
</span></span></code></pre></div><h3 id=构建结果上传到七牛>构建结果上传到七牛</h3><p>在实际开发中，资源文件构建完成后一般会同步到CDN，最终前端界面使用的是CDN服务器上的静态资源。</p><p>下面我们编写一个Webpack插件，文件构建完成后上传的七牛CDN。</p><p>我们的插件依赖qiniu，因此需要额外安装qiniu模块</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm install qiniu --save-dev
</span></span></code></pre></div><p>七牛的Node.js SDK文档地址如下：</p><pre tabindex=0><code>https://developer.qiniu.com/kodo/sdk/1289/nodejs
</code></pre><p>开始编写插件代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>qiniu</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;qiniu&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;path&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyWebpackPlugin</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 七牛SDK mac对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>mac</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>options</span>) {
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 读取传入选项
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>options</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span> <span style=color:#f92672>||</span> {};
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 检查选项中的参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkQiniuConfig</span>();
</span></span><span style=display:flex><span>      	<span style=color:#75715e>// 初始化七牛mac对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mac</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>auth</span>.<span style=color:#a6e22e>digest</span>.<span style=color:#a6e22e>Mac</span>(
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>accessKey</span>,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>secretKey</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>checkQiniuConfig</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 配置未传qiniu，读取环境变量中的配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>qiniu</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>qiniu</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>accessKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>QINIU_ACCESS_KEY</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>secretKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>QINIU_SECRET_KEY</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>bucket</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>QINIU_BUCKET</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>keyPrefix</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>QINIU_KEY_PREFIX</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>qiniu</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>qiniu</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>accessKey</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>secretKey</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>bucket</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;invalid qiniu config&#39;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apply</span>(<span style=color:#a6e22e>compiler</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>compiler</span>.<span style=color:#a6e22e>hooks</span>.<span style=color:#a6e22e>afterEmit</span>.<span style=color:#a6e22e>tapPromise</span>(<span style=color:#e6db74>&#39;MyWebpackPlugin&#39;</span>, (<span style=color:#a6e22e>compilation</span>) =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 总上传数量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>uploadCount</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>keys</span>(<span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>assets</span>).<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 已上传数量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>currentUploadedCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>								<span style=color:#75715e>// 七牛SDK相关参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>putPolicy</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>rs</span>.<span style=color:#a6e22e>PutPolicy</span>({ <span style=color:#a6e22e>scope</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>bucket</span> });
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>uploadToken</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>putPolicy</span>.<span style=color:#a6e22e>uploadToken</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mac</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>conf</span>.<span style=color:#a6e22e>Config</span>();
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>zone</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>zone</span>.<span style=color:#a6e22e>Zone_z1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>formUploader</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>form_up</span>.<span style=color:#a6e22e>FormUploader</span>()
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>putExtra</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>form_up</span>.<span style=color:#a6e22e>PutExtra</span>();
</span></span><span style=display:flex><span>								<span style=color:#75715e>// 因为是批量上传，需要在最后将错误对象回调
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>globalError</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              	<span style=color:#75715e>// 遍历编译资源文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filename</span> <span style=color:#66d9ef>of</span> Object.<span style=color:#a6e22e>keys</span>(<span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>assets</span>)) {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 开始上传
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#a6e22e>formUploader</span>.<span style=color:#a6e22e>putFile</span>(
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>uploadToken</span>,
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>qiniu</span>.<span style=color:#a6e22e>keyPrefix</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>filename</span>,
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>compilation</span>.<span style=color:#a6e22e>outputOptions</span>.<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>filename</span>),
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>putExtra</span>,
</span></span><span style=display:flex><span>                        (<span style=color:#a6e22e>err</span>) =&gt; {
</span></span><span style=display:flex><span>                            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`uploade </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filename</span><span style=color:#e6db74>}</span><span style=color:#e6db74> result: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>`Error:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Success&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span>                            <span style=color:#a6e22e>currentUploadedCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>                                <span style=color:#a6e22e>globalError</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>err</span>;
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>currentUploadedCount</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>uploadCount</span>) {
</span></span><span style=display:flex><span>                                <span style=color:#a6e22e>globalError</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>globalError</span>) <span style=color:#f92672>:</span> <span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                        });
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>MyWebpackPlugin</span>;
</span></span></code></pre></div><p>Webpack中需要传递给该插件传递相关配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>entry</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;./src/index&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>target</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;node&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>output</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#39;build&#39;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>filename</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;[name].js&#39;</span>,
</span></span><span style=display:flex><span>      	<span style=color:#a6e22e>publicPath</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CDN域名&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CleanWebpackPlugin</span>(),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>QiniuWebpackPlugin</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>qiniu</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>accessKey</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;七牛AccessKey&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>secretKey</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;七牛SecretKey&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>bucket</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;static&#39;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>keyPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;webpack-inaction/demo1/&#39;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>编译完成后资源会自动上传到七牛CDN，这样前端只用交付index.html即可。</p><h2 id=小结>小结</h2><p>至此，Webpack相关常用知识和进阶知识都介绍完毕，需要各位读者在工作中去多加探索，Webpack配合Node.js生态，一定会涌现出更多优秀的新语言和新工具！</p><p><img src=https://static.ddhigh.com/blog/2020-03-11-060831.png alt=0></p><div class=blog-footer><div class=social-share></div><div class=copyright><ul><li style=margin-bottom:.5em>本文作者: <a href=https://ddhigh.com/ target=_blank style=color:#000;text-decoration:none>xialeistudio</a></li><li style=margin-bottom:.5em>本文链接: <a href=https://www.ddhigh.com/2020/03/18/webpack-plugin-development/ target=_blank style=color:#000;text-decoration:none>Webpack4不求人(5)——编写自定义插件</a></li><li>版权声明: <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank style=color:#000;text-decoration:none>「署名-非商业性使用-相同方式共享 4.0 国际」</a></li></ul></div><div style=margin-top:2rem><img src=/img/mp.png alt=qrcode></div></div></section><div class=paginator><a class=prev href=https://www.ddhigh.com/2020/08/20/golang-http-captcha-example/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>Golang Http 验证码示例</span></a>
<a class=next href=https://www.ddhigh.com/2020/03/11/webpack-loader-development/><span>Webpack4不求人(4)——编写自定义Loader</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","xialeistudio/discussion"),s.setAttribute("data-repo-id","R_kgDOKurTRA"),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOKurTRM4CbCJt"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2014 - 2025 <a href=https://www.ddhigh.com>每天进步一点点</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js integrity="sha512-9DNXrSjk17bU9MUbRp3IjwcWe46V8FaGA062PFbryPUAEQVRbz4jiZP6FW0AdbqEGtMYBDWnul3eiGBMJOQajA==" crossorigin=anonymous referrerpolicy=no-referrer></script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>