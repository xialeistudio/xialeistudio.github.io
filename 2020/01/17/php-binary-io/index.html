<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>kafka二进制协议简要分析</title>
<meta charset=utf-8><meta name=description content="Ladder@最近分享了《应用层私有协议的设计和实战》，对应用层私有协议设计做了一些介绍，同时也对协议设计中常用的数据类型做了比较形象的讲解，今天我们来研究一下kafka的二进制协议。
数据类型 kafka二进制协议定义了许多的数据类型，包含常用的数字、字符串，也包含了数组等类型。
本文主要讨论不可变长数据类型，可变长度（如Google Protocol Buffers）不在讨论范围内。
数据类型 字节长度 说明 BOOLEAN 1 布尔值 INT8 1 单字节整型，-2^7 ~ 2^7-1 INT16 2 双字节整型，大端序，范围 -2^15 ~ 2^15 - 1 INT32 4 四字节整型、大端序，范围 -2^31 ~ 2^31 - 1 INT64 8 八字节整型、大端序，范围 -2^63 ~ 2^63 -1 UINT32 4 十字街 UUID 16 16字节，Java UUID类型 STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容 NULLABLE_STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容，N为-1时无后续内容 BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容 NULLABLE_BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容，N为-1时无后续内容 ARRAY 4+N*M 头部4字节标识数组长度N，M为单个数组元素的长度，N为-1时为空数组 错误码 -1 未知错误 0 未出错 大于0， 具体错误 kafka内置的操作类型有点多，有兴趣的可以参阅kafka错误码"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/2020/01/17/php-binary-io/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com/index.xml title="Lei Xia"><script async defer data-website-id=865c8529-0729-4cf5-88a9-448616abbcbb src=https://umami-beta-peach.vercel.app/xialeistudio></script><meta property="og:title" content="kafka二进制协议简要分析"><meta property="og:description" content="最近分享了《应用层私有协议的设计和实战》，对应用层私有协议设计做了一些介绍，同时也对协议设计中常用的数据类型做了比较形象的讲解，今天我们来研究一下kafka的二进制协议。
数据类型 kafka二进制协议定义了许多的数据类型，包含常用的数字、字符串，也包含了数组等类型。
本文主要讨论不可变长数据类型，可变长度（如Google Protocol Buffers）不在讨论范围内。
数据类型 字节长度 说明 BOOLEAN 1 布尔值 INT8 1 单字节整型，-2^7 ~ 2^7-1 INT16 2 双字节整型，大端序，范围 -2^15 ~ 2^15 - 1 INT32 4 四字节整型、大端序，范围 -2^31 ~ 2^31 - 1 INT64 8 八字节整型、大端序，范围 -2^63 ~ 2^63 -1 UINT32 4 十字街 UUID 16 16字节，Java UUID类型 STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容 NULLABLE_STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容，N为-1时无后续内容 BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容 NULLABLE_BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容，N为-1时无后续内容 ARRAY 4+N*M 头部4字节标识数组长度N，M为单个数组元素的长度，N为-1时为空数组 错误码 -1 未知错误 0 未出错 大于0， 具体错误 kafka内置的操作类型有点多，有兴趣的可以参阅kafka错误码"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ddhigh.com/2020/01/17/php-binary-io/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-17T12:00:00+00:00"><meta property="article:modified_time" content="2020-01-17T12:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="kafka二进制协议简要分析"><meta name=twitter:description content="最近分享了《应用层私有协议的设计和实战》，对应用层私有协议设计做了一些介绍，同时也对协议设计中常用的数据类型做了比较形象的讲解，今天我们来研究一下kafka的二进制协议。
数据类型 kafka二进制协议定义了许多的数据类型，包含常用的数字、字符串，也包含了数组等类型。
本文主要讨论不可变长数据类型，可变长度（如Google Protocol Buffers）不在讨论范围内。
数据类型 字节长度 说明 BOOLEAN 1 布尔值 INT8 1 单字节整型，-2^7 ~ 2^7-1 INT16 2 双字节整型，大端序，范围 -2^15 ~ 2^15 - 1 INT32 4 四字节整型、大端序，范围 -2^31 ~ 2^31 - 1 INT64 8 八字节整型、大端序，范围 -2^63 ~ 2^63 -1 UINT32 4 十字街 UUID 16 16字节，Java UUID类型 STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容 NULLABLE_STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容，N为-1时无后续内容 BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容 NULLABLE_BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容，N为-1时无后续内容 ARRAY 4+N*M 头部4字节标识数组长度N，M为单个数组元素的长度，N为-1时为空数组 错误码 -1 未知错误 0 未出错 大于0， 具体错误 kafka内置的操作类型有点多，有兴趣的可以参阅kafka错误码"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.ddhigh.com/posts/"},{"@type":"ListItem","position":3,"name":"kafka二进制协议简要分析","item":"https://www.ddhigh.com/2020/01/17/php-binary-io/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kafka二进制协议简要分析","name":"kafka二进制协议简要分析","description":"最近分享了《应用层私有协议的设计和实战》，对应用层私有协议设计做了一些介绍，同时也对协议设计中常用的数据类型做了比较形象的讲解，今天我们来研究一下kafka的二进制协议。\n数据类型 kafka二进制协议定义了许多的数据类型，包含常用的数字、字符串，也包含了数组等类型。\n本文主要讨论不可变长数据类型，可变长度（如Google Protocol Buffers）不在讨论范围内。\n数据类型 字节长度 说明 BOOLEAN 1 布尔值 INT8 1 单字节整型，-2^7 ~ 2^7-1 INT16 2 双字节整型，大端序，范围 -2^15 ~ 2^15 - 1 INT32 4 四字节整型、大端序，范围 -2^31 ~ 2^31 - 1 INT64 8 八字节整型、大端序，范围 -2^63 ~ 2^63 -1 UINT32 4 十字街 UUID 16 16字节，Java UUID类型 STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容 NULLABLE_STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容，N为-1时无后续内容 BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容 NULLABLE_BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容，N为-1时无后续内容 ARRAY 4+N*M 头部4字节标识数组长度N，M为单个数组元素的长度，N为-1时为空数组 错误码 -1 未知错误 0 未出错 大于0， 具体错误 kafka内置的操作类型有点多，有兴趣的可以参阅kafka错误码","keywords":[],"articleBody":"最近分享了《应用层私有协议的设计和实战》，对应用层私有协议设计做了一些介绍，同时也对协议设计中常用的数据类型做了比较形象的讲解，今天我们来研究一下kafka的二进制协议。\n数据类型 kafka二进制协议定义了许多的数据类型，包含常用的数字、字符串，也包含了数组等类型。\n本文主要讨论不可变长数据类型，可变长度（如Google Protocol Buffers）不在讨论范围内。\n数据类型 字节长度 说明 BOOLEAN 1 布尔值 INT8 1 单字节整型，-2^7 ~ 2^7-1 INT16 2 双字节整型，大端序，范围 -2^15 ~ 2^15 - 1 INT32 4 四字节整型、大端序，范围 -2^31 ~ 2^31 - 1 INT64 8 八字节整型、大端序，范围 -2^63 ~ 2^63 -1 UINT32 4 十字街 UUID 16 16字节，Java UUID类型 STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容 NULLABLE_STRING 2+N 头部由2字节标识字符串长度N，后续N字节为字符串内容，N为-1时无后续内容 BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容 NULLABLE_BYTES 4+N 头部4字节标识字节数组长度，后续N字节为字节数组内容，N为-1时无后续内容 ARRAY 4+N*M 头部4字节标识数组长度N，M为单个数组元素的长度，N为-1时为空数组 错误码 -1 未知错误 0 未出错 大于0， 具体错误 kafka内置的操作类型有点多，有兴趣的可以参阅kafka错误码\nApi Keys 可以理解为操作码，服务端根据该字段区分当前请求操作。\n这里不做展开，有兴趣的可以参阅kafka Api Keys\n报文结构 接下来我们重点分析一下kafka的报文结构。\n本文基于kafka V1版本协议写作，其他版本的研究原理时一致的。\n整体结构 kafka的协议结构比较简单，请求和响应使用同样的整体结构。\nRequestOrResponse =\u003e Size (RequestMessage | ResponseMessage) Size =\u003e int32 我们转化为表格来看看\nSize为INT32类型，正文长度 Message 为请求或响应正文的内容，变长字段，长度由Size给出 请求格式 请求数据包有固定的请求包头，我们来看看。\nRequest Header v1 =\u003e request_api_key request_api_version correlation_id client_id request_api_key =\u003e INT16 request_api_version =\u003e INT16 correlation_id =\u003e INT32 client_id =\u003e NULLABLE_STRING 上面给出的是请求头的内容，结合整体结构得出的协议表格如下：\nSize 4字节正文长度（包含请求头） request_api_key 2字节 api key，用来区分操作 request_api_version 2字节api 版本号 correlation_id 4字节请求ID，服务端会原样响应该请求ID client_id 可空字符串，根据kafka数据类型定义，需要2字节client_id length字段标识client_id长度，如果client_id length为-1，则不需要传具体的client_id，否则需要传递client_id request message* 请求正文，不同的api key请求正文不同 响应格式 Response Header v1 =\u003e correlation_id TAG_BUFFER correlation_id =\u003e INT32 响应头的结构比较简单，返回了请求ID\nSize 4字节响应正文长度（包含请求ID） correlation_id 4字节请求ID response message* 响应正文 Metadata 示例 请求数据 Kafka Metadata对应的协议格式如下\nMetadata Request (Version: 1) =\u003e [topics] topics =\u003e name name =\u003e STRING 我们转化为表格看看\nSize 4字节请求正文长度 Request_api_key，根据协议文档， 此处为3 Request_api_version，本文基于v1版本写作，因此版本号为1 correlation_id 请求ID client_id length 2字节客户端长度，我们使用test作为客户端标识，此处传入4 client_id 客户端名称，传入test字符串 topic name length 需要查询的topic数组，我们查询test1这个topic，此处传入1 topic name 字符串类型，因此先写入字符串长度5(test1字符串长度为5)，再写入test1字符串（总共写入2+5 = 7个字节） 响应数据 Metadata Response (Version: 1) =\u003e [brokers] controller_id [topics] brokers =\u003e node_id host port rack node_id =\u003e INT32 host =\u003e STRING port =\u003e INT32 rack =\u003e NULLABLE_STRING controller_id =\u003e INT32 topics =\u003e error_code name is_internal [partitions] error_code =\u003e INT16 name =\u003e STRING is_internal =\u003e BOOLEAN partitions =\u003e error_code partition_index leader_id [replica_nodes] [isr_nodes] error_code =\u003e INT16 partition_index =\u003e INT32 leader_id =\u003e INT32 replica_nodes =\u003e INT32 isr_nodes =\u003e INT32 Size 4字节响应长度 Correlation_id 4字节请求ID Broker Count，数组类型，4字节整型标识数组长度 node_id 4字节整型，broker的节点ID host 字符串类型，主机名称 port 4字节整型，端口号 rack 可空字符串，如果broker是rack，则需要2+N字节，否则只需要2字节 Controller_id 4字节整型 Topics 数组类型，topic数组 error_code 2字节整型，错误码 name 字符串类型，topic名称 is_internal 布尔类型，是否内部topic partions 数组类型，topic所在partition error_code 2字节整型，错误码 partition_index 4字节整型，partition index leader_id 4字节整型，leader id Replica_nodes 数组类型 Replica_node 4字节整型 isr_nodes 数组类型 Isr_node 4字节整型 其他类型的请求也可以使用同样的方式去分析\nPHP客户端实现 PHP自带了pack/unpack函数帮助我们操作二进制数据，不过pack/unpack易用性比较低。\n对于二进制数据，java有byte[]，golang有[]byte，PHP没有专门的类型，而是使用字符串存储的，不过PHP字符串是二进制安全的。\n针对pack/unpack函数易用性问题，这两天参考Java的IO系统开发了一个简单版本的io库来简化二进制数据流的操作（文末有仓库地址）。\n接下来使用该库来编写一个kafka的客户端。\n\u003c?php /** * 读取kafka broker列表 */ require __DIR__ . '/../vendor/autoload.php'; use io\\BinaryStringInputStream; use io\\BinaryStringOutputStream; use io\\DataInputStream; use io\\DataOutputStream; use io\\FileInputStream; use io\\FileOutputStream; $client = stream_socket_client('tcp://127.0.0.1:9092', $errno, $errstr, 5); if ($errno) { die($errstr); } $binaryOutputStream = new BinaryStringOutputStream(); $binaryPacketOutput = new DataOutputStream($binaryOutputStream); $binaryPacketOutput-\u003ewriteUnSignedShortBE(0x03); // METADATA_REQUEST $binaryPacketOutput-\u003ewriteUnSignedShortBE(1); // API_VERSION $binaryPacketOutput-\u003ewriteUnSignedIntBE(0x01); // 请求ID $binaryPacketOutput-\u003ewriteUnSignedShortBE(strlen('test')); // 客户端标识长度 $binaryPacketOutput-\u003ewriteString('test'); // 客户端标识 $binaryPacketOutput-\u003ewriteUnSignedIntBE(1); // topic列表数组长度 // topic数组元素 $binaryPacketOutput-\u003ewriteUnSignedShortBE(strlen('test1')); // 写入2字节topic名称长度 $binaryPacketOutput-\u003ewriteString('test1'); // topic名称 $binaryPacketOutput-\u003eflush(); // 输出缓冲 $packet = $binaryOutputStream-\u003etoBinaryString(); // 获得构造好的正文数据包 // 包装socket链接，获得多数据类型操作能力 $out = new DataOutputStream(new FileOutputStream($client)); $out-\u003ewriteUnSignedIntBE(strlen($packet)); // 4字节包长度 $out-\u003ewrite($packet); // 包体 $out-\u003eflush(); // 输出到Socket // 实例化输入流，从socket读取数据 $in = new DataInputStream(new FileInputStream($client)); $size = $in-\u003ereadUnSignedIntBE(); // 4字节包长度 // 一次性读取完socket数据后关闭，然后将读取到的响应数据填充到二进制字符串输入流中，释放socket $in = new DataInputStream(new BinaryStringInputStream(fread($client, $size))); fclose($client); $requestId = $in-\u003ereadUnSignedIntBE(); // 4字节请求ID printf(\"packet length: %d requestId: %d\\n\", $size, $requestId); $brokerCount = $in-\u003ereadUnSignedIntBE(); // broker数量 for ($i = 0; $i \u003c $brokerCount; $i++) { // 循环读取broker $nodeId = $in-\u003ereadUnSignedIntBE(); // nodeId $hostLength = $in-\u003ereadUnSignedShortBE(); // host长度 $host = $in-\u003ereadString($hostLength); // 主机名 $port = $in-\u003ereadUnSignedIntBE(); // port $rackLength = $in-\u003ereadShortBE(); // rack $rack = null; if ($rackLength != -1) { $rack = $in-\u003ereadString($rackLength); } printf(\"nodeId:%d host:%s port:%d rack: %s\\n\", $nodeId, $host, $port, $rack); } $controllerId = $in-\u003ereadUnSignedIntBE(); printf(\"controllerId: %d\\n\", $controllerId); $topicCount = $in-\u003ereadUnSignedIntBE(); printf(\"topic count %d\\n\", $topicCount); for ($i = 0; $i \u003c $topicCount; $i++) { printf(\"----topic list----\\n\"); $errCode = $in-\u003ereadUnSignedShortBE(); $nameLength = $in-\u003ereadUnSignedShortBE(); $name = $in-\u003ereadString($nameLength); $isInternal = $in-\u003ereadUnSignedChar(); printf(\"errcode: %d name: %s interval: %d\\n\", $errCode, $name, $isInternal); $partitionCount = $in-\u003ereadUnSignedIntBE(); printf(\"----topic [%s] partition list count %d---\\n\", $name, $partitionCount); for ($j = 0; $j \u003c $partitionCount; $j++) { $errCode = $in-\u003ereadUnSignedShortBE(); $partitionIndex = $in-\u003ereadUnSignedIntBE(); $leaderId = $in-\u003ereadUnSignedIntBE(); $replicaNodesCount = $in-\u003ereadUnSignedIntBE(); $replicaNodes = []; for ($k = 0; $k \u003c $replicaNodesCount; $k++) { $replicaNodes[] = $in-\u003ereadUnSignedIntBE(); } $isrNodeCount = $in-\u003ereadUnSignedIntBE(); $isrNodes = []; for ($k = 0; $k \u003c $isrNodeCount; $k++) { $isrNodes[] = $in-\u003ereadUnSignedIntBE(); } printf( \"errcode: %d partitionIndex: %d leaderId: %d replicaNodes: [%s] isrNodes: [%s]\\n\", $errCode, $partitionIndex, $leaderId, join(',', $replicaNodes), join(',', $isrNodes) ); } } 输出如下：\npacket length: 73 requestId: 1 nodeId:0 host:bogon port:9092 rack: controllerId: 0 topic count 1 ----topic list---- errcode: 0 name: test1 interval: 0 ----topic [test1] partition list count 1--- errcode: 0 partitionIndex: 0 leaderId: 0 replicaNodes: [0] isrNodes: [0] 项目地址 php-io\n(完)\n","wordCount":"671","inLanguage":"en","datePublished":"2020-01-17T12:00:00Z","dateModified":"2020-01-17T12:00:00Z","author":{"@type":"Person","name":"Lei Xia"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com/2020/01/17/php-binary-io/"},"publisher":{"@type":"Organization","name":"Lei Xia","logo":{"@type":"ImageObject","url":"https://www.ddhigh.com/favicon.ico"}}}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>Guestbook</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>kafka二进制协议简要分析</h1></header><p><small>January 17, 2020&nbsp;· 671 words&nbsp;· 4 min</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#数据类型>数据类型</a></li><li><a href=#错误码>错误码</a></li><li><a href=#api-keys>Api Keys</a></li><li><a href=#报文结构>报文结构</a><ul><li><a href=#整体结构>整体结构</a></li><li><a href=#请求格式>请求格式</a></li><li><a href=#响应格式>响应格式</a></li><li><a href=#metadata-示例>Metadata 示例</a></li></ul></li><li><a href=#php客户端实现>PHP客户端实现</a></li><li><a href=#项目地址>项目地址</a></li></ul></nav></div><section class=blog-content><p>最近分享了《应用层私有协议的设计和实战》，对应用层私有协议设计做了一些介绍，同时也对协议设计中常用的数据类型做了比较形象的讲解，今天我们来研究一下kafka的二进制协议。</p><h2 id=数据类型>数据类型</h2><p>kafka二进制协议定义了许多的数据类型，包含常用的数字、字符串，也包含了数组等类型。</p><p>本文主要讨论不可变长数据类型，可变长度（如Google Protocol Buffers）不在讨论范围内。</p><table><thead><tr><th>数据类型</th><th>字节长度</th><th>说明</th></tr></thead><tbody><tr><td>BOOLEAN</td><td>1</td><td>布尔值</td></tr><tr><td>INT8</td><td>1</td><td>单字节整型，-2^7 ~ 2^7-1</td></tr><tr><td>INT16</td><td>2</td><td>双字节整型，大端序，范围 -2^15 ~ 2^15 - 1</td></tr><tr><td>INT32</td><td>4</td><td>四字节整型、大端序，范围 -2^31 ~ 2^31 - 1</td></tr><tr><td>INT64</td><td>8</td><td>八字节整型、大端序，范围 -2^63 ~ 2^63 -1</td></tr><tr><td>UINT32</td><td>4</td><td>十字街</td></tr><tr><td>UUID</td><td>16</td><td>16字节，Java UUID类型</td></tr><tr><td>STRING</td><td>2+N</td><td>头部由2字节标识字符串长度N，后续N字节为字符串内容</td></tr><tr><td>NULLABLE_STRING</td><td>2+N</td><td>头部由2字节标识字符串长度N，后续N字节为字符串内容，N为-1时无后续内容</td></tr><tr><td>BYTES</td><td>4+N</td><td>头部4字节标识字节数组长度，后续N字节为字节数组内容</td></tr><tr><td>NULLABLE_BYTES</td><td>4+N</td><td>头部4字节标识字节数组长度，后续N字节为字节数组内容，N为-1时无后续内容</td></tr><tr><td>ARRAY</td><td>4+N*M</td><td>头部4字节标识数组长度N，M为单个数组元素的长度，N为-1时为空数组</td></tr></tbody></table><h2 id=错误码>错误码</h2><ul><li>-1 未知错误</li><li>0 未出错</li><li>大于0， 具体错误</li></ul><p>kafka内置的操作类型有点多，有兴趣的可以参阅<a href=https://kafka.apache.org/protocol#protocol_error_codes>kafka错误码</a></p><h2 id=api-keys>Api Keys</h2><p>可以理解为操作码，服务端根据该字段区分当前请求操作。</p><p>这里不做展开，有兴趣的可以参阅<a href=https://kafka.apache.org/protocol#protocol_api_keys>kafka Api Keys</a></p><h2 id=报文结构>报文结构</h2><p>接下来我们重点分析一下kafka的报文结构。</p><blockquote><p>本文基于kafka V1版本协议写作，其他版本的研究原理时一致的。</p></blockquote><h3 id=整体结构>整体结构</h3><p>kafka的协议结构比较简单，请求和响应使用同样的整体结构。</p><pre tabindex=0><code>RequestOrResponse =&gt; Size (RequestMessage | ResponseMessage)
  Size =&gt; int32
</code></pre><p>我们转化为表格来看看</p><p><img src=https://static.ddhigh.com/blog/2020-01-17-093002.png alt=image-20200117172959642></p><ul><li>Size为INT32类型，正文长度</li><li>Message 为请求或响应正文的内容，变长字段，长度由Size给出</li></ul><h3 id=请求格式>请求格式</h3><p>请求数据包有固定的请求包头，我们来看看。</p><pre tabindex=0><code>Request Header v1 =&gt; request_api_key request_api_version correlation_id client_id 
  request_api_key =&gt; INT16
  request_api_version =&gt; INT16
  correlation_id =&gt; INT32
  client_id =&gt; NULLABLE_STRING
</code></pre><p>上面给出的是请求头的内容，结合整体结构得出的协议表格如下：</p><p><img src=https://static.ddhigh.com/blog/2020-01-17-093119.png alt=image-20200117173117965></p><ul><li>Size 4字节正文长度（包含请求头）</li><li>request_api_key 2字节 api key，用来区分操作</li><li>request_api_version 2字节api 版本号</li><li>correlation_id 4字节请求ID，服务端会原样响应该请求ID</li><li>client_id 可空字符串，根据kafka数据类型定义，需要2字节client_id length字段标识client_id长度，如果client_id length为-1，则不需要传具体的client_id，否则需要传递client_id</li><li>request message* 请求正文，不同的api key请求正文不同</li></ul><h3 id=响应格式>响应格式</h3><pre tabindex=0><code>Response Header v1 =&gt; correlation_id TAG_BUFFER 
  correlation_id =&gt; INT32
</code></pre><p>响应头的结构比较简单，返回了请求ID</p><p><img src=https://static.ddhigh.com/blog/2020-01-17-093701.png alt=image-20200117173658934></p><ul><li>Size 4字节响应正文长度（包含请求ID）</li><li>correlation_id 4字节请求ID</li><li>response message* 响应正文</li></ul><h3 id=metadata-示例>Metadata 示例</h3><h4 id=请求数据>请求数据</h4><p>Kafka Metadata对应的协议格式如下</p><pre tabindex=0><code>Metadata Request (Version: 1) =&gt; [topics] 
  topics =&gt; name 
    name =&gt; STRING
</code></pre><p>我们转化为表格看看</p><p><img src=https://static.ddhigh.com/blog/2020-01-17-093858.png alt=image-20200117173855988></p><ul><li>Size 4字节请求正文长度</li><li>Request_api_key，根据协议文档， 此处为3</li><li>Request_api_version，本文基于v1版本写作，因此版本号为1</li><li>correlation_id 请求ID</li><li>client_id length 2字节客户端长度，我们使用test作为客户端标识，此处传入4</li><li>client_id 客户端名称，传入test字符串</li><li>topic name length 需要查询的topic数组，我们查询test1这个topic，此处传入1</li><li>topic name 字符串类型，因此先写入字符串长度5(test1字符串长度为5)，再写入test1字符串（总共写入2+5 = 7个字节）</li></ul><h4 id=响应数据>响应数据</h4><pre tabindex=0><code>Metadata Response (Version: 1) =&gt; [brokers] controller_id [topics] 
  brokers =&gt; node_id host port rack 
    node_id =&gt; INT32
    host =&gt; STRING
    port =&gt; INT32
    rack =&gt; NULLABLE_STRING
  controller_id =&gt; INT32
  topics =&gt; error_code name is_internal [partitions] 
    error_code =&gt; INT16
    name =&gt; STRING
    is_internal =&gt; BOOLEAN
    partitions =&gt; error_code partition_index leader_id [replica_nodes] [isr_nodes] 
      error_code =&gt; INT16
      partition_index =&gt; INT32
      leader_id =&gt; INT32
      replica_nodes =&gt; INT32
      isr_nodes =&gt; INT32
</code></pre><p><img src=https://static.ddhigh.com/blog/2020-01-17-094212.png alt=image-20200117174211271></p><ul><li>Size 4字节响应长度</li><li>Correlation_id 4字节请求ID</li><li>Broker Count，数组类型，4字节整型标识数组长度<ul><li>node_id 4字节整型，broker的节点ID</li><li>host 字符串类型，主机名称</li><li>port 4字节整型，端口号</li><li>rack 可空字符串，如果broker是rack，则需要2+N字节，否则只需要2字节</li></ul></li><li>Controller_id 4字节整型</li><li>Topics 数组类型，topic数组<ul><li>error_code 2字节整型，错误码</li><li>name 字符串类型，topic名称</li><li>is_internal 布尔类型，是否内部topic</li><li>partions 数组类型，topic所在partition<ul><li>error_code 2字节整型，错误码</li><li>partition_index 4字节整型，partition index</li><li>leader_id 4字节整型，leader id</li><li>Replica_nodes 数组类型<ul><li>Replica_node 4字节整型</li></ul></li><li>isr_nodes 数组类型<ul><li>Isr_node 4字节整型</li></ul></li></ul></li></ul></li></ul><blockquote><p>其他类型的请求也可以使用同样的方式去分析</p></blockquote><h2 id=php客户端实现>PHP客户端实现</h2><p>PHP自带了pack/unpack函数帮助我们操作二进制数据，不过pack/unpack易用性比较低。</p><blockquote><p>对于二进制数据，java有byte[]，golang有[]byte，PHP没有专门的类型，而是使用字符串存储的，不过PHP字符串是二进制安全的。</p></blockquote><p>针对pack/unpack函数易用性问题，这两天参考Java的IO系统开发了一个简单版本的io库来简化二进制数据流的操作（文末有仓库地址）。</p><p>接下来使用该库来编写一个kafka的客户端。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span><span style=color:#e6db74>/**
</span></span></span><span style=display:flex><span><span style=color:#e6db74> * 读取kafka broker列表
</span></span></span><span style=display:flex><span><span style=color:#e6db74> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>require</span> <span style=color:#66d9ef>__DIR__</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/../vendor/autoload.php&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>io\BinaryStringInputStream</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>io\BinaryStringOutputStream</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>io\DataInputStream</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>io\DataOutputStream</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>io\FileInputStream</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> <span style=color:#a6e22e>io\FileOutputStream</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$client <span style=color:#f92672>=</span> <span style=color:#a6e22e>stream_socket_client</span>(<span style=color:#e6db74>&#39;tcp://127.0.0.1:9092&#39;</span>, $errno, $errstr, <span style=color:#ae81ff>5</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ($errno) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>die</span>($errstr);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$binaryOutputStream <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BinaryStringOutputStream</span>();
</span></span><span style=display:flex><span>$binaryPacketOutput <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataOutputStream</span>($binaryOutputStream);
</span></span><span style=display:flex><span>$binaryPacketOutput<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>writeUnSignedShortBE</span>(<span style=color:#ae81ff>0x03</span>); <span style=color:#75715e>// METADATA_REQUEST
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$binaryPacketOutput<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>writeUnSignedShortBE</span>(<span style=color:#ae81ff>1</span>); <span style=color:#75715e>// API_VERSION
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$binaryPacketOutput<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>writeUnSignedIntBE</span>(<span style=color:#ae81ff>0x01</span>); <span style=color:#75715e>// 请求ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$binaryPacketOutput<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>writeUnSignedShortBE</span>(<span style=color:#a6e22e>strlen</span>(<span style=color:#e6db74>&#39;test&#39;</span>)); <span style=color:#75715e>// 客户端标识长度
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$binaryPacketOutput<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>writeString</span>(<span style=color:#e6db74>&#39;test&#39;</span>); <span style=color:#75715e>// 客户端标识
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$binaryPacketOutput<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>writeUnSignedIntBE</span>(<span style=color:#ae81ff>1</span>); <span style=color:#75715e>// topic列表数组长度
</span></span></span><span style=display:flex><span><span style=color:#75715e>// topic数组元素
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$binaryPacketOutput<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>writeUnSignedShortBE</span>(<span style=color:#a6e22e>strlen</span>(<span style=color:#e6db74>&#39;test1&#39;</span>)); <span style=color:#75715e>// 写入2字节topic名称长度
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$binaryPacketOutput<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>writeString</span>(<span style=color:#e6db74>&#39;test1&#39;</span>); <span style=color:#75715e>// topic名称
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$binaryPacketOutput<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>flush</span>(); <span style=color:#75715e>// 输出缓冲
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$packet <span style=color:#f92672>=</span> $binaryOutputStream<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>toBinaryString</span>(); <span style=color:#75715e>// 获得构造好的正文数据包
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 包装socket链接，获得多数据类型操作能力
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$out <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataOutputStream</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>FileOutputStream</span>($client));
</span></span><span style=display:flex><span>$out<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>writeUnSignedIntBE</span>(<span style=color:#a6e22e>strlen</span>($packet)); <span style=color:#75715e>// 4字节包长度
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$out<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>write</span>($packet); <span style=color:#75715e>// 包体
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$out<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>flush</span>(); <span style=color:#75715e>// 输出到Socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 实例化输入流，从socket读取数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$in <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataInputStream</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>FileInputStream</span>($client));
</span></span><span style=display:flex><span>$size <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>(); <span style=color:#75715e>// 4字节包长度
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 一次性读取完socket数据后关闭，然后将读取到的响应数据填充到二进制字符串输入流中，释放socket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$in <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataInputStream</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BinaryStringInputStream</span>(<span style=color:#a6e22e>fread</span>($client, $size)));
</span></span><span style=display:flex><span><span style=color:#a6e22e>fclose</span>($client);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$requestId <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>(); <span style=color:#75715e>// 4字节请求ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;packet length: %d requestId: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, $size, $requestId);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$brokerCount <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>(); <span style=color:#75715e>// broker数量
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>for</span> ($i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $i <span style=color:#f92672>&lt;</span> $brokerCount; $i<span style=color:#f92672>++</span>) { <span style=color:#75715e>// 循环读取broker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $nodeId <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>(); <span style=color:#75715e>// nodeId
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $hostLength <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedShortBE</span>(); <span style=color:#75715e>// host长度
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $host <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readString</span>($hostLength); <span style=color:#75715e>// 主机名
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $port <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>(); <span style=color:#75715e>// port
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $rackLength <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readShortBE</span>(); <span style=color:#75715e>// rack
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    $rack <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ($rackLength <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        $rack <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readString</span>($rackLength);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;nodeId:%d host:%s port:%d rack: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, $nodeId, $host, $port, $rack);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>$controllerId <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;controllerId: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, $controllerId);
</span></span><span style=display:flex><span>$topicCount <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;topic count %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, $topicCount);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ($i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $i <span style=color:#f92672>&lt;</span> $topicCount; $i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;----topic list----</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    $errCode <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedShortBE</span>();
</span></span><span style=display:flex><span>    $nameLength <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedShortBE</span>();
</span></span><span style=display:flex><span>    $name <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readString</span>($nameLength);
</span></span><span style=display:flex><span>    $isInternal <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedChar</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;errcode: %d name: %s interval: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, $errCode, $name, $isInternal);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $partitionCount <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;----topic [%s] partition list count %d---</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, $name, $partitionCount);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> ($j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $j <span style=color:#f92672>&lt;</span> $partitionCount; $j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        $errCode <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedShortBE</span>();
</span></span><span style=display:flex><span>        $partitionIndex <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>();
</span></span><span style=display:flex><span>        $leaderId <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>();
</span></span><span style=display:flex><span>        $replicaNodesCount <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>();
</span></span><span style=display:flex><span>        $replicaNodes <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> ($k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $k <span style=color:#f92672>&lt;</span> $replicaNodesCount; $k<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            $replicaNodes[] <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        $isrNodeCount <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>();
</span></span><span style=display:flex><span>        $isrNodes <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> ($k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $k <span style=color:#f92672>&lt;</span> $isrNodeCount; $k<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            $isrNodes[] <span style=color:#f92672>=</span> $in<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>readUnSignedIntBE</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;errcode: %d partitionIndex: %d leaderId: %d replicaNodes: [%s] isrNodes: [%s]</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>            $errCode,
</span></span><span style=display:flex><span>            $partitionIndex,
</span></span><span style=display:flex><span>            $leaderId,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;,&#39;</span>, $replicaNodes),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;,&#39;</span>, $isrNodes)
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>输出如下：</p><pre tabindex=0><code>packet length: 73 requestId: 1
nodeId:0 host:bogon port:9092 rack: 
controllerId: 0
topic count 1
----topic list----
errcode: 0 name: test1 interval: 0
----topic [test1] partition list count 1---
errcode: 0 partitionIndex: 0 leaderId: 0 replicaNodes: [0] isrNodes: [0]
</code></pre><h2 id=项目地址>项目地址</h2><p><a href=https://github.com/xialeistudio/php-io>php-io</a></p><p>(完)</p></section><div class=paginator><a class=prev href=https://www.ddhigh.com/2020/02/01/java-resource-load/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>Java中加载文件的几种方式</span></a>
<a class=next href=https://www.ddhigh.com/2019/12/30/javascript-event/><span>Javascript事件系统</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","xialeistudio/discussion"),s.setAttribute("data-repo-id","R_kgDOKurTRA"),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOKurTRM4CbCJt"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2014 - 2023 <a href=https://www.ddhigh.com>Lei Xia</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
<a href=https://umami-beta-peach.vercel.app/ target=_blank>Statistics</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>