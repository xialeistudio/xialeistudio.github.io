<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Redis优化高并发下的秒杀性能</title>
<meta charset=utf-8><meta content="Web开发 ,Java ,Go ,Node.js ,PHP ,Koa ,MySQL ,Redis ,前端 ,后端 ,数据库" name=keywords><meta name=description content="本文内容
使用Redis优化高并发场景下的接口性能 数据库乐观锁 随着双11的临近，各种促销活动开始变得热门起来，比较主流的有秒杀、抢优惠券、拼团等等。
涉及到高并发争抢同一个资源的主要场景有秒杀和抢优惠券。"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/2019/10/29/redis-high-concurrent/><meta name=baidu-site-verification content="IdPCSpVMQx"><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com//index.xml title="Lei Xia"><script async src="https://www.googletagmanager.com/gtag/js?id=G-EC3XLVSGKV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EC3XLVSGKV")</script><meta property="og:title" content="Redis优化高并发下的秒杀性能"><meta property="og:description" content="本文内容
使用Redis优化高并发场景下的接口性能 数据库乐观锁 随着双11的临近，各种促销活动开始变得热门起来，比较主流的有秒杀、抢优惠券、拼团等等。
涉及到高并发争抢同一个资源的主要场景有秒杀和抢优惠券。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ddhigh.com/2019/10/29/redis-high-concurrent/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-29T12:00:00+00:00"><meta property="article:modified_time" content="2019-10-29T12:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Redis优化高并发下的秒杀性能"><meta name=twitter:description content="本文内容
使用Redis优化高并发场景下的接口性能 数据库乐观锁 随着双11的临近，各种促销活动开始变得热门起来，比较主流的有秒杀、抢优惠券、拼团等等。
涉及到高并发争抢同一个资源的主要场景有秒杀和抢优惠券。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.ddhigh.com/posts/"},{"@type":"ListItem","position":2,"name":"Redis优化高并发下的秒杀性能","item":"https://www.ddhigh.com/2019/10/29/redis-high-concurrent/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Redis优化高并发下的秒杀性能","name":"Redis优化高并发下的秒杀性能","description":"本文内容\n使用Redis优化高并发场景下的接口性能 数据库乐观锁 随着双11的临近，各种促销活动开始变得热门起来，比较主流的有秒杀、抢优惠券、拼团等等。\n涉及到高并发争抢同一个资源的主要场景有秒杀和抢优惠券。","keywords":["redis"],"articleBody":"本文内容\n使用Redis优化高并发场景下的接口性能 数据库乐观锁 随着双11的临近，各种促销活动开始变得热门起来，比较主流的有秒杀、抢优惠券、拼团等等。\n涉及到高并发争抢同一个资源的主要场景有秒杀和抢优惠券。\n前提 活动规则\n奖品数量有限，比如100个 不限制参与用户数 每个用户只能参与1次秒杀 活动要求\n不能多发，也不能少发，100个奖品要全部发出去 1个用户最多抢1个奖品 遵循先到先得原则，先来的用户有奖品 数据库实现 悲观锁性能太差，本文不予讨论，讨论一下使用乐观锁解决高并发问题的优缺点。\n数据库结构 ID Code UserId CreatedAt RewardAt 奖品ID 奖品码 用户ID 创建时间 中奖时间 未中奖时UserId为0，RewardAt为NULL 中奖时UserId为中奖用户ID，RewardAt为中奖时间 乐观锁实现 乐观锁实际上并不存在真正的锁，乐观锁是利用数据的某个字段来做的，比如本文的例子就是以UserId来实现的。\n实现流程如下：\n查询UserId为0的奖品，如果未找到则提示无奖品\nSELECT * FROM envelope WHERE user_id=0 LIMIT 1 更新奖品的用户ID和中奖时间(假设奖品ID为1，中奖用户ID为100，当前时间为2019-10-29 12:00:00)，这里的user_id=0就是我们的乐观锁了。\nUPDATE envelope SET user_id=100, reward_at='2019-10-29 12:00:00' WHERE user_id=0 AND id=1 检测UPDATE语句的执行返回值，如果返回1证明中奖成功，否则证明该奖品被其他人抢了\n为什么要添加乐观锁 正常情况下获取奖品、然后把奖品更新给指定用户是没问题的。如果不添加user_id=0时，高并发场景下会出现下面的问题：\n两个用户同时查询到了1个未中奖的奖品(发生并发问题) 将奖品的中奖用户更新为用户1，更新条件只有ID=奖品ID 上述SQL执行是成功的，影响行数也是1，此时接口会返回用户1中奖 接下来将中奖用户更新为用户2，更新条件也只有ID=奖品ID 由于是同一个奖品，已经发给用户1的奖品会重新发放给用户2，此时影响行数为1，接口返回用户2也中奖 所以该奖品的最终结果是发放给用户2 用户1就会过来投诉活动方了，因为抽奖接口返回用户1中奖，但他的奖品被抢了，此时活动方只能赔钱了 添加乐观锁之后的抽奖流程 更新用户1时的条件为id=红包ID AND user_id=0 ,由于此时红包未分配给任何人，用户1更新成功，接口返回用户1中奖 当更新用户2时更新条件为id=红包ID AND user_id=0，由于此时该红包已经分配给用户1了，所以该条件不会更新任何记录，接口返回用户2中奖 乐观锁优缺点 优点\n性能尚可，因为无锁 不会超发 缺点\n通常不满足“先到先得”的活动规则，一旦发生并发，就会发生未中奖的情况，此时奖品库还有奖品 压测 在MacBook Pro 2018上的压测表现如下(Golang实现的HTTP服务器,MySQL连接池大小100，Jmeter压测)：\n500并发 500总请求数 平均响应时间331ms 发放成功数为31 吞吐量458.7/s Redis实现 可以看到乐观锁的实现下争抢比太高，不是推荐的实现方法，下面通过Redis来优化这个秒杀业务。\nRedis高性能的原因 单线程 省去了线程切换开销 基于内存的操作 虽然持久化操作涉及到硬盘访问，但是那是异步的，不会影响Redis的业务 使用了IO多路复用 实现流程 活动开始前将数据库中奖品的code写入Redis队列中\n活动进行时使用lpop弹出队列中的元素\n如果获取成功，则使用UPDATE语法发放奖品\nUPDATE reward SET user_id=用户ID,reward_at=当前时间 WHERE code='奖品码' 如果获取失败，则当前无可用奖品，提示未中奖即可\n使用Redis的情况下并发访问是通过Redis的lpop()来保证的，该方法是原子方法，可以保证并发情况下也是一个个弹出的。\n压测 在MacBook Pro 2018上的压测表现如下(Golang实现的HTTP服务器,MySQL连接池大小100，Redis连接池代销100，Jmeter压测)：\n500并发 500总请求数 平均响应时间48ms 发放成功数100 吞吐量497.0/s 结论 可以看到Redis的表现是稳定的，不会出现超发，且访问延迟少了8倍左右，吞吐量还没达到瓶颈，可以看出Redis对于高并发系统的性能提升是非常大的！接入成本也不算高，值得学习！\n实验代码 // main.go package main import ( \"fmt\" \"github.com/go-redis/redis\" _ \"github.com/go-sql-driver/mysql\" \"github.com/jinzhu/gorm\" \"log\" \"net/http\" \"strconv\" \"time\" ) type Envelope struct { Id int `gorm:\"primary_key\"` Code string UserId int CreatedAt time.Time RewardAt *time.Time } func (Envelope) TableName() string { return \"envelope\" } func (p *Envelope) BeforeCreate() error { p.CreatedAt = time.Now() return nil } const ( QueueEnvelope = \"envelope\" QueueUser = \"user\" ) var ( db *gorm.DB redisClient *redis.Client ) func init() { var err error db, err = gorm.Open(\"mysql\", \"root:root@tcp(localhost:3306)/test?charset=utf8\u0026parseTime=True\u0026loc=Local\") if err != nil { log.Fatal(err) } if err = db.DB().Ping(); err != nil { log.Fatal(err) } db.DB().SetMaxOpenConns(100) fmt.Println(\"database connected. pool size 10\") } func init() { redisClient = redis.NewClient(\u0026redis.Options{ Addr: \"localhost:6379\", DB: 0, PoolSize: 100, }) if _, err := redisClient.Ping().Result(); err != nil { log.Fatal(err) } fmt.Println(\"redis connected. pool size 100\") } // 读取Code写入Queue func init() { envelopes := make([]Envelope, 0, 100) if err := db.Debug().Where(\"user_id=0\").Limit(100).Find(\u0026envelopes).Error; err != nil { log.Fatal(err) } if len(envelopes) != 100 { log.Fatal(\"不足100个奖品\") } for i := range envelopes { if err := redisClient.LPush(QueueEnvelope, envelopes[i].Code).Err(); err != nil { log.Fatal(err) } } fmt.Println(\"load 100 envelopes\") } func main() { http.HandleFunc(\"/envelope\", func(w http.ResponseWriter, r *http.Request) { uid := r.Header.Get(\"x-user-id\") if uid == \"\" { w.WriteHeader(401) _, _ = fmt.Fprint(w, \"UnAuthorized\") return } uidValue, err := strconv.Atoi(uid) if err != nil { w.WriteHeader(400) _, _ = fmt.Fprint(w, \"Bad Request\") return } // 检测用户是否抢过了 if result, err := redisClient.HIncrBy(QueueUser, uid, 1).Result(); err != nil || result != 1 { w.WriteHeader(429) _, _ = fmt.Fprint(w, \"Too Many Request\") return } // 检测是否在队列中 code, err := redisClient.LPop(QueueEnvelope).Result() if err != nil { w.WriteHeader(200) _, _ = fmt.Fprint(w, \"No Envelope\") return } // 发放红包 envelope := \u0026Envelope{} err = db.Where(\"code=?\", code).Take(\u0026envelope).Error if err == gorm.ErrRecordNotFound { w.WriteHeader(200) _, _ = fmt.Fprint(w, \"No Envelope\") return } if err != nil { w.WriteHeader(500) _, _ = fmt.Fprint(w, err) return } now := time.Now() envelope.UserId = uidValue envelope.RewardAt = \u0026now rowsAffected := db.Where(\"user_id=0\").Save(\u0026envelope).RowsAffected // 添加user_id=0来验证Redis是否真的解决争抢问题 if rowsAffected == 0 { fmt.Printf(\"发生争抢. id=%d\\n\", envelope.Id) w.WriteHeader(500) _, _ = fmt.Fprintf(w, \"发生争抢. id=%d\\n\", envelope.Id) return } _, _ = fmt.Fprint(w, envelope.Code) }) fmt.Println(\"listen on 8080\") fmt.Println(http.ListenAndServe(\":8080\", nil)) } ","wordCount":"470","inLanguage":"zh","datePublished":"2019-10-29T12:00:00Z","dateModified":"2019-10-29T12:00:00Z","author":{"@type":"Person","name":"Lei Xia"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com/2019/10/29/redis-high-concurrent/"},"publisher":{"@type":"Organization","name":"Lei Xia","logo":{"@type":"ImageObject","url":"https://www.ddhigh.com/favicon.ico"}}}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.eb16e2c37edda7bb7b8f844336c65138877ea26f51562d3d69efff7f073bff83.css integrity="sha256-6xbiw37dp7t7j4RDNsZROId+om9RVi09ae//fwc7/4M=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>$darkModeInit.Content|safeJS</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>每天进步一点点
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>归档</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>出版物</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>留言板</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li><li class="navigation-item navigation-language"><a href=https://www.ddhigh.com/en/>EN</a></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Redis优化高并发下的秒杀性能</h1></header><p><small>2019年10月29日&nbsp;· 470 字&nbsp;· 3 分钟</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#前提>前提</a></li><li><a href=#数据库实现>数据库实现</a><ul><li><a href=#数据库结构>数据库结构</a></li><li><a href=#乐观锁实现>乐观锁实现</a></li><li><a href=#压测>压测</a></li></ul></li><li><a href=#redis实现>Redis实现</a><ul><li><a href=#redis高性能的原因>Redis高性能的原因</a></li><li><a href=#实现流程>实现流程</a></li><li><a href=#压测-1>压测</a></li></ul></li><li><a href=#结论>结论</a></li><li><a href=#实验代码>实验代码</a></li></ul></nav></div><section class=blog-content><p>本文内容</p><ul><li>使用Redis优化高并发场景下的接口性能</li><li>数据库乐观锁</li></ul><p>随着双11的临近，各种促销活动开始变得热门起来，比较主流的有秒杀、抢优惠券、拼团等等。</p><p>涉及到高并发争抢同一个资源的主要场景有秒杀和抢优惠券。</p><h2 id=前提>前提</h2><p>活动规则</p><ul><li>奖品数量有限，比如100个</li><li>不限制参与用户数</li><li>每个用户只能参与1次秒杀</li></ul><p>活动要求</p><ul><li>不能多发，也不能少发，100个奖品要全部发出去</li><li>1个用户最多抢1个奖品</li><li>遵循先到先得原则，先来的用户有奖品</li></ul><h2 id=数据库实现>数据库实现</h2><p>悲观锁性能太差，本文不予讨论，讨论一下使用乐观锁解决高并发问题的优缺点。</p><h3 id=数据库结构>数据库结构</h3><table><thead><tr><th>ID</th><th>Code</th><th>UserId</th><th>CreatedAt</th><th>RewardAt</th></tr></thead><tbody><tr><td>奖品ID</td><td>奖品码</td><td>用户ID</td><td>创建时间</td><td>中奖时间</td></tr></tbody></table><ul><li>未中奖时UserId为0，RewardAt为NULL</li><li>中奖时UserId为中奖用户ID，RewardAt为中奖时间</li></ul><h3 id=乐观锁实现>乐观锁实现</h3><p>乐观锁实际上并不存在真正的锁，乐观锁是利用数据的某个字段来做的，比如本文的例子就是以UserId来实现的。</p><p>实现流程如下：</p><ol><li><p>查询UserId为0的奖品，如果未找到则提示无奖品</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> envelope <span style=color:#66d9ef>WHERE</span> user_id<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></div></li><li><p>更新奖品的用户ID和中奖时间(假设奖品ID为1，中奖用户ID为100，当前时间为2019-10-29 12:00:00)，这里的user_id=0就是我们的乐观锁了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>UPDATE</span> envelope <span style=color:#66d9ef>SET</span> user_id<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>, reward_at<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;2019-10-29 12:00:00&#39;</span> <span style=color:#66d9ef>WHERE</span> user_id<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> <span style=color:#66d9ef>AND</span> id<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></div></li><li><p>检测UPDATE语句的执行返回值，如果返回1证明中奖成功，否则证明该奖品被其他人抢了</p></li></ol><h4 id=为什么要添加乐观锁>为什么要添加乐观锁</h4><p>正常情况下获取奖品、然后把奖品更新给指定用户是没问题的。如果不添加user_id=0时，高并发场景下会出现下面的问题：</p><ol><li>两个用户同时查询到了1个未中奖的奖品(发生并发问题)</li><li>将奖品的中奖用户更新为用户1，更新条件只有ID=奖品ID</li><li>上述SQL执行是成功的，影响行数也是1，此时接口会返回用户1中奖</li><li>接下来将中奖用户更新为用户2，更新条件也只有ID=奖品ID</li><li>由于是同一个奖品，已经发给用户1的奖品会重新发放给用户2，此时影响行数为1，接口返回用户2也中奖</li><li>所以该奖品的最终结果是发放给用户2</li><li><code>用户1就会过来投诉活动方了，因为抽奖接口返回用户1中奖，但他的奖品被抢了，此时活动方只能赔钱了</code></li></ol><h4 id=添加乐观锁之后的抽奖流程>添加乐观锁之后的抽奖流程</h4><ol><li>更新用户1时的条件为<code>id=红包ID AND user_id=0</code> ,由于此时红包未分配给任何人，用户1更新成功，接口返回用户1中奖</li><li>当更新用户2时更新条件为<code>id=红包ID AND user_id=0</code>，由于此时该红包已经分配给用户1了，所以该条件不会更新任何记录，接口返回用户2中奖</li></ol><h4 id=乐观锁优缺点>乐观锁优缺点</h4><p>优点</p><ul><li>性能尚可，因为无锁</li><li>不会超发</li></ul><p>缺点</p><ul><li>通常不满足“先到先得”的活动规则，一旦发生并发，就会发生未中奖的情况，此时奖品库还有奖品</li></ul><h3 id=压测>压测</h3><p>在MacBook Pro 2018上的压测表现如下(Golang实现的HTTP服务器,MySQL连接池大小100，Jmeter压测)：</p><ul><li>500并发 500总请求数 平均响应时间331ms 发放成功数为31 吞吐量458.7/s</li></ul><h2 id=redis实现>Redis实现</h2><p>可以看到乐观锁的实现下争抢比太高，不是推荐的实现方法，下面通过Redis来优化这个秒杀业务。</p><h3 id=redis高性能的原因>Redis高性能的原因</h3><ul><li>单线程 省去了线程切换开销</li><li>基于内存的操作 虽然持久化操作涉及到硬盘访问，但是那是异步的，不会影响Redis的业务</li><li>使用了IO多路复用</li></ul><h3 id=实现流程>实现流程</h3><ol><li><p>活动开始前将数据库中奖品的code写入Redis队列中</p></li><li><p>活动进行时使用lpop弹出队列中的元素</p></li><li><p>如果获取成功，则使用UPDATE语法发放奖品</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>UPDATE</span> reward <span style=color:#66d9ef>SET</span> user_id<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>用户</span>ID,reward_at<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>当前时间</span> <span style=color:#66d9ef>WHERE</span> code<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;奖品码&#39;</span>
</span></span></code></pre></div></li><li><p>如果获取失败，则当前无可用奖品，提示未中奖即可</p></li></ol><p>使用Redis的情况下并发访问是通过Redis的<code>lpop()</code>来保证的，该方法是原子方法，可以保证并发情况下也是一个个弹出的。</p><h3 id=压测-1>压测</h3><p>在MacBook Pro 2018上的压测表现如下(Golang实现的HTTP服务器,MySQL连接池大小100，Redis连接池代销100，Jmeter压测)：</p><ul><li>500并发 500总请求数 平均响应时间48ms 发放成功数100 吞吐量497.0/s</li></ul><h2 id=结论>结论</h2><p>可以看到Redis的表现是稳定的，不会出现超发，且访问延迟少了8倍左右，吞吐量还没达到瓶颈，可以看出Redis对于高并发系统的性能提升是非常大的！接入成本也不算高，值得学习！</p><p><img alt=0.jpeg src=https://static.ddhigh.com/blog/2019-10-22-102654.jpg></p><h2 id=实验代码>实验代码</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// main.go
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/go-redis/redis&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_</span> <span style=color:#e6db74>&#34;github.com/go-sql-driver/mysql&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/jinzhu/gorm&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Envelope</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Id</span>        <span style=color:#66d9ef>int</span> <span style=color:#e6db74>`gorm:&#34;primary_key&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Code</span>      <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UserId</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>CreatedAt</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RewardAt</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>Envelope</span>) <span style=color:#a6e22e>TableName</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;envelope&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Envelope</span>) <span style=color:#a6e22e>BeforeCreate</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>p</span>.<span style=color:#a6e22e>CreatedAt</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>QueueEnvelope</span> = <span style=color:#e6db74>&#34;envelope&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>QueueUser</span>     = <span style=color:#e6db74>&#34;user&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>          <span style=color:#f92672>*</span><span style=color:#a6e22e>gorm</span>.<span style=color:#a6e22e>DB</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>redisClient</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>gorm</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;mysql&#34;</span>, <span style=color:#e6db74>&#34;root:root@tcp(localhost:3306)/test?charset=utf8&amp;parseTime=True&amp;loc=Local&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>DB</span>().<span style=color:#a6e22e>Ping</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>DB</span>().<span style=color:#a6e22e>SetMaxOpenConns</span>(<span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;database connected. pool size 10&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>redisClient</span> = <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Options</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Addr</span>:     <span style=color:#e6db74>&#34;localhost:6379&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>DB</span>:       <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>PoolSize</span>: <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>Ping</span>().<span style=color:#a6e22e>Result</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;redis connected. pool size 100&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 读取Code写入Queue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>envelopes</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>Envelope</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Debug</span>().<span style=color:#a6e22e>Where</span>(<span style=color:#e6db74>&#34;user_id=0&#34;</span>).<span style=color:#a6e22e>Limit</span>(<span style=color:#ae81ff>100</span>).<span style=color:#a6e22e>Find</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>envelopes</span>).<span style=color:#a6e22e>Error</span>; <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>envelopes</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>100</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#e6db74>&#34;不足100个奖品&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>envelopes</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>LPush</span>(<span style=color:#a6e22e>QueueEnvelope</span>, <span style=color:#a6e22e>envelopes</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Code</span>).<span style=color:#a6e22e>Err</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;load 100 envelopes&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/envelope&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>uid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Header</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;x-user-id&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>uid</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>401</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;UnAuthorized&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>uidValue</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>uid</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>400</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Bad Request&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 检测用户是否抢过了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>HIncrBy</span>(<span style=color:#a6e22e>QueueUser</span>, <span style=color:#a6e22e>uid</span>, <span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>Result</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>429</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Too Many Request&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 检测是否在队列中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>code</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>LPop</span>(<span style=color:#a6e22e>QueueEnvelope</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;No Envelope&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 发放红包
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>envelope</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Envelope</span>{}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Where</span>(<span style=color:#e6db74>&#34;code=?&#34;</span>, <span style=color:#a6e22e>code</span>).<span style=color:#a6e22e>Take</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>envelope</span>).<span style=color:#a6e22e>Error</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>gorm</span>.<span style=color:#a6e22e>ErrRecordNotFound</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>200</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;No Envelope&#34;</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>envelope</span>.<span style=color:#a6e22e>UserId</span> = <span style=color:#a6e22e>uidValue</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>envelope</span>.<span style=color:#a6e22e>RewardAt</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>now</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>rowsAffected</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Where</span>(<span style=color:#e6db74>&#34;user_id=0&#34;</span>).<span style=color:#a6e22e>Save</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>envelope</span>).<span style=color:#a6e22e>RowsAffected</span> <span style=color:#75715e>// 添加user_id=0来验证Redis是否真的解决争抢问题
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rowsAffected</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;发生争抢. id=%d\n&#34;</span>, <span style=color:#a6e22e>envelope</span>.<span style=color:#a6e22e>Id</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#ae81ff>500</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;发生争抢. id=%d\n&#34;</span>, <span style=color:#a6e22e>envelope</span>.<span style=color:#a6e22e>Id</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>envelope</span>.<span style=color:#a6e22e>Code</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;listen on 8080&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#e6db74>&#34;:8080&#34;</span>, <span style=color:#66d9ef>nil</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div style="margin-top:2em;border:1px solid #d3d3d3;background-color:#f7f7f7"><ul><li style=margin-bottom:.5em>本文作者: <a href=https://ddhigh.com/ target=_blank style=color:#000;text-decoration:none>xialeistudio</a></li><li style=margin-bottom:.5em>本文链接: <a href=https://www.ddhigh.com/2019/10/29/redis-high-concurrent/ target=_blank style=color:#000;text-decoration:none>Redis优化高并发下的秒杀性能</a></li><li>版权声明: <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank style=color:#000;text-decoration:none>「署名-非商业性使用-相同方式共享 4.0 国际」</a></li></ul></div></section><div class=paginator><a class=prev href=https://www.ddhigh.com/2019/10/30/twblog/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>我是如何发现我的文章被侵权以及如何得到侵权网站的联系方式的?</span></a>
<a class=next href=https://www.ddhigh.com/2019/10/28/symbol/><span>深入浅出ES6的Symbol类型</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","xialeistudio/discussion"),s.setAttribute("data-repo-id","R_kgDOKurTRA"),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOKurTRM4CbCJt"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2014 - 2024 <a href=https://www.ddhigh.com/>Lei Xia</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>