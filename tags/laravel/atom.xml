<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>laravel on Lei Xia</title><link>https://www.ddhigh.com/tags/laravel/</link><description>Recent content in laravel on Lei Xia</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Tue, 20 Oct 2020 11:17:09 +0000</lastBuildDate><atom:link href="https://www.ddhigh.com/tags/laravel/atom.xml" rel="self" type="application/rss+xml"/><item><title>Laravel定时任务写入日志用户变为root导致Web进程无法写入日志问题</title><link>https://www.ddhigh.com/2020/10/20/laravel-crontab-log-permission/</link><pubDate>Tue, 20 Oct 2020 11:17:09 +0000</pubDate><guid>https://www.ddhigh.com/2020/10/20/laravel-crontab-log-permission/</guid><description>&lt;p>今天访问接口时返回 &lt;strong>接口写入日志失败&lt;/strong>，通过排查后发现 &lt;code>storage/logs&lt;/code>下面出现了&lt;code>root&lt;/code>用户新建的日志，导致&lt;code>www&lt;/code>用户无法写入日志。&lt;/p>
&lt;p>通过排查发现，&lt;code>crontab&lt;/code>写入了&lt;code>laravel&lt;/code>的&lt;code>定时任务命令&lt;/code>。默认情况下，crontab的任务是使用&lt;code>root&lt;/code>用户去执行的，因此&lt;code>laravel定时任务&lt;/code>新建的文件属主自然成为了&lt;code>root&lt;/code>。&lt;/p>
&lt;h2 id="解决方法">解决方法&lt;/h2>
&lt;p>解决方法就是&lt;code>使用指定用户来运行 crontab 任务&lt;/code>。比如使用&lt;code>www&lt;/code>用户来运行&lt;code>laravel&lt;/code>的计划任务命令。&lt;/p>
&lt;p>使用下面的命令编辑&lt;code>www&lt;/code>用户的定时任务。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>crontab -u www -e
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>例如写入下面的示例任务：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>* * * * * /usr/local/php/bin/php /data/wwwroot/laravel/artisan schedule:run &amp;gt;&amp;gt; /var/log/laravel-crontab.log 2&amp;gt;&amp;amp;&lt;span style="color:#ae81ff">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>保存即可，等待系统运行任务。&lt;/p>
&lt;h2 id="运行时错误">运行时错误&lt;/h2>
&lt;p>通过观察发现定时任务并没有成功运行，通过查询&lt;code>/var/log/cron&lt;/code>日志发现如下的日志：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-text" data-lang="text">&lt;span style="display:flex;">&lt;span>(www) CMD (/usr/local/php/bin/php /data/wwwroot/laravel/artisan schedule:run &amp;gt;&amp;gt; /var/log/laravel-crontab.log 2&amp;gt;&amp;amp;1)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>(CRON) ERROR chdir failed (/home/www): No such file or directory
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>可以看到，定时任务确实有执行，但是执行出错。出现这个问题的原因是&lt;code>www 用户没有主目录&lt;/code>。&lt;/p>
&lt;p>解决方案如下：&lt;/p>
&lt;ol>
&lt;li>新建&lt;code>/home/www&lt;/code>目录&lt;/li>
&lt;li>将&lt;code>/home/www&lt;/code>的用户属主改为&lt;code>www&lt;/code>用户&lt;/li>
&lt;/ol>
&lt;p>相关命令如下：&lt;/p>
&lt;pre tabindex="0">&lt;code>mkdir /home/www
chown -R www:www /home/www
&lt;/code>&lt;/pre>&lt;p>后续执行没有再出现错误。&lt;/p></description></item></channel></rss>