<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>java</title>
<meta charset=utf-8><meta name=description content="Ladder@Learning & Writing & Sharing"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/tags/java/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com/index.xml title="Lei Xia"><script async defer data-website-id=865c8529-0729-4cf5-88a9-448616abbcbb src=https://umami-beta-peach.vercel.app/xialeistudio></script><meta property="og:title" content="java"><meta property="og:description" content="Learning & Writing & Sharing"><meta property="og:type" content="website"><meta property="og:url" content="https://www.ddhigh.com/tags/java/"><meta name=twitter:card content="summary"><meta name=twitter:title content="java"><meta name=twitter:description content="Learning & Writing & Sharing"><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.ff1bc260fafbfb440e10194d7d06d57eb5e85eed11d12d06255581262664204e.css integrity="sha256-/xvCYPr7+0QOEBlNfQbVfrXoXu0R0S0GJVWBJiZkIE4=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>Guestbook</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><div class=blog-wrapper><div><div class=blog-list><article><div class=blog-card><h3><a href=/2018/06/14/permissionscope-with-swift-4/>PermissionScope Swift4 兼容问题</a></h3><p><small>June 14, 2018&nbsp;· 36 words&nbsp;· One minute</small><p>PermissionScope是iOS非常好用的权限处理库，界面效果也非常精美。不幸的是作者已经停止维护。
PermissionScope is no longer supported. Please use an alternative if you need updates for newer iOS 10 and 11 APIs!
问题的来源 因为作者是基于Swift3开发的，而4.0的@selector语法有一点调整，所以是不能通过编译的，处理办法是根据Xcode的提示一个个修正。
可是事情真的这么简单吗？Xcode处理过后虽然编译通过了，但是会触发运行时错误。错误内容大致是调用了不存在的方法。
解决方案 由于我们根据Xcode的提示给相关代码加了@objc，但是有些方法是没有加的，而这些方法类似下面的代码：
func requestCamera() { } 由于没有@objc修饰，@selector指令找不到方法，所以就报错了。解决方案如下：
@objc func requestCamera() { }</div></article><article><div class=blog-card><h3><a href=/2018/04/24/yii2-dependency-inject/>使用yii2依赖注入规范业务开发</a></h3><p><small>April 24, 2018&nbsp;· 494 words&nbsp;· 3 min</small><p>本文代码 https://github.com/xialeistudio/yii2-di-demo
什么是依赖注入(DI)? 对象由框架来创建而不是程序员通过 new 创建。跟IoC差不多一个意思。
为什么要有依赖注入? 解耦。调用方不再通过 new 运算符实例化被调用对象，而通过框架(IoC容器)创建之后注入进来。解除了调用者与被调用者之间的依赖。 有利于面向接口编程。个人认为OOP程序设计最重要的就是面向接口(面向抽象)编程。因为有了第1步的关系，调用者只需要依赖接口类型而不用依赖实现类型，提高了程序的扩展性。 Yii2的依赖注入 Yii2通过 yii\di\Container 提供DI容器特性。目前支持一下4种方式注入：
构造方法注入 方法注入 Setter和属性注入 PHP回调注入 注册依赖关系 通过容器的 set 方法注入 通过配置文件注入(推荐) 依赖注入实战 打开终端，执行以下命令初始化项目：
composer create-project --prefer-dist yiisoft/yii2-app-basic basic 声明接口业务类 app\services\UserService
&lt;?php /** * Created by PhpStorm. * User: xialei * Date: 2018/4/24 * Time: 下午10:55 */ namespace app\services; /** * 用户业务类 * Interface UserService * @package app\services */ interface UserService { /** * 根据ID查询用户 * @param integer $id * @return array|null */ public function show($id); /** * 查看所有用户 * @return array */ public function all(); } 接口实现文件 app\services\impl\UserServiceImpl</div></article><article><div class=blog-card><h3><a href=/2018/04/08/golang-travis-ci/>golang使用travis进行持续集成</a></h3><p><small>April 8, 2018&nbsp;· 65 words&nbsp;· One minute</small><p>虽然golang的工程工具已经非常完善了，比如测试、代码格式化等等。但是如果开发library开源到github的话，这些东西是可以使用自动化工具完成的，那就是 travis
使用步骤 开发好需要集成的library以及测试用例 在项目根目录新建.travis.yml文件 language: go go: - 1.x - '1.8' - '1.9' - 1.10.x script: - go test -v ./... 提交到github 打开https://www.travis-ci.org/并使用github账号登录 登录之后点击左边 &ldquo;My Repositories&rdquo; 旁边的 "+" 号添加项目（点击项目前面的滑块即可） 更改项目文件，push一次到github，此时travis会自动运行测试脚本 敏感数据加密 如果你的测试用例需要使用到敏感数据（如一些密钥等等），那需要用travis将你的敏感数据加密(以Mac为例)
终端执行sudo gem install travis 在项目根目录打开终端执行travis encrypt AMAP_KEY="xxxx" --add AMAP_KEY是环境变量名称，程序读取环境变量可以得到真实的key，xxxx是敏感数据 执行完毕后，.travis.yml 会发生更改, 会添加如下内容(secure可能不一致) env: global: secure: kr5JHNTYsh/jezvk88qP91arb+UD/op/5CyOFY7uNYpJ6ZSsJY5fDKyZHjf0VSFmaYqJFMPl6uCASE9baiepeGvBFcy8aI9CNsbLzj2uBNjqqYPmvYGnBjpzp8yknVJKRTitF/kkWtzZcWImHnpvNGHuzXxp/EIBeJtNwjcCRoP/qfGhlZKbLsYFvlWkmRYb0dr8RM5mlmGXPZi8q7m+soVRO8Zjr4QQccybgmhonxlcUrHr6ro+yjjQefoJXRufqoRX0sGyecGYucC4nUpWl5hkDPkQE+Mekhz+rF657SwNsn8nXOFnnUuwsPXE26ak5xF1roEcFk2CpwGZuT7smJZPtw1inXFdIaW+4qllbyxMJkylvFZa5IcvLT3+/eKaQc8Fg6PoxJH0PF3RdtoQVB31cQiPWNm1SecQ6wC64WA/5qN4T5OoRfpt60BFDAITdS62dQGu5LSepcXMWXhxCdQPeDm5Qce6wjJXURubJMpBm0mPWwCNZhJyRw1G5TTyO25NckXQRlObrjltvwAd+7OEUcsYXqhdPtUTIVy6w3XOwT2eC/hP0Yi7qqUMMlJTHUW7Lb9zsEc4UB5BVwgeZ5Y9bVbknJfpt3ygcXAJeeDYxwV9g16KoS7HMFPzwrqlHbiBytIahqarBd4enwqR5RYQPEyetiIDLaJA4SyQ0cE= 上传到github 接收测试结果通知 如果你需要获取travis执行结果通知的话，可以添加邮箱配置，travis执行完毕后会通知到该邮箱。
打开 .travis.yml 添加以下内容： notifications: email: recipients: - 邮箱地址 on_success: change on_failure: always 提交到github</div></article><article><div class=blog-card><h3><a href=/2018/04/05/golang-for-over-channels/>golang for遍历channel时需要注意的问题</a></h3><p><small>April 5, 2018&nbsp;· 122 words&nbsp;· One minute</small><p>最近在做一个基于RabbitMQ的应用，由于官方的qos没有golang的版本，所以出了一点问题。问题代码如下：
_, ch, err := component.NewRabbitMQ() if err != nil { panic(err) } if err := ch.Qos(10, 0, true); err != nil { panic(err) } msgs, err := ch.Consume("push", "", false, false, false, false, nil) if err != nil { panic(err) } for m := range msgs { go func(d *amqp.Delivery) { defer func() { d.Ack(false) } // 处理消息 }(&amp;m) } 发现消费到10条消息，进程就退出了，但是exit code为0，表示系统是正常退出，由于做了日志记录可以确定消费了10条，所以初步确定是qos相关问题。
排查过程 首先是把d的tag打印出来，发现全部是一样的，可以确定是重复的一条消息 一开始想到可能是经典的go协程执行在for循环结束以后导致的，但是看我的代码不属于这种情况，有使用&amp;m保证每一条消息都是不同循环传入的。所以判断可能是for循环的传递问题。 确定方向之后开始写了一个测试项目用来验证我的想法是否正确。 测试代码 package main import "fmt" func main() { ch := make(chan int, 10) for i := 0; i &lt; 10; i++ { ch &lt;- i } close(ch) for v := range ch { fmt.</div></article><article><div class=blog-card><h3><a href=/2018/03/02/golang-tcp-stick-package/>golang解决TCP粘包问题</a></h3><p><small>March 2, 2018&nbsp;· 567 words&nbsp;· 3 min</small><p>什么是TCP粘包问题以及为什么会产生TCP粘包，本文不加讨论。本文使用golang的bufio.Scanner来实现自定义协议解包。
协议数据包定义 本文模拟一个日志服务器，该服务器接收客户端传到的数据包并显示出来
type Package struct { Version [2]byte // 协议版本，暂定V1 Length int16 // 数据部分长度 Timestamp int64 // 时间戳 HostnameLength int16 // 主机名长度 Hostname []byte // 主机名 TagLength int16 // 标签长度 Tag []byte // 标签 Msg []byte // 日志数据 } 协议定义部分没有什么好讲的，根据具体的业务逻辑定义即可。
数据打包 由于TCP协议是语言无关的协议，所以直接把协议数据包结构体发送到TCP连接中也是不可能的，只能发送字节流数据，所以需要自己实现数据编码。所幸golang提供了binary来帮助我们实现网络字节编码。
func (p *Package) Pack(writer io.Writer) error { var err error err = binary.Write(writer, binary.BigEndian, &amp;p.Version) err = binary.Write(writer, binary.BigEndian, &amp;p.Length) err = binary.Write(writer, binary.BigEndian, &amp;p.Timestamp) err = binary.</div></article><article><div class=blog-card><h3><a href=/2018/03/01/golang-upload/>golang multipart上传文件到远端（如上传微信临时素材）</a></h3><p><small>March 1, 2018&nbsp;· 243 words&nbsp;· 2 min</small><p>最近在开发一个关注之后通过客服消息推送一张海报给用户的功能，海报图片是本地生成好的，需要上传到微信临时素材之后通过客服消息推送给用户。 上传文件需要multipart/form-data格式的表单，所以golang默认的http.POST方法是实现不了的。需要自行实现body参数逻辑。
上传请求初始化 // 新建上传请求 func NewUploadRequest(link string, params map[string]string, name, path string) (*http.Request, error) { fp, err := os.Open(path) // 打开文件句柄 if err != nil { return nil, err } defer fp.Close() body := &amp;bytes.Buffer{} // 初始化body参数 writer := multipart.NewWriter(body) // 实例化multipart part, err := writer.CreateFormFile(name, filepath.Base(path)) // 创建multipart 文件字段 if err != nil { return nil, err } _, err = io.Copy(part, fp) // 写入文件数据到multipart for key, val := range params { _ = writer.</div></article><article><div class=blog-card><h3><a href=/2018/03/01/golang-docker-timezone/>Docker部署golang应用时时区问题</a></h3><p><small>March 1, 2018&nbsp;· 17 words&nbsp;· One minute</small><p>目前golang用的基础镜像是busybox，由于golang交叉编译之后只有一个二进制文件，可以直接部署到容器中运行，容器镜像大小几乎等于二进制文件大小。
带来的问题 由于基础镜像太过精简，目前遇到的问题是将时间戳格式化为时间字符串时发现差了8个小时。
尝试过的解决办法 刚开始使用了Location时区相关API，但是部署到容器中发现直接报错了，因为容器中缺少相关的系统调用函数。代码如下：
loc, _ := time.LoadLocation("Asia/Shanghai") time.Now().In(loc).Format("2006-01-02 15:04:05") 目前应用会部署到docker容器中，故处理办法比较原始，直接在Time对象上添加8个小时来解决时差问题。代码如下:
time.Now().Add(time.Hour * 8).Format("2006年01月02日 15:04"), 暂时解决了这个问题。</div></article><article><div class=blog-card><h3><a href=/2018/03/01/golang-json-no-escape-html/>golang JSON编码时保留HTML标签</a></h3><p><small>March 1, 2018&nbsp;· 41 words&nbsp;· One minute</small><p>golang默认编码JSON时会将HTML标签中的尖括号编码为\u003c这种unicode字符。而最近在开发的微信客服消息推送就会出现以下结果
\u003ca href='https://www.example.com'\u003e点击进入\u003c/a\u003e 查看golang的json包发现json编码器有个方法SetEscapeHTML方法，接收一个bool值来设置是否保留HTML标签。
问题 json的Encoder只能编码到实现了io.Writer接口的对象中去，而本例中需要编码到一个[]byte切片中。
解决 查找资料发现bytes.Buffer对象实现了io.Writer接口。所以最终代码如下：
func BuildJson(data map[string]interface{}) ([]byte, error) { buf := bytes.NewBufferString("") encoder := json.NewEncoder(buf) encoder.SetEscapeHTML(false) if err := encoder.Encode(&amp;data); err != nil { return nil, err } else { return buf.Bytes(), nil } } 经过测试，输出接口符合要求。</div></article><article><div class=blog-card><h3><a href=/2018/02/28/golang-export-csv/>golang使用CSV导出大量数据</a></h3><p><small>February 28, 2018&nbsp;· 86 words&nbsp;· One minute</small><p>最近在做一个导出功能，最初是使用https://github.com/tealeg/xlsx做的，但是发现导出有个30W行的excel时，这玩意内存彪到700M+，后来发现只是导出数据为表格，并没有其他东西，于是打算使用CSV导出。
CSV格式简介 CSV本质上是个文本文件，该文件有以下要求：
列之间用逗号分隔，行之间用换行分隔 单元格如果有逗号，引号之类的字符，该单元格需要使用双引号括起来 如果包含中文，需要使用GBK编码，否则会乱码 golang实现 UTF8转GBK函数(需要 go get golang.org/x/text/)
func UTF82GBK(src string) (string, error) { reader := transform.NewReader(strings.NewReader(src), simplifiedchinese.GBK.NewEncoder()) if buf, err := ioutil.ReadAll(reader); err != nil { return "", err } else { return string(buf), nil } } 导出代码
filename := "test.csv" fp, err := os.Create(filename) // 创建文件句柄 if err != nil { return nil, err } defer fp.Close() columns := []string{"姓名", "电话", "公司", "职位", "加入时间"} if line, err := util.</div></article><article><div class=blog-card><h3><a href=/2018/02/08/nodejs-thrift-multiple-client/>nodejs thrift多路复用客户端</a></h3><p><small>February 8, 2018&nbsp;· 103 words&nbsp;· One minute</small><p>官网nodejs示例中只实现了服务端是单一service的情形，而对于服务端属于多个服务复用一个连接地址的例子却未实现。
查看thrift的nodejs库源码发现实际上还是支持的。以下来展示调用单一服务和多个服务的区别。
单一服务 var thrift = require('thrift'); var Calculator = require('./gen-nodejs/Calculator'); var ttypes = require('./gen-nodejs/tutorial_types'); const assert = require('assert'); var transport = thrift.TBufferedTransport; var protocol = thrift.TBinaryProtocol; var connection = thrift.createConnection("localhost", 9090, { transport : transport, protocol : protocol }); var client = thrift.createClient(Calculator, connection); // 已经可以调用client方法 复用服务 var thrift = require('thrift'); var Calculator = require('./gen-nodejs/Calculator'); var ttypes = require('./gen-nodejs/tutorial_types'); const assert = require('assert'); var transport = thrift.TBufferedTransport; var protocol = thrift.</div></article></div><div class=paginator><a class=prev href=/tags/java/page/13/>&larr;&nbsp;&nbsp;Pre Page</a>
<a class=next href=/tags/java/page/15/>Next Page&nbsp;&nbsp;&rarr;</a></div></div></div></div><footer class=footer><p>&copy; 2014 - 2023 <a href=https://www.ddhigh.com>Lei Xia</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
<a href=https://umami-beta-peach.vercel.app/ target=_blank>Statistics</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>