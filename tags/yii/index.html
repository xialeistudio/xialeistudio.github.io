<!doctype html><html lang=en><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Yii</title>
<meta charset=utf-8><meta name=description content="Ladder@Learning & Writing & Sharing"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/tags/yii/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com//index.xml title="Lei Xia"><script async defer data-website-id=865c8529-0729-4cf5-88a9-448616abbcbb src=https://umami-beta-peach.vercel.app/xialeistudio></script><meta property="og:title" content="Yii"><meta property="og:description" content="Learning & Writing & Sharing"><meta property="og:type" content="website"><meta property="og:url" content="https://www.ddhigh.com/tags/yii/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Yii"><meta name=twitter:description content="Learning & Writing & Sharing"><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.4e70a7c9d7285fdcae5fdaeeddd5999441d33a8b2c4f360cdbff862671a3c49c.css integrity="sha256-TnCnydcoX9yuX9ru3dWZlEHTOossTzYM2/+GJnGjxJw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>Books</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>Guestbook</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><div class=blog-wrapper><div><div class=blog-list><article><div class=blog-card><h3><a href=/2019/05/19/running-thrift-on-swoole-with-yii2/>在Swoole环境下运行注入Yii2框架的thrift应用</a></h3><p><small>May 19, 2019&nbsp;· 8 words&nbsp;· One minute</small><p>前两天发布了使用swoole来运行thrift应用，项目虽然可以运行起来，但是周边的生态（如缓存，ORM，日志等等）并没有跟上，实际上开发体验比较差。周末研究了一下，把Yii2框架集成到了thrift应用上。
项目地址：https://github.com/swoole-foundation/yii2-swoole-thrift
Yii2优势：
完美的OOP设计 大量开箱即用的组件(DB/Cache/Logger/RBAC等等) 组件化开发 扩展性 这些支持是提高thrift应用开发效率的保证，毕竟没有人会直接在生产环境下手写SQL不是?</div></article><article><div class=blog-card><h3><a href=/2019/05/19/running-yii2-on-swoole/>在swoole上运行Yii2应用</a></h3><p><small>May 19, 2019&nbsp;· 27 words&nbsp;· One minute</small><p>Yii2：业界著名的开发框架，完美的OOP设计以及组件化开发思想保证了框架的扩展性。 Swoole：面向生产环境的 PHP 异步网络通信引擎。使 PHP 开发人员可以编写高性能的异步并发 TCP、UDP、Unix Socket、HTTP，WebSocket 服务。
Yii2优点 完美的OOP设计 大量开箱即用的组件(DB/Cache/Logger/RBAC等等) 组件化开发 扩展性 Swoole优点 高性能/异步/事件驱动 使用PHP语言开发 单文件容器化(传统的php-fpm容器化有点麻烦，一般使用apache的镜像，但是性能不行) 如果这两者结合将会擦出什么样的火花呢?
Yii2-Swoole-Extension Yii2-Swoole-Extension
基于swoole运行环境的Yii2扩展，基于标准Yii2组件化思想开发，对应用无侵入性，可以随时从 PHP-FPM &lt;-> swoole 互相迁移。
通过简单的几行代码即可完成传统PHP-FPM应用到Swoole的升级，给应用带来实打实的性能提升!</div></article><article><div class=blog-card><h3><a href=/2018/04/24/yii2-dependency-inject/>使用yii2依赖注入规范业务开发</a></h3><p><small>April 24, 2018&nbsp;· 494 words&nbsp;· 3 min</small><p>本文代码 https://github.com/xialeistudio/yii2-di-demo
什么是依赖注入(DI)? 对象由框架来创建而不是程序员通过 new 创建。跟IoC差不多一个意思。
为什么要有依赖注入? 解耦。调用方不再通过 new 运算符实例化被调用对象，而通过框架(IoC容器)创建之后注入进来。解除了调用者与被调用者之间的依赖。 有利于面向接口编程。个人认为OOP程序设计最重要的就是面向接口(面向抽象)编程。因为有了第1步的关系，调用者只需要依赖接口类型而不用依赖实现类型，提高了程序的扩展性。 Yii2的依赖注入 Yii2通过 yii\di\Container 提供DI容器特性。目前支持一下4种方式注入：
构造方法注入 方法注入 Setter和属性注入 PHP回调注入 注册依赖关系 通过容器的 set 方法注入 通过配置文件注入(推荐) 依赖注入实战 打开终端，执行以下命令初始化项目：
composer create-project --prefer-dist yiisoft/yii2-app-basic basic 声明接口业务类 app\services\UserService
&lt;?php /** * Created by PhpStorm. * User: xialei * Date: 2018/4/24 * Time: 下午10:55 */ namespace app\services; /** * 用户业务类 * Interface UserService * @package app\services */ interface UserService { /** * 根据ID查询用户 * @param integer $id * @return array|null */ public function show($id); /** * 查看所有用户 * @return array */ public function all(); } 接口实现文件 app\services\impl\UserServiceImpl</div></article><article><div class=blog-card><h3><a href=/2017/10/17/yii2-close-csrf-validation-cookie-validatetion/>yii2关闭csrf校验和cookie校验</a></h3><p><small>October 17, 2017&nbsp;· 67 words&nbsp;· One minute</small><p>重要提示 关闭该选项会导致应用安全性收到影响！ 问题出现 开发API的时候发现POST请求老是不能通过验证，直接把报错文案放到项目中去搜索发现yii\web\Request中有enableCsrfValidation。 其他应用设置的cookie，抓包的时候可以看到请求中有cookie，但是yii2读取不到。 源码解析 找到yii\web\Request文件，看到
/** * @var bool whether to enable CSRF (Cross-Site Request Forgery) validation. Defaults to true. */ public $enableCsrfValidation = true; /** * @var bool whether cookies should be validated to ensure they are not tampered. Defaults to true. */ public $enableCookieValidation = true; 发现是这里有问题，基于yii2一切都是组件的思想，去修改组件配置即可。
修正 编辑config/web.php的components节
'request' => [ 'cookieValidationKey' => 'xxxx', 'enableCookieValidation' => false, 'enableCsrfValidation' => false, ], ],</div></article><article><div class=blog-card><h3><a href=/2017/05/12/yii2-memcached-qcloud-not-expires/>Yii2框架MemCache在腾讯云部署时不过期问题</a></h3><p><small>May 12, 2017&nbsp;· 1278 words&nbsp;· 6 min</small><p>之前部署在阿里云时一直memcache没有问题，部署到腾讯云发现缓存永不过期。查看yii2的MemCache类源码后，发现在设置缓存时，Yii2添加了$expire = $duration > 0 ? $duration + time() :0;这样的代码，会导致强制使用时间戳来标记过期时间，而阿里云是过期时间和时间戳都支持的，腾讯云只支持前者。
解决方案 重写组件即可 在app\components中加添加MemCache集成Yii2的MemCache，由于Yii2的MemCache中$_cache成员变量为private，子类无法访问，所以需要直接copy源码：
&lt;?php /** * Created by PhpStorm. * User: xialei * Date: 2017/5/12 * Time: 下午5:55 */ namespace app\components; use yii\base\InvalidConfigException; use yii\caching\MemCacheServer; class MemCache extends \yii\caching\MemCache { /** * @var bool whether to use memcached or memcache as the underlying caching extension. * If true, [memcached](http://pecl.php.net/package/memcached) will be used. * If false, [memcache](http://pecl.php.net/package/memcache) will be used. * Defaults to false.</div></article><article><div class=blog-card><h3><a href=/2017/01/20/yii2-migrate/>Yii2 migrate使用</a></h3><p><small>January 20, 2017&nbsp;· 102 words&nbsp;· One minute</small><p>试想一个很简单的场景，在使用Yii2开发时，如果对已经有数据的数据表结构进行编辑的话，需要同步数据结构需要在本地导出一份SQL，放到线上去执行SQL，非常的不方便。 而有了Yii2 migrate工具之后，这个问题简直不是问题。以下对常用的表结构操作进行演示。
关键命令 创建migrate yii migrate/create [名称] 执行migrate升级 yii migrate 执行migrate降级 yii migrate/down 创建新表 执行创建migrate命令后，项目文件夹下migrations中会多出m170119_093917_[名称].php的文件，文件名称可能不同，但是结构是相同的，打开该php文件，内容如下
&lt;?php use yii\db\Migration; class m170119_093917_name_20 extends Migration { public function up() { $tableName = 't_category'; $this->createTable($tableName, [ 'id' => $this->primaryKey(), 'name' => $this->string(10)->notNull()->unique()->comment('标识'), 'title' => $this->string(6)->notNull()->comment('名称'), 'count' => $this->integer()->defaultValue(0)->notNull()->comment('入驻数量') ]); } public function down() { echo "m170119_093917_name_20 cannot be reverted.\n"; return false; } /* // Use safeUp/safeDown to run migration code within a transaction public function safeUp() { } public function safeDown() { } */ } 如果需要支持降级的话在down方法中写逻辑返回true即可。</div></article><article><div class=blog-card><h3><a href=/2014/12/05/coding-yii1/>在coding上部署Yii1.x应用</a></h3><p><small>December 5, 2014&nbsp;· 90 words&nbsp;· One minute</small><p>总的来说，由于没有成熟的资料可以参考，部署过程话费了将近一个小时才成功，现在来分享一下经验。
目录配置 由于Paas禁止了本地写功能，所以，如果不加任何处理的话，Yii会尝试在 protected/runtime 目录下写私有文件，结果是肯定没权限的。
经过查找官方文档发现CApplication有个方法叫setRuntimePath，可以设置运行时目录，那么最重要的一点，这个目录的配置肯定要在入口文件中配置，更改之后的入口文件代码如下：
defined('YII_DEBUG') or define('YII_DEBUG',false); if(isset($_GET['_d'])) setcookie('_d',1,7*25*3600); // change the following paths if necessary $yii=dirname(__FILE__).'/framework/yii.php'; $config=dirname(__FILE__).'/protected/config/main.php'; // remove the following lines when in production mode // specify how many levels of call stack should be shown in each log message defined('YII_TRACE_LEVEL') or define('YII_TRACE_LEVEL',3); require_once($yii); $app = Yii::createWebApplication($config); $app->setRuntimePath('/home/vcap/fs/*****'); $app->run(); 可以看到，倒数一二行，重新设置了 runtimepath，所以，第一个问题解决。
数据库配置 数据库这边没什么好说的，自己更改下连接信息就可以了。
缓存配置 本地开发采用的缓存，默认是File的，如果你解决了上一个问题之后，在线上，缓存是没有问题了，这里探讨下服务器缓存的设置（Coding.NET提供的缓存为Redis的，PHP操作Redis需要扩展，这里先不探讨），本站现在的缓存驱动为DB方法，配置方法为:
'cache' => array( 'class' => 'system.caching.CDbCache', 'connectionID' => 'db', 'cacheTableName'=>'t_cache' ), 日志配置 默认情况下，日志是写入runtime path的，不过在Paas上，我们一般是没有本地文件权限的，就算写入了，查看起来比较麻烦，这里也采用数据库方法记录：</div></article><article><div class=blog-card><h3><a href=/2014/09/28/yii1-sso/>Yii1.x单点登录</a></h3><p><small>September 28, 2014&nbsp;· 63 words&nbsp;· One minute</small><p>背景 Web迅速发展的今天，往往一个产品拥有很多个子站点，SSO技术显得很重要。Yii作为我常用的框架，发现Yii的SSO配置其实是非常简单的。
代码 在所有站点中直接打开 protected/config/main.php 在 components 中加入以下代码，并且把protected/runtime/state.bin文件复制到各个具体的子站点中就可以实现SSO了！
'user' => array( 'identityCookie' => array( 'domain' => '.ddhigh.com', 'path' => '/' ), // enable cookie-based authentication 'allowAutoLogin' => true, 'stateKeyPrefix' => 'ddhigh', 'loginUrl' => array('user/login') ), 'session' => array( 'cookieParams' => array( 'domain' => '.ddhigh.com', 'lifetime' => 0, 'timeout' => 3600 ), ), 'statePersister' => array( 'class' => 'CStatePersister', 'stateFile' => './protected/runtime/state.bin' ), 推荐所有的站点全部放在一个域名中进行操作~</div></article><article><div class=blog-card><h3><a href=/2014/09/06/yii-multi-user/>Yii同一站点配置多个用户角色</a></h3><p><small>September 6, 2014&nbsp;· 18 words&nbsp;· One minute</small><p>Yii是基于组件的PHP MVC框架，yii的用户组件调用很方便，但是如果有遇到一个站点有多种用户的时候，如前台用户，后台用户，就需要增加User组件了。
简单来说，就是新建一个用户类去继承 CWebUser类，比如
WebUser继承CWebUser，配置文件在components中增加
'user'=>array( 'class'=>'WebUser' ) 以上就创建了一个前台用户,调用方式 Yii::app()->user
后台用户可以这么写
AdminUser继承CWebUser,配置文件在components中增加
'admin'=>array( 'class'=>'AdminUser' ) 这样就创建了一个后台用户，调用方式 Yii::app()->admin
这种方法是本人所知最科学的，比用session来区分好多了。毕竟很多时候，能用框架现有的方法就用框架的方法。</div></article></div></div></div></div><footer class=footer><p>&copy; 2014 - 2024 <a href=https://www.ddhigh.com/>Lei Xia</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
<a href=https://umami-beta-peach.vercel.app/ target=_blank>Statistics</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>