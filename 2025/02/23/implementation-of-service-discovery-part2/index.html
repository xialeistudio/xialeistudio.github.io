<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>服务发现的设计与实现（二）</title>
<meta charset=utf-8><meta name=google-adsense-account content="ca-pub-2871082647721658"><meta content="Web开发 ,Java ,Go ,Node.js ,PHP ,Koa ,MySQL ,Redis ,前端 ,后端 ,数据库" name=keywords><meta name=description content="在微服务架构中，服务发现是确保服务间高效通信和动态扩展的关键机制。随着分布式系统的复杂性日益增加，如何设计一个可靠、高性能的服务发现方案成为工程实践中的核心课题。
本文作为“服务发现的设计与实现”系列的第二部分，将深入探讨服务注册中心的具体实现与负载均衡策略。我们将聚焦于三种主流技术——etcd、Consul 和 ZooKeeper，分析它们的原理与应用场景，并通过实际代码展示如何构建服务发现功能。此外，我们还将介绍常见的负载均衡算法及其实现方法，帮助读者理解如何在微服务中优化请求分配。"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/2025/02/23/implementation-of-service-discovery-part2/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com/index.xml title=每天进步一点点><script async src="https://www.googletagmanager.com/gtag/js?id=G-EC3XLVSGKV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EC3XLVSGKV")</script><meta property="og:title" content="服务发现的设计与实现（二）"><meta property="og:description" content="在微服务架构中，服务发现是确保服务间高效通信和动态扩展的关键机制。随着分布式系统的复杂性日益增加，如何设计一个可靠、高性能的服务发现方案成为工程实践中的核心课题。
本文作为“服务发现的设计与实现”系列的第二部分，将深入探讨服务注册中心的具体实现与负载均衡策略。我们将聚焦于三种主流技术——etcd、Consul 和 ZooKeeper，分析它们的原理与应用场景，并通过实际代码展示如何构建服务发现功能。此外，我们还将介绍常见的负载均衡算法及其实现方法，帮助读者理解如何在微服务中优化请求分配。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ddhigh.com/2025/02/23/implementation-of-service-discovery-part2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-23T11:53:08+08:00"><meta property="article:modified_time" content="2025-02-23T11:53:08+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="服务发现的设计与实现（二）"><meta name=twitter:description content="在微服务架构中，服务发现是确保服务间高效通信和动态扩展的关键机制。随着分布式系统的复杂性日益增加，如何设计一个可靠、高性能的服务发现方案成为工程实践中的核心课题。
本文作为“服务发现的设计与实现”系列的第二部分，将深入探讨服务注册中心的具体实现与负载均衡策略。我们将聚焦于三种主流技术——etcd、Consul 和 ZooKeeper，分析它们的原理与应用场景，并通过实际代码展示如何构建服务发现功能。此外，我们还将介绍常见的负载均衡算法及其实现方法，帮助读者理解如何在微服务中优化请求分配。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.ddhigh.com/posts/"},{"@type":"ListItem","position":3,"name":"服务发现的设计与实现（二）","item":"https://www.ddhigh.com/2025/02/23/implementation-of-service-discovery-part2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"服务发现的设计与实现（二）","name":"服务发现的设计与实现（二）","description":"在微服务架构中，服务发现是确保服务间高效通信和动态扩展的关键机制。随着分布式系统的复杂性日益增加，如何设计一个可靠、高性能的服务发现方案成为工程实践中的核心课题。\n本文作为“服务发现的设计与实现”系列的第二部分，将深入探讨服务注册中心的具体实现与负载均衡策略。我们将聚焦于三种主流技术——etcd、Consul 和 ZooKeeper，分析它们的原理与应用场景，并通过实际代码展示如何构建服务发现功能。此外，我们还将介绍常见的负载均衡算法及其实现方法，帮助读者理解如何在微服务中优化请求分配。\n","keywords":["Microservices"],"articleBody":"在微服务架构中，服务发现是确保服务间高效通信和动态扩展的关键机制。随着分布式系统的复杂性日益增加，如何设计一个可靠、高性能的服务发现方案成为工程实践中的核心课题。\n本文作为“服务发现的设计与实现”系列的第二部分，将深入探讨服务注册中心的具体实现与负载均衡策略。我们将聚焦于三种主流技术——etcd、Consul 和 ZooKeeper，分析它们的原理与应用场景，并通过实际代码展示如何构建服务发现功能。此外，我们还将介绍常见的负载均衡算法及其实现方法，帮助读者理解如何在微服务中优化请求分配。\nConsul注册中心 Consul 是一个开源的服务网格解决方案，提供服务发现、配置和分段功能。它结合了分布式系统的几个关键组件，包括服务发现、健康检查、键值存储和多数据中心支持。Consul 的设计目标是提供一种简单、灵活且可靠的方法来构建和运行分布式系统。\nConsul 的核心特性包括一个分布式服务目录，它允许服务实例注册自己并提供元数据，其他服务可以通过查询这个目录来发现它们。它还提供了健康检查功能，可以确保只有健康的服务实例被客户端发现。此外，Consul 提供了一个内置的 DNS 和 HTTP API 接口，用于服务发现，使得服务之间的通信变得简单。\nConsul 还支持分布式一致性配置，允许团队存储和同步配置信息。它的分段特性允许服务在不同的网络环境中进行隔离，这对于微服务架构中的蓝绿部署和金丝雀发布非常有用。\nConsul 的架构设计支持高可用性，它使用 Raft 算法来保证数据的一致性和容错性。Consul 通常部署为一个集群模式，集群中的每个节点都参与数据的复制和一致性保证。这种设计使得 Consul 成为构建现代云原生应用的有力工具，尤其是在需要跨多个数据中心或云环境进行服务发现和配置管理的场景中。\nConsul 的安装和启动 要开始使用 Consul 作为服务注册中心，首先需要安装 Consul。您可以访问 HashiCorp 官方开发者网站 https://developer.hashicorp.com/consul/install 下载与您的操作系统相匹配的 Consul 二进制文件。\n安装完成后，打开终端并运行以下命令来启动 Consul 的开发服务器模式。这将启动一个单节点的 Consul 服务器，适用于开发和测试环境。\nconsul agent -dev -bind 127.0.0.1 接下来，在新的终端会话中，您可以使用以下命令来设置一个键值对。此命令将存储一个简单的字符串值，并返回操作结果。如果操作成功，您应该看到 “true” 作为输出。\ncurl \\ --request PUT \\ --data 'hello consul' \\ http://127.0.0.1:8500/v1/kv/foo 最后，为了验证键值对是否已正确设置，您可以执行以下命令来检索该键的值。预期的输出将显示键 “foo” 及其关联的值，值将以 Base64 编码的形式展示。\ncurl http://127.0.0.1:8500/v1/kv/foo 预期的输出结果如下，展示了键 “foo” 的详细信息，包括其值 “aGVsbG8gY29uc3Vs”（Base64 编码的 “hello consul”）：\n[ { \"LockIndex\": 0, \"Key\": \"foo\", \"Flags\": 0, \"Value\": \"aGVsbG8gY29uc3Vs\", \"CreateIndex\": 24, \"ModifyIndex\": 24 } ] 包结构设计 我们直接在上一节的基础上添加 consul 包即可。\n├── client │ └── client.go ├── discovery │ ├── discovery.go │ └── etcd │ ├── registry.go │ └── registry_test.go │ └── consul │ ├── registry.go │ └── registry_test.go ├── go.mod └── loadbalancer └── loadbalancer.go 编写实现 Consul 服务发现客户端的逻辑和 etcd 类似，都是提供获取节点、注册服务实例、取消注册服务实例。不同的是 Consul 的 watch 机制和 etcd 不同，而且 Consul 支持健康检查。\ndiscovery/consul/registry.go\npackage consul import ( \"context\" \"fmt\" \"log\" \"net\" \"sync\" capi \"github.com/hashicorp/consul/api\" \"github.com/hashicorp/consul/api/watch\" \"github.com/xialeistudio/go-service-discovery/discovery\" ) type registry struct { nodeListMap *sync.Map // ","wordCount":"2149","inLanguage":"zh","datePublished":"2025-02-23T11:53:08+08:00","dateModified":"2025-02-23T11:53:08+08:00","author":{"@type":"Person","name":"Lei Xia"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com/2025/02/23/implementation-of-service-discovery-part2/"},"publisher":{"@type":"Organization","name":"每天进步一点点","logo":{"@type":"ImageObject","url":"https://www.ddhigh.com/favicon.ico"}}}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link href=/titilliumweb/titilliumweb.css rel=stylesheet><link rel=stylesheet href=/css/main.min.0eb4160ba4a2d63122fe8ae83f1560951a87ab510d5dab0615973b5206555759.css integrity="sha256-DrQWC6Si1jEi/oroPxVglRqHq1ENXasGFZc7UgZVV1k=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css integrity="sha512-ygEyjMC6rqnzJqWGjRTJUPYMEs9JUOm3i7OWUS9CgQ4XkBUvMsgCS1I8JqavidQ2ClHcREB7IbA2mN08+r9Elg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>$darkModeInit.Content|safeJS</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2871082647721658" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>每天进步一点点
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/>首页</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>归档</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>出版物</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>留言板</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li><li class="navigation-item navigation-language"><a href=https://www.ddhigh.com/en/>EN</a></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>服务发现的设计与实现（二）</h1></header><p><small>2025年2月23日&nbsp;· 2149 字&nbsp;· 11 分钟</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#consul注册中心>Consul注册中心</a><ul><li><a href=#consul-的安装和启动>Consul 的安装和启动</a></li><li><a href=#包结构设计>包结构设计</a></li><li><a href=#编写实现>编写实现</a></li><li><a href=#单元测试编写>单元测试编写</a></li></ul></li><li><a href=#zookeeper注册中心>Zookeeper注册中心</a><ul><li><a href=#zookeeper-的安装和启动>ZooKeeper 的安装和启动</a></li><li><a href=#编写实现-1>编写实现</a></li><li><a href=#单元测试>单元测试</a></li></ul></li><li><a href=#45-负载均衡>4.5 负载均衡</a><ul><li><a href=#原理>原理</a></li><li><a href=#轮询实现>轮询实现</a></li><li><a href=#加权轮询实现>加权轮询实现</a></li><li><a href=#随机实现>随机实现</a></li></ul></li><li><a href=#小结>小结</a></li></ul></nav></div><section class=blog-content><p>在微服务架构中，服务发现是确保服务间高效通信和动态扩展的关键机制。随着分布式系统的复杂性日益增加，如何设计一个可靠、高性能的服务发现方案成为工程实践中的核心课题。</p><p>本文作为“服务发现的设计与实现”系列的第二部分，将深入探讨服务注册中心的具体实现与负载均衡策略。我们将聚焦于三种主流技术——etcd、Consul 和 ZooKeeper，分析它们的原理与应用场景，并通过实际代码展示如何构建服务发现功能。此外，我们还将介绍常见的负载均衡算法及其实现方法，帮助读者理解如何在微服务中优化请求分配。</p><h2 id=consul注册中心>Consul注册中心</h2><p>Consul 是一个开源的服务网格解决方案，提供服务发现、配置和分段功能。它结合了分布式系统的几个关键组件，包括服务发现、健康检查、键值存储和多数据中心支持。Consul 的设计目标是提供一种简单、灵活且可靠的方法来构建和运行分布式系统。</p><p>Consul 的核心特性包括一个分布式服务目录，它允许服务实例注册自己并提供元数据，其他服务可以通过查询这个目录来发现它们。它还提供了健康检查功能，可以确保只有健康的服务实例被客户端发现。此外，Consul 提供了一个内置的 DNS 和 HTTP API 接口，用于服务发现，使得服务之间的通信变得简单。</p><p>Consul 还支持分布式一致性配置，允许团队存储和同步配置信息。它的分段特性允许服务在不同的网络环境中进行隔离，这对于微服务架构中的蓝绿部署和金丝雀发布非常有用。</p><p>Consul 的架构设计支持高可用性，它使用 Raft 算法来保证数据的一致性和容错性。Consul 通常部署为一个集群模式，集群中的每个节点都参与数据的复制和一致性保证。这种设计使得 Consul 成为构建现代云原生应用的有力工具，尤其是在需要跨多个数据中心或云环境进行服务发现和配置管理的场景中。</p><h3 id=consul-的安装和启动>Consul 的安装和启动</h3><p>要开始使用 Consul 作为服务注册中心，首先需要安装 Consul。您可以访问 HashiCorp 官方开发者网站 <a href=https://developer.hashicorp.com/consul/install target=_blank rel=noopener>https://developer.hashicorp.com/consul/install</a> 下载与您的操作系统相匹配的 Consul 二进制文件。</p><p>安装完成后，打开终端并运行以下命令来启动 Consul 的开发服务器模式。这将启动一个单节点的 Consul 服务器，适用于开发和测试环境。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>consul agent -dev -bind 127.0.0.1
</span></span></code></pre></div><p>接下来，在新的终端会话中，您可以使用以下命令来设置一个键值对。此命令将存储一个简单的字符串值，并返回操作结果。如果操作成功，您应该看到 &ldquo;true&rdquo; 作为输出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --request PUT <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --data <span style=color:#e6db74>&#39;hello consul&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  http://127.0.0.1:8500/v1/kv/foo
</span></span></code></pre></div><p>最后，为了验证键值对是否已正确设置，您可以执行以下命令来检索该键的值。预期的输出将显示键 &ldquo;foo&rdquo; 及其关联的值，值将以 Base64 编码的形式展示。</p><pre tabindex=0><code>curl http://127.0.0.1:8500/v1/kv/foo
</code></pre><p>预期的输出结果如下，展示了键 &ldquo;foo&rdquo; 的详细信息，包括其值 &ldquo;aGVsbG8gY29uc3Vs&rdquo;（Base64 编码的 &ldquo;hello consul&rdquo;）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;LockIndex&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Key&#34;</span>: <span style=color:#e6db74>&#34;foo&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Flags&#34;</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Value&#34;</span>: <span style=color:#e6db74>&#34;aGVsbG8gY29uc3Vs&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;CreateIndex&#34;</span>: <span style=color:#ae81ff>24</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;ModifyIndex&#34;</span>: <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><h3 id=包结构设计>包结构设计</h3><p>我们直接在上一节的基础上添加 consul 包即可。</p><pre tabindex=0><code>├── client
│   └── client.go
├── discovery
│   ├── discovery.go
│   └── etcd
│       ├── registry.go
│       └── registry_test.go
│   └── consul
│       ├── registry.go
│       └── registry_test.go
├── go.mod
└── loadbalancer
    └── loadbalancer.go
</code></pre><h3 id=编写实现>编写实现</h3><p>Consul 服务发现客户端的逻辑和 etcd 类似，都是提供获取节点、注册服务实例、取消注册服务实例。不同的是 Consul 的 watch 机制和 etcd 不同，而且 Consul 支持健康检查。</p><p><strong>discovery/consul/registry.go</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>consul</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>capi</span> <span style=color:#e6db74>&#34;github.com/hashicorp/consul/api&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/hashicorp/consul/api/watch&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>registry</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodeListMap</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span> <span style=color:#75715e>// &lt;serviceName, &lt;nodeKey, *ServiceNode&gt;&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>config</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>Config</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>tags</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 本地缓存为空，从 consul 拉取
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>pullNodes</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 缓存到本地
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动 watch
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>watchNodes</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 按标签过滤节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>filteredNodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodes</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>).<span style=color:#a6e22e>Range</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>value</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>MatchTags</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Tags</span>, <span style=color:#a6e22e>tags</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>filteredNodes</span> = append(<span style=color:#a6e22e>filteredNodes</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filteredNodes</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>AgentServiceRegistration</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ID</span>:      <span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:    <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>ServiceName</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Address</span>: <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>IP</span>.<span style=color:#a6e22e>String</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Port</span>:    <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Port</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Meta</span>:    <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Tags</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Check</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>AgentServiceCheck</span>{ <span style=color:#75715e>// 健康检查
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>TCP</span>:                            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%d&#34;</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>IP</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Port</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Timeout</span>:                        <span style=color:#e6db74>&#34;5s&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Interval</span>:                       <span style=color:#e6db74>&#34;5s&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>DeregisterCriticalServiceAfter</span>: <span style=color:#e6db74>&#34;30s&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Status</span>:                         <span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>HealthPassing</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Agent</span>().<span style=color:#a6e22e>ServiceRegisterOpts</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>ServiceRegisterOpts</span>{}.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>ctx</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;register service error: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>QueryOptions</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>opts</span> = <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Agent</span>().<span style=color:#a6e22e>ServiceDeregisterOpts</span>(<span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span>), <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;unregister service error: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>pullNodes</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>QueryOptions</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>opts</span> = <span style=color:#a6e22e>opts</span>.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Agent</span>().<span style=color:#a6e22e>ServicesWithFilterOpts</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>`Service==&#34;%s&#34;`</span>, <span style=color:#a6e22e>name</span>), <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;pull services error: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>results</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>services</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ParseIP</span>(<span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Address</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Port</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>:        <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Meta</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span>), <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>results</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>watchNodes</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>params</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>any</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;type&#34;</span>:    <span style=color:#e6db74>&#34;service&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;service&#34;</span>: <span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>plan</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>watch</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>params</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>plan</span>.<span style=color:#a6e22e>Handler</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>u</span> <span style=color:#66d9ef>uint64</span>, <span style=color:#a6e22e>i</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>i</span>.([]<span style=color:#f92672>*</span><span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>ServiceEntry</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>val</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>name</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>{})
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>healthInstances</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>instance</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>val</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>Service</span>.<span style=color:#a6e22e>Service</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>name</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>Checks</span>.<span style=color:#a6e22e>AggregatedStatus</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>HealthPassing</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>ServiceName</span>: <span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>ParseIP</span>(<span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>Service</span>.<span style=color:#a6e22e>Address</span>),
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>Port</span>:        <span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>Service</span>.<span style=color:#a6e22e>Port</span>,
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>Tags</span>:        <span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>Service</span>.<span style=color:#a6e22e>Meta</span>,
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>healthInstances</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span>), <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>name</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>healthInstances</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>plan</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>plan</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Address</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;watch service %s error: %v&#34;</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRegistry</span>(<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>Config</span>) (<span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>NodeRegistry</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;new consul client error: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>registry</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>nodeListMap</span>: new(<span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>:      <span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>config</span>:      <span style=color:#a6e22e>config</span>,
</span></span><span style=display:flex><span>    }, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s/%s:%d&#34;</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>ServiceName</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>IP</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Port</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>watch 机制允许客户端实时监听服务状态的变化。在上述代码中，watchNodes 函数实现了对 Consul 服务状态的监听，当服务注册或注销时，通过 handler 更新本地缓存，确保服务消费者能够获取到最新的服务节点列表。这种机制使得服务消费者能够及时响应服务提供者的变化，提高了系统的动态性和可靠性。</p><p>而健康检查确保只有健康的服务实例对消费者可见，上述代码使用 TCP 连接来进行健康检查。一旦服务实例出现问题，Consul 会自动将其标记为不健康，并从服务发现中移除，避免流量被路由到该实例。</p><h3 id=单元测试编写>单元测试编写</h3><p>因为我们使用了面向接口的方式来设计注册中心，前面的 etcd 和当前的 Consul 都只是实现类，因此单元测试可以通用，唯一不同的是初始化 Registry 的代码。</p><p><strong>discovery/consul/registry_test.go</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>consul</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>capi</span> <span style=color:#e6db74>&#34;github.com/hashicorp/consul/api&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span> <span style=color:#e6db74>&#34;github.com/json-iterator/go&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestConsulRegistry</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化注册中心
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewRegistry</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>capi</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Address</span>: <span style=color:#e6db74>&#34;localhost:8500&#34;</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;Register single node&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 注册节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>node</span>, <span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 注销节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;Register multi nodeListMap with multi tags&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>node1</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;region&#34;</span>:  <span style=color:#e6db74>&#34;cn&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>node2</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;region&#34;</span>:  <span style=color:#e6db74>&#34;us&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 注册节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node1</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node2</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;region&#34;</span>:  <span style=color:#e6db74>&#34;cn&#34;</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>str</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalToString</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Log</span>(<span style=color:#a6e22e>str</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>node1</span>, <span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;region&#34;</span>:  <span style=color:#e6db74>&#34;us&#34;</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>node2</span>, <span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 注销节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node1</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node2</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在确保 Consul 服务端运行的情况下执行单元测试即可。</p><p>Consul 作为服务注册与发现的工具，在微服务架构中扮演着至关重要的角色。它通过提供一个中心化的服务注册表，使得服务实例能够相互发现并进行通信。服务注册过程中，每个服务实例将自己注册到 Consul，并关联健康检查以确保其可用性。Consul 的 watch 机制允许服务消费者实时监听服务状态的变化，从而动态更新本地服务节点列表。这种动态服务发现的能力，不仅提高了系统的灵活性和可扩展性，还增强了服务之间的解耦合。Consul 的这些特性共同确保了微服务架构的高效运行和稳定性，使其成为现代云原生应用的理想选择。</p><h2 id=zookeeper注册中心>Zookeeper注册中心</h2><p>ZooKeeper 是一个分布式协调服务，它为分布式应用提供一致性协调功能。作为一个开源的协调服务，ZooKeeper 提供了一系列的原语，使得开发者能够构建可靠的分布式同步服务。</p><p>ZooKeeper 的核心是它的状态机模型，它维护了一个具有层次结构的命名空间，类似于文件系统的树形结构。每个节点在这个命名空间中被称为 znode，它可以存储数据和状态信息。客户端可以通过创建、读取、更新和删除这些 znode 来实现服务的注册与发现。</p><p>在微服务架构中，ZooKeeper 常被用作服务注册中心，服务实例在启动时会在 ZooKeeper 中注册自己的信息，如 IP 地址和端口号。其他服务实例可以通过查询这些 znode 来发现可用的服务提供者。此外，ZooKeeper 还提供了 watch 机制，允许服务实例监听 znode 的变化，从而实现服务的动态发现和负载均衡。</p><h3 id=zookeeper-的安装和启动>ZooKeeper 的安装和启动</h3><p>ZooKeeper 作为基于 Java 的分布式协调服务，其运行离不开 Java 环境的支持。因此，首先需要确保您的系统中安装了 JDK 或 JRE。您可以通过访问 <a href=https://www.java.com/zh-CN/download/help/download_options_zh-cn.html target=_blank rel=noopener>https://www.java.com/zh-CN/download/help/download_options_zh-cn.html</a> 下载与您的操作系统相匹配的 Java 版本，并进行安装。</p><p>安装完成后，您可以通过打开终端或命令提示符，输入以下命令来验证 Java 是否安装成功：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>java -version
</span></span></code></pre></div><p>例如，笔者的系统中显示的输出如下：</p><pre tabindex=0><code>openjdk version &#34;17.0.9&#34; 2023-10-17
OpenJDK Runtime Environment Homebrew (build 17.0.9+0)
OpenJDK 64-Bit Server VM Homebrew (build 17.0.9+0, mixed mode, sharing)
</code></pre><p>接下来，您可以访问 <a href=https://zookeeper.apache.org/releases.html target=_blank rel=noopener>https://zookeeper.apache.org/releases.html</a> 下载最新版本的 ZooKeeper，并按照提供的指南进行解压和配置。</p><p>启动 ZooKeeper 服务时，您可以在终端执行以下命令，以在前台模式运行 ZooKeeper，这样有助于实时查看服务的输出信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>zkServer start-foreground
</span></span></code></pre></div><p>为了与 ZooKeeper 服务器建立连接，您可以在新的终端会话中执行以下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>zkCli
</span></span></code></pre></div><p>一旦连接成功，您可以通过执行 stat / 命令来查看根节点的状态。以下是笔者的示例输出：</p><pre tabindex=0><code>[zk: localhost:2181(CONNECTED) 1] stat /
cZxid = 0x0
ctime = Thu Jan 01 08:00:00 CST 1970
mZxid = 0x0
mtime = Thu Jan 01 08:00:00 CST 1970
pZxid = 0x3a
cversion = 27
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 0
numChildren = 1
</code></pre><p>至此，我们已经成功安装并启动了 ZooKeeper 服务器，并且能够通过命令行界面与其交互。</p><h3 id=编写实现-1>编写实现</h3><p>ZooKeeper 需要先建立父路径之后才能添加服务实例节点，因此需要先创建根路径 /services，在注册服务节点之前确保服务名称节点已经创建，最后创建服务实例节点即可。</p><p>我们使用的 watch 机制是接收到节点事件后尝试获取节点详情数据，如果获取不到则证明节点被删除，需要跳过循环，不能直接 return，否则会导致本地缓存无法更新。</p><p><strong>discovery/zookeeper/registry.go</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>zookeeper</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-zookeeper/zk&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span> <span style=color:#e6db74>&#34;github.com/json-iterator/go&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#75715e>// DialTimeout 默认的连接超时时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>DialTimeout</span> = <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// BasePath 服务注册的根路径
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>BasePath</span> = <span style=color:#e6db74>&#34;/services&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>registry</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodeListMap</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span> <span style=color:#75715e>// &lt;serviceName, &lt;nodeKey, *ServiceNode&gt;&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>conn</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>Conn</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>tags</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 本地缓存为空，从 zookeeper 拉取
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>pullNodes</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 缓存到本地
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动 watch
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>watchNodes</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 按标签过滤节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>filteredNodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodes</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>).<span style=color:#a6e22e>Range</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>value</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>MatchTags</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Tags</span>, <span style=color:#a6e22e>tags</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>filteredNodes</span> = append(<span style=color:#a6e22e>filteredNodes</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filteredNodes</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>ensureServiceNode</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>ServiceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to marshal node: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodePath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s/%s&#34;</span>, <span style=color:#a6e22e>makeServicePath</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>ServiceName</span>), <span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>nodePath</span>, <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>FlagEphemeral</span>, <span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>WorldACL</span>(<span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>PermAll</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create node %v: %v&#34;</span>, <span style=color:#a6e22e>node</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%d&#34;</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>IP</span>.<span style=color:#a6e22e>String</span>(), <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Port</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodePath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s/%s&#34;</span>, <span style=color:#a6e22e>makeServicePath</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>ServiceName</span>), <span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>nodePath</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to delete node %v: %v&#34;</span>, <span style=color:#a6e22e>node</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>ensureServiceNode</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodePath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>makeServicePath</span>(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exists</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Exists</span>(<span style=color:#a6e22e>nodePath</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to check if node exists %v: %v&#34;</span>, <span style=color:#a6e22e>nodePath</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>nodePath</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>FlagPersistent</span>, <span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>WorldACL</span>(<span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>PermAll</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create node %v: %v&#34;</span>, <span style=color:#a6e22e>nodePath</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>pullNodes</span>(<span style=color:#a6e22e>_</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nodes</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodePath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>makeServicePath</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>children</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Children</span>(<span style=color:#a6e22e>nodePath</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get children of node %v: %v&#34;</span>, <span style=color:#a6e22e>nodePath</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>child</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>children</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s/%s&#34;</span>, <span style=color:#a6e22e>nodePath</span>, <span style=color:#a6e22e>child</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get node %v: %v&#34;</span>, <span style=color:#a6e22e>child</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>node</span> <span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>node</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to unmarshal node %v: %v&#34;</span>, <span style=color:#a6e22e>child</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>nodes</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>child</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>nodes</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>makeServicePath</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s/%s&#34;</span>, <span style=color:#a6e22e>BasePath</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>watchNodes</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodePath</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>makeServicePath</span>(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>children</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>ChildrenW</span>(<span style=color:#a6e22e>nodePath</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to watch children of node %s: %v\n&#34;</span>, <span style=color:#a6e22e>nodePath</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nodes</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>count</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>child</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>children</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s/%s&#34;</span>, <span style=color:#a6e22e>nodePath</span>, <span style=color:#a6e22e>child</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> { <span style=color:#75715e>// 如果是节点解除注册触发的事件，此处无法获取到节点数据，直接跳过即可，不能报错，否则无法更新本地节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>node</span> <span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>node</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to unmarshal node %s: %v\n&#34;</span>, <span style=color:#a6e22e>child</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>count</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>nodes</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>child</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>name</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>:
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRegistry</span>(<span style=color:#a6e22e>servers</span> []<span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>NodeRegistry</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>Connect</span>(<span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>DialTimeout</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to connect to zookeeper: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// create base path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>BasePath</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>WorldACL</span>(<span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>PermAll</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>zk</span>.<span style=color:#a6e22e>ErrNodeExists</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create base path %v: %v&#34;</span>, <span style=color:#a6e22e>BasePath</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>registry</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>nodeListMap</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>{},
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conn</span>:        <span style=color:#a6e22e>conn</span>,
</span></span><span style=display:flex><span>    }, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在 ZooKeeper 中，只有永久节点下面可以创建临时节点，因此服务名称节点是永久性的，而服务实例节点是临时的。当注册服务的节点与 ZooKeeper 服务器的连接断开时，临时节点会自动被删除。</p><h3 id=单元测试>单元测试</h3><p>单元测试代码与 etcd 和 consul 一致，唯一的区别是初始化 Registry 的代码：</p><p><strong>discovery/zookeeper/registry_test.go</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewRegistry</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;localhost:2181&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span></code></pre></div><p>ZooKeeper 是一个高性能的分布式协调服务，它为构建大型分布式系统提供了关键的协调功能。作为一个服务注册中心，ZooKeeper 能够存储服务实例的信息，并允许服务消费者查询和订阅这些信息。它的树形结构使得服务的注册和发现变得直观和灵活。ZooKeeper 的临时节点和 watch 机制进一步增强了服务注册中心的能力，确保了服务实例的动态管理和自动更新。这些特性使得 ZooKeeper 成为微服务架构中服务发现和协调的理想选择，尤其是在需要强一致性和高可靠性的场景中。</p><h2 id=45-负载均衡>4.5 负载均衡</h2><p>在微服务架构中，服务调用的负载均衡是一个至关重要的环节，它决定了如何将大量的服务请求有效地分配到多个服务实例上。良好的负载均衡策略可以显著提高系统的吞吐量、响应速度和整体的可靠性。本节将深入探讨负载均衡的原理和实现，介绍几种常见的负载均衡算法，包括轮询、随机、加权轮询等，以及它们在实际应用中的适用场景和实现方式。</p><h3 id=原理>原理</h3><p>负载均衡本质上是从一组服务节点中选择一个节点来处理客户端的请求。这个过程通过算法决定哪个节点应该接收特定的请求，目的是确保所有节点的负载尽可能均衡，从而提高系统的整体性能和可靠性。负载均衡器根据预设的策略，如轮询、随机选择或最少连接数，智能地分发请求，避免任何单一节点因过载而影响服务的稳定性。</p><h3 id=轮询实现>轮询实现</h3><p>轮询（Round Robin）负载均衡策略通过循环遍历服务节点列表，依次将新的请求分配给每个可用的服务实例。这种顺序分配方法简单而公平，确保了所有节点在长时间内接收到的请求数量大致相等，有效地平衡了系统负载，提高了资源利用率。轮询策略尤其适合所有服务节点性能相近的场景。</p><p><code>loadbalancer/round_robin.go</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>loadbalancer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>roundRobin</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>roundRobin</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>nodes</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nodes</span>[<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>index</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>index</span> = (<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>index</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>node</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRoundRobin</span>() <span style=color:#a6e22e>LoadBalancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>roundRobin</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=单元测试-1>单元测试</h4><p><strong>loadbalancer/round_robin_test.go</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>loadbalancer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_roundRobin_Select</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodes</span> <span style=color:#f92672>:=</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>:        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>:        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>:        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewRoundRobin</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> = <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>1</span>], <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=加权轮询实现>加权轮询实现</h3><p>加权轮询根据服务节点的权重来决定请求的分配。每个服务节点被赋予一个权重值，权重高的节点将更频繁地接收到请求。这种方法考虑了节点的不同处理能力，使得处理能力强的节点可以承担更多的流量，从而优化资源利用率并提高系统的整体性能。加权轮询适用于服务节点性能不均或有特定性能要求的场景。</p><p><strong>loadbalancer/weighted_round_robin.go</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>package</span> <span style=color:#960050;background-color:#1e0010>loadbalancer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>import</span> <span style=color:#960050;background-color:#1e0010>(</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/spf13/cast&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>type</span> <span style=color:#960050;background-color:#1e0010>weightedRoundRobin</span> <span style=color:#960050;background-color:#1e0010>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>mu</span>            <span style=color:#960050;background-color:#1e0010>sync.Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>index</span>         <span style=color:#960050;background-color:#1e0010>int</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>currentWeight</span> <span style=color:#960050;background-color:#1e0010>int</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>totalWeight</span>   <span style=color:#960050;background-color:#1e0010>int</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>nodes</span>         <span style=color:#960050;background-color:#1e0010>[]*discovery.ServiceNode</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>func</span> <span style=color:#960050;background-color:#1e0010>(w</span> <span style=color:#960050;background-color:#1e0010>*weightedRoundRobin)</span> <span style=color:#960050;background-color:#1e0010>Select(nodes</span> []<span style=color:#960050;background-color:#1e0010>*discovery.ServiceNode)</span> <span style=color:#960050;background-color:#1e0010>*discovery.ServiceNode</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>w.mu.Lock()</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>defer</span> <span style=color:#960050;background-color:#1e0010>w.mu.Unlock()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>len(nodes)</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>0</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 节点变动时重新计算权重
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>!equalNodes(w.nodes,</span> <span style=color:#960050;background-color:#1e0010>nodes)</span> {
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>w.nodes</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>nodes</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>w.totalWeight</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>0</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>for</span> <span style=color:#960050;background-color:#1e0010>_,</span> <span style=color:#960050;background-color:#1e0010>node</span> <span style=color:#960050;background-color:#1e0010>:=</span> <span style=color:#960050;background-color:#1e0010>range</span> <span style=color:#960050;background-color:#1e0010>nodes</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>w.totalWeight</span> <span style=color:#960050;background-color:#1e0010>+=</span> <span style=color:#960050;background-color:#1e0010>cast.ToInt(node.Tags[</span><span style=color:#f92672>&#34;weight&#34;</span><span style=color:#960050;background-color:#1e0010>])</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>w.index</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>(w.index</span> <span style=color:#960050;background-color:#1e0010>+</span> <span style=color:#960050;background-color:#1e0010>1)</span> <span style=color:#960050;background-color:#1e0010>%</span> <span style=color:#960050;background-color:#1e0010>len(nodes)</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>w.index</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>0</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>w.currentWeight</span> <span style=color:#960050;background-color:#1e0010>-=</span> <span style=color:#960050;background-color:#1e0010>gcd(nodes)</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>w.currentWeight</span> <span style=color:#960050;background-color:#1e0010>&lt;=</span> <span style=color:#960050;background-color:#1e0010>0</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>                <span style=color:#960050;background-color:#1e0010>w.currentWeight</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>w.totalWeight</span>
</span></span><span style=display:flex><span>                <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>w.currentWeight</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>0</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>nil</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>cast.ToInt(nodes</span>[<span style=color:#960050;background-color:#1e0010>w.index</span>]<span style=color:#960050;background-color:#1e0010>.Tags</span>[<span style=color:#e6db74>&#34;weight&#34;</span>]<span style=color:#960050;background-color:#1e0010>)</span> <span style=color:#960050;background-color:#1e0010>&gt;=</span> <span style=color:#960050;background-color:#1e0010>w.currentWeight</span> {
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>nodes[w.index]</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>func</span> <span style=color:#960050;background-color:#1e0010>equalNodes(a,</span> <span style=color:#960050;background-color:#1e0010>b</span> []<span style=color:#960050;background-color:#1e0010>*discovery.ServiceNode)</span> <span style=color:#960050;background-color:#1e0010>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>len(a)</span> <span style=color:#960050;background-color:#1e0010>!=</span> <span style=color:#960050;background-color:#1e0010>len(b)</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>for</span> <span style=color:#960050;background-color:#1e0010>i</span> <span style=color:#960050;background-color:#1e0010>:=</span> <span style=color:#960050;background-color:#1e0010>range</span> <span style=color:#960050;background-color:#1e0010>a</span> {
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>a[i]</span> <span style=color:#960050;background-color:#1e0010>!=</span> <span style=color:#960050;background-color:#1e0010>b[i]</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>func</span> <span style=color:#960050;background-color:#1e0010>gcd(nodes</span> []<span style=color:#960050;background-color:#1e0010>*discovery.ServiceNode)</span> <span style=color:#960050;background-color:#1e0010>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>gcdValue</span> <span style=color:#960050;background-color:#1e0010>:=</span> <span style=color:#960050;background-color:#1e0010>cast.ToInt(nodes[0].Tags[</span><span style=color:#f92672>&#34;weight&#34;</span><span style=color:#960050;background-color:#1e0010>])</span>
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>for</span> <span style=color:#960050;background-color:#1e0010>_</span>, <span style=color:#960050;background-color:#1e0010>node</span> <span style=color:#960050;background-color:#1e0010>:=</span> <span style=color:#960050;background-color:#1e0010>range</span> <span style=color:#960050;background-color:#1e0010>nodes</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>gcdValue</span> <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#960050;background-color:#1e0010>gcdTwo(gcdValue,</span> <span style=color:#960050;background-color:#1e0010>cast.ToInt(node.Tags[</span><span style=color:#f92672>&#34;weight&#34;</span><span style=color:#960050;background-color:#1e0010>]))</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>gcdValue</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>func</span> <span style=color:#960050;background-color:#1e0010>gcdTwo(a,</span> <span style=color:#960050;background-color:#1e0010>b</span> <span style=color:#960050;background-color:#1e0010>int)</span> <span style=color:#960050;background-color:#1e0010>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>if</span> <span style=color:#960050;background-color:#1e0010>b</span> <span style=color:#960050;background-color:#1e0010>==</span> <span style=color:#960050;background-color:#1e0010>0</span> <span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>a</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>gcdTwo(b,</span> <span style=color:#960050;background-color:#1e0010>a%b)</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>func</span> <span style=color:#960050;background-color:#1e0010>NewWeightedRoundRobin()</span> <span style=color:#960050;background-color:#1e0010>LoadBalancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>return</span> <span style=color:#960050;background-color:#1e0010>&amp;weightedRoundRobin{</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><h4 id=单元测试-2>单元测试</h4><p>单元测试构造节点时需要添加 weight 到节点标签。</p><p><strong>loadbalancer/weighted_round_robin_test.go</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>loadbalancer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_weightedRoundRobin_Select</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodes</span> <span style=color:#f92672>:=</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;weight&#34;</span>: <span style=color:#e6db74>&#34;90&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;weight&#34;</span>: <span style=color:#e6db74>&#34;50&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;weight&#34;</span>: <span style=color:#e6db74>&#34;80&#34;</span>,
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewWeightedRoundRobin</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> = <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> = <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>2</span>], <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=随机实现>随机实现</h3><p>随机通过随机选择服务节点来处理请求。这种方法不考虑节点的负载或性能差异，而是简单地从所有可用节点中随机挑选一个来响应请求。随机策略简单易实现，适用于服务节点性能相近且无明显差异的场景，可以提供良好的负载分散，但可能不如其他策略那样精确地平衡负载。</p><p><strong>loadbalancer/random.go</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>loadbalancer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>random</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Rand</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#a6e22e>random</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>nodes</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Intn</span>(len(<span style=color:#a6e22e>nodes</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodes</span>[<span style=color:#a6e22e>index</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRandom</span>() <span style=color:#a6e22e>LoadBalancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>random</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>: <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>NewSource</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Unix</span>())),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>r 是随机数发生器，通过 NewRandom 构造时填充了时间戳作为随机数种子，保证安全性。在单元测试时使用固定的随机数种子，保证结果的可控性。</p><h4 id=单元测试-3>单元测试</h4><p><strong>loadbalancer/random_test.go</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>loadbalancer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;math/rand&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Test_random_Select</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>NewSource</span>(<span style=color:#ae81ff>1</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lb</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>random</span>{<span style=color:#a6e22e>r</span>: <span style=color:#a6e22e>r</span>}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodes</span> <span style=color:#f92672>:=</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>:        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>:        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>IP</span>:          <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>3</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:        <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Tags</span>:        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{},
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>2</span>], <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> = <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> = <span style=color:#a6e22e>lb</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>2</span>], <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=小结>小结</h2><p>在本文中，我们全面探讨了微服务架构中服务发现的设计与实现，特别关注了三种主流的服务注册中心：etcd、Consul和ZooKeeper。我们详细分析了每种技术的工作原理、特点以及它们在服务发现中的角色。</p><p>对于etcd，我们讨论了其基于Raft算法的强一致性特性，以及如何利用其丰富的客户端库来实现服务的注册与发现。Consul的章节则展示了其开箱即用的特性，包括健康检查和HTTP API接口。最后，ZooKeeper的实现部分强调了其树形结构和watch机制，这些都是构建高效服务注册中心的关键。</p><p>此外，我们还设计了一个通用的NodeRegistry接口，它定义了服务发现客户端必须实现的方法，如获取服务节点列表、注册和注销服务节点。这个接口的实现为服务发现提供了一个统一的抽象，使得服务消费者可以无缝地与不同的服务注册中心交互。</p><p>总的来说，本文为读者提供了一个关于服务发现的全面视角，包括理论基础、关键技术的深入分析以及实际的代码实现。通过学习，读者应该能够理解服务发现的重要性，掌握不同服务注册中心的使用方法，并能够根据自己的需求选择合适的技术来构建服务发现机制。</p><div class=blog-footer><div class=social-share></div><div class=copyright><ul><li style=margin-bottom:.5em>本文作者: <a href=https://ddhigh.com/ target=_blank style=color:#000;text-decoration:none>xialeistudio</a></li><li style=margin-bottom:.5em>本文链接: <a href=https://www.ddhigh.com/2025/02/23/implementation-of-service-discovery-part2/ target=_blank style=color:#000;text-decoration:none>服务发现的设计与实现（二）</a></li><li>版权声明: <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank style=color:#000;text-decoration:none>「署名-非商业性使用-相同方式共享 4.0 国际」</a></li></ul></div><div style=margin-top:2rem><img src=/img/mp.png alt=qrcode></div></div></section><div class=paginator><a class=next href=https://www.ddhigh.com/2025/02/19/implementation-of-service-discovery-part1/><span>服务发现的设计与实现（一）</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","xialeistudio/discussion"),s.setAttribute("data-repo-id","R_kgDOKurTRA"),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOKurTRM4CbCJt"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2014 - 2025 <a href=https://www.ddhigh.com>每天进步一点点</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js integrity="sha512-9DNXrSjk17bU9MUbRp3IjwcWe46V8FaGA062PFbryPUAEQVRbz4jiZP6FW0AdbqEGtMYBDWnul3eiGBMJOQajA==" crossorigin=anonymous referrerpolicy=no-referrer></script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>