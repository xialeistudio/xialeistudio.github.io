<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>服务发现的设计与实现（一）</title>
<meta charset=utf-8><meta name=google-adsense-account content="ca-pub-2871082647721658"><meta content="Web开发 ,Java ,Go ,Node.js ,PHP ,Koa ,MySQL ,Redis ,前端 ,后端 ,数据库" name=keywords><meta name=description content="服务发现是微服务架构中的一个核心组件，它允许服务实例在启动时向注册中心注册自己的元数据，如网络地址、服务名称和标签等。这些信息使得其他服务能够发现并与之通信，从而实现服务间的动态解耦和高效协作。
在本文中，我们将深入探讨服务发现的客户端接口设计。服务发现的客户端接口通常包括注册、注销和查询服务实例的方法。服务注册是服务实例将自己信息注册到注册中心的过程，注销则是服务实例在停止时从注册中心删除自己的信息。查询服务实例则是服务消费者根据服务名称查询可用的服务实例列表。"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/2025/02/19/implementation-of-service-discovery-part1/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com/index.xml title=每天进步一点点><script async src="https://www.googletagmanager.com/gtag/js?id=G-EC3XLVSGKV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EC3XLVSGKV")</script><meta property="og:title" content="服务发现的设计与实现（一）"><meta property="og:description" content="服务发现是微服务架构中的一个核心组件，它允许服务实例在启动时向注册中心注册自己的元数据，如网络地址、服务名称和标签等。这些信息使得其他服务能够发现并与之通信，从而实现服务间的动态解耦和高效协作。
在本文中，我们将深入探讨服务发现的客户端接口设计。服务发现的客户端接口通常包括注册、注销和查询服务实例的方法。服务注册是服务实例将自己信息注册到注册中心的过程，注销则是服务实例在停止时从注册中心删除自己的信息。查询服务实例则是服务消费者根据服务名称查询可用的服务实例列表。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ddhigh.com/2025/02/19/implementation-of-service-discovery-part1/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-19T11:53:08+08:00"><meta property="article:modified_time" content="2025-02-19T11:53:08+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="服务发现的设计与实现（一）"><meta name=twitter:description content="服务发现是微服务架构中的一个核心组件，它允许服务实例在启动时向注册中心注册自己的元数据，如网络地址、服务名称和标签等。这些信息使得其他服务能够发现并与之通信，从而实现服务间的动态解耦和高效协作。
在本文中，我们将深入探讨服务发现的客户端接口设计。服务发现的客户端接口通常包括注册、注销和查询服务实例的方法。服务注册是服务实例将自己信息注册到注册中心的过程，注销则是服务实例在停止时从注册中心删除自己的信息。查询服务实例则是服务消费者根据服务名称查询可用的服务实例列表。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.ddhigh.com/posts/"},{"@type":"ListItem","position":3,"name":"服务发现的设计与实现（一）","item":"https://www.ddhigh.com/2025/02/19/implementation-of-service-discovery-part1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"服务发现的设计与实现（一）","name":"服务发现的设计与实现（一）","description":"服务发现是微服务架构中的一个核心组件，它允许服务实例在启动时向注册中心注册自己的元数据，如网络地址、服务名称和标签等。这些信息使得其他服务能够发现并与之通信，从而实现服务间的动态解耦和高效协作。\n在本文中，我们将深入探讨服务发现的客户端接口设计。服务发现的客户端接口通常包括注册、注销和查询服务实例的方法。服务注册是服务实例将自己信息注册到注册中心的过程，注销则是服务实例在停止时从注册中心删除自己的信息。查询服务实例则是服务消费者根据服务名称查询可用的服务实例列表。\n","keywords":["Microservices"],"articleBody":"服务发现是微服务架构中的一个核心组件，它允许服务实例在启动时向注册中心注册自己的元数据，如网络地址、服务名称和标签等。这些信息使得其他服务能够发现并与之通信，从而实现服务间的动态解耦和高效协作。\n在本文中，我们将深入探讨服务发现的客户端接口设计。服务发现的客户端接口通常包括注册、注销和查询服务实例的方法。服务注册是服务实例将自己信息注册到注册中心的过程，注销则是服务实例在停止时从注册中心删除自己的信息。查询服务实例则是服务消费者根据服务名称查询可用的服务实例列表。\n我们将介绍几个知名的服务发现项目，包括etcd、Zookeeper和Consul。这些项目提供了不同的服务发现机制和客户端实现方式。例如，etcd使用Raft算法保证数据的一致性，支持服务注册与发现；Zookeeper提供了分布式协调服务，包括服务注册和健康检查；Consul则提供了全面的服务发现和健康检查功能，支持多数据中心部署。\n为了将理论知识与实践相结合，本文还将提供一个简单的示例，展示如何将两个HTTP微服务与服务发现集成。我们将创建两个微服务，并通过服务发现组件实现它们的注册和发现。这个示例将帮助读者理解服务发现在实际应用中的工作方式。\n客户端接口设计 在微服务架构中，服务发现是实现服务间通信和动态路由的关键机制。为了有效地管理和协调这些服务，我们需要设计一套健壮的客户端接口。本节将深入探讨如何构建这样的接口，包括定义服务节点（ServiceNode）、服务发现客户端（NodeRegistry）以及负载均衡器（LoadBalancer）的核心组件。我们将分析这些组件的实现原理，探讨它们在服务发现过程中的作用，以及如何通过这些接口实现服务的注册、发现和负载均衡。\nServiceNode\nServiceNode是服务发现机制中的一个基础组件，它代表了一个服务实例的网络位置和状态。在微服务架构中，一个服务可能由多个实例组成，每个实例都运行着相同的代码，但可能部署在不同的物理或虚拟机器上。ServiceNode 结构体通常包含服务实例的 IP 地址、端口号以及一系列标签（tags），这些标签可以用于进一步描述服务实例的特性，如版本号、环境（开发、测试、生产）等。\ntype ServiceNode struct { ServiceName string IP net.IP Port int Tags map[string]string } 这样的设计允许服务消费者根据标签选择特定的服务实例进行调用，例如，可能只想调用某个特定版本的服务实例，或者基于标签进行路由选择。\nNodeRegistry\nDiscoveryClient 是服务发现机制的核心接口，它定义了服务发现客户端必须实现的方法。这些方法包括获取服务节点列表、注册当前节点到服务注册中心以及注销节点。NodeRegistry接口的实现负责与服务注册中心的交互，无论是通过 REST API、gRPC 还是其他通信协议。\ntype NodeRegistry interface { GetNodes(ctx context.Context, serverName string, tags map[string]string) ([]*ServiceNode, error) Register(ctx context.Context, node *ServiceNode) error Unregister(ctx context.Context, node *ServiceNode) error } 这种接口设计使得服务发现客户端可以与具体的服务注册中心实现解耦，提高了代码的可维护性和可扩展性。服务消费者可以通过实现此接口的任何客户端库与不同的服务注册中心进行交互，而无需关心背后的实现细节。\nLoadBalancer\nLoadBalancer 定义了负载均衡器的接口，它负责从服务发现客户端获取的服务节点列表中选择一个节点来处理请求。负载均衡器可以采用不同的策略，如轮询、随机选择、加权轮询或基于 IP 哈希的策略，以确保请求均匀地分配到各个服务实例。\ntype LoadBalancer interface { Select(nodes []*ServiceNode) *ServiceNode } 负载均衡器的设计对于提高系统的可用性和响应性至关重要。通过实现不同的负载均衡策略，可以为不同的业务场景提供最适合的请求分配机制。\nDiscoveryClient\n对于业务应用来说，只需要根据服务名称获取一个节点信息然后进行请求即可。因此应该组合NodeRegistry和LoadBalancer的能力，获取到节点列表后直接进行路由，最后将最终节点返回给业务应用。\ntype DiscoveryClient struct { LoadBalancer LoadBalancer Registry NodeRegistry } func (d *DiscoveryClient) Resolve(ctx context.Context, serviceName)(*ServiceNode) { // TODO 返回服务节点 } etcd etcd(https://etcd.io/)是一个高度一致的分布式键值存储，它提供了一种可靠的方式来存储需要由分布式系统或机器集群访问的数据。它在微服务和 Kubernetes 集群中不仅可以作为服务注册于发现，还可以作为 key-value 存储的中间件。etcd 的目标是构建一个高可用的分布式键值数据库，具有简单、键值对存储、监测变更、安全、快速和可靠等特点。它采用 Raft 算法实现分布式系统数据的高可用性、一致性，并且使用 Go 语言编写，具有出色的跨平台支持和强大的社区。\netcd 的架构包括 client 层、API 网络层、Raft 算法层和存储层。client 层包含 client v2 和 v3 两个版本的 API 客户端。API 网络层处理客户端访问服务器和服务器节点间的通信协议。Raft 算法层实现了 Leader 选举、日志复制等核心算法特性，保障 etcd 多节点间的数据一致性。存储层包含预写日志 WAL 模块、快照 Snapshot 模块和 boltdb 模块，其中 WAL 可保障 etcd crash 后数据不丢失，boltdb 则保存了集群元数据和用户写入的数据。\netcd 的应用场景广泛，最常用于服务注册与发现，作为集群管理的组件使用，也可以作为 K-V 存储，作为数据库使用。它的存储特点是采用 kv 型数据存储，支持动态存储和静态存储，分布式存储，可集成为多节点集群，存储方式采用类似目录结构。\n在安全性方面，etcd 支持通过 TLS 协议进行的加密通信，包括对等体之间的加密内部群集通信以及加密的客户端流量。通过使用 SSL 证书，etcd 可以实现互联网的通信安全，防止窃听、篡改和冒充风险。\n本节我们基于etcd来实现前文中设计的接口。\netcd的安装与启动\n要开始使用 etcd，您可以访问 GitHub 上的 etcd 仓库，具体网址为 https://github.com/etcd-io/etcd/releases/，从中下载与您的操作系统相匹配的二进制文件。下载完成后，您可以通过执行 etcd 的二进制文件来启动一个单节点的 etcd 服务器。在本节中，我们将重点介绍如何利用 etcd 实现服务发现客户端，因此，对于演示目的而言，单节点的 etcd 服务器已经足够。但请注意，在生产环境中，为了确保高可用性和数据一致性，强烈推荐使用 etcd 的集群部署。\n为了验证您的 etcd 服务器是否已经正常运行，您可以使用 etcdctl 这个命令行工具来进行测试。首先，打开一个新的终端窗口，然后输入 etcdctl put greeting \"Hello, etcd\" 命令，如果一切正常，您应该会看到 “OK” 作为返回结果。接下来，通过执行 etcdctl get greeting 命令，您应该能够看到预期的输出 “Hello, etcd”。这表明您的 etcd 服务器已经成功启动，并且可以正常处理键值存储的读写操作。\n包结构设计\n作为我们的首个服务注册中心实现，在开始编码之前，让我们先规划一下包结构的设计。这将帮助我们组织代码，确保项目的可维护性和可扩展性。以下是我们为etcd服务注册中心设计的包结构概览：\n├── client │ └── client.go ├── discovery │ ├── discovery.go │ └── etcd │ ├── registry.go │ └── registry_test.go ├── go.mod └── loadbalancer └── loadbalancer.go client: 服务注册客户端，提供给应用层使用 discovery: 服务注册接口声明 etcd: 服务注册的etcd实现 loadbalancer: 负载均衡接口声明 编写接口\n根据之前的设计，我们直接在discovery/discovery.go编写服务节点和注册中心的声明。\n在工程实践中，注册中心会本地缓存服务的实例列表，避免频繁请求注册中心导致注册中心过载影响服务发现。下列代码使用的sync.Map来保证并发安全。\ndiscovery/discovery.go\npackage discovery import ( \"context\" \"net\" ) // ServiceNode 服务节点 type ServiceNode struct { ServiceName string IP net.IP Port int Tags map[string]string } // NodeRegistry 服务节点注册中心 type NodeRegistry interface { // GetNodes 获取服务节点 GetNodes(ctx context.Context, serviceName string, tags map[string]string) ([]*ServiceNode, error) // Register 注册服务节点 Register(ctx context.Context, node *ServiceNode) error // Unregister 注销服务节点 Unregister(ctx context.Context, node *ServiceNode) error } // MatchTags 匹配标签 func MatchTags(nodeTags, queryTags map[string]string) bool { for name, value := range queryTags { if nodeTags[name] != value { return false } } return true } 编写实现\n实现类的流程基本是类似的，在GetNodes方法中优先读取本地缓存，如果不存在，则远程请求注册中心，并监听节点变更事件，实现本地节点的实时变更。在Register方法中注册节点并实现心跳机制，在etcd中，心跳机制是基于租约实现的，只要定期续约，节点就会存活。\ndiscovery/etcd/registry.go\npackage etcd import ( \"context\" \"fmt\" json \"github.com/json-iterator/go\" \"github.com/xialeistudio/go-service-discovery/discovery\" \"go.etcd.io/etcd/client/v3\" \"log\" \"strconv\" \"sync\" \"time\" ) var ( // DialTimeout 默认的连接超时时间 DialTimeout = 5 * time.Second // LeaseTTL 默认的租约时间 LeaseTTL = 10 * time.Second ) type registry struct { nodeListMap *sync.Map // ","wordCount":"1247","inLanguage":"zh","datePublished":"2025-02-19T11:53:08+08:00","dateModified":"2025-02-19T11:53:08+08:00","author":{"@type":"Person","name":"Lei Xia"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com/2025/02/19/implementation-of-service-discovery-part1/"},"publisher":{"@type":"Organization","name":"每天进步一点点","logo":{"@type":"ImageObject","url":"https://www.ddhigh.com/favicon.ico"}}}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link href=/titilliumweb/titilliumweb.css rel=stylesheet><link rel=stylesheet href=/css/main.min.0eb4160ba4a2d63122fe8ae83f1560951a87ab510d5dab0615973b5206555759.css integrity="sha256-DrQWC6Si1jEi/oroPxVglRqHq1ENXasGFZc7UgZVV1k=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css integrity="sha512-ygEyjMC6rqnzJqWGjRTJUPYMEs9JUOm3i7OWUS9CgQ4XkBUvMsgCS1I8JqavidQ2ClHcREB7IbA2mN08+r9Elg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>$darkModeInit.Content|safeJS</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2871082647721658" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>每天进步一点点
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/>首页</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>归档</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>出版物</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>留言板</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li><li class="navigation-item navigation-language"><a href=https://www.ddhigh.com/en/>EN</a></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>服务发现的设计与实现（一）</h1></header><p><small>2025年2月19日&nbsp;· 1247 字&nbsp;· 6 分钟</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#客户端接口设计>客户端接口设计</a></li><li><a href=#etcd>etcd</a></li></ul></nav></div><section class=blog-content><p>服务发现是微服务架构中的一个核心组件，它允许服务实例在启动时向注册中心注册自己的元数据，如网络地址、服务名称和标签等。这些信息使得其他服务能够发现并与之通信，从而实现服务间的动态解耦和高效协作。</p><p>在本文中，我们将深入探讨服务发现的客户端接口设计。服务发现的客户端接口通常包括注册、注销和查询服务实例的方法。服务注册是服务实例将自己信息注册到注册中心的过程，注销则是服务实例在停止时从注册中心删除自己的信息。查询服务实例则是服务消费者根据服务名称查询可用的服务实例列表。</p><p>我们将介绍几个知名的服务发现项目，包括etcd、Zookeeper和Consul。这些项目提供了不同的服务发现机制和客户端实现方式。例如，etcd使用Raft算法保证数据的一致性，支持服务注册与发现；Zookeeper提供了分布式协调服务，包括服务注册和健康检查；Consul则提供了全面的服务发现和健康检查功能，支持多数据中心部署。</p><p>为了将理论知识与实践相结合，本文还将提供一个简单的示例，展示如何将两个HTTP微服务与服务发现集成。我们将创建两个微服务，并通过服务发现组件实现它们的注册和发现。这个示例将帮助读者理解服务发现在实际应用中的工作方式。</p><h2 id=客户端接口设计>客户端接口设计</h2><p>在微服务架构中，服务发现是实现服务间通信和动态路由的关键机制。为了有效地管理和协调这些服务，我们需要设计一套健壮的客户端接口。本节将深入探讨如何构建这样的接口，包括定义服务节点（ServiceNode）、服务发现客户端（NodeRegistry）以及负载均衡器（LoadBalancer）的核心组件。我们将分析这些组件的实现原理，探讨它们在服务发现过程中的作用，以及如何通过这些接口实现服务的注册、发现和负载均衡。</p><p><strong>ServiceNode</strong></p><p>ServiceNode是服务发现机制中的一个基础组件，它代表了一个服务实例的网络位置和状态。在微服务架构中，一个服务可能由多个实例组成，每个实例都运行着相同的代码，但可能部署在不同的物理或虚拟机器上。ServiceNode 结构体通常包含服务实例的 IP 地址、端口号以及一系列标签（tags），这些标签可以用于进一步描述服务实例的特性，如版本号、环境（开发、测试、生产）等。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceNode</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ServiceName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>IP</span>    <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IP</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Port</span>   <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Tags</span>   <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样的设计允许服务消费者根据标签选择特定的服务实例进行调用，例如，可能只想调用某个特定版本的服务实例，或者基于标签进行路由选择。</p><p><strong>NodeRegistry</strong></p><p>DiscoveryClient 是服务发现机制的核心接口，它定义了服务发现客户端必须实现的方法。这些方法包括获取服务节点列表、注册当前节点到服务注册中心以及注销节点。NodeRegistry接口的实现负责与服务注册中心的交互，无论是通过 REST API、gRPC 还是其他通信协议。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NodeRegistry</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serverName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>tags</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceNode</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这种接口设计使得服务发现客户端可以与具体的服务注册中心实现解耦，提高了代码的可维护性和可扩展性。服务消费者可以通过实现此接口的任何客户端库与不同的服务注册中心进行交互，而无需关心背后的实现细节。</p><p><strong>LoadBalancer</strong></p><p>LoadBalancer 定义了负载均衡器的接口，它负责从服务发现客户端获取的服务节点列表中选择一个节点来处理请求。负载均衡器可以采用不同的策略，如轮询、随机选择、加权轮询或基于 IP 哈希的策略，以确保请求均匀地分配到各个服务实例。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LoadBalancer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceNode</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceNode</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>负载均衡器的设计对于提高系统的可用性和响应性至关重要。通过实现不同的负载均衡策略，可以为不同的业务场景提供最适合的请求分配机制。</p><p><strong>DiscoveryClient</strong></p><p>对于业务应用来说，只需要根据服务名称获取一个节点信息然后进行请求即可。因此应该组合NodeRegistry和LoadBalancer的能力，获取到节点列表后直接进行路由，最后将最终节点返回给业务应用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DiscoveryClient</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span> <span style=color:#a6e22e>LoadBalancer</span> <span style=color:#a6e22e>LoadBalancer</span>
</span></span><span style=display:flex><span> <span style=color:#a6e22e>Registry</span> <span style=color:#a6e22e>NodeRegistry</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DiscoveryClient</span>) <span style=color:#a6e22e>Resolve</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span>)(<span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceNode</span>) {
</span></span><span style=display:flex><span> <span style=color:#75715e>// TODO 返回服务节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><h2 id=etcd>etcd</h2><p>etcd(<a href=https://etcd.io/ target=_blank rel=noopener>https://etcd.io/</a>)是一个高度一致的分布式键值存储，它提供了一种可靠的方式来存储需要由分布式系统或机器集群访问的数据。它在微服务和 Kubernetes 集群中不仅可以作为服务注册于发现，还可以作为 key-value 存储的中间件。etcd 的目标是构建一个高可用的分布式键值数据库，具有简单、键值对存储、监测变更、安全、快速和可靠等特点。它采用 Raft 算法实现分布式系统数据的高可用性、一致性，并且使用 Go 语言编写，具有出色的跨平台支持和强大的社区。</p><p>etcd 的架构包括 client 层、API 网络层、Raft 算法层和存储层。client 层包含 client v2 和 v3 两个版本的 API 客户端。API 网络层处理客户端访问服务器和服务器节点间的通信协议。Raft 算法层实现了 Leader 选举、日志复制等核心算法特性，保障 etcd 多节点间的数据一致性。存储层包含预写日志 WAL 模块、快照 Snapshot 模块和 boltdb 模块，其中 WAL 可保障 etcd crash 后数据不丢失，boltdb 则保存了集群元数据和用户写入的数据。</p><p>etcd 的应用场景广泛，最常用于服务注册与发现，作为集群管理的组件使用，也可以作为 K-V 存储，作为数据库使用。它的存储特点是采用 kv 型数据存储，支持动态存储和静态存储，分布式存储，可集成为多节点集群，存储方式采用类似目录结构。</p><p>在安全性方面，etcd 支持通过 TLS 协议进行的加密通信，包括对等体之间的加密内部群集通信以及加密的客户端流量。通过使用 SSL 证书，etcd 可以实现互联网的通信安全，防止窃听、篡改和冒充风险。</p><p>本节我们基于etcd来实现前文中设计的接口。</p><p><strong>etcd的安装与启动</strong></p><p>要开始使用 etcd，您可以访问 GitHub 上的 etcd 仓库，具体网址为 <a href=https://github.com/etcd-io/etcd/releases/ target=_blank rel=noopener>https://github.com/etcd-io/etcd/releases/</a>，从中下载与您的操作系统相匹配的二进制文件。下载完成后，您可以通过执行 etcd 的二进制文件来启动一个单节点的 etcd 服务器。在本节中，我们将重点介绍如何利用 etcd 实现服务发现客户端，因此，对于演示目的而言，单节点的 etcd 服务器已经足够。但请注意，在生产环境中，为了确保高可用性和数据一致性，强烈推荐使用 etcd 的集群部署。</p><p>为了验证您的 etcd 服务器是否已经正常运行，您可以使用 etcdctl 这个命令行工具来进行测试。首先，打开一个新的终端窗口，然后输入 <code>etcdctl put greeting "Hello, etcd"</code> 命令，如果一切正常，您应该会看到 &ldquo;OK&rdquo; 作为返回结果。接下来，通过执行 <code>etcdctl get greeting</code> 命令，您应该能够看到预期的输出 &ldquo;Hello, etcd&rdquo;。这表明您的 etcd 服务器已经成功启动，并且可以正常处理键值存储的读写操作。</p><p><strong>包结构设计</strong></p><p>作为我们的首个服务注册中心实现，在开始编码之前，让我们先规划一下包结构的设计。这将帮助我们组织代码，确保项目的可维护性和可扩展性。以下是我们为etcd服务注册中心设计的包结构概览：</p><pre tabindex=0><code>├── client
│  └── client.go
├── discovery
│  ├── discovery.go
│  └── etcd
│    ├── registry.go
│    └── registry_test.go
├── go.mod
└── loadbalancer
└── loadbalancer.go
</code></pre><ul><li>client: 服务注册客户端，提供给应用层使用</li><li>discovery: 服务注册接口声明<ul><li>etcd: 服务注册的etcd实现</li></ul></li><li>loadbalancer: 负载均衡接口声明</li></ul><p><strong>编写接口</strong></p><p>根据之前的设计，我们直接在discovery/discovery.go编写服务节点和注册中心的声明。</p><p>在工程实践中，注册中心会本地缓存服务的实例列表，避免频繁请求注册中心导致注册中心过载影响服务发现。下列代码使用的sync.Map来保证并发安全。</p><p>discovery/discovery.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>discovery</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ServiceNode 服务节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceNode</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ServiceName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>IP</span>     <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IP</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Port</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Tags</span>    <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// NodeRegistry 服务节点注册中心
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NodeRegistry</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// GetNodes 获取服务节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>tags</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceNode</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Register 注册服务节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Unregister 注销服务节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// MatchTags 匹配标签
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MatchTags</span>(<span style=color:#a6e22e>nodeTags</span>, <span style=color:#a6e22e>queryTags</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>value</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>queryTags</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nodeTags</span>[<span style=color:#a6e22e>name</span>] <span style=color:#f92672>!=</span> <span style=color:#a6e22e>value</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>编写实现</strong></p><p>实现类的流程基本是类似的，在GetNodes方法中优先读取本地缓存，如果不存在，则远程请求注册中心，并监听节点变更事件，实现本地节点的实时变更。在Register方法中注册节点并实现心跳机制，在etcd中，心跳机制是基于租约实现的，只要定期续约，节点就会存活。</p><p>discovery/etcd/registry.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>etcd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>json</span> <span style=color:#e6db74>&#34;github.com/json-iterator/go&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/xialeistudio/go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;go.etcd.io/etcd/client/v3&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>  <span style=color:#75715e>// DialTimeout 默认的连接超时时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>DialTimeout</span> = <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// LeaseTTL 默认的租约时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>LeaseTTL</span> = <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>registry</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nodeListMap</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span> <span style=color:#75715e>// &lt;serviceName, &lt;nodeKey, *ServiceNode&gt;&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>watcher</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Watcher</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>kv</span>   <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>KV</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRegistry</span>(<span style=color:#a6e22e>endpoints</span> []<span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>NodeRegistry</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>config</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Endpoints</span>:  <span style=color:#a6e22e>endpoints</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DialTimeout</span>: <span style=color:#a6e22e>DialTimeout</span>,
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create etcd client: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>registry</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodeListMap</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>{},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>:   <span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>:     <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>NewKV</span>(<span style=color:#a6e22e>client</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>watcher</span>:   <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>NewWatcher</span>(<span style=color:#a6e22e>client</span>),
</span></span><span style=display:flex><span>  }, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>tags</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 检查本地缓存是否有服务节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 本地缓存为空，从 etcd 拉取
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>pullNodes</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 缓存到本地
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动协程监听节点变化
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>watchNodes</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 根据标签过滤服务节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>filteredNodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nodes</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>).<span style=color:#a6e22e>Range</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>value</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>MatchTags</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Tags</span>, <span style=color:#a6e22e>tags</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>filteredNodes</span> = append(<span style=color:#a6e22e>filteredNodes</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>filteredNodes</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalToString</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to marshal service node: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 创建租约
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>lease</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Grant</span>(<span style=color:#a6e22e>ctx</span>, int64(<span style=color:#a6e22e>LeaseTTL</span>.<span style=color:#a6e22e>Seconds</span>()))
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span><span style=color:#75715e>// 将服务节点信息写入etcd
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>WithLease</span>(<span style=color:#a6e22e>lease</span>.<span style=color:#a6e22e>ID</span>))
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to put key to etcd: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 续租
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>keepLeaseAlive</span>(<span style=color:#a6e22e>lease</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to delete key from etcd: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>removeNode</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>ServiceName</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>IP</span>.<span style=color:#a6e22e>String</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Port</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 续租
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>keepLeaseAlive</span>(<span style=color:#a6e22e>leaseId</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>LeaseID</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>LeaseTTL</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>KeepAliveOnce</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>leaseId</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>removeNode</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>removeNode</span>(<span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Range</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>nodes</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>value</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>nodes</span>.<span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>makeNodeKey</span>(<span style=color:#a6e22e>node</span>))
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>pullNodes</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>WithPrefix</span>())
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get nodeListMap from etcd: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nodes</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>kv</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Kvs</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#a6e22e>node</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to unmarshal node data: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>nodes</span>.<span style=color:#a6e22e>Store</span>(string(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>Key</span>), <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>nodes</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>) <span style=color:#a6e22e>watchNodes</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>watchChan</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>Watch</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>WithPrefix</span>())
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>wResp</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>watchChan</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ev</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>wResp</span>.<span style=color:#a6e22e>Events</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>EventTypePut</span>:
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#75715e>// 新增或更新服务节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>Kv</span>.<span style=color:#a6e22e>Value</span>, <span style=color:#a6e22e>node</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>         <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;failed to unmarshal node data: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>         <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>LoadOrStore</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>{})
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#a6e22e>nodes</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>).<span style=color:#a6e22e>Store</span>(string(<span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>Kv</span>.<span style=color:#a6e22e>Key</span>), <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>EventTypeDelete</span>:
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#75715e>// 删除服务节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>nodeListMap</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#a6e22e>nodes</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Map</span>).<span style=color:#a6e22e>Delete</span>(string(<span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>Kv</span>.<span style=color:#a6e22e>Key</span>))
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>registry结构体实现了 discovery.NodeRegistry 接口，用于管理微服务架构中的服务节点。结构体包含一个节点映射 nodes，用于缓存服务节点信息，以及 etcd 客户端 client，用于与 etcd 集群通信。</p><p>NewRegistry 函数用于初始化 etcd 客户端并创建 registry 实例。它接受 etcd 服务端点列表作为参数，并配置客户端以连接到 etcd 集群。</p><p>GetNodes 方法用于获取指定服务名称的服务节点列表。如果本地缓存中不存在该服务的节点信息，它会从 etcd 中拉取节点信息，并启动一个协程 watchNodes 来监听 etcd 中服务节点的变化。</p><p>Register 方法允许服务节点将自己注册到 etcd 中，并创建一个租约以保持其注册信息的有效性。它还启动一个协程 keepLeaseAlive 来续租，确保节点信息不会过期。</p><p>Unregister 方法用于从 etcd 中注销服务节点，并更新本地缓存。</p><p>keepLeaseAlive 方法负责定期续租，以保持服务节点在 etcd 中的注册信息不过期。</p><p>removeNode 方法用于从本地缓存中移除已注销的服务节点。</p><p>pullNodes 方法从 etcd 中拉取服务节点信息，并将其反序列化为 ServiceNode 对象列表。</p><p>watchNodes 方法监听 etcd 中服务节点的变化事件，并更新本地缓存。</p><p><strong>单元测试编写</strong></p><p>在微服务架构中，服务注册中心的稳定性和可靠性对于整个系统的运行至关重要。为了确保我们的 etcd 服务注册中心能够正确地处理服务节点的注册、查询和注销操作，我们编写了一系列单元测试来验证其功能。这些测试不仅涵盖了单个服务节点的注册和注销，还包括了多节点多标签的场景，确保服务发现逻辑在各种情况下都能正常工作。</p><p>discovery/etcd/registry_test.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>etcd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;go-service-discovery/discovery&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestEtcdRegistry</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>a</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>assert</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>t</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewRegistry</span>([]<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;localhost:2379&#34;</span>})
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;Register single node&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>IP</span>:     <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>Port</span>:    <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      },
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 注册节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    })
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>node</span>, <span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 注销节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    })
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>t</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#e6db74>&#34;Register multi nodes with multi tags&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>node1</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>IP</span>:     <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>Port</span>:    <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#e6db74>&#34;region&#34;</span>: <span style=color:#e6db74>&#34;cn&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      },
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>node2</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>discovery</span>.<span style=color:#a6e22e>ServiceNode</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>ServiceName</span>: <span style=color:#e6db74>&#34;test&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>IP</span>:     <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>IPv4</span>(<span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>),
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>Port</span>:    <span style=color:#ae81ff>8484</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>       <span style=color:#e6db74>&#34;region&#34;</span>: <span style=color:#e6db74>&#34;us&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      },
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    }
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 注册节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node1</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node2</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#e6db74>&#34;region&#34;</span>: <span style=color:#e6db74>&#34;cn&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    })
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>node1</span>, <span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#e6db74>&#34;region&#34;</span>: <span style=color:#e6db74>&#34;us&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    })
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Equal</span>(<span style=color:#a6e22e>node2</span>, <span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 注销节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node1</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Unregister</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>node2</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#75715e>// 获取节点
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>GetNodes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#e6db74>&#34;test&#34;</span>, <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>      <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    })
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Nil</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>​</span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Len</span>(<span style=color:#a6e22e>nodes</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>需要说明的是，测试代码中包含了time.Sleep操作来阻塞协程，这是因为节点监听是在另外的协程实现的，是异步过程，需要阻塞主协程来让异步代码执行完毕，更新本地节点缓存后才能通过测试。</p><p>本节详细介绍了基于 etcd 的服务注册中心实现，涵盖了从客户端初始化、服务节点的注册与注销，到服务节点的查询和监听等功能。通过 etcd 强大的分布式键值存储能力，我们构建了一个高可用和一致性的服务发现机制。测试部分验证了服务注册中心在处理单节点和多节点场景下的正确性和稳定性，确保了服务发现过程中数据的准确性和实时性通过本节的学习，我们不仅理解了 etcd 在服务发现中的关键作用，还掌握了如何在实际项目中应用 etcd 来实现服务注册与发现。</p><p>后面会继续更新基于Consul和zookeeper的服务发现和注册中心的实现。</p><div class=blog-footer><div class=social-share></div><div class=copyright><ul><li style=margin-bottom:.5em>本文作者: <a href=https://ddhigh.com/ target=_blank style=color:#000;text-decoration:none>xialeistudio</a></li><li style=margin-bottom:.5em>本文链接: <a href=https://www.ddhigh.com/2025/02/19/implementation-of-service-discovery-part1/ target=_blank style=color:#000;text-decoration:none>服务发现的设计与实现（一）</a></li><li>版权声明: <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank style=color:#000;text-decoration:none>「署名-非商业性使用-相同方式共享 4.0 国际」</a></li></ul></div><div style=margin-top:2rem><img src=/img/mp.png alt=qrcode></div></div></section><div class=paginator><a class=prev href=https://www.ddhigh.com/2025/02/23/implementation-of-service-discovery-part2/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>服务发现的设计与实现（二）</span></a>
<a class=next href=https://www.ddhigh.com/2025/02/15/core-components-of-microservice/><span>微服务核心组件</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","xialeistudio/discussion"),s.setAttribute("data-repo-id","R_kgDOKurTRA"),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOKurTRM4CbCJt"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2014 - 2025 <a href=https://www.ddhigh.com>每天进步一点点</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js integrity="sha512-9DNXrSjk17bU9MUbRp3IjwcWe46V8FaGA062PFbryPUAEQVRbz4jiZP6FW0AdbqEGtMYBDWnul3eiGBMJOQajA==" crossorigin=anonymous referrerpolicy=no-referrer></script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>