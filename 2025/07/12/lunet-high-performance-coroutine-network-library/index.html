<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>Lunet: 高性能协程网络库的设计与实现</title>
<meta charset=utf-8><meta name=google-adsense-account content="ca-pub-2871082647721658"><meta content="Web开发 ,Java ,Go ,Node.js ,PHP ,Koa ,MySQL ,Redis ,前端 ,后端 ,数据库" name=keywords><meta name=description content="Lunet 是一个用 C 语言编写的高性能运行时，集成了 LuaJIT 和 libuv，专注于协程驱动的异步编程。它简化了异步 I/O 和阻塞任务的处理，使开发者能用 Lua 脚本轻松编写高并发网络应用。适合游戏服务器、网络服务等场景。"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/2025/07/12/lunet-high-performance-coroutine-network-library/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com/index.xml title=每天进步一点点><script async src="https://www.googletagmanager.com/gtag/js?id=G-EC3XLVSGKV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EC3XLVSGKV")</script><meta property="og:title" content="Lunet: 高性能协程网络库的设计与实现"><meta property="og:description" content="Lunet 是一个用 C 语言编写的高性能运行时，集成了 LuaJIT 和 libuv，专注于协程驱动的异步编程。它简化了异步 I/O 和阻塞任务的处理，使开发者能用 Lua 脚本轻松编写高并发网络应用。适合游戏服务器、网络服务等场景。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ddhigh.com/2025/07/12/lunet-high-performance-coroutine-network-library/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-12T11:53:08+08:00"><meta property="article:modified_time" content="2025-07-12T11:53:08+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lunet: 高性能协程网络库的设计与实现"><meta name=twitter:description content="Lunet 是一个用 C 语言编写的高性能运行时，集成了 LuaJIT 和 libuv，专注于协程驱动的异步编程。它简化了异步 I/O 和阻塞任务的处理，使开发者能用 Lua 脚本轻松编写高并发网络应用。适合游戏服务器、网络服务等场景。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.ddhigh.com/posts/"},{"@type":"ListItem","position":3,"name":"Lunet: 高性能协程网络库的设计与实现","item":"https://www.ddhigh.com/2025/07/12/lunet-high-performance-coroutine-network-library/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Lunet: 高性能协程网络库的设计与实现","name":"Lunet: 高性能协程网络库的设计与实现","description":"Lunet 是一个用 C 语言编写的高性能运行时，集成了 LuaJIT 和 libuv，专注于协程驱动的异步编程。它简化了异步 I/O 和阻塞任务的处理，使开发者能用 Lua 脚本轻松编写高并发网络应用。适合游戏服务器、网络服务等场景。\n","keywords":["libuv","lua"],"articleBody":"Lunet 是一个用 C 语言编写的高性能运行时，集成了 LuaJIT 和 libuv，专注于协程驱动的异步编程。它简化了异步 I/O 和阻塞任务的处理，使开发者能用 Lua 脚本轻松编写高并发网络应用。适合游戏服务器、网络服务等场景。\n什么是 Lunet 在现代应用开发中，高并发和异步编程已成为必备技能。然而，传统的异步编程往往需要开发者处理复杂的回调函数和状态管理，代码可读性较差。Lunet 通过协程技术，巧妙地解决了这个问题。\nLunet 是一个基于协程的网络库，它提供同步风格的 API，底层异步执行。这意味着你可以像写同步代码一样编写异步程序，既保持了代码的清晰可读，又获得了异步执行的高性能。\n核心架构 Lunet 的架构设计充分体现了\"站在巨人肩膀上\"的思想：\n技术栈 C 核心：高性能的原生实现，提供最佳的执行效率 LuaJIT：快速的 Lua 执行环境，支持 FFI（Foreign Function Interface） libuv：跨平台异步 I/O 库，Node.js 的底层引擎 协程：使用 Lua 协程实现并发编程 设计理念 简洁性：提供简单直观的 API，降低学习成本 高性能：充分利用 LuaJIT 的 JIT 编译能力和 libuv 的异步特性 模块化：按功能划分模块，便于维护和扩展 跨平台：支持 Linux、macOS 和 Windows 核心模块详解 1. 核心模块 (lunet) 核心模块提供了协程管理的基础功能：\nlocal lunet = require('lunet') -- 创建并运行新协程 lunet.spawn(function() print(\"Hello from coroutine!\") lunet.sleep(1000) -- 非阻塞睡眠 print(\"After 1 second\") end) 2. 网络模块 (lunet.socket) 网络模块是 Lunet 的核心，提供了完整的 TCP 网络编程能力：\nlocal socket = require('lunet.socket') -- 创建 TCP 服务器 local listener, err = socket.listen(\"tcp\", \"127.0.0.1\", 8080) if not listener then error(\"Failed to listen: \" .. err) end -- 接受连接 lunet.spawn(function() while true do local client, err = socket.accept(listener) if client then -- 在新协程中处理每个客户端 lunet.spawn(function() local data, err = socket.read(client) if data then socket.write(client, \"Echo: \" .. data) end socket.close(client) end) end end end) 3. 文件系统模块 (lunet.fs) 文件系统模块提供了异步文件操作能力：\nlocal fs = require('lunet.fs') lunet.spawn(function() -- 异步文件操作 local file, err = fs.open('config.json', 'r') if file then local content, err = fs.read(file, 1024) if content then print(\"Config content:\", content) end fs.close(file) end -- 目录遍历 local entries, err = fs.scandir('./logs') if entries then for i, entry in ipairs(entries) do print(\"Log file:\", entry.name, \"type:\", entry.type) end end end) 4. 数据库模块 (lunet.mysql) 数据库模块提供了 MySQL 数据库的异步访问能力：\nlocal mysql = require('lunet.mysql') lunet.spawn(function() local conn, err = mysql.open({ host = \"localhost\", port = 3306, user = \"root\", password = \"password\", database = \"myapp\" }) if conn then -- 查询操作 local users, err = mysql.query(conn, \"SELECT * FROM users WHERE active = 1\") if users then for i, user in ipairs(users) do print(\"User:\", user.name, user.email) end end -- 更新操作 local result, err = mysql.exec(conn, \"UPDATE users SET last_login = NOW() WHERE id = ?\", {user_id}) if result then print(\"Updated\", result.affected_rows, \"rows\") end mysql.close(conn) end end) 实战案例：构建高性能 Web 服务器 让我们通过一个完整的例子来展示 Lunet 的强大功能：\nlocal lunet = require('lunet') local socket = require('lunet.socket') local fs = require('lunet.fs') local mysql = require('lunet.mysql') -- 数据库连接池 local db_pool = {} -- 初始化数据库连接 local function init_database() for i = 1, 10 do -- 创建 10 个连接 local conn, err = mysql.open({ host = \"localhost\", port = 3306, user = \"webuser\", password = \"password\", database = \"website\" }) if conn then table.insert(db_pool, conn) end end end -- 获取数据库连接 local function get_db_connection() if #db_pool \u003e 0 then return table.remove(db_pool, 1) end return nil end -- 释放数据库连接 local function release_db_connection(conn) table.insert(db_pool, conn) end -- 处理 HTTP 请求 local function handle_request(client) local request, err = socket.read(client) if not request then socket.close(client) return end -- 解析请求 local method, path = request:match(\"([A-Z]+) ([^ ]+)\") if path == \"/api/users\" then -- 处理用户 API local conn = get_db_connection() if conn then local users, err = mysql.query(conn, \"SELECT id, name, email FROM users LIMIT 10\") release_db_connection(conn) if users then local json_response = json.encode(users) local response = string.format( \"HTTP/1.1 200 OK\\r\\n\" .. \"Content-Type: application/json\\r\\n\" .. \"Content-Length: %d\\r\\n\\r\\n%s\", #json_response, json_response ) socket.write(client, response) end end elseif path == \"/static/\" then -- 处理静态文件 local filename = path:sub(9) -- 去掉 \"/static/\" local file, err = fs.open(\"public/\" .. filename, \"r\") if file then local content, err = fs.read(file, 1024 * 1024) -- 读取 1MB fs.close(file) if content then local response = string.format( \"HTTP/1.1 200 OK\\r\\n\" .. \"Content-Type: text/html\\r\\n\" .. \"Content-Length: %d\\r\\n\\r\\n%s\", #content, content ) socket.write(client, response) end end else -- 404 响应 local response = \"HTTP/1.1 404 Not Found\\r\\nContent-Length: 0\\r\\n\\r\\n\" socket.write(client, response) end socket.close(client) end -- 主服务器逻辑 local function start_server() init_database() local listener, err = socket.listen(\"tcp\", \"0.0.0.0\", 8080) if not listener then error(\"Failed to start server: \" .. err) end print(\"Server started on http://0.0.0.0:8080\") lunet.spawn(function() while true do local client, err = socket.accept(listener) if client then -- 为每个客户端创建独立的协程 lunet.spawn(function() handle_request(client) end) end end end) end -- 启动服务器 start_server() 性能优势 1. 协程 vs 线程 传统的多线程模型需要为每个连接创建一个线程，这会带来以下问题：\n线程创建和销毁的开销 上下文切换的成本 内存占用（每个线程需要几MB的栈空间） Lunet 的协程模型则不同：\n协程创建几乎零成本 协程切换由用户态控制，无需内核参与 单个协程只占用几KB内存 2. 异步 I/O 的优势 通过 libuv 的事件循环，Lunet 可以在单线程中处理成千上万的并发连接，避免了传统同步 I/O 的阻塞问题。\n3. LuaJIT 的性能 LuaJIT 的 JIT 编译器可以将热点代码编译为机器码，性能接近 C 语言，远超传统的解释执行。\n使用场景 1. 游戏服务器 -- 游戏服务器示例 local lunet = require('lunet') local socket = require('lunet.socket') -- 玩家连接管理 local players = {} local function handle_player(client) local player_id = generate_player_id() players[player_id] = { client = client, x = 0, y = 0, last_heartbeat = os.time() } while true do local message, err = socket.read(client) if not message then break end -- 处理游戏消息 local msg_type, data = parse_message(message) if msg_type == \"move\" then players[player_id].x = data.x players[player_id].y = data.y broadcast_player_position(player_id, data.x, data.y) elseif msg_type == \"heartbeat\" then players[player_id].last_heartbeat = os.time() end end -- 玩家断开连接 players[player_id] = nil socket.close(client) end 2. 微服务网关 -- API 网关示例 local lunet = require('lunet') local socket = require('lunet.socket') -- 服务发现 local services = { user_service = {\"127.0.0.1:3001\", \"127.0.0.1:3002\"}, order_service = {\"127.0.0.1:3003\", \"127.0.0.1:3004\"} } local function proxy_request(service_name, request) local service_list = services[service_name] if not service_list then return nil, \"Service not found\" end -- 负载均衡（轮询） local service_addr = service_list[math.random(#service_list)] local host, port = service_addr:match(\"([^:]+):(%d+)\") -- 转发请求 local backend, err = socket.connect(host, tonumber(port)) if not backend then return nil, \"Failed to connect to backend\" end socket.write(backend, request) local response, err = socket.read(backend) socket.close(backend) return response, err end 3. 实时数据处理 -- 实时数据处理示例 local lunet = require('lunet') local socket = require('lunet.socket') -- 数据处理管道 local function process_data_stream() local listener, err = socket.listen(\"tcp\", \"0.0.0.0\", 9999) if not listener then error(\"Failed to start data processor\") end lunet.spawn(function() while true do local client, err = socket.accept(listener) if client then lunet.spawn(function() while true do local data, err = socket.read(client) if not data then break end -- 数据处理 local processed = process_json_data(data) -- 发送到消息队列 send_to_queue(processed) -- 实时统计 update_metrics(processed) end socket.close(client) end) end end end) end 开发体验 1. 类型安全 Lunet 提供了完整的类型定义，支持现代 IDE 的智能提示：\n---@type lunet local lunet = require('lunet') -- IDE 会提供完整的函数签名和文档 lunet.spawn(function() lunet.sleep(1000) -- 智能提示：Sleep for specified milliseconds end) 2. 错误处理 Lunet 采用了 Lua 风格的错误处理模式：\nlocal result, err = some_operation() if not result then -- 处理错误 print(\"Error:\", err) return end -- 继续处理结果 3. 调试支持 由于使用 Lua 编写业务逻辑，可以利用 LuaJIT 的调试工具进行开发和调试。\n总结 Lunet 通过巧妙的设计，将协程、异步 I/O 和高性能运行时完美结合，为开发者提供了一个强大而易用的网络编程框架。它的主要优势包括：\n开发效率高：同步风格的 API，易于理解和维护 性能优异：基于 LuaJIT 和 libuv，具备极高的并发能力 功能完整：涵盖网络、文件系统、数据库等常用模块 跨平台：支持主流操作系统 社区友好：开源项目，持续更新和维护 无论是构建高并发的 Web 服务器、游戏服务器，还是实时数据处理系统，Lunet 都能为你提供强大的技术支持。如果你正在寻找一个高性能、易用的网络编程框架，Lunet 绝对值得一试。\n相关资源 GitHub 仓库 API 文档 中文文档 本文深入介绍了 Lunet 的设计理念、核心功能和使用方法，希望能帮助你更好地理解和使用这个强大的网络编程框架。\n","wordCount":"984","inLanguage":"zh","datePublished":"2025-07-12T11:53:08+08:00","dateModified":"2025-07-12T11:53:08+08:00","author":{"@type":"Person","name":"Lei Xia"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com/2025/07/12/lunet-high-performance-coroutine-network-library/"},"publisher":{"@type":"Organization","name":"每天进步一点点","logo":{"@type":"ImageObject","url":"https://www.ddhigh.com/favicon.ico"}}}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link href=/titilliumweb/titilliumweb.css rel=stylesheet><link rel=stylesheet href=/css/main.min.0eb4160ba4a2d63122fe8ae83f1560951a87ab510d5dab0615973b5206555759.css integrity="sha256-DrQWC6Si1jEi/oroPxVglRqHq1ENXasGFZc7UgZVV1k=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css integrity="sha512-ygEyjMC6rqnzJqWGjRTJUPYMEs9JUOm3i7OWUS9CgQ4XkBUvMsgCS1I8JqavidQ2ClHcREB7IbA2mN08+r9Elg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.894ca9c68afab956438c4926a0dc7f5293e04e08595bd27abdb123e94801f684.js></script><script>hljs.highlightAll()</script><script>$darkModeInit.Content|safeJS</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2871082647721658" crossorigin=anonymous></script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>每天进步一点点
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/>首页</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>归档</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>出版物</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>留言板</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li><li class="navigation-item navigation-language"><a href=https://www.ddhigh.com/en/2025/07/12/lunet-high-performance-coroutine-network-library/>EN</a></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>Lunet: 高性能协程网络库的设计与实现</h1></header><p><small>2025年7月12日&nbsp;· 984 字&nbsp;· 5 分钟</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#什么是-lunet>什么是 Lunet</a></li><li><a href=#核心架构>核心架构</a><ul><li><a href=#技术栈>技术栈</a></li><li><a href=#设计理念>设计理念</a></li></ul></li><li><a href=#核心模块详解>核心模块详解</a><ul><li><a href=#1-核心模块-lunet>1. 核心模块 (<code>lunet</code>)</a></li><li><a href=#2-网络模块-lunetsocket>2. 网络模块 (<code>lunet.socket</code>)</a></li><li><a href=#3-文件系统模块-lunetfs>3. 文件系统模块 (<code>lunet.fs</code>)</a></li><li><a href=#4-数据库模块-lunetmysql>4. 数据库模块 (<code>lunet.mysql</code>)</a></li></ul></li><li><a href=#实战案例构建高性能-web-服务器>实战案例：构建高性能 Web 服务器</a></li><li><a href=#性能优势>性能优势</a><ul><li><a href=#1-协程-vs-线程>1. 协程 vs 线程</a></li><li><a href=#2-异步-io-的优势>2. 异步 I/O 的优势</a></li><li><a href=#3-luajit-的性能>3. LuaJIT 的性能</a></li></ul></li><li><a href=#使用场景>使用场景</a><ul><li><a href=#1-游戏服务器>1. 游戏服务器</a></li><li><a href=#2-微服务网关>2. 微服务网关</a></li><li><a href=#3-实时数据处理>3. 实时数据处理</a></li></ul></li><li><a href=#开发体验>开发体验</a><ul><li><a href=#1-类型安全>1. 类型安全</a></li><li><a href=#2-错误处理>2. 错误处理</a></li><li><a href=#3-调试支持>3. 调试支持</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#相关资源>相关资源</a></li></ul></nav></div><section class=blog-content><p>Lunet 是一个用 C 语言编写的高性能运行时，集成了 LuaJIT 和 libuv，专注于协程驱动的异步编程。它简化了异步 I/O 和阻塞任务的处理，使开发者能用 Lua 脚本轻松编写高并发网络应用。适合游戏服务器、网络服务等场景。</p><h2 id=什么是-lunet>什么是 Lunet</h2><p>在现代应用开发中，高并发和异步编程已成为必备技能。然而，传统的异步编程往往需要开发者处理复杂的回调函数和状态管理，代码可读性较差。Lunet 通过协程技术，巧妙地解决了这个问题。</p><p>Lunet 是一个基于协程的网络库，它提供<strong>同步风格的 API，底层异步执行</strong>。这意味着你可以像写同步代码一样编写异步程序，既保持了代码的清晰可读，又获得了异步执行的高性能。</p><h2 id=核心架构>核心架构</h2><p>Lunet 的架构设计充分体现了"站在巨人肩膀上"的思想：</p><h3 id=技术栈>技术栈</h3><ul><li><strong>C 核心</strong>：高性能的原生实现，提供最佳的执行效率</li><li><strong>LuaJIT</strong>：快速的 Lua 执行环境，支持 FFI（Foreign Function Interface）</li><li><strong>libuv</strong>：跨平台异步 I/O 库，Node.js 的底层引擎</li><li><strong>协程</strong>：使用 Lua 协程实现并发编程</li></ul><h3 id=设计理念>设计理念</h3><ol><li><strong>简洁性</strong>：提供简单直观的 API，降低学习成本</li><li><strong>高性能</strong>：充分利用 LuaJIT 的 JIT 编译能力和 libuv 的异步特性</li><li><strong>模块化</strong>：按功能划分模块，便于维护和扩展</li><li><strong>跨平台</strong>：支持 Linux、macOS 和 Windows</li></ol><h2 id=核心模块详解>核心模块详解</h2><h3 id=1-核心模块-lunet>1. 核心模块 (<code>lunet</code>)</h3><p>核心模块提供了协程管理的基础功能：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> lunet <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 创建并运行新协程</span>
</span></span><span style=display:flex><span>lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Hello from coroutine!&#34;</span>)
</span></span><span style=display:flex><span>    lunet.sleep(<span style=color:#ae81ff>1000</span>)  <span style=color:#75715e>-- 非阻塞睡眠</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;After 1 second&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><h3 id=2-网络模块-lunetsocket>2. 网络模块 (<code>lunet.socket</code>)</h3><p>网络模块是 Lunet 的核心，提供了完整的 TCP 网络编程能力：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> socket <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet.socket&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 创建 TCP 服务器</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> listener, err <span style=color:#f92672>=</span> socket.listen(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#e6db74>&#34;127.0.0.1&#34;</span>, <span style=color:#ae81ff>8080</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> listener <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    error(<span style=color:#e6db74>&#34;Failed to listen: &#34;</span> <span style=color:#f92672>..</span> err)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 接受连接</span>
</span></span><span style=display:flex><span>lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> client, err <span style=color:#f92672>=</span> socket.accept(listener)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> client <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>-- 在新协程中处理每个客户端</span>
</span></span><span style=display:flex><span>            lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>local</span> data, err <span style=color:#f92672>=</span> socket.read(client)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> data <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                    socket.write(client, <span style=color:#e6db74>&#34;Echo: &#34;</span> <span style=color:#f92672>..</span> data)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                socket.close(client)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><h3 id=3-文件系统模块-lunetfs>3. 文件系统模块 (<code>lunet.fs</code>)</h3><p>文件系统模块提供了异步文件操作能力：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> fs <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet.fs&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- 异步文件操作</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> file, err <span style=color:#f92672>=</span> fs.open(<span style=color:#e6db74>&#39;config.json&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> file <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> content, err <span style=color:#f92672>=</span> fs.read(file, <span style=color:#ae81ff>1024</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> content <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;Config content:&#34;</span>, content)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        fs.close(file)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- 目录遍历</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> entries, err <span style=color:#f92672>=</span> fs.scandir(<span style=color:#e6db74>&#39;./logs&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> entries <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i, entry <span style=color:#66d9ef>in</span> ipairs(entries) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;Log file:&#34;</span>, entry.name, <span style=color:#e6db74>&#34;type:&#34;</span>, entry.type)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><h3 id=4-数据库模块-lunetmysql>4. 数据库模块 (<code>lunet.mysql</code>)</h3><p>数据库模块提供了 MySQL 数据库的异步访问能力：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> mysql <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet.mysql&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> conn, err <span style=color:#f92672>=</span> mysql.open({
</span></span><span style=display:flex><span>        host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>        port <span style=color:#f92672>=</span> <span style=color:#ae81ff>3306</span>,
</span></span><span style=display:flex><span>        user <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root&#34;</span>,
</span></span><span style=display:flex><span>        password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;password&#34;</span>,
</span></span><span style=display:flex><span>        database <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;myapp&#34;</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> conn <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- 查询操作</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> users, err <span style=color:#f92672>=</span> mysql.query(conn, <span style=color:#e6db74>&#34;SELECT * FROM users WHERE active = 1&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> users <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> i, user <span style=color:#66d9ef>in</span> ipairs(users) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;User:&#34;</span>, user.name, user.email)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- 更新操作</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> result, err <span style=color:#f92672>=</span> mysql.exec(conn, 
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;UPDATE users SET last_login = NOW() WHERE id = ?&#34;</span>, {user_id})
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> result <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;Updated&#34;</span>, result.affected_rows, <span style=color:#e6db74>&#34;rows&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        mysql.close(conn)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><h2 id=实战案例构建高性能-web-服务器>实战案例：构建高性能 Web 服务器</h2><p>让我们通过一个完整的例子来展示 Lunet 的强大功能：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> lunet <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> socket <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet.socket&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> fs <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet.fs&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> mysql <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet.mysql&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 数据库连接池</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> db_pool <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 初始化数据库连接</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>init_database</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span> <span style=color:#66d9ef>do</span>  <span style=color:#75715e>-- 创建 10 个连接</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> conn, err <span style=color:#f92672>=</span> mysql.open({
</span></span><span style=display:flex><span>            host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>            port <span style=color:#f92672>=</span> <span style=color:#ae81ff>3306</span>,
</span></span><span style=display:flex><span>            user <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;webuser&#34;</span>,
</span></span><span style=display:flex><span>            password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;password&#34;</span>,
</span></span><span style=display:flex><span>            database <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;website&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> conn <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            table.insert(db_pool, conn)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 获取数据库连接</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>get_db_connection</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>#</span>db_pool <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> table.remove(db_pool, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 释放数据库连接</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>release_db_connection</span>(conn)
</span></span><span style=display:flex><span>    table.insert(db_pool, conn)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 处理 HTTP 请求</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handle_request</span>(client)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> request, err <span style=color:#f92672>=</span> socket.read(client)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> request <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        socket.close(client)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- 解析请求</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> method, path <span style=color:#f92672>=</span> request:match(<span style=color:#e6db74>&#34;([A-Z]+) ([^ ]+)&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> path <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;/api/users&#34;</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- 处理用户 API</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> conn <span style=color:#f92672>=</span> get_db_connection()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> conn <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> users, err <span style=color:#f92672>=</span> mysql.query(conn, <span style=color:#e6db74>&#34;SELECT id, name, email FROM users LIMIT 10&#34;</span>)
</span></span><span style=display:flex><span>            release_db_connection(conn)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> users <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>local</span> json_response <span style=color:#f92672>=</span> json.encode(users)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>local</span> response <span style=color:#f92672>=</span> string.format(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;HTTP/1.1 200 OK</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>..</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;Content-Type: application/json</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>..</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;Content-Length: %d</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>%s&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>#</span>json_response, json_response
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                socket.write(client, response)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>elseif</span> path <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;/static/&#34;</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- 处理静态文件</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> filename <span style=color:#f92672>=</span> path:sub(<span style=color:#ae81ff>9</span>)  <span style=color:#75715e>-- 去掉 &#34;/static/&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> file, err <span style=color:#f92672>=</span> fs.open(<span style=color:#e6db74>&#34;public/&#34;</span> <span style=color:#f92672>..</span> filename, <span style=color:#e6db74>&#34;r&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> file <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> content, err <span style=color:#f92672>=</span> fs.read(file, <span style=color:#ae81ff>1024</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1024</span>)  <span style=color:#75715e>-- 读取 1MB</span>
</span></span><span style=display:flex><span>            fs.close(file)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> content <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>local</span> response <span style=color:#f92672>=</span> string.format(
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;HTTP/1.1 200 OK</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>..</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;Content-Type: text/html</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>..</span>
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#34;Content-Length: %d</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>%s&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#f92672>#</span>content, content
</span></span><span style=display:flex><span>                )
</span></span><span style=display:flex><span>                socket.write(client, response)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- 404 响应</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> response <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;HTTP/1.1 404 Not Found</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>Content-Length: 0</span><span style=color:#ae81ff>\r\n\r\n</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        socket.write(client, response)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    socket.close(client)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 主服务器逻辑</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>start_server</span>()
</span></span><span style=display:flex><span>    init_database()
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> listener, err <span style=color:#f92672>=</span> socket.listen(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, <span style=color:#ae81ff>8080</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> listener <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        error(<span style=color:#e6db74>&#34;Failed to start server: &#34;</span> <span style=color:#f92672>..</span> err)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Server started on http://0.0.0.0:8080&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> client, err <span style=color:#f92672>=</span> socket.accept(listener)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> client <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>-- 为每个客户端创建独立的协程</span>
</span></span><span style=display:flex><span>                lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>                    handle_request(client)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 启动服务器</span>
</span></span><span style=display:flex><span>start_server()
</span></span></code></pre></div><h2 id=性能优势>性能优势</h2><h3 id=1-协程-vs-线程>1. 协程 vs 线程</h3><p>传统的多线程模型需要为每个连接创建一个线程，这会带来以下问题：</p><ul><li>线程创建和销毁的开销</li><li>上下文切换的成本</li><li>内存占用（每个线程需要几MB的栈空间）</li></ul><p>Lunet 的协程模型则不同：</p><ul><li>协程创建几乎零成本</li><li>协程切换由用户态控制，无需内核参与</li><li>单个协程只占用几KB内存</li></ul><h3 id=2-异步-io-的优势>2. 异步 I/O 的优势</h3><p>通过 libuv 的事件循环，Lunet 可以在单线程中处理成千上万的并发连接，避免了传统同步 I/O 的阻塞问题。</p><h3 id=3-luajit-的性能>3. LuaJIT 的性能</h3><p>LuaJIT 的 JIT 编译器可以将热点代码编译为机器码，性能接近 C 语言，远超传统的解释执行。</p><h2 id=使用场景>使用场景</h2><h3 id=1-游戏服务器>1. 游戏服务器</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- 游戏服务器示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> lunet <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> socket <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet.socket&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 玩家连接管理</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> players <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handle_player</span>(client)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> player_id <span style=color:#f92672>=</span> generate_player_id()
</span></span><span style=display:flex><span>    players[player_id] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        client <span style=color:#f92672>=</span> client,
</span></span><span style=display:flex><span>        x <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>        y <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>        last_heartbeat <span style=color:#f92672>=</span> os.time()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> message, err <span style=color:#f92672>=</span> socket.read(client)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> message <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>-- 处理游戏消息</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>local</span> msg_type, data <span style=color:#f92672>=</span> parse_message(message)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> msg_type <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;move&#34;</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            players[player_id].x <span style=color:#f92672>=</span> data.x
</span></span><span style=display:flex><span>            players[player_id].y <span style=color:#f92672>=</span> data.y
</span></span><span style=display:flex><span>            broadcast_player_position(player_id, data.x, data.y)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>elseif</span> msg_type <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;heartbeat&#34;</span> <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>            players[player_id].last_heartbeat <span style=color:#f92672>=</span> os.time()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- 玩家断开连接</span>
</span></span><span style=display:flex><span>    players[player_id] <span style=color:#f92672>=</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    socket.close(client)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h3 id=2-微服务网关>2. 微服务网关</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- API 网关示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> lunet <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> socket <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet.socket&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 服务发现</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> services <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    user_service <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;127.0.0.1:3001&#34;</span>, <span style=color:#e6db74>&#34;127.0.0.1:3002&#34;</span>},
</span></span><span style=display:flex><span>    order_service <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;127.0.0.1:3003&#34;</span>, <span style=color:#e6db74>&#34;127.0.0.1:3004&#34;</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>proxy_request</span>(service_name, request)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> service_list <span style=color:#f92672>=</span> services[service_name]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> service_list <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;Service not found&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- 负载均衡（轮询）</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> service_addr <span style=color:#f92672>=</span> service_list[math.random(<span style=color:#f92672>#</span>service_list)]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> host, port <span style=color:#f92672>=</span> service_addr:match(<span style=color:#e6db74>&#34;([^:]+):(%d+)&#34;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- 转发请求</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> backend, err <span style=color:#f92672>=</span> socket.connect(host, tonumber(port))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> backend <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;Failed to connect to backend&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    socket.write(backend, request)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> response, err <span style=color:#f92672>=</span> socket.read(backend)
</span></span><span style=display:flex><span>    socket.close(backend)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response, err
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h3 id=3-实时数据处理>3. 实时数据处理</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>-- 实时数据处理示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> lunet <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> socket <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet.socket&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 数据处理管道</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>process_data_stream</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>local</span> listener, err <span style=color:#f92672>=</span> socket.listen(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, <span style=color:#ae81ff>9999</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> listener <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        error(<span style=color:#e6db74>&#34;Failed to start data processor&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>local</span> client, err <span style=color:#f92672>=</span> socket.accept(listener)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> client <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>true</span> <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>local</span> data, err <span style=color:#f92672>=</span> socket.read(client)
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> data <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                        
</span></span><span style=display:flex><span>                        <span style=color:#75715e>-- 数据处理</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>local</span> processed <span style=color:#f92672>=</span> process_json_data(data)
</span></span><span style=display:flex><span>                        
</span></span><span style=display:flex><span>                        <span style=color:#75715e>-- 发送到消息队列</span>
</span></span><span style=display:flex><span>                        send_to_queue(processed)
</span></span><span style=display:flex><span>                        
</span></span><span style=display:flex><span>                        <span style=color:#75715e>-- 实时统计</span>
</span></span><span style=display:flex><span>                        update_metrics(processed)
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>                    socket.close(client)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=开发体验>开发体验</h2><h3 id=1-类型安全>1. 类型安全</h3><p>Lunet 提供了完整的类型定义，支持现代 IDE 的智能提示：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#75715e>---@type lunet</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>local</span> lunet <span style=color:#f92672>=</span> require(<span style=color:#e6db74>&#39;lunet&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- IDE 会提供完整的函数签名和文档</span>
</span></span><span style=display:flex><span>lunet.spawn(<span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>    lunet.sleep(<span style=color:#ae81ff>1000</span>)  <span style=color:#75715e>-- 智能提示：Sleep for specified milliseconds</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>)
</span></span></code></pre></div><h3 id=2-错误处理>2. 错误处理</h3><p>Lunet 采用了 Lua 风格的错误处理模式：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#66d9ef>local</span> result, err <span style=color:#f92672>=</span> some_operation()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> result <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- 处理错误</span>
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Error:&#34;</span>, err)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 继续处理结果</span>
</span></span></code></pre></div><h3 id=3-调试支持>3. 调试支持</h3><p>由于使用 Lua 编写业务逻辑，可以利用 LuaJIT 的调试工具进行开发和调试。</p><h2 id=总结>总结</h2><p>Lunet 通过巧妙的设计，将协程、异步 I/O 和高性能运行时完美结合，为开发者提供了一个强大而易用的网络编程框架。它的主要优势包括：</p><ol><li><strong>开发效率高</strong>：同步风格的 API，易于理解和维护</li><li><strong>性能优异</strong>：基于 LuaJIT 和 libuv，具备极高的并发能力</li><li><strong>功能完整</strong>：涵盖网络、文件系统、数据库等常用模块</li><li><strong>跨平台</strong>：支持主流操作系统</li><li><strong>社区友好</strong>：开源项目，持续更新和维护</li></ol><p>无论是构建高并发的 Web 服务器、游戏服务器，还是实时数据处理系统，Lunet 都能为你提供强大的技术支持。如果你正在寻找一个高性能、易用的网络编程框架，Lunet 绝对值得一试。</p><h2 id=相关资源>相关资源</h2><ul><li><a href=https://github.com/xialeistudio/lunet target=_blank rel=noopener>GitHub 仓库</a></li><li><a href=https://github.com/xialeistudio/lunet/blob/main/README.md target=_blank rel=noopener>API 文档</a></li><li><a href=https://github.com/xialeistudio/lunet/blob/main/README-CN.md target=_blank rel=noopener>中文文档</a></li></ul><p><em>本文深入介绍了 Lunet 的设计理念、核心功能和使用方法，希望能帮助你更好地理解和使用这个强大的网络编程框架。</em></p><div class=blog-footer><div class=social-share></div><div class=copyright><ul><li style=margin-bottom:.5em>本文作者: <a href=https://ddhigh.com/ target=_blank style=color:#000;text-decoration:none>xialeistudio</a></li><li style=margin-bottom:.5em>本文链接: <a href=https://www.ddhigh.com/2025/07/12/lunet-high-performance-coroutine-network-library/ target=_blank style=color:#000;text-decoration:none>Lunet: 高性能协程网络库的设计与实现</a></li><li>版权声明: <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank style=color:#000;text-decoration:none>「署名-非商业性使用-相同方式共享 4.0 国际」</a></li></ul></div><div style=margin-top:2rem><img src=/img/mp.png alt=qrcode></div></div></section><div class=paginator><a class=prev href=https://www.ddhigh.com/2025/07/15/cpp-coroutine-future-to-awaitable/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg><span>C++ 协程进阶：将 std::future 转换为 asio::awaitable</span></a>
<a class=next href=https://www.ddhigh.com/2025/02/23/implementation-of-service-discovery-part2/><span>服务发现的设计与实现（二）</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","xialeistudio/discussion"),s.setAttribute("data-repo-id","R_kgDOKurTRA"),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOKurTRM4CbCJt"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2014 - 2025 <a href=https://www.ddhigh.com>每天进步一点点</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg></a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js integrity="sha512-9DNXrSjk17bU9MUbRp3IjwcWe46V8FaGA062PFbryPUAEQVRbz4jiZP6FW0AdbqEGtMYBDWnul3eiGBMJOQajA==" crossorigin=anonymous referrerpolicy=no-referrer></script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>