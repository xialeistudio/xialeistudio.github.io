<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Learning &amp; Sharing</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Learning &amp; Sharing"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Learning &amp; Sharing"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Learning &amp;amp; Sharing"><meta property="og:type" content="website"><meta property="og:title" content="Learning &amp; Sharing"><meta property="og:url" content="https://www.ddhigh.com/"><meta property="og:site_name" content="Learning &amp; Sharing"><meta property="og:description" content="Learning &amp;amp; Sharing"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.ddhigh.com/img/og_image.png"><meta property="article:author" content="Xia Lei"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://www.ddhigh.com/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com"},"headline":"Learning & Sharing","image":["https://www.ddhigh.com/img/og_image.png"],"author":{"@type":"Person","name":"Xia Lei"},"publisher":{"@type":"Organization","name":"Learning & Sharing","logo":{"@type":"ImageObject","url":{"text":"Learning & Sharing"}}},"description":"Learning &amp; Sharing"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.4.1/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?78141f99bbb49f1564a7af89344f5add";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Learning &amp; Sharing</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Suche" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-10-20T03:17:09.000Z" title="10/20/2020, 3:17:09 AM">2020-10-20</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/php/">php</a></span><span class="level-item">3 minutes lesen (Über 388 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/10/20/2020-10-20-laravel-crontab-log-permission.html">Laravel定时任务写入日志用户变为root导致Web进程无法写入日志问题</a></p><div class="content"><p>今天访问接口时返回 <strong>接口写入日志失败</strong>，通过排查后发现 <code>storage/logs</code>下面出现了<code>root</code>用户新建的日志，导致<code>www</code>用户无法写入日志。</p>
<p>通过排查发现，<code>crontab</code>写入了<code>laravel</code>的<code>定时任务命令</code>。默认情况下，crontab的任务是使用<code>root</code>用户去执行的，因此<code>laravel定时任务</code>新建的文件属主自然成为了<code>root</code>。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>解决方法就是<code>使用指定用户来运行 crontab 任务</code>。比如使用<code>www</code>用户来运行<code>laravel</code>的计划任务命令。</p>
<p>使用下面的命令编辑<code>www</code>用户的定时任务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crontab -u www -e</span><br></pre></td></tr></table></figure>

<p>例如写入下面的示例任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /usr/local/php/bin/php /data/wwwroot/laravel/artisan schedule:run &gt;&gt; /var/log/laravel-crontab.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>保存即可，等待系统运行任务。</p>
<h2 id="运行时错误"><a href="#运行时错误" class="headerlink" title="运行时错误"></a>运行时错误</h2><p>通过观察发现定时任务并没有成功运行，通过查询<code>/var/log/cron</code>日志发现如下的日志：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(www) CMD (/usr/local/php/bin/php /data/wwwroot/laravel/artisan schedule:run &gt;&gt; /var/log/laravel-crontab.log 2&gt;&amp;1)</span><br><span class="line">(CRON) ERROR chdir failed (/home/www): No such file or directory</span><br></pre></td></tr></table></figure>

<p>可以看到，定时任务确实有执行，但是执行出错。出现这个问题的原因是<code>www 用户没有主目录</code>。</p>
<p>解决方案如下：</p>
<ol>
<li>新建<code>/home/www</code>目录</li>
<li>将<code>/home/www</code>的用户属主改为<code>www</code>用户</li>
</ol>
<p>相关命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/www</span><br><span class="line">chown -R www:www /home/www</span><br></pre></td></tr></table></figure>

<p>后续执行没有再出现错误。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-08-20T09:18:38.000Z" title="8/20/2020, 9:18:38 AM">2020-08-20</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/go/">go</a></span><span class="level-item">6 minutes lesen (Über 940 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/08/20/2020-08-20-golang-http-captcha-example.html">Golang Http 验证码示例</a></p><div class="content"><blockquote>
<p>验证码（CAPTCHA）是“Completely Automated Public Turing test to tell Computers and Humans Apart”（全自动区分<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E8%AE%A1%E7%AE%97%E6%9C%BA">计算机</a>和人类的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%9B%BE%E7%81%B5%E6%B5%8B%E8%AF%95">图灵测试</a>）的缩写，是一种区分用户是计算机还是人的公共全自动<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%A8%8B%E5%BA%8F/71525">程序</a>。可以防止：恶意破解密码、<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%88%B7%E7%A5%A8/6540942">刷票</a>、论坛灌水，有效防止某个黑客对某一个特定注册用户用特定程序暴力破解方式进行不断的登陆尝试，实际上用验证码是现在很多网站通行的方式，我们利用比较简易的方式实现了这个功能。这个问题可以由计算机生成并评判，但是必须只有人类才能解答。由于计算机无法解答CAPTCHA的问题，所以回答出问题的用户就可以被认为是人类。</p>
</blockquote>
<h2 id="传统网站验证码工作机制"><a href="#传统网站验证码工作机制" class="headerlink" title="传统网站验证码工作机制"></a>传统网站验证码工作机制</h2><ol>
<li>客户端请求服务器获取验证码图片</li>
<li>服务器生成随机串(验证码值)写入Session，并将验证码值写入到图片中返回给客户端</li>
<li>客户端输入图片上的字符串提交给服务器验证</li>
<li>服务器比对客户端提交的字符串值和 Session 中是否匹配，如果匹配则通过验证</li>
</ol>
<p>由于服务器生成的验证码值从始至终均未返回给客户端，因此，客户端只能从图片中识别验证码字符串，从而保证人机校验逻辑。</p>
<h2 id="Go的HTTP验证码"><a href="#Go的HTTP验证码" class="headerlink" title="Go的HTTP验证码"></a>Go的HTTP验证码</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>Go 语言的 HTTP 服务器默认不支持 Session，因此验证码值需要换个思路存储，以下是不使用 Session 的逻辑</p>
<ol>
<li>客户端请求服务器获取验证码ID</li>
<li>服务器生成验证码 ID，并生成验证码值，将 ID 和值的映射关系记录到内存或缓存，并将 ID 返回给客户端</li>
<li>客户端根据返回的 ID 请求服务器获取验证码图片</li>
<li>服务器获取到验证码 ID，从内存或缓存中取出验证码值，将该值写入图片并将图片返回给客户端</li>
<li>客户端提交验证码 ID（第1步获得）和验证码值给服务器验证</li>
<li>服务器获取验证码 ID，从内存或缓存中取出验证码值与客户端提交的验证码值比对</li>
</ol>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ol>
<li><p>安装验证码依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">github.com/dchest/captcha</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/dchest/captcha&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 获取验证码 ID</span></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/captcha/generate&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		id := captcha.NewLen(<span class="number">6</span>)</span><br><span class="line">		<span class="keyword">if</span> _, err := fmt.Fprint(w, id); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;generate captcha error&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">// 获取验证码图片</span></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/captcha/image&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		id := r.URL.Query().Get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> id == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			http.Error(w, <span class="string">&quot;Bad Request&quot;</span>, http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		w.Header().Set(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;image/png&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err := captcha.WriteImage(w, id, <span class="number">120</span>, <span class="number">80</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;show captcha error&quot;</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="comment">// 业务处理</span></span><br><span class="line">	http.HandleFunc(<span class="string">&quot;/login&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := r.ParseForm(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">&quot;parseForm error&quot;</span>, err)</span><br><span class="line">			http.Error(w, <span class="string">&quot;Internal Error&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 获取验证码 ID 和验证码值</span></span><br><span class="line">		id := r.FormValue(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">		value := r.FormValue(<span class="string">&quot;value&quot;</span>)</span><br><span class="line">		<span class="comment">// 比对提交的验证码值和内存中的验证码值</span></span><br><span class="line">		<span class="keyword">if</span> captcha.VerifyString(id, value) &#123;</span><br><span class="line">			fmt.Fprint(w, <span class="string">&quot;ok&quot;</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fmt.Fprint(w, <span class="string">&quot;mismatch&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行</p>
<ol>
<li>访问&#x2F;captcha&#x2F;generate获得验证码 ID</li>
<li>访问&#x2F;captcha&#x2F;image?id&#x3D;验证码 ID</li>
<li>访问&#x2F;login，并输入第一步的验证码 ID 和第二步的验证码值即可查看验证结果</li>
</ol>
</li>
</ol>
<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/xialeistudio/go-http-captcha-example">https://github.com/xialeistudio/go-http-captcha-example</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-03-18T04:00:00.000Z" title="3/18/2020, 4:00:00 AM">2020-03-18</time></span><span class="level-item"><a class="link-muted" href="/categories/frontend/">frontend</a><span> / </span><a class="link-muted" href="/categories/frontend/javascript/">javascript</a></span><span class="level-item">15 minutes lesen (Über 2200 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/03/18/2020-03-18-webpack-plugin-development.html">Webpack4不求人(5)——编写自定义插件</a></p><div class="content"><p><img src="https://static.ddhigh.com/blog/2020-03-18-032856.png"></p>
<p>Webpack通过Loader完成模块的转换工作，让“一切皆模块”成为可能。Plugin机制则让其更加灵活，可以在Webpack生命周期中调用钩子完成各种任务，包括修改输出资源、输出目录等等。</p>
<p>今天我们一起来学习如何编写Webpack插件。</p>
<h2 id="构建流程"><a href="#构建流程" class="headerlink" title="构建流程"></a>构建流程</h2><p>在编写插件之前，还需要了解一下Webpack的构建流程，以便在合适的时机插入合适的插件逻辑。Webpack的基本构建流程如下：</p>
<ol>
<li>校验配置文件</li>
<li>生成Compiler对象</li>
<li>初始化默认插件</li>
<li>run&#x2F;watch：如果运行在watch模式则执行watch方法，否则执行run方法</li>
<li>compilation：创建Compilation对象回调compilation相关钩子</li>
<li>emit：文件内容准备完成，准备生成文件，这是最后一次修改最终文件的机会</li>
<li>afterEmit：文件已经写入磁盘完成</li>
<li>done：完成编译</li>
</ol>
<h2 id="插件示例"><a href="#插件示例" class="headerlink" title="插件示例"></a>插件示例</h2><p>一个典型的Webpack插件代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 插件代码</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWebpackPlugin</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">    <span class="comment">// 在emit阶段插入钩子函数</span></span><br><span class="line">    compiler.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">tap</span>(<span class="string">&#x27;MyWebpackPlugin&#x27;</span>, <span class="function">(<span class="params">compilation</span>) =&gt;</span> &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">MyWebpackPlugin</span>;</span><br></pre></td></tr></table></figure>

<p>接下来需要在webpack.config.js中引入这个插件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>:[</span><br><span class="line">    <span class="comment">// 传入插件实例</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MyWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">param</span>:<span class="string">&#x27;paramValue&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Webpack在启动时会实例化插件对象，在初始化compiler对象之后会调用插件实例的apply方法，传入compiler对象，插件实例在apply方法中会注册感兴趣的钩子，Webpack在执行过程中会根据构建阶段回调相应的钩子。</p>
<h2 id="Compiler-amp-amp-Compilation对象"><a href="#Compiler-amp-amp-Compilation对象" class="headerlink" title="Compiler &amp;&amp; Compilation对象"></a>Compiler &amp;&amp; Compilation对象</h2><p>在编写Webpack插件过程中，最常用也是最主要的两个对象就是Webpack提供的Compiler和Compilation，Plugin通过访问Compiler和Compilation对象来完成工作。</p>
<ul>
<li>Compiler 对象包含了当前运行Webpack的配置，包括entry、output、loaders等配置，这个对象在启动Webpack时被实例化，而且是全局唯一的。Plugin可以通过该对象获取到Webpack的配置信息进行处理。</li>
<li>Compilation对象可以理解编译对象，包含了模块、依赖、文件等信息。在开发模式下运行Webpack时，每修改一次文件都会产生一个新的Compilation对象，Plugin可以访问到本次编译过程中的模块、依赖、文件内容等信息。</li>
</ul>
<h3 id="常见钩子"><a href="#常见钩子" class="headerlink" title="常见钩子"></a>常见钩子</h3><p>Webpack会根据执行流程来回调对应的钩子，下面我们来看看都有哪些常见钩子，这些钩子支持的tap操作是什么。</p>
<table>
<thead>
<tr>
<th>钩子</th>
<th>说明</th>
<th>参数</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td>afterPlugins</td>
<td>启动一次新的编译</td>
<td>compiler</td>
<td>同步</td>
</tr>
<tr>
<td>compile</td>
<td>创建compilation对象之前</td>
<td>compilationParams</td>
<td>同步</td>
</tr>
<tr>
<td>compilation</td>
<td>compilation对象创建完成</td>
<td>compilation</td>
<td>同步</td>
</tr>
<tr>
<td>emit</td>
<td>资源生成完成，输出之前</td>
<td>compilation</td>
<td>异步</td>
</tr>
<tr>
<td>afterEmit</td>
<td>资源输出到目录完成</td>
<td>compilation</td>
<td>异步</td>
</tr>
<tr>
<td>done</td>
<td>完成编译</td>
<td>stats</td>
<td>同步</td>
</tr>
</tbody></table>
<h2 id="Tapable"><a href="#Tapable" class="headerlink" title="Tapable"></a>Tapable</h2><p>Tapable是Webpack的一个核心工具，Webpack中许多对象扩展自Tapable类。Tapable类暴露了tap、tapAsync和tapPromise方法，可以根据钩子的同步&#x2F;异步方式来选择一个函数注入逻辑。</p>
<ul>
<li>tap 同步钩子</li>
<li>tapAsync 异步钩子，通过callback回调告诉Webpack异步执行完毕</li>
<li>tapPromise 异步钩子，返回一个Promise告诉Webpack异步执行完毕</li>
</ul>
<h3 id="tap"><a href="#tap" class="headerlink" title="tap"></a>tap</h3><p>tap是一个同步钩子，同步钩子在使用时不可以包含异步调用，因为函数返回时异步逻辑有可能未执行完毕导致问题。</p>
<p>下面一个在compile阶段插入同步钩子的示例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compiler.<span class="property">hooks</span>.<span class="property">compile</span>.<span class="title function_">tap</span>(<span class="string">&#x27;MyWebpackPlugin&#x27;</span>, <span class="function"><span class="params">params</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;我是同步钩子&#x27;</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="tapAsync"><a href="#tapAsync" class="headerlink" title="tapAsync"></a>tapAsync</h3><p>tapAsync是一个异步钩子，我们可以通过callback告知Webpack异步逻辑执行完毕。</p>
<p>下面是一个在emit阶段的示例，在1秒后打印文件列表。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">compiler.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">tapAsync</span>(<span class="string">&#x27;MyWebpackPlugin&#x27;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;文件列表&#x27;</span>, <span class="title class_">Object</span>.<span class="title function_">keys</span>(compilation.<span class="property">assets</span>).<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>));</span><br><span class="line">    <span class="title function_">callback</span>();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="tapPromise"><a href="#tapPromise" class="headerlink" title="tapPromise"></a>tapPromise</h3><p>tapPromise也是也是异步钩子，和tapAsync的区别在于tapPromise是通过返回Promise来告知Webpack异步逻辑执行完毕。</p>
<p>下面是一个将生成结果上传到CDN的示例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">compiler.<span class="property">hooks</span>.<span class="property">afterEmit</span>.<span class="title function_">tapPromise</span>(<span class="string">&#x27;MyWebpackPlugin&#x27;</span>, <span class="function">(<span class="params">compilation</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> filelist = <span class="title class_">Object</span>.<span class="title function_">keys</span>(compilation.<span class="property">assets</span>);</span><br><span class="line">    <span class="title function_">uploadToCDN</span>(filelist, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(err) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(err);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">resolve</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>apply方法中插入钩子的一般形式如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compileer.<span class="property">hooks</span>.阶段.<span class="property">tap</span>函数(<span class="string">&#x27;插件名称&#x27;</span>, <span class="function">(<span class="params">阶段回调参数</span>) =&gt;</span> &#123;</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="常用API"><a href="#常用API" class="headerlink" title="常用API"></a>常用API</h2><h3 id="读取输出资源、模块及依赖"><a href="#读取输出资源、模块及依赖" class="headerlink" title="读取输出资源、模块及依赖"></a>读取输出资源、模块及依赖</h3><p>在emit阶段，我们可以读取最终需要输出的资源、chunk、模块和对应的依赖，如果有需要还可以更改输出资源。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">  compiler.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">tapAsync</span>(<span class="string">&#x27;MyWebpackPlugin&#x27;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// compilation.chunks存放了代码块列表</span></span><br><span class="line">    compilation.<span class="property">chunks</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">chunk</span> =&gt;</span> &#123;</span><br><span class="line">     <span class="comment">// chunk包含多个模块，通过chunk.modulesIterable可以遍历模块列表 </span></span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">const</span> <span class="variable language_">module</span> <span class="keyword">of</span> chunk.<span class="property">modulesIterable</span>) &#123;</span><br><span class="line">        <span class="comment">// module包含多个依赖，通过module.dependencies进行遍历</span></span><br><span class="line">      	<span class="variable language_">module</span>.<span class="property">dependencies</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">dependency</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(dependency);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title function_">callback</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改输出资源"><a href="#修改输出资源" class="headerlink" title="修改输出资源"></a>修改输出资源</h3><p>通过操作compilation.assets对象，我们可以添加、删除、更改最终输出的资源。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">  compiler.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">tapAsync</span>(<span class="string">&#x27;MyWebpackPlugin&#x27;</span>, <span class="function">(<span class="params">compilation</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 修改或添加资源</span></span><br><span class="line">    compilation.<span class="property">assets</span>[<span class="string">&#x27;main.js&#x27;</span>]  = &#123;</span><br><span class="line">      <span class="title function_">source</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;modified content&#x27;</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">size</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">source</span>().<span class="property">length</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 删除资源</span></span><br><span class="line">    <span class="keyword">delete</span> compilation.<span class="property">assets</span>[<span class="string">&#x27;main.js&#x27;</span>];</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>assets对象需要定义source和size方法，source方法返回资源的内容，支持字符串和Node.js的Buffer，size返回文件的大小字节数。</p>
<h2 id="插件编写实例"><a href="#插件编写实例" class="headerlink" title="插件编写实例"></a>插件编写实例</h2><p>接下来我们开始编写自定义插件，所有插件使用的示例项目如下(需要安装webpack和webpack-cli)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">|----src</span><br><span class="line">		|----main.js</span><br><span class="line">|----plugins</span><br><span class="line">		|----my-webpack-plugin.js</span><br><span class="line">|----package.json</span><br><span class="line">|----webpack.config.js</span><br></pre></td></tr></table></figure>

<p>相关文件的内容如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span><span class="string">&quot;webpack&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MyWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;my-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>:<span class="string">&#x27;./src/main&#x27;</span>,</span><br><span class="line">  <span class="attr">output</span>:&#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;build&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>:<span class="string">&#x27;[name].js&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>:[</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MyWebpackPlugin</span>()</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="生成清单文件"><a href="#生成清单文件" class="headerlink" title="生成清单文件"></a>生成清单文件</h3><p>通过在emit阶段操作compilation.assets实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyWebpackPlugin</span> &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">        compiler.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">tapAsync</span>(<span class="string">&#x27;MyWebpackPlugin&#x27;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> manifest = &#123;&#125;;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(compilation.<span class="property">assets</span>)) &#123;</span><br><span class="line">                manifest[name] = compilation.<span class="property">assets</span>[name].<span class="title function_">size</span>();</span><br><span class="line">                <span class="comment">// 将生成文件的文件名和大小写入manifest对象</span></span><br><span class="line">            &#125;</span><br><span class="line">            compilation.<span class="property">assets</span>[<span class="string">&#x27;manifest.json&#x27;</span>] = &#123;</span><br><span class="line">                <span class="title function_">source</span>(<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(manifest);</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="title function_">size</span>(<span class="params"></span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">source</span>().<span class="property">length</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="title function_">callback</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">MyWebpackPlugin</span>;</span><br></pre></td></tr></table></figure>

<p>构建完成后会在build目录添加manifest.json，内容如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;main.js&quot;</span><span class="punctuation">:</span><span class="number">956</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="构建结果上传到七牛"><a href="#构建结果上传到七牛" class="headerlink" title="构建结果上传到七牛"></a>构建结果上传到七牛</h3><p>在实际开发中，资源文件构建完成后一般会同步到CDN，最终前端界面使用的是CDN服务器上的静态资源。</p>
<p>下面我们编写一个Webpack插件，文件构建完成后上传的七牛CDN。</p>
<p>我们的插件依赖qiniu，因此需要额外安装qiniu模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install qiniu --save-dev</span><br></pre></td></tr></table></figure>

<p>七牛的Node.js SDK文档地址如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://developer.qiniu.com/kodo/sdk/1289/nodejs</span><br></pre></td></tr></table></figure>

<p>开始编写插件代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> qiniu = <span class="built_in">require</span>(<span class="string">&#x27;qiniu&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWebpackPlugin</span> &#123;</span><br><span class="line">    <span class="comment">// 七牛SDK mac对象</span></span><br><span class="line">    mac = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">      	<span class="comment">// 读取传入选项</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">options</span> = options || &#123;&#125;;</span><br><span class="line">      	<span class="comment">// 检查选项中的参数</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">checkQiniuConfig</span>();</span><br><span class="line">      	<span class="comment">// 初始化七牛mac对象</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">mac</span> = <span class="keyword">new</span> qiniu.<span class="property">auth</span>.<span class="property">digest</span>.<span class="title class_">Mac</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">qiniu</span>.<span class="property">accessKey</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">qiniu</span>.<span class="property">secretKey</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">checkQiniuConfig</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 配置未传qiniu，读取环境变量中的配置</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">qiniu</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">qiniu</span> = &#123;</span><br><span class="line">                <span class="attr">accessKey</span>: process.<span class="property">env</span>.<span class="property">QINIU_ACCESS_KEY</span>,</span><br><span class="line">                <span class="attr">secretKey</span>: process.<span class="property">env</span>.<span class="property">QINIU_SECRET_KEY</span>,</span><br><span class="line">                <span class="attr">bucket</span>: process.<span class="property">env</span>.<span class="property">QINIU_BUCKET</span>,</span><br><span class="line">                <span class="attr">keyPrefix</span>: process.<span class="property">env</span>.<span class="property">QINIU_KEY_PREFIX</span> || <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> qiniu = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">qiniu</span>;</span><br><span class="line">        <span class="keyword">if</span> (!qiniu.<span class="property">accessKey</span> || !qiniu.<span class="property">secretKey</span> || !qiniu.<span class="property">bucket</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;invalid qiniu config&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">        compiler.<span class="property">hooks</span>.<span class="property">afterEmit</span>.<span class="title function_">tapPromise</span>(<span class="string">&#x27;MyWebpackPlugin&#x27;</span>, <span class="function">(<span class="params">compilation</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 总上传数量</span></span><br><span class="line">                <span class="keyword">const</span> uploadCount = <span class="title class_">Object</span>.<span class="title function_">keys</span>(compilation.<span class="property">assets</span>).<span class="property">length</span>;</span><br><span class="line">                <span class="comment">// 已上传数量</span></span><br><span class="line">                <span class="keyword">let</span> currentUploadedCount = <span class="number">0</span>;</span><br><span class="line">								<span class="comment">// 七牛SDK相关参数</span></span><br><span class="line">                <span class="keyword">const</span> putPolicy = <span class="keyword">new</span> qiniu.<span class="property">rs</span>.<span class="title class_">PutPolicy</span>(&#123; <span class="attr">scope</span>: <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">qiniu</span>.<span class="property">bucket</span> &#125;);</span><br><span class="line">                <span class="keyword">const</span> uploadToken = putPolicy.<span class="title function_">uploadToken</span>(<span class="variable language_">this</span>.<span class="property">mac</span>);</span><br><span class="line">                <span class="keyword">const</span> config = <span class="keyword">new</span> qiniu.<span class="property">conf</span>.<span class="title class_">Config</span>();</span><br><span class="line">                config.<span class="property">zone</span> = qiniu.<span class="property">zone</span>.<span class="property">Zone_z1</span>;</span><br><span class="line">                <span class="keyword">const</span> formUploader = <span class="keyword">new</span> qiniu.<span class="property">form_up</span>.<span class="title class_">FormUploader</span>()</span><br><span class="line">                <span class="keyword">const</span> putExtra = <span class="keyword">new</span> qiniu.<span class="property">form_up</span>.<span class="title class_">PutExtra</span>();</span><br><span class="line">								<span class="comment">// 因为是批量上传，需要在最后将错误对象回调</span></span><br><span class="line">                <span class="keyword">let</span> globalError = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">              	<span class="comment">// 遍历编译资源文件</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">const</span> filename <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(compilation.<span class="property">assets</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 开始上传</span></span><br><span class="line">                    formUploader.<span class="title function_">putFile</span>(</span><br><span class="line">                        uploadToken,</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">qiniu</span>.<span class="property">keyPrefix</span> + filename,</span><br><span class="line">                        path.<span class="title function_">resolve</span>(compilation.<span class="property">outputOptions</span>.<span class="property">path</span>, filename),</span><br><span class="line">                        putExtra,</span><br><span class="line">                        <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`uploade <span class="subst">$&#123;filename&#125;</span> result: <span class="subst">$&#123;err ? <span class="string">`Error:<span class="subst">$&#123;err.message&#125;</span>`</span> : <span class="string">&#x27;Success&#x27;</span>&#125;</span>`</span>)</span><br><span class="line">                            currentUploadedCount++;</span><br><span class="line">                            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                                globalError = err;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (currentUploadedCount === uploadCount) &#123;</span><br><span class="line">                                globalError ? <span class="title function_">reject</span>(globalError) : <span class="title function_">resolve</span>();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">MyWebpackPlugin</span>;</span><br></pre></td></tr></table></figure>

<p>Webpack中需要传递给该插件传递相关配置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;./src/index&#x27;</span>,</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;node&#x27;</span>,</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;build&#x27;</span>),</span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;[name].js&#x27;</span>,</span><br><span class="line">      	<span class="attr">publicPath</span>: <span class="string">&#x27;CDN域名&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">CleanWebpackPlugin</span>(),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">QiniuWebpackPlugin</span>(&#123;</span><br><span class="line">            <span class="attr">qiniu</span>: &#123;</span><br><span class="line">                <span class="attr">accessKey</span>: <span class="string">&#x27;七牛AccessKey&#x27;</span>,</span><br><span class="line">                <span class="attr">secretKey</span>: <span class="string">&#x27;七牛SecretKey&#x27;</span>,</span><br><span class="line">                <span class="attr">bucket</span>: <span class="string">&#x27;static&#x27;</span>,</span><br><span class="line">                <span class="attr">keyPrefix</span>: <span class="string">&#x27;webpack-inaction/demo1/&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>编译完成后资源会自动上传到七牛CDN，这样前端只用交付index.html即可。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>至此，Webpack相关常用知识和进阶知识都介绍完毕，需要各位读者在工作中去多加探索，Webpack配合Node.js生态，一定会涌现出更多优秀的新语言和新工具！</p>
<p><img src="https://static.ddhigh.com/blog/2020-03-11-060831.png" alt="0"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-03-11T04:00:00.000Z" title="3/11/2020, 4:00:00 AM">2020-03-11</time></span><span class="level-item"><a class="link-muted" href="/categories/frontend/">frontend</a><span> / </span><a class="link-muted" href="/categories/frontend/javascript/">javascript</a></span><span class="level-item">10 minutes lesen (Über 1428 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/03/11/2020-03-11-webpack-loader-development.html">Webpack4不求人(4)——编写自定义Loader</a></p><div class="content"><p>在前面的内容中，我们学习了Webpack的基本知识、常用脚手架和性能优化，虽然说大部分的开发场景社区已经又成熟的模块给我们使用，但是遇到特殊情况还是需要自己有独立开发的能力，因此今天我们一起来学习如何编写自定义Loader。</p>
<h2 id="基本Loader"><a href="#基本Loader" class="headerlink" title="基本Loader"></a>基本Loader</h2><p>Webpack中loader是一个CommonJs风格的函数，接收输入的源码，通过同步或异步的方式替换源码后进行输出。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params">source, sourceMap, meta</span>) &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>source是输入的内容</li>
<li>sourceMap是可选的</li>
<li>meta是模块的元数据，也是可选的</li>
</ul>
<p>需要注意的是，该导出函数必须使用function，不能使用箭头函数，因为loader编写过程中会经常使用到<code>this</code>访问选项和其他方法。</p>
<p>我们先编写一个基本的Loader，完成的工作很简单，那就是把输出的字符串进行替换。</p>
<p>1.新建loader-example目录，执行npm初始化，并安装webpack</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> loader-example</span><br><span class="line"><span class="built_in">cd</span> loadeer-example</span><br><span class="line">npm init -y</span><br><span class="line">npm install webpack webpack-cli</span><br></pre></td></tr></table></figure>

<p>2.构建项目目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">|----loader # loader目录</span><br><span class="line">		|----replace-loader.js # 替换字符串的Loader</span><br><span class="line">|----src   # 应用源码</span><br><span class="line">		|----index.js # 首页</span><br><span class="line">|----package.json</span><br><span class="line">|----webpack.config.js</span><br></pre></td></tr></table></figure>

<p>3.编写loader&#x2F;replace-loader.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> source.<span class="title function_">replace</span>(<span class="regexp">/World/g</span>, <span class="string">&#x27;Loader&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>本例中我们Loader只是简单的将源码中的”World“替换成了”Loader“。</p>
<p>4.编写src&#x2F;index.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br></pre></td></tr></table></figure>


<p>5.编写webpack.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index&#x27;</span>,</span><br><span class="line">  <span class="attr">target</span>: <span class="string">&#x27;node&#x27;</span>, <span class="comment">// 我们编译为Node.js环境下的JS，等下直接使用Node.js执行编译完成的文件</span></span><br><span class="line">  <span class="attr">output</span>:&#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;build&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>:&#123;</span><br><span class="line">    <span class="attr">rules</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>:<span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&#x27;replace-loader&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">resolveLoader</span>: &#123;</span><br><span class="line">  	<span class="attr">modules</span>: [<span class="string">&#x27;./node_modules&#x27;</span>, <span class="string">&#x27;./loader&#x27;</span>] <span class="comment">// 配置loader的查找目录</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>6.编写package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span><span class="string">&quot;webpack&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>7.执行构建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure>

<p>8.构建完成后，执行build&#x2F;main.js</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node build/main.js</span><br></pre></td></tr></table></figure>

<p>此时终端输出如下，我们编写的Loader工作正常。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello Loader</span><br></pre></td></tr></table></figure>

<h2 id="Loader选项"><a href="#Loader选项" class="headerlink" title="Loader选项"></a>Loader选项</h2><p>我们使用第三方loader时经常可以看到传递选项的情况：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">test</span>:<span class="regexp">/\.js$/</span>,</span><br><span class="line">  <span class="attr">use</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">loader</span>:<span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">      <span class="attr">options</span>:&#123;</span><br><span class="line">        <span class="attr">plugins</span>:[<span class="string">&#x27;@babel/transform-runtime&#x27;</span>],</span><br><span class="line">        <span class="attr">presets</span>:[<span class="string">&#x27;@babel/env&#x27;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Loader编写时，Webpack中官方推荐通过loader-utils来读取配置选项，我们需要先安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install loader-utils</span><br></pre></td></tr></table></figure>

<p>我们给刚才编写的replace-loader传递一个选项，允许自定义替换结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">&#x27;loader-utils&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params">source</span>) &#123;</span><br><span class="line">	<span class="keyword">const</span> options = loaderUtils.<span class="title function_">getOptions</span>(<span class="variable language_">this</span>);</span><br><span class="line">  <span class="keyword">return</span> source.<span class="title function_">replace</span>(<span class="regexp">/World/g</span>, options.<span class="property">text</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来编辑webpack.config.js，给replace-loader传递选项。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>:&#123;</span><br><span class="line">    <span class="attr">rules</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>:<span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>:[</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">loader</span>:<span class="string">&#x27;replace-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>:&#123;</span><br><span class="line">              <span class="attr">text</span>: <span class="string">&#x27;Webpack4&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">resolveLoader</span>:&#123;</span><br><span class="line">    <span class="attr">modules</span>: [<span class="string">&#x27;./node_modules&#x27;</span>, <span class="string">&#x27;./loader&#x27;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>执行构建之后用Node.js执行build&#x2F;main.js，可以看到输出的内容已经发生变化了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello Webpack4</span><br></pre></td></tr></table></figure>

<h2 id="异步Loader"><a href="#异步Loader" class="headerlink" title="异步Loader"></a>异步Loader</h2><p>在Loader中，如果存在异步调用，那么就无法直接通过return返回构建后的结果了，此时需要使用到Webpack提供的回调函数将数据进行回调。</p>
<p>Webpack4给Loader提供了<code>this.async()</code>函数，调用之后返回一个callback，callback的签名如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">callback</span>(<span class="params"></span></span><br><span class="line"><span class="params">  err: <span class="built_in">Error</span>|<span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  content: string|Buffer,</span></span><br><span class="line"><span class="params">  sourceMap?:SourceMap,</span></span><br><span class="line"><span class="params">  meta?: any</span></span><br><span class="line"><span class="params"></span>)</span><br></pre></td></tr></table></figure>

<p>例如我们需要在loader中调用setTimeout进行等待，则相应的代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="variable language_">this</span>.<span class="title function_">async</span>();</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> output = source.<span class="title function_">replace</span>(<span class="regexp">/World/g</span>, <span class="string">&#x27;Webpack4&#x27;</span>);</span><br><span class="line">    <span class="title function_">callback</span>(<span class="literal">null</span>, output);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行构建，Webpack会等待一秒，然后再输出构建内容，通过Node.js执行构建后的文件，输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello Webpack4</span><br></pre></td></tr></table></figure>

<h2 id="“Raw”-Loader"><a href="#“Raw”-Loader" class="headerlink" title="“Raw” Loader"></a>“Raw” Loader</h2><p>默认情况下，资源文件会被转化为 UTF-8 字符串，然后传给 loader。通过设置 <code>raw</code>，loader 可以接收原始的 <code>Buffer</code>。比如处理非文本文件时(如图片等等)。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params">source</span>) &#123;</span><br><span class="line">  <span class="title function_">assert</span>(source <span class="keyword">instanceof</span> <span class="title class_">Buffer</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">someSyncOperation</span>(source);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">raw</span> = <span class="literal">true</span>; <span class="comment">// 设置当前Loader为raw loader, webpack会将原始的Buffer对象传入</span></span><br></pre></td></tr></table></figure>

<h2 id="读取loader配置文件"><a href="#读取loader配置文件" class="headerlink" title="读取loader配置文件"></a>读取loader配置文件</h2><p>babel-loader在使用时可以加载.babelrc配置文件来配置plugins和presets，减少了webpack.config.js的代码量，便于维护。接下来我们编写一个i18n-loader，通过读取语言配置文件完成语言转换。</p>
<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|----loader</span><br><span class="line">		|----i18n-loader.js # loader</span><br><span class="line">|----i18n</span><br><span class="line">		|----zh.json # 中文语言包</span><br><span class="line">|----src</span><br><span class="line">		|----index.js # 入口文件</span><br><span class="line">|----webpack.config.js</span><br></pre></td></tr></table></figure>

<p>i18n&#x2F;zh.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hello&quot;</span><span class="punctuation">:</span> <span class="string">&quot;你好&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;today&quot;</span><span class="punctuation">:</span> <span class="string">&quot;今天&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>loader&#x2F;i18n-loader.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loaderUtils = <span class="built_in">require</span>(<span class="string">&#x27;loader-utils&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">source</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> options = loaderUtils.<span class="title function_">getOptions</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">const</span> locale = options ? options.<span class="property">locale</span> : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取语言配置文件</span></span><br><span class="line">    <span class="keyword">let</span> json = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (locale) &#123;</span><br><span class="line">        <span class="keyword">const</span> filename = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;i18n&#x27;</span>, <span class="string">`<span class="subst">$&#123;locale&#125;</span>.json`</span>);</span><br><span class="line">        json = <span class="built_in">require</span>(filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取语言标记 &#123;&#123;&#125;&#125;</span></span><br><span class="line">    <span class="keyword">const</span> matches = source.<span class="title function_">match</span>(<span class="regexp">/\&#123;\&#123;\w+\&#125;\&#125;/g</span>); </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> match <span class="keyword">of</span> matches) &#123;</span><br><span class="line">        <span class="keyword">const</span> name = match.<span class="title function_">match</span>(<span class="regexp">/\&#123;\&#123;(\w+)\&#125;\&#125;/</span>)[<span class="number">1</span>].<span class="title function_">toLowerCase</span>();</span><br><span class="line">        <span class="keyword">if</span> (json !== <span class="literal">null</span> &amp;&amp; json[name] !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            source = source.<span class="title function_">replace</span>(match, json[name]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            source = source.<span class="title function_">replace</span>(match, name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> source;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>src&#x2F;index.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&#123;&#123;Hello&#125;&#125;, &#123;&#123;Today&#125;&#125; is a good day.&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>webpack.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;./src/index&#x27;</span>,</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;build&#x27;</span>),</span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;[name].js&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;node&#x27;</span>,</span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                <span class="attr">use</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">loader</span>: <span class="string">&#x27;i18n-loader&#x27;</span>,</span><br><span class="line">                        <span class="attr">options</span>: &#123; <span class="comment">// 传递选项</span></span><br><span class="line">                            <span class="attr">locale</span>: <span class="string">&#x27;zh&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">resolveLoader</span>: &#123;</span><br><span class="line">        <span class="attr">modules</span>: [<span class="string">&#x27;./node_modules&#x27;</span>, <span class="string">&#x27;./loader&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span><span class="string">&quot;webpack&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="执行构建"><a href="#执行构建" class="headerlink" title="执行构建"></a>执行构建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure>

<p>构建完毕后使用Node.js执行build&#x2F;main.js输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">你好, 今天 is a good day.</span><br></pre></td></tr></table></figure>

<p>可以看到i18n-loader成功读取了配置文件。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文简要介绍了Webpack中如何编写一个自定义的loader，权当抛砖引玉，更多的用法等待读者在实际工作中去挖掘，要想掌握Webpack的高级知识，Loader是必不可少的技能，有时候如果社区找不到合适的Loader，大家可以根据需要自己进行开发。</p>
<p><img src="https://static.ddhigh.com/blog/2020-03-11-060831.png" alt="0"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-03-06T04:00:00.000Z" title="3/6/2020, 4:00:00 AM">2020-03-06</time></span><span class="level-item"><a class="link-muted" href="/categories/frontend/">frontend</a><span> / </span><a class="link-muted" href="/categories/frontend/javascript/">javascript</a></span><span class="level-item">15 minutes lesen (Über 2260 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/03/06/2020-03-06-webpack-optimize.html">Webpack4不求人(3) ——性能优化</a></p><div class="content"><h2 id="限定Webpack处理文件范围"><a href="#限定Webpack处理文件范围" class="headerlink" title="限定Webpack处理文件范围"></a>限定Webpack处理文件范围</h2><p>项目比较小的情况下Webpack的性能问题几乎可以忽略，但是一旦项目复杂度上升，Webpack会有额外的性能损失需要我们进行优化。</p>
<p>通过前面内容的学习我们可以知道Webpack主要干下面这些事情：</p>
<ol>
<li>通过entry指定的入口脚本进行依赖解析。</li>
<li>找到文件后通过配置的loader对其进行处理。</li>
</ol>
<p>因此，我们可以从这方面入手进行优化，减少Webpack搜索文件的范围，减少不必要的处理。</p>
<h3 id="loader配置"><a href="#loader配置" class="headerlink" title="loader配置"></a>loader配置</h3><p>在之前的内容中介绍过loader可以使用test、include、exclude配置项来匹配需要Loader处理的文件，因此推荐给每个loader定义test之后还定义include或exclude。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>:&#123;</span><br><span class="line">  	<span class="attr">rules</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>:<span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>:<span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">        <span class="attr">include</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src&#x27;</span>), <span class="comment">// 只处理src目录下的js文件</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="resolve-extensions配置"><a href="#resolve-extensions配置" class="headerlink" title="resolve.extensions配置"></a>resolve.extensions配置</h3><p>导入未添加扩展名的模块时，Webpack会通过resolve.extensions后缀去检查文件是否存在。由于resolve.extensions是一个数组，如果数组项比较多，正确的后缀放置得越靠后，Webpack尝试次数就会越多，影响到性能。</p>
<p>因此配置resolve.extensions时需要遵守以下规则：</p>
<ul>
<li>尽量减少后缀列表，不要将不可能存在的文件后缀配置进来</li>
<li>出现频率越高的后缀尽量写到前面，比如可以将.js写在第一个</li>
<li>业务代码中导入模块时，可以手动加上后缀导入，省去Webpack查找过程</li>
</ul>
<h3 id="module-noParse配置"><a href="#module-noParse配置" class="headerlink" title="module.noParse配置"></a>module.noParse配置</h3><p>module.noParse可以告诉Webpack忽略未采用模块系统文件的处理，可以有效地提高性能。比如常见的jQuery非常大，又没有采用模块系统，让Webpack解析这类型文件完全是浪费性能。</p>
<p>因此我们可以配置如下的module.noParse:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>:&#123;</span><br><span class="line">  	<span class="attr">noParse</span>:[<span class="regexp">/jQuery/</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="IgnorePlugin"><a href="#IgnorePlugin" class="headerlink" title="IgnorePlugin"></a>IgnorePlugin</h2><p>在导入模块时，IgnorePlugin可以忽略指定模块的生成。比如moment.js在导入时会自动导入本地化文件，一般情况下几乎不使用而且又比较大，此时可以通过IgnorePlugin忽略对本地化文件的生成，减小文件大小。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>:[</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">IgnorePlugin</span>(<span class="regexp">/\.\/local/</span>, <span class="regexp">/moment/</span>)</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="DllPlugin"><a href="#DllPlugin" class="headerlink" title="DllPlugin"></a>DllPlugin</h2><p>使用过Windows操作系统的读者应该会经常看到以.dll扩展名的文件，这些文件叫做动态链接库，包含了其他程序或动态链接库的函数和数据。</p>
<p>Webpack的DllPlugin的思想是类似的，先将公共模块打包为独立的Dll模块，然后在业务代码中直接引用这些模块。采用DllPlugin之后会大大提升Webpack构建速度，原因在于，包含大量复用模块的动态链接库只需要编译一次，之后的构建中会直接引用这些构建好的模块。</p>
<p>在Webpack中使用动态链接库有以下两个步骤：</p>
<ol>
<li>通过webpack.DllPlugin插件打包出Dll库</li>
<li>通过webpack.DllReferencePlugin引用打包好的Dll库</li>
</ol>
<p>下面以React项目为例进行说明。</p>
<p>Dll库需要单独构建，因此我们需要一份单独的配置Webpack文件。</p>
<p>1.新建webpack.dll.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">	<span class="attr">entry</span>:&#123;</span><br><span class="line">  	<span class="attr">react</span>: [<span class="string">&#x27;react&#x27;</span>, <span class="string">&#x27;react-dom&#x27;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">output</span>:&#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;_dll_[name].js&#x27;</span>, <span class="comment">// 输出的文件名</span></span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>), <span class="comment">// 输出到dist目录</span></span><br><span class="line">    <span class="attr">library</span>: <span class="string">&#x27;_dll_[name]&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// name要等于output.library里的name</span></span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">DllPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;_dll_[name]&quot;</span>,</span><br><span class="line">      <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;dist&quot;</span>, <span class="string">&quot;manifest.json&quot;</span>) <span class="comment">// 清单文件路径</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>2.编辑webpack.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">	<span class="attr">entry</span>: <span class="string">&#x27;./src/main&#x27;</span>,</span><br><span class="line">  <span class="attr">output</span>:&#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].js&#x27;</span>, <span class="comment">// 输出的文件名</span></span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>), <span class="comment">// 输出到dist目录</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// 传入manifest.json</span></span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">DllReferencePlugin</span>(&#123;</span><br><span class="line">      <span class="attr">manifest</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;dist&quot;</span>, <span class="string">&quot;manifest.json&quot;</span>) <span class="comment">// 清单文件路径</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>3.添加构建命令</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"> 		<span class="attr">&quot;build-dll&quot;</span><span class="punctuation">:</span><span class="string">&quot;webpack --config webpack.dll.config.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span><span class="string">&quot;webpack&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>4.构建Dll</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build-dll</span><br></pre></td></tr></table></figure>

<p>5.构建应用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Dll需要先构建，否则应用将构建失败</p>
</blockquote>
<h2 id="HappyPack"><a href="#HappyPack" class="headerlink" title="HappyPack"></a>HappyPack</h2><p>Webpack默认情况下是单进程执行的，因此无法利用多核优势，通过HappyPack可以变成多进程构建，从而提升构建速度。下面我们一起来看看如何使用happypack来加速构建。</p>
<p>1.安装happypack</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm isntall happypack</span><br></pre></td></tr></table></figure>

<p>2.编辑配置文件，需要将Loader配置到HappyPack插件中，由HappyPack对Loader进行调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HappyPackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;happypack&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">	<span class="attr">entry</span>: <span class="string">&#x27;./src/main&#x27;</span>,</span><br><span class="line">  <span class="attr">output</span>:&#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;build&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>:<span class="string">&#x27;[name].js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>:&#123;</span><br><span class="line">    <span class="attr">rules</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>:<span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>:<span class="string">&#x27;happypack/loader?id=js&#x27;</span>, <span class="comment">// 配置id为js</span></span><br><span class="line">        <span class="attr">include</span>:[</span><br><span class="line">          path.<span class="title function_">resolve</span>(__dirname,<span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>:<span class="regexp">/\.scss$/</span>,</span><br><span class="line">        <span class="attr">use</span>:<span class="string">&#x27;happypack/loader?id=scss&#x27;</span>, <span class="comment">// 配置id为scss</span></span><br><span class="line">        <span class="attr">include</span>:[</span><br><span class="line">          path.<span class="title function_">resolve</span>(__dirname,<span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>:<span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>:<span class="string">&#x27;happypack/loader?id=css&#x27;</span>, <span class="comment">// 配置id为css</span></span><br><span class="line">        <span class="attr">include</span>:[</span><br><span class="line">          path.<span class="title function_">resolve</span>(__dirname,<span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>:[</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HappyPackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">id</span>:<span class="string">&#x27;js&#x27;</span>, <span class="comment">// id为js的loader配置</span></span><br><span class="line">      <span class="attr">use</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">loader</span>:<span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">options</span>:&#123;</span><br><span class="line">            <span class="attr">plugins</span>:[<span class="string">&#x27;@babel/transform-runtime&#x27;</span>],</span><br><span class="line">            <span class="attr">presets</span>:[<span class="string">&#x27;@babel/env&#x27;</span>]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HappyPackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">id</span>:<span class="string">&#x27;scss&#x27;</span>, <span class="comment">// id为scss的loader配置</span></span><br><span class="line">      <span class="attr">use</span>:[<span class="string">&#x27;style-loader&#x27;</span>,<span class="string">&#x27;css-loader&#x27;</span>,<span class="string">&#x27;sass-loader&#x27;</span>]</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HappyPackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">id</span>:<span class="string">&#x27;css&#x27;</span>, <span class="comment">// id为css的loader配置</span></span><br><span class="line">      <span class="attr">use</span>:[<span class="string">&#x27;style-loader&#x27;</span>,<span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">    &#125;),</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Tree-Shaking"><a href="#Tree-Shaking" class="headerlink" title="Tree-Shaking"></a>Tree-Shaking</h2><p>Tree-Shaking原始的本意是”摇动树“，这样就会将一些分支”摇掉“，从而减少主干大小。而Webpack中的Tree-Shaking是类似的，在Webpack项目中，有一个入口文件，相当于树的主干，入口文件又依赖了许多模块。实际开发中，虽然依赖了某个模块，但其实只使用了其中的部分代码，通过Tree-Shaking，可以将模块中未使用的代码剔除掉，从而减少构建结果的大小。</p>
<blockquote>
<p>注意：只有使用ES6模块系统的代码，在mode为production时，Tree-Shaking才会生效。因此，在编写代码时尽量使用import&#x2F;export的方式。</p>
</blockquote>
<h2 id="按需加载"><a href="#按需加载" class="headerlink" title="按需加载"></a>按需加载</h2><p>在开发中，我们一般会将业务代码打包为app.js，其他第三方依赖打包为vendor.js。这样会有一个比较大的问题，如果依赖的第三方模块过多，vendor.js会越来越大，而在浏览器加载时需要完全加载完vendor.js才可以，这样就会造成无谓的等待，因为我们当前页面可能只使用了一部分代码。此时可以使用Webpack来实现按需加载，只有在真正用到这个模块时才会加载相应的js。</p>
<p>比如基于echarts开发了一个数据可视化页面，可以在这个路由组件下面使用异步的方式加载echarts的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="string">&#x27;echarts&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">modules</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> echarts = modules.<span class="property">default</span>;</span><br><span class="line">  <span class="keyword">const</span> chart = echarts.<span class="title function_">init</span>(<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#chart&#x27;</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>不过使用按需加载时，构建代码中会包含Promise调用，因此低版本浏览器需要注入Promise的polyfill实现。</p>
<h2 id="提取公共代码"><a href="#提取公共代码" class="headerlink" title="提取公共代码"></a>提取公共代码</h2><p>Webpack4中可以将多个公共模块打包一份，减少代码冗余，Webpack4之前的版本是使用webpack内置的CommonsChunkPlugin实现的，Webpack4直接配置<code>optimization</code>即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>:&#123;</span><br><span class="line">    <span class="attr">splitChunks</span>:&#123;</span><br><span class="line">      <span class="attr">cacheGroups</span>:&#123;</span><br><span class="line">        <span class="attr">common</span>:&#123; <span class="comment">// 应用代码中公共模块</span></span><br><span class="line">          <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">          <span class="comment">// 最小公共模块引用次数</span></span><br><span class="line">          <span class="attr">minChunks</span>: <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">vendor</span>:&#123; <span class="comment">// node_modules中第三方模块</span></span><br><span class="line">					<span class="attr">test</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">          <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span>,</span><br><span class="line">          <span class="attr">minChunks</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第三方库代码的变更一般比较少(通过package.json的版本可以指定依赖版本)，因此构建出来的vendor.js基本不会变就可以利用浏览器的缓存机制进行缓存。</p>
<p>而应用代码的变更是比较频繁的，因此单独打包为common.js，浏览器可以单独缓存，如果应用代码发生变更，浏览器只用重新下载common.js文件，而不用重新下载vendor.js。</p>
<h2 id="热更新"><a href="#热更新" class="headerlink" title="热更新"></a>热更新</h2><p>HMR(Hot Module Replacement)是Webpack提供的常用功能之一，它允许在运行时对模块进行修改，而无需刷新整个页面(LiveReload需要刷新页面才能加载)，这样有以下优势：</p>
<ul>
<li>保留应用状态，比如使用Vue&#x2F;React时如果使用LiveReload，组件状态全部丢失，而HMR不会</li>
<li>只更新变更的内容，节省开发时间</li>
</ul>
<p>使用以下配置即可打开内置的HMR功能：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">	<span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">hot</span>: <span class="literal">true</span>, <span class="comment">// 启用热加载</span></span><br><span class="line">    <span class="attr">contentBase</span>: <span class="string">&#x27;./dist&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>:[</span><br><span class="line">		<span class="keyword">new</span> webpack.<span class="title class_">NamedModulesPlugin</span>(), <span class="comment">// 打印更新的模块路径</span></span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">HotModuleReplacementPlugin</span>() <span class="comment">// 热更新插件</span></span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文我们对Webpack4最常用的性能优化技术进行了学习，这些优化方法对业务代码的侵入性非常小（只有按需加载优化会要求使用import()函数进行加载），在实际的开发中，可以结合这些技术进行针对性的优化，比如开发时编译慢，可能就需要使用HappyPack插件进行多进程编译以加快编译速度等等。</p>
<p><img src="https://static.ddhigh.com/blog/2019-10-22-102654.jpg" alt="0.jpeg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-03-02T04:00:00.000Z" title="3/2/2020, 4:00:00 AM">2020-03-02</time></span><span class="level-item"><a class="link-muted" href="/categories/frontend/">frontend</a><span> / </span><a class="link-muted" href="/categories/frontend/javascript/">javascript</a></span><span class="level-item">9 minutes lesen (Über 1297 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/03/02/2020-03-02-react-ssr-example.html">Webpack4不求人(2) ——手把手搭建TypeScript+React16+ReactRouter5同构应用脚手架</a></p><div class="content"><h2 id="同构应用"><a href="#同构应用" class="headerlink" title="同构应用"></a>同构应用</h2><p>使用同一份应用代码，同时提供浏览器环境和服务器环境下的应用，解决传统浏览器单页应用的两个顽固问题：</p>
<ul>
<li>不利于SEO，浏览器环境代码是在客户端渲染，大部分爬虫都只能爬到一个空白的入口文件</li>
<li>代码在浏览器渲染，低端机可能会卡顿</li>
</ul>
<p>接下来我们一起从零开始搭建基于Webpack的React同构应用脚手架。</p>
<h2 id="SSR流程"><a href="#SSR流程" class="headerlink" title="SSR流程"></a>SSR流程</h2><ol>
<li>Web应用构建完成后输出CSS、JS和HTML</li>
<li>SSR应用构建完成后输出一个CommonJs模块文件，可以将虚拟DOM在服务端渲染为HTML字符串</li>
<li>Node.js新建HTTP服务器，收到请求后调用SSR模块导出的render函数输出HTML到客户端</li>
</ol>
<h2 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> react-ssr-example</span><br><span class="line"><span class="built_in">cd</span> react-ssr-example</span><br><span class="line">yarn init -y</span><br><span class="line"></span><br><span class="line">yarn add webpack webpack-cli webpack-dev-server -D <span class="comment"># 安装Webpack</span></span><br><span class="line">yarn add react react-dom react-router-dom <span class="comment"># 安装React</span></span><br><span class="line">yarn add @types/react @types/react-dom @types/react-router-dom -D <span class="comment"># 安装React声明文件</span></span><br><span class="line">yarn add express <span class="comment"># 安装express</span></span><br><span class="line">yarn add css-loader sass-loader node-sass mini-css-extract-plugin <span class="comment"># 安装CSS相关模块</span></span><br><span class="line">yarn add ts-loader typescript <span class="comment"># 安装TypeScript</span></span><br><span class="line">yarn add html-webpack-plugin <span class="comment"># 安装HTML处理插件</span></span><br></pre></td></tr></table></figure>

<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>脚手架的完整目录如下：(这些文件一步步都会有)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">|----build # 构建结果目录</span><br><span class="line">		|----styles # 样式</span><br><span class="line">				|----main.css</span><br><span class="line">		|----bundle.ssr.js # SSR应用文件</span><br><span class="line">		|----bundle.web.js # Web应用文件</span><br><span class="line">		|----index.html # Web应用入口HTML</span><br><span class="line">|----src # 应用源码</span><br><span class="line">		|----home # 首页组件</span><br><span class="line">				|----index.scss # 首页SCSS</span><br><span class="line">				|----index.tsx # 首页组件</span><br><span class="line">		|----signin # 登录页组件</span><br><span class="line">				|----index.scss # 登录页SCSS</span><br><span class="line">				|----index.tsx # 登录页组件</span><br><span class="line">		|----App.tsx # 应用路由设置</span><br><span class="line">		|----index.html # Web应用入口HTML</span><br><span class="line">		|----main.ssr.tsx # SSR入口文件</span><br><span class="line">		|----main.web.tsx # Web入口文件</span><br><span class="line">|----index.js #　express服务器入口</span><br><span class="line">|----package.json</span><br><span class="line">|----tsconfig.json # TypeScript配置文件</span><br><span class="line">|----webpack.config.js # Web应用webpack配置</span><br><span class="line">|----webconfig.ssr.config.js # SSR应用Webpack配置</span><br></pre></td></tr></table></figure>

<h2 id="工具配置"><a href="#工具配置" class="headerlink" title="工具配置"></a>工具配置</h2><p>1.TypeScript配置，新建tsconfig.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;es5&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;commonjs&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;jsx&quot;</span><span class="punctuation">:</span> <span class="string">&quot;react&quot;</span><span class="punctuation">,</span> </span><br><span class="line">      <span class="attr">&quot;strict&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lib&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;DOM&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;esModuleInterop&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;./src/**/*.ts&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;./src/**/*.tsx&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;exclude&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;node_modules&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>主要是添加了jsx设置和include设置</p>
<p>2.Web环境webpack配置，新建webpack.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MiniCssPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;mini-css-extract-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;./src/main.web&#x27;</span>, <span class="comment">// 入口文件</span></span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;build&#x27;</span>), <span class="comment">// 输出目录</span></span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;bundle.web.js&#x27;</span> <span class="comment">// 输出文件</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\.tsx?$/</span>, <span class="comment">// ts文件处理</span></span><br><span class="line">                <span class="attr">use</span>: <span class="string">&#x27;ts-loader&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="comment">// scss文件处理</span></span><br><span class="line">                <span class="attr">use</span>: [<span class="title class_">MiniCssPlugin</span>.<span class="property">loader</span>, <span class="string">&#x27;css-loader&#x27;</span>, <span class="string">&#x27;sass-loader&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="comment">// css文件处理</span></span><br><span class="line">                <span class="attr">use</span>: [<span class="title class_">MiniCssPlugin</span>.<span class="property">loader</span>, <span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">            <span class="attr">chunks</span>: [<span class="string">&#x27;main&#x27;</span>], <span class="comment">// chunk名称，entry是字符串类型，因此chunk为main</span></span><br><span class="line">            <span class="attr">filename</span>: <span class="string">&#x27;index.html&#x27;</span>, <span class="comment">// 输出到build目录的文件名</span></span><br><span class="line">            <span class="attr">template</span>: <span class="string">&#x27;src/index.html&#x27;</span> <span class="comment">// 模板路径</span></span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MiniCssPlugin</span>(&#123;</span><br><span class="line">            <span class="attr">filename</span>: <span class="string">&#x27;styles/[name].[contenthash:8].css&#x27;</span>, <span class="comment">// 输出的CSS文件名</span></span><br><span class="line">            <span class="attr">chunkFilename</span>: <span class="string">&#x27;styles/[name].[contenthash:8].css&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">resolve</span>: &#123;</span><br><span class="line">        <span class="attr">extensions</span>: [<span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>, <span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.json&#x27;</span>] <span class="comment">// 添加ts和tsx后缀</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>3.SSR环境Webpack配置，新建webpack.ssr.config.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MiniCssPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;mini-css-extract-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;./src/main.ssr&#x27;</span>,</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;node&#x27;</span>, <span class="comment">// 必须指定为Node.js，否则会打包Node.js内置模块</span></span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;build&#x27;</span>),</span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;bundle.ssr.js&#x27;</span>,</span><br><span class="line">        <span class="attr">libraryTarget</span>: <span class="string">&#x27;commonjs2&#x27;</span> <span class="comment">// 打包为CommonJs模块才能被Node.js加载</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\.tsx?$/</span>,</span><br><span class="line">                <span class="attr">use</span>: <span class="string">&#x27;ts-loader&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">                <span class="attr">use</span>: [<span class="title class_">MiniCssPlugin</span>.<span class="property">loader</span>, <span class="string">&#x27;css-loader&#x27;</span>, <span class="string">&#x27;sass-loader&#x27;</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                <span class="attr">use</span>: [<span class="title class_">MiniCssPlugin</span>.<span class="property">loader</span>, <span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">MiniCssPlugin</span>(&#123;</span><br><span class="line">            <span class="attr">filename</span>: <span class="string">&#x27;styles/[name].[contenthash:8].css&#x27;</span>,</span><br><span class="line">            <span class="attr">chunkFilename</span>: <span class="string">&#x27;styles/[name].[contenthash:8].css&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">resolve</span>: &#123;</span><br><span class="line">        <span class="attr">extensions</span>: [<span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.tsx&#x27;</span>, <span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;.json&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>4.package.json添加npm命令</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpack-dev-server&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build-ssr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;webpack --config webpack.ssr.config.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="应用编码"><a href="#应用编码" class="headerlink" title="应用编码"></a>应用编码</h2><p>src&#x2F;home&#x2F;index.tsx</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.scss&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Home</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;main&quot;</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>src&#x2F;home&#x2F;index.scss</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.main</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>src&#x2F;signin&#x2F;index.tsx</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; withRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SignIn</span>(<span class="params">props: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> props.history.replace(&#x27;/&#x27;)&#125;&gt;登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">withRouter</span>(<span class="title class_">SignIn</span>);</span><br></pre></td></tr></table></figure>

<p>src&#x2F;App.tsx</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Switch</span>, <span class="title class_">Route</span>, <span class="title class_">Link</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>; <span class="comment">// router</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入页面组件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span> <span class="keyword">from</span> <span class="string">&#x27;./home&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">SignIn</span> <span class="keyword">from</span> <span class="string">&#x27;./signin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出路由组件配置</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/signin&quot;</span> <span class="attr">component</span>=<span class="string">&#123;SignIn&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">component</span>=<span class="string">&#123;Home&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>src&#x2F;main.ssr.tsx</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">StaticRouter</span>, <span class="title class_">Link</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; renderToString &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom/server&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>; <span class="comment">// 将路由组件导入进来</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">req: <span class="built_in">any</span></span>) &#123; <span class="comment">// 导出一个渲染函数，根据请求链接进行分发</span></span><br><span class="line">    <span class="keyword">const</span> context = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> html = <span class="title function_">renderToString</span>(</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">StaticRouter</span> <span class="attr">location</span>=<span class="string">&#123;req.url&#125;</span> <span class="attr">context</span>=<span class="string">&#123;context&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/signin&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">StaticRouter</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> [html, context]; <span class="comment">// 导出context和html渲染结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>src&#x2F;main.web.tsx</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserRouter</span>, <span class="title class_">Link</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>( <span class="comment">// 渲染路由</span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">BrowserRouter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/&quot;</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/signin&quot;</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">BrowserRouter</span>&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#app&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>index.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>); <span class="comment">// 加载express</span></span><br><span class="line"><span class="keyword">const</span> &#123; render &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./build/bundle.ssr&#x27;</span>); <span class="comment">// 加载ssr</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;.&#x27;</span>)) <span class="comment">// 静态资源配置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/*&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; <span class="comment">// 所有请求都走这里处理，必须加*</span></span><br><span class="line">    <span class="keyword">const</span> [html, context] = <span class="title function_">render</span>(req)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(context) <span class="comment">// context目前没发现啥用处</span></span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;SSR&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;link href=&quot;build/styles/main.8f173ff5.css&quot; rel=&quot;stylesheet&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;div id=&quot;app&quot;&gt;<span class="subst">$&#123;html&#125;</span>&lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;script src=&quot;build/bundle.web.js&quot;&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;</span></span><br><span class="line"><span class="string">    `</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(context)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>静态资源配置必须在最上面</li>
<li>app.get(‘&#x2F;<em>‘)必须有</em>号</li>
<li>HTML字符串必须手动引入CSS和Web构建结果</li>
</ul>
<h2 id="执行构建"><a href="#执行构建" class="headerlink" title="执行构建"></a>执行构建</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm run build <span class="comment"># 构建Web</span></span><br><span class="line">npm run build-ssr <span class="comment">#　构建SSR</span></span><br><span class="line">node index.js <span class="comment"># 启动Express服务器</span></span><br></pre></td></tr></table></figure>

<h2 id="查看结果"><a href="#查看结果" class="headerlink" title="查看结果"></a>查看结果</h2><p>首页样式</p>
<p><img src="https://static.ddhigh.com/blog/2020-03-02-093301.png" alt="image-20200302173258430"></p>
<p>首页代码</p>
<p><img src="https://static.ddhigh.com/blog/2020-03-02-093323.png" alt="image-20200302173322601"></p>
<p>登录页样式</p>
<p><img src="https://static.ddhigh.com/blog/2020-03-02-093346.png" alt="image-20200302173344488"></p>
<p>登录页代码</p>
<p><img src="https://static.ddhigh.com/blog/2020-03-02-093408.png" alt="image-20200302173405907"></p>
<h2 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/xialeistudio/react-ssr-example">Https://github.com/xialeistudio/react-ssr-example</a></p>
<p><img src="https://static.ddhigh.com/blog/2019-10-22-102654.jpg" alt="0.jpeg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-02-11T04:00:00.000Z" title="2/11/2020, 4:00:00 AM">2020-02-11</time></span><span class="level-item"><a class="link-muted" href="/categories/devtools/">devtools</a></span><span class="level-item">11 minutes lesen (Über 1646 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/02/11/2020-02-11-shell-operator-flow-control.html">Shell脚本快速入门(2)</a></p><div class="content"><p>今天我们来学习Shell的运算符和流程控制。</p>
<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><p>Shell和其他编程语言一样支持多种运算符，包括：</p>
<ul>
<li>算术运算符</li>
<li>关系运算符</li>
<li>逻辑运算符</li>
<li>字符串运算符</li>
<li>文件测试运算符</li>
</ul>
<p>下面我们一起来看看。</p>
<h3 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h3><blockquote>
<p>原生bash不支持简单的数学运算，需要借助expr命令。</p>
</blockquote>
<p>例如，输出两个数的和：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>=`<span class="built_in">expr</span> 1 + 1`</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$sum</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<blockquote>
<p>操作数和操作符之间必须用空格分开；</p>
<p>表达式必须使用反引号包裹；</p>
</blockquote>
<table>
<thead>
<tr>
<th>操作符</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>+</td>
<td>加法</td>
<td>expr 1 + 1</td>
</tr>
<tr>
<td>-</td>
<td>减法</td>
<td>expr 1 - 1</td>
</tr>
<tr>
<td>*</td>
<td>乘法</td>
<td>expr 1 \* 1 需要转义*号</td>
</tr>
<tr>
<td>&#x2F;</td>
<td>除法</td>
<td>expr 1 &#x2F; 1</td>
</tr>
<tr>
<td>%</td>
<td>取余</td>
<td>expr 2 % 2</td>
</tr>
</tbody></table>
<p>完整示例如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">a=1</span><br><span class="line">b=2</span><br><span class="line"><span class="comment"># 加法</span></span><br><span class="line">val=`<span class="built_in">expr</span> <span class="variable">$a</span> + <span class="variable">$b</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>+<span class="variable">$b</span>=<span class="variable">$val</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 减法</span></span><br><span class="line">val=`<span class="built_in">expr</span> <span class="variable">$a</span> - <span class="variable">$b</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>-<span class="variable">$b</span>=<span class="variable">$val</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 乘法</span></span><br><span class="line">val=`<span class="built_in">expr</span> <span class="variable">$a</span> \* <span class="variable">$b</span>` <span class="comment"># 必须转义</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>*<span class="variable">$b</span>=<span class="variable">$val</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 除法</span></span><br><span class="line">val=`<span class="built_in">expr</span> <span class="variable">$a</span> / <span class="variable">$b</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>/<span class="variable">$b</span>=<span class="variable">$val</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 取余</span></span><br><span class="line">val=`<span class="built_in">expr</span> <span class="variable">$a</span> % <span class="variable">$b</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>%<span class="variable">$b</span>=<span class="variable">$val</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="关系运算符"><a href="#关系运算符" class="headerlink" title="关系运算符"></a>关系运算符</h3><p>关系运算符是比较两个操作数的数学大小关系，支持数字和数字字符串(如”1”)</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td>-eq</td>
<td>检测两数是否相等</td>
<td>[ <code>$a -eq $b</code> ]</td>
</tr>
<tr>
<td>-ne</td>
<td>检测两数是否不等</td>
<td>[ <code>$a -ne $b</code> ]</td>
</tr>
<tr>
<td>-gt</td>
<td>检查左边是否大于右边(greater than)</td>
<td>[ <code>$a -gt $b</code> ]</td>
</tr>
<tr>
<td>-lt</td>
<td>检查左边是否小于右边(less than)</td>
<td>[ <code>$a -lt $b</code> ]</td>
</tr>
<tr>
<td>-ge</td>
<td>检查左边是否大于等于右边</td>
<td>[ <code>$a -ge $b</code> ]</td>
</tr>
<tr>
<td>-le</td>
<td>检查左边是否小于等于右边</td>
<td>[ <code>$a -le $b</code> ]</td>
</tr>
<tr>
<td>&#x3D;&#x3D;</td>
<td>判断两数是否相等</td>
<td>[ <code>$a == $b</code> ]</td>
</tr>
<tr>
<td>!&#x3D;</td>
<td>判断两数是否不想等</td>
<td>[ <code>$a != $b</code> ]</td>
</tr>
</tbody></table>
<p>下面是一个if比较的示例，if语法将在本文介绍流程控制的时候进行详细学习。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a=10</span><br><span class="line">b=20</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -eq <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>=<span class="variable">$b</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>!=<span class="variable">$b</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h3><p>逻辑运算符就是与(AND)、或(OR)、非(NOT)。</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>!</td>
<td>逻辑非</td>
<td>[ !false]返回true</td>
</tr>
<tr>
<td>-o</td>
<td>逻辑或</td>
<td>[ <code>$a -gt 0 -o $b -gt 0</code>] 当a和b有一个大于0时返回true</td>
</tr>
<tr>
<td>-a</td>
<td>逻辑与</td>
<td>[ <code>$a -gt 0 -a $b -gt 0</code> ]当a和b都大于0时返回true</td>
</tr>
</tbody></table>
<p>下面是结合关系运算符的例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">a=1</span><br><span class="line">b=2</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> != <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;1!=2&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;1=2&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -gt 0 -o <span class="variable">$b</span> -gt 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;a或b大于0&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;a和b都不大于0&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> -gt 0 -a <span class="variable">$b</span> -gt 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;a和b都大于0&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;a和b不都大于0&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="字符串运算符"><a href="#字符串运算符" class="headerlink" title="字符串运算符"></a>字符串运算符</h3><p>Shell被常用来处理字符串数据，因此有一些专门适用于字符串的运算符。</p>
<table>
<thead>
<tr>
<th>运算符</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>&#x3D;</td>
<td>检查两个字符串是否相等</td>
<td>[ <code>$a = $b</code> ]</td>
</tr>
<tr>
<td>!&#x3D;</td>
<td>检查两个字符串是否不想等</td>
<td>[ <code>$a != $b</code> ]</td>
</tr>
<tr>
<td>-z</td>
<td>检查字符串长度是否为0</td>
<td>[ <code>-z $a</code> ]</td>
</tr>
<tr>
<td>-n</td>
<td>检查字符串长度是否不为0</td>
<td>[ <code>-n $a</code> ]</td>
</tr>
<tr>
<td>$</td>
<td>检查字符串是否为空</td>
<td>[ <code>$a</code> ]</td>
</tr>
</tbody></table>
<p>下面是一些示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="string">&quot;hello&quot;</span></span><br><span class="line">b=<span class="string">&quot;world&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> = <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>和<span class="variable">$b</span>相同&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>和<span class="variable">$b</span>不同&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="variable">$a</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>长度为0&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>长度不为0&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -n <span class="variable">$a</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>长度不为0&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>长度为0&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>不为空&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$a</span>为空&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="文件测试运算符"><a href="#文件测试运算符" class="headerlink" title="文件测试运算符"></a>文件测试运算符</h3><p>文件测试运算符用于检测文件的各种状态。下表列出了常用的文件测试运算符。</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>-d file</td>
<td>检查文件是否是目录</td>
<td>[ <code>-d $file</code> ]</td>
</tr>
<tr>
<td>-f file</td>
<td>检查文件是否是普通文件(不是目录，也不是块设备文件)</td>
<td>[ <code>-f $file</code>]</td>
</tr>
<tr>
<td>-r file</td>
<td>检查文件是否可读</td>
<td>[ <code>-r $file</code> ]</td>
</tr>
<tr>
<td>-w file</td>
<td>检查文件是否可写</td>
<td>[ <code>-w $file</code> ]</td>
</tr>
<tr>
<td>-x file</td>
<td>检查文件是否可执行</td>
<td>[ <code>-x $file</code> ]</td>
</tr>
<tr>
<td>-s file</td>
<td>检查文件大小是否为0</td>
<td>[ <code>-s $file</code> ]</td>
</tr>
<tr>
<td>-e file</td>
<td>检查文件或文件夹是否存在</td>
<td>[ <code>-e $file</code> ]</td>
</tr>
<tr>
<td>-S</td>
<td>检查文件是否是Socket文件</td>
<td>[ <code>-S $file</code> ]</td>
</tr>
<tr>
<td>-L</td>
<td>检查文件是否存在且是一个符号链接</td>
<td>[ <code>-L $file</code> ]</td>
</tr>
</tbody></table>
<p>下面是一些示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">file=<span class="string">&quot;/etc/passwd&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="variable">$file</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$file</span>是目录&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$file</span>不是目录&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$file</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$file</span>是普通文件&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$file</span>不是普通文件&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -e <span class="variable">$file</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$file</span>存在&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$file</span>不存在&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><p>Shell的流程控制也包含判断和循环，我们一起来学习一下。</p>
<h3 id="if-x2F-else"><a href="#if-x2F-else" class="headerlink" title="if&#x2F;else"></a>if&#x2F;else</h3><p>语法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> condition</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	 语句1</span><br><span class="line">	 语句2</span><br><span class="line">	 ...</span><br><span class="line">	 语句N</span><br><span class="line"><span class="keyword">elif</span> condition2</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	 语句1</span><br><span class="line">	 语句2</span><br><span class="line">	 ...</span><br><span class="line">	 语句N</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	 语句1</span><br><span class="line">	 语句2</span><br><span class="line">	 ...</span><br><span class="line">	 语句N</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><p>elif和else分支是可以省略的</p>
</li>
<li><p>if&#x2F;fi 需要配对</p>
</li>
</ul>
</blockquote>
<p>下面是一些示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">a=1</span><br><span class="line">b=2</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$a</span> == <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;a = b&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$a</span> -gt <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;a &gt; b&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$a</span> -lt <span class="variable">$b</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;a &lt; b&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;所有条件都不匹配&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><p>语法如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> item1 item2 ... itemN</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	语句1</span><br><span class="line">	语句2</span><br><span class="line">	...</span><br><span class="line">	语句N</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>do&#x2F;done需要配对</li>
<li>in列表支持文件列表、字符串、数字和其他数组数据</li>
</ul>
</blockquote>
<p>下面是循环输出<code>/etc</code>下文件和目录的示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> `<span class="built_in">ls</span> /etc`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$dir</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="while"><a href="#while" class="headerlink" title="while"></a>while</h3><p>语法如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> condition</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	语句1</span><br><span class="line">	语句2</span><br><span class="line">	...</span><br><span class="line">	语句N</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>下面是一个示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">c=1</span><br><span class="line"><span class="keyword">while</span>(( <span class="variable">$c</span>&lt;=<span class="number">10</span> ))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$c</span></span><br><span class="line">		c=`<span class="built_in">expr</span> <span class="variable">$c</span> + 1`</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><p>语法如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> 值 <span class="keyword">in</span></span><br><span class="line">模式1)</span><br><span class="line">	语句1</span><br><span class="line">	语句2</span><br><span class="line">	...</span><br><span class="line">	语句N</span><br><span class="line">	;;</span><br><span class="line">模式2)</span><br><span class="line">	语句1</span><br><span class="line">	语句2</span><br><span class="line">	...</span><br><span class="line">	语句N</span><br><span class="line">	;;</span><br><span class="line">*)</span><br><span class="line">	语句1</span><br><span class="line">	语句2</span><br><span class="line">	...</span><br><span class="line">	语句N</span><br><span class="line">	;;</span><br><span class="line">easc</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>模式匹配之后不会再执行其他模式语句(不需要手动break)</li>
<li>case&#x2F;easc 必须配对</li>
<li>每个模式语句的末尾必须添加两个分号</li>
<li>使用*号捕获其他模式</li>
</ul>
</blockquote>
<p>如下是一个示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;输入星期几&#x27;</span></span><br><span class="line"><span class="built_in">read</span> day</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$day</span> <span class="keyword">in</span></span><br><span class="line">	1)</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;星期一&quot;</span></span><br><span class="line">		;;</span><br><span class="line">	2)</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;星期二&quot;</span></span><br><span class="line">		;;</span><br><span class="line">	...</span><br><span class="line">	*)</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;输入的数字无效&quot;</span></span><br><span class="line">		;;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>read是从标准输入读取一行赋值给指定变量</li>
</ul>
</blockquote>
<h3 id="break"><a href="#break" class="headerlink" title="break"></a>break</h3><p>break命令允许跳出循环体。下面是一个示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>=0</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> n</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="keyword">if</span> [ <span class="variable">$n</span> -gt 0 ]</span><br><span class="line">	<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">sum</span>=`<span class="built_in">expr</span> <span class="variable">$sum</span> + <span class="variable">$n</span>`</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">break</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="continue"><a href="#continue" class="headerlink" title="continue"></a>continue</h3><p>continue命令允许跳过本次循环，直接进行下一轮循环。下面是一个示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>=0</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> n</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	<span class="keyword">if</span> [ <span class="variable">$n</span> -gt 0 ]</span><br><span class="line">	<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">sum</span>=`<span class="built_in">expr</span> <span class="variable">$sum</span> + <span class="variable">$n</span>`</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">continue</span> <span class="comment"># 本次输入不合法，跳过，</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="九九乘法表"><a href="#九九乘法表" class="headerlink" title="九九乘法表"></a>九九乘法表</h2><p>结合今日所学，我们用Shell来打印一个九九乘法表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">i=1</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$i</span> -le 9 ] <span class="comment"># i &lt;= 9</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	j=1</span><br><span class="line">	<span class="keyword">while</span> [ <span class="variable">$j</span> -le 9 ] <span class="comment"># j &lt;= 9</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		<span class="keyword">if</span> [ <span class="variable">$i</span> -ge <span class="variable">$j</span> ] <span class="comment"># if($i &gt;= $j)</span></span><br><span class="line">		<span class="keyword">then</span></span><br><span class="line">			val=`<span class="built_in">expr</span> <span class="variable">$i</span> \* <span class="variable">$j</span>`</span><br><span class="line">			<span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$j</span>*<span class="variable">$i</span>=<span class="variable">$val</span> &quot;</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">		j=`<span class="built_in">expr</span> <span class="variable">$j</span> + 1` <span class="comment"># j++</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">	<span class="built_in">echo</span></span><br><span class="line">	i=`<span class="built_in">expr</span> <span class="variable">$i</span> + 1` <span class="comment"># i++</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>执行结果如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1*1=1 </span><br><span class="line">1*2=2 2*2=4 </span><br><span class="line">1*3=3 2*3=6 3*3=9 </span><br><span class="line">1*4=4 2*4=8 3*4=12 4*4=16 </span><br><span class="line">1*5=5 2*5=10 3*5=15 4*5=20 5*5=25 </span><br><span class="line">1*6=6 2*6=12 3*6=18 4*6=24 5*6=30 6*6=36 </span><br><span class="line">1*7=7 2*7=14 3*7=21 4*7=28 5*7=35 6*7=42 7*7=49 </span><br><span class="line">1*8=8 2*8=16 3*8=24 4*8=32 5*8=40 6*8=48 7*8=56 8*8=64 </span><br><span class="line">1*9=9 2*9=18 3*9=27 4*9=36 5*9=45 6*9=54 7*9=63 8*9=72 9*9=81 </span><br></pre></td></tr></table></figure>

<p>今天的内容是Shell中比较重要的，也是最常用的语法。下一篇将对Shell的输入输出进行学习。</p>
<p><img src="https://static.ddhigh.com/blog/2019-10-22-102654.jpg" alt="0.jpeg"></p>
<p>(未完待续)</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-02-10T04:00:00.000Z" title="2/10/2020, 4:00:00 AM">2020-02-10</time></span><span class="level-item"><a class="link-muted" href="/categories/devtools/">devtools</a></span><span class="level-item">10 minutes lesen (Über 1554 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/02/10/2020-02-10-shell-quickstart.html">Shell脚本快速入门(1)</a></p><div class="content"><p>Shell 是一个用 C 语言编写的程序，用户可以通过Shell脚本语言来进行程序开发。与其他脚本语言不同，Shell脚本所需的解释器一般是内置在操作系统的，而像Node.js、PHP等脚本语言需要手动安装解释器程序才可以。</p>
<p>接下来将和大家一起来学习Shell脚本编程。</p>
<h2 id="Shell解释器"><a href="#Shell解释器" class="headerlink" title="Shell解释器"></a>Shell解释器</h2><p>Shell解释器种类众多，笔者的电脑上内置以下Shell:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash</span><br><span class="line">/bin/csh</span><br><span class="line">/bin/ksh</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/tcsh</span><br><span class="line">/bin/zsh</span><br></pre></td></tr></table></figure>

<p>其中bash和sh是最常见的Shell解释器，一般情况下，这两种Shell没有区别，本文以bash为例。</p>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>打开文本编辑器(vim或者vscode)，新建文件 <strong>hello.sh</strong>，扩展名为sh(常用)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello World!&quot;</span></span><br></pre></td></tr></table></figure>

<p>第1行用来指明本脚本需要使用什么解释器来执行。<code>#!</code>是一个约定的语法。</p>
<p><code>echo</code>用来输出文本。</p>
<h2 id="执行Shell脚本"><a href="#执行Shell脚本" class="headerlink" title="执行Shell脚本"></a>执行Shell脚本</h2><p>有两种方法可以执行Shell脚本：</p>
<ol>
<li>作为可执行程序。给脚本添加可执行权限之后执行即可。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x ./hello.sh <span class="comment"># 添加可执行权限</span></span><br><span class="line">./hello.sh <span class="comment"># 执行脚本</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>作为解释器脚本。直接运行指定的解释器程序，并将脚本路径传入，本方式不要求脚本有可执行权限。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash hello.sh <span class="comment"># 使用/bin/bash来执行hello.sh</span></span><br></pre></td></tr></table></figure>

<h2 id="Shell语法"><a href="#Shell语法" class="headerlink" title="Shell语法"></a>Shell语法</h2><p>和其他编程语言一样，Shell脚本也有自己的一套语法规则，我们现在来系统学习一下。</p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><h4 id="命名规则"><a href="#命名规则" class="headerlink" title="命名规则"></a>命名规则</h4><p>定义变量时，变量名不加美元符号$，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&quot;xialei&quot;</span></span><br></pre></td></tr></table></figure>

<p>和其他编程语言不同的时，Shell脚本中<code>变量名和等号之间不能有空格</code>。Shell变量名的命名规则如下：</p>
<ul>
<li>只能包含英文字母、数字和下划线，且不能以数字开头</li>
<li>不能包含空格</li>
<li>不能使用关键字命名(通过下划线连接关键字是允许的)</li>
<li>不能使用标点符号</li>
</ul>
<p>以下是合法的示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var1</span><br><span class="line">var_2</span><br><span class="line">_var3</span><br><span class="line">MAX_PAGE</span><br></pre></td></tr></table></figure>

<p>以下是不合法的示例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$var</span></span><br></pre></td></tr></table></figure>

<h4 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h4><p>Shell有以下两种复制方式。</p>
<ol>
<li>直接赋值。直接在等号后面指定变量值。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&quot;xialei</span></span><br><span class="line"><span class="string">admin=1</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用命名执行结果。可以将其他命令的执行结果赋值给变量。（以下两种方式是等效的）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file=`<span class="built_in">ls</span> /etc` <span class="comment"># 反引号(键盘Tab上面的键)</span></span><br><span class="line">file1=$(<span class="built_in">ls</span> /etc)</span><br></pre></td></tr></table></figure>

<p>已经存在的变量，可以被重新赋值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$name</span></span><br><span class="line"></span><br><span class="line">name=<span class="string">&quot;world&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$name</span></span><br></pre></td></tr></table></figure>

<h4 id="使用变量"><a href="#使用变量" class="headerlink" title="使用变量"></a>使用变量</h4><blockquote>
<p>使用变量时在变量名前添加$符号，定义时不加。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&quot;xialei&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$name</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;name&#125;</span></span><br></pre></td></tr></table></figure>

<p>变量名两边的花括号是可选的，一般情况下不用加，但是如果涉及到边界识别问题，则需要手动添加花括号。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&quot;xialei&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;I&#x27;m <span class="variable">$&#123;name&#125;</span>studio.&quot;</span> <span class="comment"># 正确示例</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;I&#x27;m <span class="variable">$namestudio</span>.&quot;</span> <span class="comment"># 错误示例</span></span><br></pre></td></tr></table></figure>

<p>如果不添加花括号，Shell会将<code>namestudio</code>作为变量，该变量是不存在的，因此代码执行逻辑就不是我们想要的了。</p>
<h4 id="只读变量"><a href="#只读变量" class="headerlink" title="只读变量"></a>只读变量</h4><p>如果某些变量在定义后就无法更改该变量的值，可以设置使用<code>readonly</code>设置为只读变量，对只读变量赋值会跑出错误。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&quot;xialei&quot;</span></span><br><span class="line"><span class="built_in">readonly</span> name</span><br><span class="line">name=<span class="string">&quot;zhangsan&quot;</span></span><br></pre></td></tr></table></figure>

<p>上述例子执行结果如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hello.sh: line 5: name: readonly variable</span><br></pre></td></tr></table></figure>

<h4 id="释放变量"><a href="#释放变量" class="headerlink" title="释放变量"></a>释放变量</h4><p>使用<code>unset</code>可以释放变量。变量被释放后不能使用(使用不会报错,shell中使用未定义变量当做空值处理)，此外unset命令无法释放只读变量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&quot;xialei&quot;</span></span><br><span class="line"><span class="built_in">unset</span> name <span class="comment"># 不要$</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$name</span></span><br></pre></td></tr></table></figure>

<h4 id="变量类型"><a href="#变量类型" class="headerlink" title="变量类型"></a>变量类型</h4><p>Shell脚本运行时，存在以下三种变量：</p>
<ul>
<li>局部变量。在脚本中定义的变量，只对当前脚本有效</li>
<li>环境变量。所有程序都能访问到环境变量，此外Shell脚本也可以在运行时定义环境变量</li>
<li>Shell变量。Shell变量是由Shell解释器设置的变量。Shell变量中有一部分是局部变量，有一部分是环境变量。</li>
</ul>
<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><p>Shell支持数字、字符串和数组三种数据类型。下面我们分别进行学习。</p>
<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><p>字符串可以使用单引号、双引号，也可以不使用引号。</p>
<p>单引号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&#x27;xialei&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>单引号内的任何字符都会原样使用，不解析变量，也不解析转义字符。这一点和PHP有点类似</li>
</ul>
<p>双引号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&#x27;xialei&#x27;</span></span><br><span class="line">msg=<span class="string">&quot;Hello, <span class="variable">$&#123;name&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$msg</span></span><br></pre></td></tr></table></figure>

<ul>
<li>双引号内的字符串会进行变量解析和转义字符解析</li>
</ul>
<h5 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h5><p>字符串拼接有以下两种方式。</p>
<p>引号拼接(支持双引号和单引号)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&#x27;xialei&#x27;</span></span><br><span class="line">msg=<span class="string">&#x27;Hello &#x27;</span><span class="variable">$name</span><span class="string">&#x27;, welcome!&#x27;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$msg</span></span><br></pre></td></tr></table></figure>

<p>内部嵌套(只支持双引号，因为单引号不解析变量)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&#x27;xialei&#x27;</span></span><br><span class="line">msg=<span class="string">&quot;Hello <span class="variable">$&#123;name&#125;</span>, welcome!&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$msg</span></span><br></pre></td></tr></table></figure>

<h4 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h4><p>Shell只支持一维数组，不限定数组大小。</p>
<p>数组的索引由0开始，读取元素的索引可以使用整数或表达式。</p>
<h5 id="数组定义"><a href="#数组定义" class="headerlink" title="数组定义"></a>数组定义</h5><p>数组元素使用<code>小括号</code>括起来，每个元素之间用<code>空格</code>分割。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">users</span>=(xialei zhangsan lisi)</span><br></pre></td></tr></table></figure>

<h5 id="读取数组元素"><a href="#读取数组元素" class="headerlink" title="读取数组元素"></a>读取数组元素</h5><p>语法如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;数组名称[下标]&#125;</span></span><br></pre></td></tr></table></figure>

<p>比如上例中读取第2个人</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">users</span>=(xialei zhangsan lisi)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;users[1]&#125;</span> <span class="comment"># 输出zhangsan</span></span><br></pre></td></tr></table></figure>

<p>使用<code>@</code>作为下标可以获取数组的所有元素。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">users</span>=(xialei zhangsan lisi)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;users[@]&#125;</span> <span class="comment"># 输出 xialei zhangsan lisi</span></span><br></pre></td></tr></table></figure>

<h5 id="获取数组长度"><a href="#获取数组长度" class="headerlink" title="获取数组长度"></a>获取数组长度</h5><p>语法如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">length=<span class="variable">$&#123;#数组名[@]&#125;</span></span><br></pre></td></tr></table></figure>

<p>比如输出users数组的长度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">users</span>=(xialei zhangsan lisi)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;#users[@]&#125;</span></span><br></pre></td></tr></table></figure>

<p>今天的内容主要是让大家对Shell有一个宏观的认识，介绍了Shell的变量以及数据类型，下一篇将重点介绍Shell的运算符和流程控制。</p>
<p><img src="https://static.ddhigh.com/blog/2019-10-22-102654.jpg" alt="0.jpeg"></p>
<p>(未完待续)</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-02-01T04:00:00.000Z" title="2/1/2020, 4:00:00 AM">2020-02-01</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a><span> / </span><a class="link-muted" href="/categories/backend/java/">java</a></span><span class="level-item">3 minutes lesen (Über 443 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/02/01/2020-02-01-java-resource-load.html">Java中加载文件的几种方式</a></p><div class="content"><p>在Java程序中加载外部文件有多中方式，每种方式也存在区别，本文将理清这些加载方式之间的区别。</p>
<h2 id="文件IO方式"><a href="#文件IO方式" class="headerlink" title="文件IO方式"></a>文件IO方式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xialei.example.resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;app.properties&quot;</span>);</span><br><span class="line">        System.out.println(file.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>常见的读取方式，使用该方式读取文件时规则如下：</p>
<blockquote>
<p>如果传入的是绝对路径，则以系统根目录作为绝对路径的起点。</p>
<p>如果传入的是相对路径，则以当前工作目录作为起点。</p>
</blockquote>
<p>本例中，运行<code>java</code>命令的目录即为工作目录，app.properties从工作目录开始查找。</p>
<h2 id="Class-getResourceAsStream"><a href="#Class-getResourceAsStream" class="headerlink" title="Class.getResourceAsStream"></a>Class.getResourceAsStream</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xialei.example.resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Main.class.getResourceAsStream(<span class="string">&quot;app.properties&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(is);</span><br><span class="line">            System.out.println(properties.getProperty(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用该方式读取文件时规则如下：</p>
<blockquote>
<p>如果传入的是相对路径，则以当前class所在的包作为起点。</p>
<p>如果传入的是绝对路径，则以classpath的根目录为起点。</p>
</blockquote>
<ul>
<li><code>Main.class.getResourceAsStream(&quot;app.properties&quot;)</code> 会读取<code>/org/xialei/example/resource/app.properties</code>文件。</li>
<li><code>Main.class.getResourceAsStream(&quot;/app.properties&quot;)</code>会读取”classpath:&#x2F;app.properties”文件</li>
</ul>
<h2 id="ClassLoader-getResourceAsStream"><a href="#ClassLoader-getResourceAsStream" class="headerlink" title="ClassLoader.getResourceAsStream"></a>ClassLoader.getResourceAsStream</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.xialei.example.resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> Main.class.getClassLoader().getResourceAsStream(<span class="string">&quot;org/xialei/example/resource/app.properties&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            properties.load(is);</span><br><span class="line">            System.out.println(properties.getProperty(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用该方式时规则如下:</p>
<blockquote>
<p>使用classpath根目录作为起点。</p>
</blockquote>
<p>本例中，<code>org/xialei/example/resource/app.properties</code>就是从classpath根目录进行查找的。</p>
<p><img src="https://static.ddhigh.com/blog/2019-10-22-102654.jpg" alt="0.jpeg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Gepostet vor&nbsp;<time dateTime="2020-01-17T04:00:00.000Z" title="1/17/2020, 4:00:00 AM">2020-01-17</time></span><span class="level-item"><a class="link-muted" href="/categories/backend/">backend</a></span><span class="level-item">14 minutes lesen (Über 2080 Wörter)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/01/17/2020-01-17-php-binary-io.html">kafka二进制协议简要分析</a></p><div class="content"><p>最近分享了《应用层私有协议的设计和实战》，对应用层私有协议设计做了一些介绍，同时也对协议设计中常用的数据类型做了比较形象的讲解，今天我们来研究一下kafka的二进制协议。</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>kafka二进制协议定义了许多的数据类型，包含常用的数字、字符串，也包含了数组等类型。</p>
<p>本文主要讨论不可变长数据类型，可变长度（如Google Protocol Buffers）不在讨论范围内。</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>字节长度</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>BOOLEAN</td>
<td>1</td>
<td>布尔值</td>
</tr>
<tr>
<td>INT8</td>
<td>1</td>
<td>单字节整型，-2^7 ~ 2^7-1</td>
</tr>
<tr>
<td>INT16</td>
<td>2</td>
<td>双字节整型，大端序，范围 -2^15 ~ 2^15 - 1</td>
</tr>
<tr>
<td>INT32</td>
<td>4</td>
<td>四字节整型、大端序，范围 -2^31 ~ 2^31 - 1</td>
</tr>
<tr>
<td>INT64</td>
<td>8</td>
<td>八字节整型、大端序，范围 -2^63 ~ 2^63 -1</td>
</tr>
<tr>
<td>UINT32</td>
<td>4</td>
<td>十字街</td>
</tr>
<tr>
<td>UUID</td>
<td>16</td>
<td>16字节，Java UUID类型</td>
</tr>
<tr>
<td>STRING</td>
<td>2+N</td>
<td>头部由2字节标识字符串长度N，后续N字节为字符串内容</td>
</tr>
<tr>
<td>NULLABLE_STRING</td>
<td>2+N</td>
<td>头部由2字节标识字符串长度N，后续N字节为字符串内容，N为-1时无后续内容</td>
</tr>
<tr>
<td>BYTES</td>
<td>4+N</td>
<td>头部4字节标识字节数组长度，后续N字节为字节数组内容</td>
</tr>
<tr>
<td>NULLABLE_BYTES</td>
<td>4+N</td>
<td>头部4字节标识字节数组长度，后续N字节为字节数组内容，N为-1时无后续内容</td>
</tr>
<tr>
<td>ARRAY</td>
<td>4+N*M</td>
<td>头部4字节标识数组长度N，M为单个数组元素的长度，N为-1时为空数组</td>
</tr>
</tbody></table>
<h2 id="错误码"><a href="#错误码" class="headerlink" title="错误码"></a>错误码</h2><ul>
<li>-1 未知错误</li>
<li>0 未出错</li>
<li>大于0， 具体错误</li>
</ul>
<p>kafka内置的操作类型有点多，有兴趣的可以参阅<a target="_blank" rel="noopener" href="https://kafka.apache.org/protocol#protocol_error_codes">kafka错误码</a></p>
<h2 id="Api-Keys"><a href="#Api-Keys" class="headerlink" title="Api Keys"></a>Api Keys</h2><p>可以理解为操作码，服务端根据该字段区分当前请求操作。</p>
<p>这里不做展开，有兴趣的可以参阅<a target="_blank" rel="noopener" href="https://kafka.apache.org/protocol#protocol_api_keys">kafka Api Keys</a></p>
<h2 id="报文结构"><a href="#报文结构" class="headerlink" title="报文结构"></a>报文结构</h2><p>接下来我们重点分析一下kafka的报文结构。</p>
<blockquote>
<p>本文基于kafka V1版本协议写作，其他版本的研究原理时一致的。</p>
</blockquote>
<h3 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h3><p>kafka的协议结构比较简单，请求和响应使用同样的整体结构。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RequestOrResponse =&gt; Size (RequestMessage | ResponseMessage)</span><br><span class="line">  Size =&gt; int32</span><br></pre></td></tr></table></figure>

<p>我们转化为表格来看看</p>
<p><img src="https://static.ddhigh.com/blog/2020-01-17-093002.png" alt="image-20200117172959642"></p>
<ul>
<li>Size为INT32类型，正文长度</li>
<li>Message 为请求或响应正文的内容，变长字段，长度由Size给出</li>
</ul>
<h3 id="请求格式"><a href="#请求格式" class="headerlink" title="请求格式"></a>请求格式</h3><p>请求数据包有固定的请求包头，我们来看看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Request Header v1 =&gt; request_api_key request_api_version correlation_id client_id </span><br><span class="line">  request_api_key =&gt; INT16</span><br><span class="line">  request_api_version =&gt; INT16</span><br><span class="line">  correlation_id =&gt; INT32</span><br><span class="line">  client_id =&gt; NULLABLE_STRING</span><br></pre></td></tr></table></figure>

<p>上面给出的是请求头的内容，结合整体结构得出的协议表格如下：</p>
<p><img src="https://static.ddhigh.com/blog/2020-01-17-093119.png" alt="image-20200117173117965"></p>
<ul>
<li>Size 4字节正文长度（包含请求头）</li>
<li>request_api_key 2字节 api key，用来区分操作</li>
<li>request_api_version 2字节api 版本号</li>
<li>correlation_id 4字节请求ID，服务端会原样响应该请求ID</li>
<li>client_id 可空字符串，根据kafka数据类型定义，需要2字节client_id length字段标识client_id长度，如果client_id length为-1，则不需要传具体的client_id，否则需要传递client_id</li>
<li>request message* 请求正文，不同的api key请求正文不同</li>
</ul>
<h3 id="响应格式"><a href="#响应格式" class="headerlink" title="响应格式"></a>响应格式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Response Header v1 =&gt; correlation_id TAG_BUFFER </span><br><span class="line">  correlation_id =&gt; INT32</span><br></pre></td></tr></table></figure>

<p>响应头的结构比较简单，返回了请求ID</p>
<p><img src="https://static.ddhigh.com/blog/2020-01-17-093701.png" alt="image-20200117173658934"></p>
<ul>
<li>Size 4字节响应正文长度（包含请求ID）</li>
<li>correlation_id 4字节请求ID</li>
<li>response message* 响应正文</li>
</ul>
<h3 id="Metadata-示例"><a href="#Metadata-示例" class="headerlink" title="Metadata 示例"></a>Metadata 示例</h3><h4 id="请求数据"><a href="#请求数据" class="headerlink" title="请求数据"></a>请求数据</h4><p>Kafka Metadata对应的协议格式如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Metadata Request (Version: 1) =&gt; [topics] </span><br><span class="line">  topics =&gt; name </span><br><span class="line">    name =&gt; STRING</span><br></pre></td></tr></table></figure>

<p>我们转化为表格看看</p>
<p><img src="https://static.ddhigh.com/blog/2020-01-17-093858.png" alt="image-20200117173855988"></p>
<ul>
<li>Size 4字节请求正文长度</li>
<li>Request_api_key，根据协议文档， 此处为3</li>
<li>Request_api_version，本文基于v1版本写作，因此版本号为1</li>
<li>correlation_id 请求ID</li>
<li>client_id length 2字节客户端长度，我们使用test作为客户端标识，此处传入4</li>
<li>client_id 客户端名称，传入test字符串</li>
<li>topic name length 需要查询的topic数组，我们查询test1这个topic，此处传入1</li>
<li>topic name 字符串类型，因此先写入字符串长度5(test1字符串长度为5)，再写入test1字符串（总共写入2+5 &#x3D; 7个字节）</li>
</ul>
<h4 id="响应数据"><a href="#响应数据" class="headerlink" title="响应数据"></a>响应数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Metadata Response (Version: 1) =&gt; [brokers] controller_id [topics] </span><br><span class="line">  brokers =&gt; node_id host port rack </span><br><span class="line">    node_id =&gt; INT32</span><br><span class="line">    host =&gt; STRING</span><br><span class="line">    port =&gt; INT32</span><br><span class="line">    rack =&gt; NULLABLE_STRING</span><br><span class="line">  controller_id =&gt; INT32</span><br><span class="line">  topics =&gt; error_code name is_internal [partitions] </span><br><span class="line">    error_code =&gt; INT16</span><br><span class="line">    name =&gt; STRING</span><br><span class="line">    is_internal =&gt; BOOLEAN</span><br><span class="line">    partitions =&gt; error_code partition_index leader_id [replica_nodes] [isr_nodes] </span><br><span class="line">      error_code =&gt; INT16</span><br><span class="line">      partition_index =&gt; INT32</span><br><span class="line">      leader_id =&gt; INT32</span><br><span class="line">      replica_nodes =&gt; INT32</span><br><span class="line">      isr_nodes =&gt; INT32</span><br></pre></td></tr></table></figure>

<p><img src="https://static.ddhigh.com/blog/2020-01-17-094212.png" alt="image-20200117174211271"></p>
<ul>
<li>Size 4字节响应长度</li>
<li>Correlation_id 4字节请求ID</li>
<li>Broker Count，数组类型，4字节整型标识数组长度<ul>
<li>node_id 4字节整型，broker的节点ID</li>
<li>host 字符串类型，主机名称</li>
<li>port 4字节整型，端口号</li>
<li>rack 可空字符串，如果broker是rack，则需要2+N字节，否则只需要2字节</li>
</ul>
</li>
<li>Controller_id 4字节整型</li>
<li>Topics 数组类型，topic数组<ul>
<li>error_code 2字节整型，错误码</li>
<li>name 字符串类型，topic名称</li>
<li>is_internal 布尔类型，是否内部topic</li>
<li>partions 数组类型，topic所在partition<ul>
<li>error_code 2字节整型，错误码</li>
<li>partition_index 4字节整型，partition index</li>
<li>leader_id 4字节整型，leader id</li>
<li>Replica_nodes 数组类型<ul>
<li>Replica_node 4字节整型</li>
</ul>
</li>
<li>isr_nodes 数组类型<ul>
<li>Isr_node 4字节整型</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>其他类型的请求也可以使用同样的方式去分析</p>
</blockquote>
<h2 id="PHP客户端实现"><a href="#PHP客户端实现" class="headerlink" title="PHP客户端实现"></a>PHP客户端实现</h2><p>PHP自带了pack&#x2F;unpack函数帮助我们操作二进制数据，不过pack&#x2F;unpack易用性比较低。</p>
<blockquote>
<p>对于二进制数据，java有byte[]，golang有[]byte，PHP没有专门的类型，而是使用字符串存储的，不过PHP字符串是二进制安全的。</p>
</blockquote>
<p>针对pack&#x2F;unpack函数易用性问题，这两天参考Java的IO系统开发了一个简单版本的io库来简化二进制数据流的操作（文末有仓库地址）。</p>
<p>接下来使用该库来编写一个kafka的客户端。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取kafka broker列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">BinaryStringInputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">BinaryStringOutputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">DataInputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">DataOutputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">FileInputStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">io</span>\<span class="title">FileOutputStream</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$client</span> = <span class="title function_ invoke__">stream_socket_client</span>(<span class="string">&#x27;tcp://127.0.0.1:9092&#x27;</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$errno</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$errstr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$binaryOutputStream</span> = <span class="keyword">new</span> <span class="title class_">BinaryStringOutputStream</span>();</span><br><span class="line"><span class="variable">$binaryPacketOutput</span> = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(<span class="variable">$binaryOutputStream</span>);</span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedShortBE</span>(<span class="number">0x03</span>); <span class="comment">// METADATA_REQUEST</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedShortBE</span>(<span class="number">1</span>); <span class="comment">// API_VERSION</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedIntBE</span>(<span class="number">0x01</span>); <span class="comment">// 请求ID</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedShortBE</span>(<span class="title function_ invoke__">strlen</span>(<span class="string">&#x27;test&#x27;</span>)); <span class="comment">// 客户端标识长度</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeString</span>(<span class="string">&#x27;test&#x27;</span>); <span class="comment">// 客户端标识</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedIntBE</span>(<span class="number">1</span>); <span class="comment">// topic列表数组长度</span></span><br><span class="line"><span class="comment">// topic数组元素</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeUnSignedShortBE</span>(<span class="title function_ invoke__">strlen</span>(<span class="string">&#x27;test1&#x27;</span>)); <span class="comment">// 写入2字节topic名称长度</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">writeString</span>(<span class="string">&#x27;test1&#x27;</span>); <span class="comment">// topic名称</span></span><br><span class="line"><span class="variable">$binaryPacketOutput</span>-&gt;<span class="title function_ invoke__">flush</span>(); <span class="comment">// 输出缓冲</span></span><br><span class="line"><span class="variable">$packet</span> = <span class="variable">$binaryOutputStream</span>-&gt;<span class="title function_ invoke__">toBinaryString</span>(); <span class="comment">// 获得构造好的正文数据包</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 包装socket链接，获得多数据类型操作能力</span></span><br><span class="line"><span class="variable">$out</span> = <span class="keyword">new</span> <span class="title class_">DataOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="variable">$client</span>));</span><br><span class="line"><span class="variable">$out</span>-&gt;<span class="title function_ invoke__">writeUnSignedIntBE</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$packet</span>)); <span class="comment">// 4字节包长度</span></span><br><span class="line"><span class="variable">$out</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$packet</span>); <span class="comment">// 包体</span></span><br><span class="line"><span class="variable">$out</span>-&gt;<span class="title function_ invoke__">flush</span>(); <span class="comment">// 输出到Socket</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化输入流，从socket读取数据</span></span><br><span class="line"><span class="variable">$in</span> = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="variable">$client</span>));</span><br><span class="line"><span class="variable">$size</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// 4字节包长度</span></span><br><span class="line"><span class="comment">// 一次性读取完socket数据后关闭，然后将读取到的响应数据填充到二进制字符串输入流中，释放socket</span></span><br><span class="line"><span class="variable">$in</span> = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="keyword">new</span> <span class="title class_">BinaryStringInputStream</span>(<span class="title function_ invoke__">fread</span>(<span class="variable">$client</span>, <span class="variable">$size</span>)));</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$client</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$requestId</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// 4字节请求ID</span></span><br><span class="line"><span class="title function_ invoke__">printf</span>(<span class="string">&quot;packet length: %d requestId: %d\n&quot;</span>, <span class="variable">$size</span>, <span class="variable">$requestId</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$brokerCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// broker数量</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$brokerCount</span>; <span class="variable">$i</span>++) &#123; <span class="comment">// 循环读取broker</span></span><br><span class="line">    <span class="variable">$nodeId</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// nodeId</span></span><br><span class="line">    <span class="variable">$hostLength</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedShortBE</span>(); <span class="comment">// host长度</span></span><br><span class="line">    <span class="variable">$host</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readString</span>(<span class="variable">$hostLength</span>); <span class="comment">// 主机名</span></span><br><span class="line">    <span class="variable">$port</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>(); <span class="comment">// port</span></span><br><span class="line">    <span class="variable">$rackLength</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readShortBE</span>(); <span class="comment">// rack</span></span><br><span class="line">    <span class="variable">$rack</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$rackLength</span> != -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable">$rack</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readString</span>(<span class="variable">$rackLength</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">printf</span>(<span class="string">&quot;nodeId:%d host:%s port:%d rack: %s\n&quot;</span>, <span class="variable">$nodeId</span>, <span class="variable">$host</span>, <span class="variable">$port</span>, <span class="variable">$rack</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$controllerId</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line"><span class="title function_ invoke__">printf</span>(<span class="string">&quot;controllerId: %d\n&quot;</span>, <span class="variable">$controllerId</span>);</span><br><span class="line"><span class="variable">$topicCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line"><span class="title function_ invoke__">printf</span>(<span class="string">&quot;topic count %d\n&quot;</span>, <span class="variable">$topicCount</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$topicCount</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">    <span class="title function_ invoke__">printf</span>(<span class="string">&quot;----topic list----\n&quot;</span>);</span><br><span class="line">    <span class="variable">$errCode</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedShortBE</span>();</span><br><span class="line">    <span class="variable">$nameLength</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedShortBE</span>();</span><br><span class="line">    <span class="variable">$name</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readString</span>(<span class="variable">$nameLength</span>);</span><br><span class="line">    <span class="variable">$isInternal</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedChar</span>();</span><br><span class="line">    <span class="title function_ invoke__">printf</span>(<span class="string">&quot;errcode: %d name: %s interval: %d\n&quot;</span>, <span class="variable">$errCode</span>, <span class="variable">$name</span>, <span class="variable">$isInternal</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$partitionCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">    <span class="title function_ invoke__">printf</span>(<span class="string">&quot;----topic [%s] partition list count %d---\n&quot;</span>, <span class="variable">$name</span>, <span class="variable">$partitionCount</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$j</span> = <span class="number">0</span>; <span class="variable">$j</span> &lt; <span class="variable">$partitionCount</span>; <span class="variable">$j</span>++) &#123;</span><br><span class="line">        <span class="variable">$errCode</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedShortBE</span>();</span><br><span class="line">        <span class="variable">$partitionIndex</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        <span class="variable">$leaderId</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        <span class="variable">$replicaNodesCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        <span class="variable">$replicaNodes</span> = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$k</span> = <span class="number">0</span>; <span class="variable">$k</span> &lt; <span class="variable">$replicaNodesCount</span>; <span class="variable">$k</span>++) &#123;</span><br><span class="line">            <span class="variable">$replicaNodes</span>[] = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$isrNodeCount</span> = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        <span class="variable">$isrNodes</span> = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$k</span> = <span class="number">0</span>; <span class="variable">$k</span> &lt; <span class="variable">$isrNodeCount</span>; <span class="variable">$k</span>++) &#123;</span><br><span class="line">            <span class="variable">$isrNodes</span>[] = <span class="variable">$in</span>-&gt;<span class="title function_ invoke__">readUnSignedIntBE</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">printf</span>(</span><br><span class="line">            <span class="string">&quot;errcode: %d partitionIndex: %d leaderId: %d replicaNodes: [%s] isrNodes: [%s]\n&quot;</span>,</span><br><span class="line">            <span class="variable">$errCode</span>,</span><br><span class="line">            <span class="variable">$partitionIndex</span>,</span><br><span class="line">            <span class="variable">$leaderId</span>,</span><br><span class="line">            <span class="title function_ invoke__">join</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$replicaNodes</span>),</span><br><span class="line">            <span class="title function_ invoke__">join</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$isrNodes</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">packet length: 73 requestId: 1</span><br><span class="line">nodeId:0 host:bogon port:9092 rack: </span><br><span class="line">controllerId: 0</span><br><span class="line">topic count 1</span><br><span class="line">----topic list----</span><br><span class="line">errcode: 0 name: test1 interval: 0</span><br><span class="line">----topic [test1] partition list count 1---</span><br><span class="line">errcode: 0 partitionIndex: 0 leaderId: 0 replicaNodes: [0] isrNodes: [0]</span><br></pre></td></tr></table></figure>

<h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p> <a target="_blank" rel="noopener" href="https://github.com/xialeistudio/php-io">php-io</a></p>
<p>(完)</p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/7/">Zurück</a></div><div class="pagination-next"><a href="/page/9/">Weiter</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/7/">7</a></li><li><a class="pagination-link is-current" href="/page/8/">8</a></li><li><a class="pagination-link" href="/page/9/">9</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/31/">31</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://static.ddhigh.com/blog/2019-09-18-094336.jpg" alt="XiaLei"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">XiaLei</p><p class="is-size-6 is-block">Senior Software Engineer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Tencent</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Seiten</p><a href="/archives"><p class="title">306</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Kategorien</p><a href="/categories"><p class="title">25</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">38</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/xialeistudio"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="LinkedIn" href="https://www.linkedin.com/in/xialeidoc/"><i class="fa-brands fa-linkedin"></i></a></div></div></div><!--!--></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Learning &amp; Sharing</a><p class="is-size-7"><span>&copy; 2023 Xia Lei</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en-us");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><a id="back-to-top" title="Zurück nach oben" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "Diese Website verwendet Cookies, um Ihre Erfahrung zu verbessern.",
          dismiss: "Verstanden!",
          allow: "Cookies zulassen",
          deny: "Ablehnen",
          link: "Mehr erfahren",
          policy: "Cookie-Richtlinie",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Tippen Sie etwas..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Tippen Sie etwas...","untitled":"(Ohne Titel)","posts":"Seiten","pages":"Pages","categories":"Kategorien","tags":"Tags"});
        });</script></body></html>