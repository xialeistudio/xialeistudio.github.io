<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.123.8"><meta name=viewport content="width=device-width,initial-scale=1"><title>Lei Xia</title>
<meta charset=utf-8><meta name=description content="Ladder@Learning & Writing & Sharing"><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com//index.xml title="Lei Xia"><script async defer data-website-id=865c8529-0729-4cf5-88a9-448616abbcbb src=https://umami-beta-peach.vercel.app/xialeistudio></script><meta property="og:title" content="Lei Xia"><meta property="og:description" content="Learning & Writing & Sharing"><meta property="og:type" content="website"><meta property="og:url" content="https://www.ddhigh.com/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lei Xia"><meta name=twitter:description content="Learning & Writing & Sharing"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"Lei Xia","url":"https://www.ddhigh.com/","description":"Learning \u0026amp; Writing \u0026amp; Sharing","thumbnailUrl":"https://www.ddhigh.com/favicon.ico","sameAs":[]}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.4e70a7c9d7285fdcae5fdaeeddd5999441d33a8b2c4f360cdbff862671a3c49c.css integrity="sha256-TnCnydcoX9yuX9ru3dWZlEHTOossTzYM2/+GJnGjxJw=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>HOME
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>Archive</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/tags>Tags</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>Books</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>Guestbook</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li></ul></section></nav><div id=content><div class=home><div class=info><div class=intro><h1>Lei Xia</h1><small>Sr. Software Engineer | Solution Architect</small><p><p>Writing code, Enjoying life, Building future</p><p><a href=/atom.xml target=_blank rel=noopener>RSS</a> ·
<a href=/sponsors target=_blank rel=noopener>Sponsor</a></p></p></div></div></div><div class=blog-wrapper><div><div class=blog-list><article><div class=blog-card><h3><a href=/2018/03/01/golang-json-no-escape-html/>golang JSON编码时保留HTML标签</a></h3><p><small>March 1, 2018&nbsp;· 41 words&nbsp;· One minute</small><p>golang默认编码JSON时会将HTML标签中的尖括号编码为\u003c这种unicode字符。而最近在开发的微信客服消息推送就会出现以下结果
\u003ca href='https://www.example.com'\u003e点击进入\u003c/a\u003e 查看golang的json包发现json编码器有个方法SetEscapeHTML方法，接收一个bool值来设置是否保留HTML标签。
问题 json的Encoder只能编码到实现了io.Writer接口的对象中去，而本例中需要编码到一个[]byte切片中。
解决 查找资料发现bytes.Buffer对象实现了io.Writer接口。所以最终代码如下：
func BuildJson(data map[string]interface{}) ([]byte, error) { buf := bytes.NewBufferString("") encoder := json.NewEncoder(buf) encoder.SetEscapeHTML(false) if err := encoder.Encode(&amp;data); err != nil { return nil, err } else { return buf.Bytes(), nil } } 经过测试，输出接口符合要求。</div></article><article><div class=blog-card><h3><a href=/2018/02/28/golang-export-csv/>golang使用CSV导出大量数据</a></h3><p><small>February 28, 2018&nbsp;· 86 words&nbsp;· One minute</small><p>最近在做一个导出功能，最初是使用https://github.com/tealeg/xlsx做的，但是发现导出有个30W行的excel时，这玩意内存彪到700M+，后来发现只是导出数据为表格，并没有其他东西，于是打算使用CSV导出。
CSV格式简介 CSV本质上是个文本文件，该文件有以下要求：
列之间用逗号分隔，行之间用换行分隔 单元格如果有逗号，引号之类的字符，该单元格需要使用双引号括起来 如果包含中文，需要使用GBK编码，否则会乱码 golang实现 UTF8转GBK函数(需要 go get golang.org/x/text/)
func UTF82GBK(src string) (string, error) { reader := transform.NewReader(strings.NewReader(src), simplifiedchinese.GBK.NewEncoder()) if buf, err := ioutil.ReadAll(reader); err != nil { return "", err } else { return string(buf), nil } } 导出代码
filename := "test.csv" fp, err := os.Create(filename) // 创建文件句柄 if err != nil { return nil, err } defer fp.Close() columns := []string{"姓名", "电话", "公司", "职位", "加入时间"} if line, err := util.</div></article><article><div class=blog-card><h3><a href=/2018/02/08/nodejs-thrift-multiple-client/>nodejs thrift多路复用客户端</a></h3><p><small>February 8, 2018&nbsp;· 103 words&nbsp;· One minute</small><p>官网nodejs示例中只实现了服务端是单一service的情形，而对于服务端属于多个服务复用一个连接地址的例子却未实现。
查看thrift的nodejs库源码发现实际上还是支持的。以下来展示调用单一服务和多个服务的区别。
单一服务 var thrift = require('thrift'); var Calculator = require('./gen-nodejs/Calculator'); var ttypes = require('./gen-nodejs/tutorial_types'); const assert = require('assert'); var transport = thrift.TBufferedTransport; var protocol = thrift.TBinaryProtocol; var connection = thrift.createConnection("localhost", 9090, { transport : transport, protocol : protocol }); var client = thrift.createClient(Calculator, connection); // 已经可以调用client方法 复用服务 var thrift = require('thrift'); var Calculator = require('./gen-nodejs/Calculator'); var ttypes = require('./gen-nodejs/tutorial_types'); const assert = require('assert'); var transport = thrift.TBufferedTransport; var protocol = thrift.</div></article><article><div class=blog-card><h3><a href=/2018/02/01/golang-generic-pool/>golang通用连接池的实现</a></h3><p><small>February 1, 2018&nbsp;· 321 words&nbsp;· 2 min</small><p>golang的channel除了goroutine通信之外还有很多其他的功能，本文将实现一种基于channel的通用连接池。
何为通用？ 连接池的实现不依赖具体的实例，而依赖某个接口，本文的连接池选用的是io.Closer接口，只要是实现了该接口的对象都可以被池管理。 当然，你可以实现基于interface{}的连接池，这样任何对象都可以被管理。
实现原理 将连接句柄存入channel中，由于缓存channel的特性，获取连接时如果池中有连接，将直接返回，如果池中没有连接，将阻塞或者新建连接（没超过最大限制的情况下）。 由于面向接口编程，所有创建连接的逻辑是不清楚的，这里需要传入一个函数，该函数返回一个io.Closer对象。
实现 由于并发问题，在需要操作池中互斥数据的时候需要加锁。
package pool import ( "errors" "io" "sync" "time" ) var ( ErrInvalidConfig = errors.New("invalid pool config") ErrPoolClosed = errors.New("pool closed") ) type factory func() (io.Closer, error) type Pool interface { Acquire() (io.Closer, error) // 获取资源 Release(io.Closer) error // 释放资源 Close(io.Closer) error // 关闭资源 Shutdown() error // 关闭池 } type GenericPool struct { sync.Mutex pool chan io.Closer maxOpen int // 池中最大资源数 numOpen int // 当前池中资源数 minOpen int // 池中最少资源数 closed bool // 池是否已关闭 maxLifetime time.</div></article><article><div class=blog-card><h3><a href=/2018/01/31/goroutine-limit-demo/>golang限制协程数量</a></h3><p><small>January 31, 2018&nbsp;· 113 words&nbsp;· One minute</small><p>为什么要限制协程数量 golang的go关键字并发实在是太简单，但是带来的问题是由于硬件和网络状况的限制，不受控制的增加协程是非常危险的做法，甚至有可能搞垮数据库之类的应用! 而并发控制在go中是非常常用的技巧，以此文来记录一下学习历程。
原理 由于channel的阻塞机制，通过设置缓冲channel的缓冲大小来控制同时执行的协程数量。
demo代码 package main import ( "log" "time" ) func main() { start := time.Now() ch := make(chan int, 2) for i := 0; i &lt;= 10; i++ { ch &lt;- 1 go worker(i, ch) } close(ch) log.Println("complete", time.Since(start).Seconds()) } // 模拟耗时操作 func worker(i int, ch chan int) { log.Println("worker", i) time.Sleep(time.Second) &lt;-ch 运行 go run demo.ho 输出 2018/01/31 22:24:49 worker 1 2018/01/31 22:24:49 worker 0 2018/01/31 22:24:50 worker 2 2018/01/31 22:24:50 worker 3 2018/01/31 22:24:51 worker 4 2018/01/31 22:24:51 worker 5 2018/01/31 22:24:52 worker 6 2018/01/31 22:24:52 worker 7 2018/01/31 22:24:53 worker 8 2018/01/31 22:24:53 worker 9 2018/01/31 22:24:54 worker 10 2018/01/31 22:24:54 complete 5.</div></article><article><div class=blog-card><h3><a href=/2018/01/30/tnwz/>头脑王者辅助</a></h3><p><small>January 30, 2018&nbsp;· 67 words&nbsp;· One minute</small><p>头脑王者 本项目仅作为学习anyproxy之用，请勿用于非法用途，否则后果自负
功能 题目爬取 答题匹配(如果题库不存在，请自行答题，系统会在答题后把正确答案自动录入数据库) 开始 安装mysql，新建数据库tnwz，建表语句 CREATE TABLE tnwz.question ( id int(11) PRIMARY KEY NOT NULL AUTO_INCREMENT, question varchar(100), a varchar(20), b varchar(20), c varchar(20), d varchar(20), answer int(11), createdAt datetime NOT NULL, updatedAt datetime NOT NULL ); config.json为数据库配置 安装anyproxy => npm install anyproxy -g 生成证书anyproxy -i 手机接入代理，代理地址电脑IP:8001 题库获取 登录两个微信号获取到uid和token之后填入auth.json node question-fetcher.js,如果出现401，请重新登录 排位系统 npm run fight开启代理 手机接入代理 开始排位，终端会提示开始匹配，系统会将正确答案添加上### 适用系统 Android && iOS iOS11.3 已通过测试 项目地址 https://github.com/xialeistudio/tnwz</div></article><article><div class=blog-card><h3><a href=/2018/01/20/golang-memory-leak/>golang可能导致内存泄漏的地方</a></h3><p><small>January 20, 2018&nbsp;· 8 words&nbsp;· One minute</small><p>核心 golang能够GC是程序声明的变量，而一些外部资源是不可以GC掉的，比如os.OpenFile打开的文件句柄，sql.Open打开的数据库连接句柄等资源。
开发中常用场景 http请求时resp.Body，刚开始写golang的时候，如果会用ioutil.readAll去读取resp.Body时会加上defer resp.Body.Close(),后来有json.NewDecoder().decode()时没有加，以为会自动关闭，没想到还是太天真了。不管什么情况都需要defer resp.Body.Close()
sql查询时DB.Prepare，数据库查询操作会得到一个rows的资源，这个一般都关闭了，但是运行一段时间之后发现有内存泄漏，因为只用到了sql查询，所以只有数据库操作代码可以排查，尽快调试发现stmt也有Close方法，加上defer stmt.Close之后，内存稳定了。</div></article><article><div class=blog-card><h3><a href=/2018/01/20/php-async/>PHP实现“异步”</a></h3><p><small>January 20, 2018&nbsp;· 13 words&nbsp;· One minute</small><p>众所周知，PHP不使用多线程扩展的情况下是不支持异步的(不算curl之类)。今天无意中看到一个函数fastcgi_finish_request; 这个方法是PHP5.3+开始提供。 注释写的很清楚，有耗时操作的时候使用该函数可以尽早结束fastcgi处理过程，提高页面响应速度。
代码说明 &lt;?php echo 1; fastcgi_finish_request(); sleep(3); ?> 此时打开浏览器发现响应速度并没有受到sleep函数的影响，基于此点，可以在适当的时候使用该函数以提升用户体验!
注意事项 PHP需要运行在fpm模式下才可以使用本函数。</div></article><article><div class=blog-card><h3><a href=/2017/11/25/wechat-web-subscribe/>微信H5点击跳转到关注页</a></h3><p><small>November 25, 2017&nbsp;· 26 words&nbsp;· One minute</small><p>背景 微信诱导关注接口在早两年已经被微信关停，但是一般的H5目的都是要关注公众号。 目前用的多的方法是用公众号发表一篇文章，文章里面一般是一个GIF的箭头图片指向公众号关注。 这种方法有点取巧。
今天要介绍的是另一种方法，感觉应该不会被微信封号。
起因 有个朋友在segmentfault上发了一个链接出来，微信打开可以直接到关注页
https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzUzMDM3MjMyNQ==#wechat_redirect 条件反射发现MzUzMDM3MjMyNQ==是Base64编码后的参数，解码后是一段数字，然后我改了下数字，重新编码，再发送到微信，发现可以打开另外一个公众号的关注页
https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MzUzMDM3MjMyNA==#wechat_redirect 所以只要知道那个公众号数字就可以构造链接进行关注，想着这种ID一般在公众平台有，果然被我找到了。
步骤 登录公众平台后台 点击右上角的公众号，来到公众号信息页面 查看公众号信息页面的源代码，在顶上找到以下代码 window.wx={ uin:"xxxx"||"0" }; xxxx 就是你的公众号数字ID 将第4步找到的ID进行base64编码 构造如下链接 https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=第5步的结果#wechat_redirect 发送到微信之后即可。 反思 从打开的链接看页面还是蛮正式的，可能不是私有接口，但是微信文档中没说过这种方式，故使用本方式带来的后果请自行负责！</div></article><article><div class=blog-card><h3><a href=/2017/11/23/go-rtmp-http-publisher/>从零开始打造自己的直播服务器-golang开发HTTP推流服务</a></h3><p><small>November 23, 2017&nbsp;· 450 words&nbsp;· 3 min</small><p>目前笔者只知道ffmpeg命令行推流到RTMP服务器，是没有HTTP接口的，像iOS和Android这种Native应用应该有RTMP SDK封装推流逻辑。但是像微信小程序这种录制音频只有原始ArrayBuffer的数据，则必须在服务端提供接口来进行推流。
本文将基于golang标准库以及ffmpeg命令来实现。
服务端原理 客户端上传base64编码后的音频数据 服务端接收后解码为**[]byte** 将**[]byte**写入本地文件 golang调用ffmpeg命令将第3步写入的文件推流到RTMP服务端 golang输出JSON响应，如果出错则返回错误JSON响应 { "errmsg":"ok", "errcode":0 } 开始开发 由于采用了log4go日志库https://github.com/alecthomas/log4go，故需要先安装
go get github.com/alecthomas/log4go 完整服务端源代码：
package main import ( "github.com/alecthomas/log4go" "flag" "net/http" "time" "encoding/json" "io/ioutil" "encoding/base64" "os" "os/exec" "strings" ) var ( rtmp string // rtmp 服务端地址 ffmpeg string // ffmpeg命令地址 listen string // 监听地址 uploadKey string // 上传key uploadDirectory string // 本地上传目录 start = time.Now() ) const ( VERSION = "1.0.0" ) func init() { flag.</div></article></div><div class=paginator><a class=prev href=/page/14/>&larr;&nbsp;&nbsp;Pre Page</a>
<a class=next href=/page/16/>Next Page&nbsp;&nbsp;&rarr;</a></div></div></div></div><footer class=footer><p>&copy; 2014 - 2024 <a href=https://www.ddhigh.com/>Lei Xia</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
<a href=https://umami-beta-peach.vercel.app/ target=_blank>Statistics</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>