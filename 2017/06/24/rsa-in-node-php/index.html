<!doctype html><html lang=zh><head><meta name=viewport content="width=device-width,initial-scale=1"><title>使用RSA在PHP和NodeJs中进行加密数据通信</title>
<meta charset=utf-8><meta name=google-adsense-account content="ca-pub-2871082647721658"><meta content="Web开发 ,Java ,Go ,Node.js ,PHP ,Koa ,MySQL ,Redis ,前端 ,后端 ,数据库" name=keywords><meta name=description content="RSA算法是目前用的最多的非对称加密算法，文本将基于openssl在nodejs和php中进行加密数据通信。
生成密钥对 openssl genrsa -out private."><meta name=author content="Lei Xia"><link rel=canonical href=https://www.ddhigh.com/2017/06/24/rsa-in-node-php/><link rel=alternate type=application/rss+xml href=https://www.ddhigh.com//index.xml title=每天进步一点点><script async defer data-website-id=52f8f0f9-d93d-466b-8ef5-508aae8c4ed4 src=https://analysis.ddhigh.com/script.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-EC3XLVSGKV"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EC3XLVSGKV")</script><meta property="og:url" content="https://www.ddhigh.com/2017/06/24/rsa-in-node-php/"><meta property="og:site_name" content="每天进步一点点"><meta property="og:title" content="使用RSA在PHP和NodeJs中进行加密数据通信"><meta property="og:description" content="RSA算法是目前用的最多的非对称加密算法，文本将基于openssl在nodejs和php中进行加密数据通信。
生成密钥对 openssl genrsa -out private."><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-06-24T00:00:00+00:00"><meta property="article:modified_time" content="2017-06-24T00:00:00+00:00"><meta property="article:tag" content="Openssl"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用RSA在PHP和NodeJs中进行加密数据通信"><meta name=twitter:description content="RSA算法是目前用的最多的非对称加密算法，文本将基于openssl在nodejs和php中进行加密数据通信。
生成密钥对 openssl genrsa -out private."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.ddhigh.com/posts/"},{"@type":"ListItem","position":2,"name":"使用RSA在PHP和NodeJs中进行加密数据通信","item":"https://www.ddhigh.com/2017/06/24/rsa-in-node-php/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用RSA在PHP和NodeJs中进行加密数据通信","name":"使用RSA在PHP和NodeJs中进行加密数据通信","description":"RSA算法是目前用的最多的非对称加密算法，文本将基于openssl在nodejs和php中进行加密数据通信。\n生成密钥对 openssl genrsa -out private.","keywords":["openssl"],"articleBody":"RSA算法是目前用的最多的非对称加密算法，文本将基于openssl在nodejs和php中进行加密数据通信。\n生成密钥对 openssl genrsa -out private.key 2048 rsa -in private.key -pubout -out public.key 执行完命令后，可以在当前目录看到:\npublic.key 公钥 private.key 私钥 NodeJs服务器 本文使用koa2来构建一个基于openssl加密方案的http服务器。 源码使用typescript进行开发。\n安装依赖 npm init -y npm install typescript koa koa-router @types/node @types/koa @types/koa-router --save 最终的package.json内容如下：\n{ \"name\": \"openssl-demo\", \"version\": \"1.0.0\", \"description\": \"\", \"main\": \"index.js\", \"scripts\": { \"build\": \"tsc -w\", \"start\": \"node index.js\" }, \"keywords\": [], \"author\": \"\", \"license\": \"ISC\", \"dependencies\": { \"@types/koa\": \"^2.0.39\", \"@types/koa-router\": \"^7.0.22\", \"@types/node\": \"^8.0.2\", \"koa\": \"^2.3.0\", \"koa-router\": \"^7.2.1\", \"typescript\": \"^2.3.4\" } } 开始编码index.ts: import * as crypto from 'crypto'; import * as constants from 'constants'; import * as Koa from 'koa'; import * as KoaRouter from 'koa-router'; import * as fs from 'fs'; class Server { app: Koa; static bootstrap() { return new Server(); } constructor() { this.app = new Koa(); this.route(); this.app.listen(8081, () =\u003e { console.info('listen on 8081'); }); } parsePostData(ctx): Promise\u003cBuffer\u003e { return new Promise((resolve, reject) =\u003e { try { let postdata = Buffer.alloc(0); ctx.req.addListener('data', (data) =\u003e { postdata = Buffer.concat([data]); }); ctx.req.addListener(\"end\", function () { resolve(postdata); }) } catch (err) { reject(err) } }) } private readFile(path): Promise\u003cBuffer\u003e { return new Promise((resolve, reject) =\u003e fs.readFile(path, (e, data) =\u003e e ? reject(e) : resolve(data))); } private route() { const router = new KoaRouter(); router.post('/', async (ctx: Koa.Context, next) =\u003e { const encrypted = await this.parsePostData(ctx); // 接收到的经过base64编码后的加密数据 const key = await this.readFile(__dirname + '/private.key');//读取私钥 const pkey = key.toString();// 字符串形式的私钥 const data = crypto.privateDecrypt({key: pkey, padding: constants.RSA_PKCS1_PADDING}, new Buffer(encrypted.toString(), 'base64')); // 使用私钥解密Buffer const json = JSON.parse(data.toString()); // 将解密后的信息解码为json对象 const msg = JSON.stringify({errcode: json.name === 'demo' ? 0 : 1, errmsg: json.name === 'demo' ? 'ok' : 'error'}); // 需要返回的明文数据 const e = crypto.privateEncrypt({key: pkey, padding: constants.RSA_PKCS1_PADDING}, new Buffer(msg)); // 使用私钥加密返回数据 ctx.body = e.toString('base64'); // 将buffer编码为base64字符串后返回 }); this.app .use(router.routes()) .use(router.allowedMethods()); } } Server.bootstrap(); 编译typescript npm run build 启动服务器 npm run start 此时我们的服务器已经启动完成。\nPHP客户端 将2中的公钥复制到php项目下。 本文使用rmccue/requests作为http客户端发起请求。 index.php关键代码如下:\n\u003c?php $pubKey = openssl_pkey_get_public(file_get_contents(__DIR__ . '/public.key')); // 读取公钥 $data = Json::encode(['name' =\u003e 'demo']); // 需要提交的明文数据 openssl_public_encrypt($data, $encryped, $pubKey); // 使用公钥加密明文数据 $data = base64_encode($encryped); // 将加密后的数据进行base64编码 $res = Requests::post('http://localhost:8081', [], $data); // 将base64数据提交到NodeJs $data = base64_decode($res-\u003ebody);// 接收NodeJs私钥加密后的响应并进行base64解码 openssl_public_decrypt($data, $dd, $pubKey); // 使用公钥将密文解密 echo $dd; // 打印数据 执行正常请求 php index.php 输出如下\n{\"errcode\":0,\"errmsg\":\"ok\"} 执行不正常请求 将php中\n$data = Json::encode(['name' =\u003e 'demo']); 改为\n$data = Json::encode(['name' =\u003e 'demo1']); 发现收到的响应为\n{\"errcode\":1,\"errmsg\":\"error\"} 证明提交的数据不能被nodejs接受。\n后记 本文简单使用了一下openssl相关功能函数，旨在起到一个抛砖引玉的作用，基于rsa算法可以开发出很多安全性很高的应用。\n","wordCount":"367","inLanguage":"zh","datePublished":"2017-06-24T00:00:00Z","dateModified":"2017-06-24T00:00:00Z","author":{"@type":"Person","name":"Lei Xia"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.ddhigh.com/2017/06/24/rsa-in-node-php/"},"publisher":{"@type":"Organization","name":"每天进步一点点","logo":{"@type":"ImageObject","url":"https://www.ddhigh.com/favicon.ico"}}}</script><link rel=icon href=/img/favicon.ico sizes=16x16><link rel=apple-touch-icon href=/img/favicon.ico><link rel=manifest href=/img/favicon.ico><link rel=stylesheet href=https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css><link rel=stylesheet href=/css/main.min.d0df733b91ef046970ecd63de7aa626886fd263fd3fb2b8ff28b560e505831f7.css integrity="sha256-0N9zO5HvBGlw7NY956piaIb9Jj/T+yuP8otWDlBYMfc=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css integrity="sha512-ygEyjMC6rqnzJqWGjRTJUPYMEs9JUOm3i7OWUS9CgQ4XkBUvMsgCS1I8JqavidQ2ClHcREB7IbA2mN08+r9Elg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css><script src=/js/highlight.min.min.c607d6febd16934a82eb61d3a896ed9d869f54373cc63ce95864ed5488fe3128.js></script><script>hljs.highlightAll()</script><script>$darkModeInit.Content|safeJS</script></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-brand href=/>每天进步一点点
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><span></span><span></span><span></span></label><ul class=navigation-list id=navigation-list><li class="navigation-item navigation-menu"><a class=navigation-link href=/>首页</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/archives>归档</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/books>出版物</a></li><li class="navigation-item navigation-menu"><a class=navigation-link href=/guestbook>留言板</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class="navigation-item navigation-social"><a class=navigation-link href=https://github.com/xialeistudio><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li class="navigation-item navigation-dark"><button id=mode type=button aria-label="toggle user light or dark theme">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span>
<span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></li><li class="navigation-item navigation-language"><a href=https://www.ddhigh.com/en/>EN</a></li></ul></section></nav><div id=content><article class=blog-single><header class=blog-title><h1>使用RSA在PHP和NodeJs中进行加密数据通信</h1></header><p><small>2017年6月24日&nbsp;· 367 字&nbsp;· 2 分钟</small><p><div class=blog-toc><nav id=TableOfContents><ul><li><a href=#生成密钥对>生成密钥对</a></li><li><a href=#nodejs服务器>NodeJs服务器</a><ul><li><a href=#安装依赖>安装依赖</a></li><li><a href=#开始编码indexts>开始编码<em>index.ts</em>:</a></li><li><a href=#编译typescript>编译typescript</a></li><li><a href=#启动服务器>启动服务器</a></li></ul></li><li><a href=#php客户端>PHP客户端</a></li><li><a href=#执行正常请求>执行正常请求</a></li><li><a href=#执行不正常请求>执行不正常请求</a></li><li><a href=#后记>后记</a></li></ul></nav></div><section class=blog-content><p>RSA算法是目前用的最多的非对称加密算法，文本将基于openssl在nodejs和php中进行加密数据通信。</p><h2 id=生成密钥对>生成密钥对</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl
</span></span><span style=display:flex><span>genrsa -out private.key <span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>rsa -in private.key -pubout -out public.key
</span></span></code></pre></div><p>执行完命令后，可以在当前目录看到:</p><ul><li>public.key 公钥</li><li>private.key 私钥</li></ul><h2 id=nodejs服务器>NodeJs服务器</h2><p>本文使用koa2来构建一个基于openssl加密方案的http服务器。
源码使用typescript进行开发。</p><h3 id=安装依赖>安装依赖</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm init -y
</span></span><span style=display:flex><span>npm install typescript koa koa-router @types/node @types/koa @types/koa-router --save
</span></span></code></pre></div><p>最终的<em>package.json</em>内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;openssl-demo&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;main&#34;</span>: <span style=color:#e6db74>&#34;index.js&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;scripts&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;build&#34;</span>: <span style=color:#e6db74>&#34;tsc -w&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;start&#34;</span>: <span style=color:#e6db74>&#34;node index.js&#34;</span>
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;keywords&#34;</span>: [],
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;author&#34;</span>: <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;license&#34;</span>: <span style=color:#e6db74>&#34;ISC&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;dependencies&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;@types/koa&#34;</span>: <span style=color:#e6db74>&#34;^2.0.39&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;@types/koa-router&#34;</span>: <span style=color:#e6db74>&#34;^7.0.22&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;@types/node&#34;</span>: <span style=color:#e6db74>&#34;^8.0.2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;koa&#34;</span>: <span style=color:#e6db74>&#34;^2.3.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;koa-router&#34;</span>: <span style=color:#e6db74>&#34;^7.2.1&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;typescript&#34;</span>: <span style=color:#e6db74>&#34;^2.3.4&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=开始编码indexts>开始编码<em>index.ts</em>:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>crypto</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;crypto&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>constants</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;constants&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>Koa</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;koa&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>KoaRouter</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;koa-router&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;fs&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Server</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>app</span>: <span style=color:#66d9ef>Koa</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>bootstrap() {</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Server</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Koa</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>route</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>8081</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#39;listen on 8081&#39;</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>parsePostData</span>(<span style=color:#a6e22e>ctx</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Buffer</span>&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>postdata</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>alloc</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>addListener</span>(<span style=color:#e6db74>&#39;data&#39;</span>, (<span style=color:#a6e22e>data</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>postdata</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#a6e22e>concat</span>([<span style=color:#a6e22e>data</span>]);
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>addListener</span>(<span style=color:#e6db74>&#34;end&#34;</span>, <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>postdata</span>);
</span></span><span style=display:flex><span>                })
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>path</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Buffer</span>&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>path</span>, (<span style=color:#a6e22e>e</span>, <span style=color:#a6e22e>data</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>e</span>) <span style=color:#f92672>:</span> <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>data</span>)));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>route() {</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>KoaRouter</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>ctx</span>: <span style=color:#66d9ef>Koa.Context</span>, <span style=color:#a6e22e>next</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encrypted</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>parsePostData</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#75715e>// 接收到的经过base64编码后的加密数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>readFile</span>(<span style=color:#a6e22e>__dirname</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;/private.key&#39;</span>);<span style=color:#75715e>//读取私钥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pkey</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>toString</span>();<span style=color:#75715e>// 字符串形式的私钥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>privateDecrypt</span>({<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>pkey</span>, <span style=color:#a6e22e>padding</span>: <span style=color:#66d9ef>constants.RSA_PKCS1_PADDING</span>}, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Buffer</span>(<span style=color:#a6e22e>encrypted</span>.<span style=color:#a6e22e>toString</span>(), <span style=color:#e6db74>&#39;base64&#39;</span>)); <span style=color:#75715e>// 使用私钥解密Buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>json</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>toString</span>()); <span style=color:#75715e>// 将解密后的信息解码为json对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({<span style=color:#a6e22e>errcode</span>: <span style=color:#66d9ef>json.name</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;demo&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>0</span> : <span style=color:#66d9ef>1</span>, <span style=color:#a6e22e>errmsg</span>: <span style=color:#66d9ef>json.name</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;demo&#39;</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;ok&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;error&#39;</span>}); <span style=color:#75715e>// 需要返回的明文数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>privateEncrypt</span>({<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>pkey</span>, <span style=color:#a6e22e>padding</span>: <span style=color:#66d9ef>constants.RSA_PKCS1_PADDING</span>}, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Buffer</span>(<span style=color:#a6e22e>msg</span>)); <span style=color:#75715e>// 使用私钥加密返回数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;base64&#39;</span>); <span style=color:#75715e>// 将buffer编码为base64字符串后返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>app</span>
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>routes</span>())
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>allowedMethods</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Server</span>.<span style=color:#a6e22e>bootstrap</span>();
</span></span></code></pre></div><h3 id=编译typescript>编译typescript</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run build
</span></span></code></pre></div><h3 id=启动服务器>启动服务器</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm run start
</span></span></code></pre></div><p>此时我们的服务器已经启动完成。</p><h2 id=php客户端>PHP客户端</h2><p>将2中的<em>公钥</em>复制到php项目下。
本文使用<code>rmccue/requests</code>作为<code>http客户端</code>发起请求。
index.php关键代码如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>$pubKey <span style=color:#f92672>=</span> <span style=color:#a6e22e>openssl_pkey_get_public</span>(<span style=color:#a6e22e>file_get_contents</span>(<span style=color:#66d9ef>__DIR__</span> <span style=color:#f92672>.</span> <span style=color:#e6db74>&#39;/public.key&#39;</span>)); <span style=color:#75715e>// 读取公钥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$data <span style=color:#f92672>=</span> <span style=color:#a6e22e>Json</span><span style=color:#f92672>::</span><span style=color:#a6e22e>encode</span>([<span style=color:#e6db74>&#39;name&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;demo&#39;</span>]); <span style=color:#75715e>// 需要提交的明文数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>openssl_public_encrypt</span>($data, $encryped, $pubKey); <span style=color:#75715e>// 使用公钥加密明文数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$data <span style=color:#f92672>=</span> <span style=color:#a6e22e>base64_encode</span>($encryped); <span style=color:#75715e>// 将加密后的数据进行base64编码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$res <span style=color:#f92672>=</span> <span style=color:#a6e22e>Requests</span><span style=color:#f92672>::</span><span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;http://localhost:8081&#39;</span>, [], $data); <span style=color:#75715e>// 将base64数据提交到NodeJs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>$data <span style=color:#f92672>=</span> <span style=color:#a6e22e>base64_decode</span>($res<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>body</span>);<span style=color:#75715e>// 接收NodeJs私钥加密后的响应并进行base64解码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>openssl_public_decrypt</span>($data, $dd, $pubKey); <span style=color:#75715e>// 使用公钥将密文解密
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>echo</span> $dd; <span style=color:#75715e>// 打印数据
</span></span></span></code></pre></div><h2 id=执行正常请求>执行正常请求</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>php index.php
</span></span></code></pre></div><p>输出如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;errcode&#34;</span>:<span style=color:#ae81ff>0</span>,<span style=color:#f92672>&#34;errmsg&#34;</span>:<span style=color:#e6db74>&#34;ok&#34;</span>}
</span></span></code></pre></div><h2 id=执行不正常请求>执行不正常请求</h2><p>将php中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$data <span style=color:#f92672>=</span> <span style=color:#a6e22e>Json</span><span style=color:#f92672>::</span><span style=color:#a6e22e>encode</span>([<span style=color:#e6db74>&#39;name&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;demo&#39;</span>]);
</span></span></code></pre></div><p>改为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$data <span style=color:#f92672>=</span> <span style=color:#a6e22e>Json</span><span style=color:#f92672>::</span><span style=color:#a6e22e>encode</span>([<span style=color:#e6db74>&#39;name&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>&#39;demo1&#39;</span>]);
</span></span></code></pre></div><p>发现收到的响应为</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;errcode&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;errmsg&#34;</span>:<span style=color:#e6db74>&#34;error&#34;</span>}
</span></span></code></pre></div><p>证明提交的数据不能被nodejs接受。</p><h2 id=后记>后记</h2><p>本文简单使用了一下openssl相关功能函数，旨在起到一个抛砖引玉的作用，基于rsa算法可以开发出很多安全性很高的应用。</p><div class=blog-footer><div class=social-share></div><div class=copyright><ul><li style=margin-bottom:.5em>本文作者: <a href=https://ddhigh.com/ target=_blank style=color:#000;text-decoration:none>xialeistudio</a></li><li style=margin-bottom:.5em>本文链接: <a href=https://www.ddhigh.com/2017/06/24/rsa-in-node-php/ target=_blank style=color:#000;text-decoration:none>使用RSA在PHP和NodeJs中进行加密数据通信</a></li><li>版权声明: <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank style=color:#000;text-decoration:none>「署名-非商业性使用-相同方式共享 4.0 国际」</a></li></ul></div><div style=margin-top:2rem><img src=/img/mp.png alt=qrcode></div></div></section><div class=paginator><a class=prev href=https://www.ddhigh.com/2017/07/18/spring-boot-druid-sql/><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M9.94496 9C9.28897 9.61644 7.63215 10.997 6.04814 11.7966 5.98257 11.8297 5.98456 11.9753 6.05061 12.0063c1.00435.4716 2.8788 1.9201 3.89435 2.9937M6.44444 11.9667C8.86549 12.0608 14 12 16 11" stroke="currentcolor" stroke-linecap="round"/></svg>
<span>druid spring boot 统计SQL问题</span></a>
<a class=next href=https://www.ddhigh.com/2017/06/13/node-unhandledrejection/><span>nodejs unhandledRejection问题解决</span><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.77086 21.1546C11.0491 22.698 21.4339 21.7773 21.4339 16.3608V4.63375c0-.69413-.075800000000001-1.3284-.2422-1.86588M3.77086 21.1546C1.9934 20.7777.973585 18.7264 1.08749 16.688c.17931-3.209.06972-7.25665-.08236-10.47293C.87809 3.52811 3.12891 1.16316 5.51029 1.25008c4.25565.15534 9.86671-.04779 13.28091-.24466 1.2952-.074686 2.0494.62843 2.4005 1.76245M3.77086 21.1546C4.56586 21.4723 5.49168 21.7879 6.5 22.0658M21.1917 2.76787c1.918 1.4143 1.9383 9.65123 1.7087 13.59293-2.0526 7.6586-10.5943 7.3054-16.4004 5.705M21.1917 2.76787C21.7612 4.51192 22.7203 9.67216 22 16.3608 21.2797 23.0494 11.3665 22.9511 6.5 22.0658M12.055 9C12.711 9.61644 14.3679 10.997 15.9519 11.7966 16.0174 11.8297 16.0154 11.9753 15.9494 12.0063 14.945 12.4779 13.0706 13.9264 12.055 15m3.5006-3.0333C13.1345 12.0608 8 12 6 11" stroke="currentcolor" stroke-linecap="round"/></svg></a></div><div class=comments><script>const getTheme=window.localStorage&&window.localStorage.getItem("theme");let theme=getTheme==="dark"?"dark":"light",s=document.createElement("script");s.src="https://giscus.app/client.js",s.setAttribute("data-repo","xialeistudio/discussion"),s.setAttribute("data-repo-id","R_kgDOKurTRA"),s.setAttribute("data-category","General"),s.setAttribute("data-category-id","DIC_kwDOKurTRM4CbCJt"),s.setAttribute("data-mapping","pathname"),s.setAttribute("data-strict","0"),s.setAttribute("data-reactions-enabled","1"),s.setAttribute("data-emit-metadata","0"),s.setAttribute("data-input-position","bottom"),s.setAttribute("data-theme",theme),s.setAttribute("data-lang","en"),s.setAttribute("data-loading","lazy"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></article></div><footer class=footer><p>&copy; 2014 - 2024 <a href=https://www.ddhigh.com/>每天进步一点点</a>
Powered by
<a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>
<a href=https://github.com/guangzhengli/hugo-theme-ladder rel=noopener target=_blank>Ladder</a>
️</p></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.5376 22.7916C11.0152 22.7207 22.5795 21.1781 22.0978 10.4211 22.0536 9.43274 21.9303 8.53367 21.7387 7.71865M10.5376 22.7916C16.876 22.3728 20.0969 19.8899 21.5383 16.9142M10.5376 22.7916C9.7707 22.9055 8.97982 22.8964 8.19743 22.7725M21.7387 7.71865C21.4988 6.69828 21.1518 5.80967 20.7188 5.04257m1.0199 2.67608C22.6022 10.1105 23.0542 13.7848 21.5383 16.9142M20.7188 5.04257c-3.5504-6.28886-12.88753-4.410077-16.44303.0C2.88063 6.77451-.0433281 11.1668 1.38159 16.6571c.89322 3.4417 3.7911 5.6365 6.81584 6.1154M20.7188 5.04257c1.3509 1.89783 3.3111 6.34223 1.6353 10.37273M21.5383 16.9142C21.8737 16.4251 22.1428 15.9235 22.3541 15.4153M8.19743 22.7725C12.1971 23.4683 20.6281 22.971 22.3541 15.4153M14 10.945C13.3836 10.289 12.003 8.63215 11.2034 7.04814 11.1703 6.98257 11.0247 6.98456 10.9937 7.05061 10.5221 8.05496 9.07362 9.92941 8 10.945m3.0333-3.50056C10.9392 9.86549 11 15 12 17" stroke="currentcolor" stroke-linecap="round"/></svg>
</a><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Copy";function n(){t.innerHTML="Copied",setTimeout(()=>{t.innerHTML="Copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),n();return}const s=document.createRange();s.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(s);try{document.execCommand("copy"),n()}catch{}o.removeRange(s)}),e.parentNode.appendChild(t)})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js integrity="sha512-9DNXrSjk17bU9MUbRp3IjwcWe46V8FaGA062PFbryPUAEQVRbz4jiZP6FW0AdbqEGtMYBDWnul3eiGBMJOQajA==" crossorigin=anonymous referrerpolicy=no-referrer></script></main></body><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>const images=Array.from(document.querySelectorAll(".blog-content img"));images.forEach(e=>{mediumZoom(e,{margin:10,scrollOffset:40,container:null,template:null,background:"rgba(0, 0, 0, 0.5)"})})</script><script src=/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin=anonymous defer></script></html>